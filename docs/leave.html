<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>‡∏Ñ‡∏ô‡∏•‡∏≤‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô ‚Äî Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <style>
    .leave-header {
      background: linear-gradient(135deg, #2d3748, #4a5568);
      color: #fff;
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl) var(--spacing-2xl);
      margin-bottom: var(--spacing-xl);
      display: flex; align-items: center; gap: var(--spacing-md);
    }
    .leave-header h2 { font-size: var(--text-xl); font-weight: 700; margin: 0; }
    .leave-header p { font-size: var(--text-sm); color: #cbd5e0; margin: 4px 0 0; }
    .leave-tabs { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-xl); flex-wrap: wrap; }
    .leave-tab { padding: 8px 20px; border-radius: var(--radius-full); cursor: pointer; font-size: var(--text-sm);
      background: var(--premium-light-gray); border: none; font-family: var(--font-family-body);
      color: var(--premium-text); transition: background .2s, color .2s; }
    .leave-tab.active { background: var(--premium-gold); color: #fff; font-weight: 600; }
    .tab-panel { display: none; } .tab-panel.active { display: block; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); }
    @media(max-width:600px) { .form-row { grid-template-columns: 1fr; } }
    .slot-btns { display: flex; flex-wrap: wrap; gap: var(--spacing-sm); margin: var(--spacing-sm) 0; }
    .slot-btn { padding: 8px 16px; border-radius: var(--radius-full); border: 2px solid var(--premium-border);
      background: #fff; cursor: pointer; font-size: var(--text-sm); font-family: var(--font-family-body);
      color: var(--premium-text); transition: all .2s; }
    .slot-btn.selected { border-color: var(--premium-gold); background: var(--premium-gold); color: #fff; font-weight: 600; }
    .leave-list { display: flex; flex-direction: column; gap: var(--spacing-md); }
    .leave-card { background: var(--premium-white); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);
      padding: var(--spacing-lg); border-left: 4px solid var(--premium-border); }
    .leave-card.pending { border-left-color: #ed8936; }
    .leave-card.approved { border-left-color: #276749; }
    .leave-card.rejected { border-left-color: #c53030; }
    .leave-card-head { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px; }
    .leave-card-head h4 { margin: 0; font-size: var(--text-md); font-weight: 600; }
    .leave-badge { padding: 4px 12px; border-radius: var(--radius-full); font-size: 12px; font-weight: 600; }
    .leave-badge.pending { background: #fef3c7; color: #92400e; }
    .leave-badge.approved { background: #d1fae5; color: #065f46; }
    .leave-badge.rejected { background: #fee2e2; color: #991b1b; }
    .leave-card-body { margin: 8px 0 0; font-size: var(--text-sm); color: var(--premium-text-light); }
    .leave-card-body span { color: var(--premium-text); font-weight: 500; }
    .sub-info { font-size: 12px; color: var(--premium-text-muted); margin-top: 6px; }
    .assign-form { background: var(--premium-off-white); border-radius: var(--radius-md); padding: var(--spacing-md); margin-top: 10px; }
    .assign-form h5 { margin: 0 0 8px; font-size: var(--text-sm); font-weight: 600; }
    .member-select-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
    .member-chip { padding: 6px 14px; border-radius: var(--radius-full); border: 2px solid var(--premium-border);
      cursor: pointer; font-size: var(--text-sm); font-family: var(--font-family-body); background: #fff; transition: all .2s; }
    .member-chip.selected { border-color: var(--premium-gold); background: var(--premium-gold); color: #fff; }
    .empty-card { text-align: center; padding: var(--spacing-2xl); color: var(--premium-text-muted); }
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <main>
    <div class="container">
      <div class="leave-header">
        <div style="font-size:36px">üîÑ</div>
        <div>
          <h2>‡∏Ñ‡∏ô‡∏•‡∏≤‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô</h2>
          <p>‡∏Ç‡∏≠‡∏•‡∏≤‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô</p>
        </div>
      </div>

      <!-- Tabs -->
      <div class="leave-tabs">
        <button class="leave-tab active" data-tab="myRequest">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        <button class="leave-tab" data-tab="requestLeave">‡∏Ç‡∏≠‡∏•‡∏≤‡∏á‡∏≤‡∏ô</button>
        <div id="managerTabs" style="display:none;display:flex;gap:var(--spacing-sm)">
          <button class="leave-tab" data-tab="allRequests">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
      </div>

      <!-- Tab: My Leave Requests -->
      <div class="tab-panel active" id="tab-myRequest">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
          </div>
          <div id="myLeaveList"><div class="empty-card">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
        </div>
      </div>

      <!-- Tab: Request Leave Form -->
      <div class="tab-panel" id="tab-requestLeave">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">‡∏Ç‡∏≠‡∏•‡∏≤‡∏á‡∏≤‡∏ô</h3>
          </div>
          <div class="form-group">
            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
            <input type="date" id="leaveDate" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
            <select id="leaveVenue" class="form-control">
              <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
            <div class="slot-btns" id="leaveSlotBtns">
              <p style="color:var(--premium-text-muted);font-size:var(--text-sm)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô</p>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
            <textarea id="leaveReason" class="form-control" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡πà‡∏ß‡∏¢ ‡∏ò‡∏∏‡∏£‡∏∞‡∏î‡πà‡∏ß‡∏ô ‡∏Ø‡∏•‡∏Ø"></textarea>
          </div>
          <button class="btn btn-primary" id="leaveSubmitBtn">‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</button>
        </div>
      </div>

      <!-- Tab: All Requests (Manager) -->
      <div class="tab-panel" id="tab-allRequests">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ß‡∏á</h3>
          </div>
          <div id="allLeaveList"><div class="empty-card">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
        </div>
      </div>
    </div>
  </main>

  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script>
  var lvBandId = '';
  var lvUserRole = '';
  var lvIsManager = false;
  var lvBandSettings = { venues: [], scheduleData: {} };
  var lvSelectedSlots = [];

  function lvEsc(s) { var d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }
  function lvFmt(s) { if (!s) return ''; return new Date(s).toLocaleDateString('th-TH', {day:'numeric',month:'long',year:'numeric'}); }

  // ===== TABS =====
  document.querySelectorAll('.leave-tab').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var tab = btn.dataset.tab;
      document.querySelectorAll('.leave-tab').forEach(function(b) { b.classList.remove('active'); });
      document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
      btn.classList.add('active');
      var panel = document.getElementById('tab-' + tab);
      if (panel) panel.classList.add('active');
      if (tab === 'allRequests') lvLoadAllRequests();
      if (tab === 'myRequest') lvLoadMyRequests();
    });
  });

  // ===== LOAD SETTINGS =====
  function lvLoadSettings(cb) {
    var stored = localStorage.getItem('bandSettings');
    if (stored) {
      try {
        var s = JSON.parse(stored);
        lvBandSettings = { venues: s.venues || [], scheduleData: s.scheduleData || s.schedule || {} };
      } catch(e) {}
    }
    if (lvBandSettings.venues.length > 0) { cb(); return; }
    if (lvBandId && typeof gasRun === 'function') {
      gasRun('getBandSettings', { bandId: lvBandId }, function(r) {
        if (r && r.success && r.data) {
          lvBandSettings = { venues: r.data.venues || [], scheduleData: r.data.scheduleData || {} };
          try { localStorage.setItem('bandSettings', JSON.stringify(r.data)); } catch(e) {}
        }
        cb();
      });
    } else { cb(); }
  }

  // ===== POPULATE VENUE SELECT =====
  function lvRenderVenues() {
    var sel = document.getElementById('leaveVenue');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà --</option>';
    (lvBandSettings.venues || []).forEach(function(v) {
      var name = v.name || v.venueName || String(v);
      var opt = document.createElement('option');
      opt.value = name; opt.textContent = name;
      sel.appendChild(opt);
    });
    if (!lvBandSettings.venues.length) {
      sel.innerHTML = '<option value="‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å">‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å</option>';
    }
  }

  // ===== SLOTS FOR DATE =====
  function lvGetSlots(dateStr) {
    if (!dateStr) return [];
    var dow = new Date(dateStr).getDay();
    var dayData = lvBandSettings.scheduleData[dow] || lvBandSettings.scheduleData[String(dow)];
    if (dayData && dayData.timeSlots && dayData.timeSlots.length) {
      return dayData.timeSlots.map(function(s) { return s.startTime + '-' + s.endTime; });
    }
    return ['19:30-20:30', '21:00-22:00', '22:30-23:30'];
  }

  function lvRenderSlots() {
    var date = document.getElementById('leaveDate').value;
    var container = document.getElementById('leaveSlotBtns');
    lvSelectedSlots = [];
    if (!date) {
      container.innerHTML = '<p style="color:var(--premium-text-muted);font-size:var(--text-sm)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô</p>';
      return;
    }
    var slots = lvGetSlots(date);
    container.innerHTML = slots.map(function(key) {
      var parts = key.split('-');
      return '<button type="button" class="slot-btn" data-slot="' + lvEsc(key) + '">üïê ' + lvEsc(parts[0] + ' ‚Äì ' + parts[1]) + '</button>';
    }).join('');
    container.querySelectorAll('.slot-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var slot = btn.dataset.slot;
        if (btn.classList.contains('selected')) {
          btn.classList.remove('selected');
          lvSelectedSlots = lvSelectedSlots.filter(function(s) { return s !== slot; });
        } else {
          btn.classList.add('selected');
          lvSelectedSlots.push(slot);
        }
      });
    });
  }

  // ===== SUBMIT LEAVE REQUEST =====
  document.getElementById('leaveSubmitBtn').addEventListener('click', function() {
    var date = document.getElementById('leaveDate').value;
    var venue = document.getElementById('leaveVenue').value;
    var reason = document.getElementById('leaveReason').value;
    if (!date) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'error'); return; }
    if (!venue) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà', 'error'); return; }
    if (!lvSelectedSlots.length) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≤', 'error'); return; }
    var btn = document.getElementById('leaveSubmitBtn');
    btn.disabled = true; btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
    gasRun('requestLeave', { bandId: lvBandId, date: date, venue: venue, slots: lvSelectedSlots, reason: reason }, function(r) {
      btn.disabled = false; btn.textContent = '‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤';
      if (r && r.success) {
        showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', 'success');
        document.getElementById('leaveDate').value = '';
        document.getElementById('leaveReason').value = '';
        lvSelectedSlots = [];
        document.querySelectorAll('.slot-btn').forEach(function(b) { b.classList.remove('selected'); });
        // Switch to my requests tab
        document.querySelector('[data-tab="myRequest"]').click();
      } else {
        showToast((r && r.message) || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
      }
    });
  });

  // ===== LOAD MY LEAVE REQUESTS =====
  function lvLoadMyRequests() {
    var container = document.getElementById('myLeaveList');
    container.innerHTML = '<div class="empty-card">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
    gasRun('getMyLeaveRequests', { bandId: lvBandId }, function(r) {
      if (!r || !r.success || !r.data || !r.data.length) {
        container.innerHTML = '<div class="empty-card">üìã ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏•‡∏≤</div>';
        return;
      }
      container.innerHTML = r.data.map(function(item) {
        var badge = item.status === 'approved' ? 'approved' : (item.status === 'rejected' ? 'rejected' : 'pending');
        var badgeText = badge === 'approved' ? '‡∏°‡∏µ‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : (badge === 'rejected' ? '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
        var slots = Array.isArray(item.slots) ? item.slots.map(function(s) {
          var p = s.split('-'); return p[0] + ' ‚Äì ' + p[1];
        }).join(', ') : (item.slots || '');
        return '<div class="leave-card ' + badge + '">'
          + '<div class="leave-card-head"><h4>üìÖ ' + lvEsc(lvFmt(item.date)) + ' ¬∑ ' + lvEsc(item.venue||'') + '</h4>'
          + '<span class="leave-badge ' + badge + '">' + badgeText + '</span></div>'
          + '<div class="leave-card-body">‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: <span>' + lvEsc(slots) + '</span>'
          + (item.reason ? '<br>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: <span>' + lvEsc(item.reason) + '</span>' : '')
          + (item.substitute ? '<br>‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô: <span>' + lvEsc(item.substitute) + '</span>' : '')
          + '</div>'
          + '<div class="sub-info">‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ' + lvEsc(item.createdAt ? new Date(item.createdAt).toLocaleDateString('th-TH') : '') + '</div>'
          + '</div>';
      }).join('');
    });
  }

  // ===== LOAD ALL REQUESTS (MANAGER) =====
  function lvLoadAllRequests() {
    var container = document.getElementById('allLeaveList');
    container.innerHTML = '<div class="empty-card">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
    gasRun('getAllLeaveRequests', { bandId: lvBandId }, function(r) {
      if (!r || !r.success || !r.data || !r.data.length) {
        container.innerHTML = '<div class="empty-card">üìã ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏á</div>';
        return;
      }
      var members = lvBandSettings.members || [];
      container.innerHTML = r.data.map(function(item) {
        var badge = item.status === 'approved' ? 'approved' : (item.status === 'rejected' ? 'rejected' : 'pending');
        var badgeText = badge === 'approved' ? '‡∏°‡∏µ‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : (badge === 'rejected' ? '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
        var slots = Array.isArray(item.slots) ? item.slots.map(function(s) {
          var p = s.split('-'); return p[0] + ' ‚Äì ' + p[1];
        }).join(', ') : (item.slots || '');
        var assignSection = badge === 'pending' ? (
          '<div class="assign-form">'
          + '<h5>‡∏à‡∏±‡∏î‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô</h5>'
          + '<div class="member-select-grid" id="memberChips_' + lvEsc(item.id) + '">'
          + members.filter(function(m) { return m.name !== item.memberName; }).map(function(m) {
            return '<button type="button" class="member-chip" data-member="' + lvEsc(m.name||m) + '">' + lvEsc(m.name||m) + '</button>';
          }).join('')
          + '</div>'
          + '<div class="form-group" style="margin-bottom:8px">'
          + '<input type="text" class="form-control" placeholder="‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ô‡∏≠‡∏Å‡∏ß‡∏á..." id="subInput_' + lvEsc(item.id) + '" style="font-size:var(--text-sm)">'
          + '</div>'
          + '<button type="button" class="btn btn-primary btn-sm" onclick="lvAssign(' + "'" + item.id + "'" + ')">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô</button>'
          + '&nbsp;<button type="button" class="btn btn-ghost btn-sm" onclick="lvReject(' + "'" + item.id + "'" + ')">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>'
          + '</div>'
        ) : '';
        return '<div class="leave-card ' + badge + '" id="leaveCard_' + lvEsc(item.id) + '">'
          + '<div class="leave-card-head"><h4>üë§ ' + lvEsc(item.memberName||'') + ' ¬∑ ' + lvEsc(lvFmt(item.date)) + '</h4>'
          + '<span class="leave-badge ' + badge + '">' + badgeText + '</span></div>'
          + '<div class="leave-card-body">üìç ‡∏£‡πâ‡∏≤‡∏ô: <span>' + lvEsc(item.venue||'') + '</span> ¬∑ ‚è∞ <span>' + lvEsc(slots) + '</span>'
          + (item.reason ? '<br>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: <span>' + lvEsc(item.reason) + '</span>' : '')
          + (item.substitute ? '<br>‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô: <span>' + lvEsc(item.substitute) + '</span>' : '')
          + '</div>'
          + assignSection + '</div>';
      }).join('');

      // Member chip toggle + text sync
      document.querySelectorAll('.member-chip').forEach(function(chip) {
        chip.addEventListener('click', function() {
          var gridId = chip.closest('.member-select-grid').id;
          var itemId = gridId.replace('memberChips_', '');
          chip.closest('.member-select-grid').querySelectorAll('.member-chip').forEach(function(c) { c.classList.remove('selected'); });
          chip.classList.add('selected');
          var inp = document.getElementById('subInput_' + itemId);
          if (inp) inp.value = chip.dataset.member;
        });
      });
    });
  }

  function lvAssign(itemId) {
    var inp = document.getElementById('subInput_' + itemId);
    var substitute = inp ? inp.value.trim() : '';
    if (!substitute) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô', 'error'); return; }
    gasRun('assignSubstitute', { bandId: lvBandId, leaveId: itemId, substitute: substitute }, function(r) {
      if (r && r.success) {
        showToast('‡∏à‡∏±‡∏î‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        lvLoadAllRequests();
      } else { showToast((r && r.message) || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
    });
  }

  function lvReject(itemId) {
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ô‡∏µ‡πâ?')) return;
    gasRun('rejectLeave', { bandId: lvBandId, leaveId: itemId }, function(r) {
      if (r && r.success) {
        showToast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
        lvLoadAllRequests();
      } else { showToast((r && r.message) || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
    });
  }

  // ===== INIT =====
  document.addEventListener('DOMContentLoaded', function() {
    requireAuth();
    renderMainNav('mainNav');
    applyTranslations();

    lvBandId = localStorage.getItem('bandId') || '';
    lvUserRole = localStorage.getItem('userRole') || 'member';
    lvIsManager = !!(localStorage.getItem('bandManager') || lvUserRole === 'manager' || lvUserRole === 'admin');

    // Show manager tab
    if (lvIsManager) {
      var mt = document.getElementById('managerTabs');
      if (mt) { mt.style.display = 'flex'; }
      // Add manager tab buttons dynamically
      var leaveTabsEl = document.querySelector('.leave-tabs');
      if (leaveTabsEl && !document.querySelector('[data-tab="allRequests"]')) {
        var t2 = document.createElement('button');
        t2.className = 'leave-tab';
        t2.dataset.tab = 'allRequests';
        t2.textContent = 'üë• ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        leaveTabsEl.appendChild(t2);
        t2.addEventListener('click', function() {
          document.querySelectorAll('.leave-tab').forEach(function(b) { b.classList.remove('active'); });
          document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
          t2.classList.add('active');
          document.getElementById('tab-allRequests').classList.add('active');
          lvLoadAllRequests();
        });
      }
    }

    // Set min date = tomorrow for leave request
    var tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate());
    document.getElementById('leaveDate').min = tomorrow.toISOString().split('T')[0];

    // Date change ‚Üí render slots
    document.getElementById('leaveDate').addEventListener('change', lvRenderSlots);

    // Venue change ‚Üí re-render slots
    document.getElementById('leaveVenue').addEventListener('change', lvRenderSlots);

    // Load settings then populate
    lvLoadSettings(function() {
      lvRenderVenues();
      lvLoadMyRequests();
    });
  });

  function showToast(msg, type) {
    var t = document.getElementById('toast');
    if (!t) { alert(msg); return; }
    t.textContent = msg;
    t.style.background = type === 'error' ? '#c53030' : (type === 'success' ? '#276749' : 'var(--premium-gold)');
    t.style.display = 'block'; t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); setTimeout(function() { t.style.display = 'none'; }, 300); }, 3500);
  }
  </script>
</body>
</html>
