<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ข้อมูลส่วนตัว — Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <style>
    .profile-avatar-wrap {
      display: flex; flex-direction: column; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg);
    }
    .profile-avatar {
      width: 90px; height: 90px; background: var(--premium-gold); border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 2.5rem; box-shadow: var(--shadow-lg);
    }
    .profile-name-display { text-align: center; }
    .profile-name-display .full-name { font-size: var(--text-xl); font-weight: 700; color: var(--premium-text); }
    .profile-name-display .nickname { font-size: var(--text-base); color: var(--premium-text-muted); }
    .profile-name-display .instrument { font-size: var(--text-sm); color: var(--premium-gold); font-weight: 600; }
    .form-section-label {
      font-size: var(--text-xs); font-weight: 600; color: var(--premium-text-muted); text-transform: uppercase;
      letter-spacing: .05em; margin: var(--spacing-lg) 0 var(--spacing-xs); border-bottom: 1px solid var(--premium-light-gray); padding-bottom: 4px;
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); }
    .form-row-3 { display: grid; grid-template-columns: auto 1fr 1fr; gap: var(--spacing-md); }
    @media(max-width:576px) { .form-row, .form-row-3 { grid-template-columns: 1fr; } }
    .info-readonly {
      background: var(--premium-light-gray); border-radius: var(--radius-md);
      padding: var(--spacing-sm) var(--spacing-md); font-size: var(--text-sm); color: var(--premium-text-muted);
    }
    .section-card {
      background: var(--premium-white); border-radius: var(--radius-lg); box-shadow: var(--shadow-md);
      padding: var(--spacing-xl); margin-bottom: var(--spacing-lg);
    }
    .section-card h3 { font-size: var(--text-lg); font-weight: 700; color: var(--premium-text); margin: 0 0 var(--spacing-md); }
    .change-row { display: flex; gap: var(--spacing-md); align-items: flex-end; flex-wrap: wrap; }
    .change-row .form-group { flex: 1; min-width: 200px; }
    .msg-box { padding: 8px 12px; border-radius: var(--radius-md); font-size: var(--text-sm); margin-top: var(--spacing-sm); display: none; }
    .msg-box.success { display: block; background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
    .msg-box.error { display: block; background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <main>
    <div class="container" style="max-width:720px">
      <div class="page-header">
        <h1 class="page-title">👤 ข้อมูลส่วนตัว</h1>
      </div>

      <!-- Avatar + ชื่อแสดงผล -->
      <div class="section-card">
        <div class="profile-avatar-wrap">
          <div class="profile-avatar" id="avatarIcon">🎤</div>
          <div class="profile-name-display">
            <div class="full-name" id="displayFullName">กำลังโหลด...</div>
            <div class="nickname" id="displayNickname"></div>
            <div class="instrument" id="displayInstrument"></div>
          </div>
        </div>
      </div>

      <!-- ฟอร์มข้อมูลส่วนตัว -->
      <div class="section-card">
        <h3>📝 แก้ไขข้อมูลส่วนตัว</h3>
        <form id="profileForm">
          <div class="form-section-label">ข้อมูลส่วนตัว</div>
          <div class="form-row-3">
            <div class="form-group">
              <label>คำนำหน้า</label>
              <select id="title" class="form-control">
                <option value="นาย">นาย</option>
                <option value="นาง">นาง</option>
                <option value="นางสาว">นางสาว</option>
                <option value="ด.ช.">ด.ช.</option>
                <option value="ด.ญ.">ด.ญ.</option>
                <option value="ไม่ระบุ">ไม่ระบุ</option>
              </select>
            </div>
            <div class="form-group">
              <label>ชื่อ <span style="color:#c53030">*</span></label>
              <input type="text" id="firstName" class="form-control" placeholder="ชื่อจริง" required>
            </div>
            <div class="form-group">
              <label>นามสกุล <span style="color:#c53030">*</span></label>
              <input type="text" id="lastName" class="form-control" placeholder="นามสกุล" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>ชื่อเล่น <span style="color:#c53030">*</span></label>
              <input type="text" id="nickname" class="form-control" placeholder="ชื่อเล่น" required>
              <small style="color:var(--premium-text-muted)">ชื่อที่แสดงในระบบ</small>
            </div>
            <div class="form-group">
              <label>ตำแหน่ง / เครื่องดนตรี</label>
              <select id="instrument" class="form-control">
                <option value="">-- เลือก --</option>
                <option value="ร้องนำ">🎤 ร้องนำ</option>
                <option value="ร้องประสาน">🎤 ร้องประสาน</option>
                <option value="กีตาร์ไฟฟ้า">🎸 กีตาร์ไฟฟ้า</option>
                <option value="กีตาร์โปร่ง">🎸 กีตาร์โปร่ง</option>
                <option value="กีตาร์เบส">🎸 กีตาร์เบส</option>
                <option value="คีย์บอร์ด">🎹 คีย์บอร์ด</option>
                <option value="กลอง">🥁 กลอง</option>
                <option value="เพอร์คัสชัน">🥁 เพอร์คัสชัน</option>
                <option value="ทรัมเปต">🎺 ทรัมเปต</option>
                <option value="แซกโซโฟน">🎷 แซกโซโฟน</option>
                <option value="ไวโอลิน">🎻 ไวโอลิน</option>
                <option value="ผู้จัดการวง">📋 ผู้จัดการวง</option>
                <option value="อื่นๆ">อื่นๆ</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>เบอร์โทรศัพท์</label>
              <input type="tel" id="phone" class="form-control" placeholder="0xx-xxx-xxxx">
            </div>
          </div>

          <!-- ช่องทางรับเงิน -->
          <div class="form-section-label">💳 ช่องทางรับเงิน</div>
          <div class="form-row">
            <div class="form-group">
              <label>ช่องทาง</label>
              <select id="paymentMethod" class="form-control">
                <option value="">-- เลือก --</option>
                <option value="promptpay">พร้อมเพย์</option>
                <option value="truemoney">ทรูมันนี่</option>
                <option value="bank_kbank">🟢 ธ.กสิกรไทย</option>
                <option value="bank_scb">🟣 ธ.ไทยพาณิชย์</option>
                <option value="bank_bbl">🔵 ธ.กรุงเทพ</option>
                <option value="bank_ktb">🔵 ธ.กรุงไทย</option>
                <option value="bank_bay">🟡 ธ.กรุงศรี</option>
                <option value="bank_ttb">🟠 ธ.ทหารไทยธนชาต</option>
                <option value="bank_gsb">🏦 ธ.ออมสิน</option>
                <option value="bank_other">🏦 ธนาคารอื่นๆ</option>
              </select>
            </div>
            <div class="form-group">
              <label>เลขบัญชี / เบอร์โทร</label>
              <input type="text" id="paymentAccount" class="form-control" placeholder="เลขบัญชี หรือ เบอร์พร้อมเพย์">
            </div>
          </div>

          <!-- ข้อมูลตามบัตรประชาชน -->
          <div class="form-section-label">🪪 ข้อมูลตามบัตรประชาชน</div>
          <div class="form-row">
            <div class="form-group">
              <label>วันเกิด</label>
              <input type="date" id="birthDate" class="form-control">
            </div>
          </div>

          <div class="form-section-label">📍 ที่อยู่ตามบัตรประชาชน</div>
          <div class="form-row">
            <div class="form-group">
              <label>เลขที่บ้าน</label>
              <input type="text" id="idAddr_houseNo" class="form-control" placeholder="เช่น 123/45">
            </div>
            <div class="form-group">
              <label>หมู่ที่</label>
              <input type="text" id="idAddr_moo" class="form-control" placeholder="เช่น 5">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ซอย</label>
              <input type="text" id="idAddr_soi" class="form-control" placeholder="ซอย">
            </div>
            <div class="form-group">
              <label>ถนน</label>
              <input type="text" id="idAddr_road" class="form-control" placeholder="ถนน">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ตำบล/แขวง</label>
              <input type="text" id="idAddr_subDistrict" class="form-control" placeholder="ตำบล/แขวง">
            </div>
            <div class="form-group">
              <label>อำเภอ/เขต</label>
              <input type="text" id="idAddr_district" class="form-control" placeholder="อำเภอ/เขต">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>จังหวัด</label>
              <input type="text" id="idAddr_province" class="form-control" placeholder="จังหวัด">
            </div>
            <div class="form-group">
              <label>รหัสไปรษณีย์</label>
              <input type="text" id="idAddr_postalCode" class="form-control" placeholder="เช่น 10110" maxlength="5">
            </div>
          </div>

          <div class="form-section-label">🏠 ที่อยู่ปัจจุบัน</div>
          <div style="margin-bottom:var(--spacing-md)">
            <label style="display:inline-flex;align-items:center;gap:6px;font-size:var(--text-sm);cursor:pointer">
              <input type="checkbox" id="sameAsIdAddr" onchange="copySameAddress()"> ใช้ที่อยู่เดียวกับบัตรประชาชน
            </label>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>เลขที่บ้าน</label>
              <input type="text" id="curAddr_houseNo" class="form-control" placeholder="เช่น 123/45">
            </div>
            <div class="form-group">
              <label>หมู่ที่</label>
              <input type="text" id="curAddr_moo" class="form-control" placeholder="เช่น 5">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ซอย</label>
              <input type="text" id="curAddr_soi" class="form-control" placeholder="ซอย">
            </div>
            <div class="form-group">
              <label>ถนน</label>
              <input type="text" id="curAddr_road" class="form-control" placeholder="ถนน">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ตำบล/แขวง</label>
              <input type="text" id="curAddr_subDistrict" class="form-control" placeholder="ตำบล/แขวง">
            </div>
            <div class="form-group">
              <label>อำเภอ/เขต</label>
              <input type="text" id="curAddr_district" class="form-control" placeholder="อำเภอ/เขต">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>จังหวัด</label>
              <input type="text" id="curAddr_province" class="form-control" placeholder="จังหวัด">
            </div>
            <div class="form-group">
              <label>รหัสไปรษณีย์</label>
              <input type="text" id="curAddr_postalCode" class="form-control" placeholder="เช่น 10110" maxlength="5">
            </div>
          </div>

          <!-- ข้อมูลบัญชี read-only -->
          <div class="form-section-label">ข้อมูลบัญชี</div>
          <div class="form-row">
            <div class="form-group">
              <label>อีเมล</label>
              <div class="info-readonly" id="profileEmail">—</div>
            </div>
            <div class="form-group">
              <label>วง</label>
              <div class="info-readonly" id="profileBand">—</div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>บทบาท</label>
              <div class="info-readonly" id="profileRole">—</div>
            </div>
            <div class="form-group">
              <label>สถานะ</label>
              <div class="info-readonly" id="profileStatus">—</div>
            </div>
          </div>

          <div style="margin-top:var(--spacing-xl);display:flex;gap:var(--spacing-md);flex-wrap:wrap">
            <button type="submit" class="btn btn-primary" id="saveBtn">💾 บันทึกข้อมูล</button>
            <button type="button" class="btn btn-secondary" onclick="history.back()">ยกเลิก</button>
          </div>
        </form>
      </div>

      <!-- เปลี่ยนอีเมล -->
      <div class="section-card">
        <h3>📧 เปลี่ยนอีเมล</h3>
        <p style="font-size:var(--text-sm);color:var(--premium-text-muted);margin-bottom:var(--spacing-md)">
          ระบบจะส่งลิงก์ยืนยันไปยังอีเมลใหม่ เมื่อกดยืนยันแล้วอีเมลจะเปลี่ยนทันที
        </p>
        <div class="change-row">
          <div class="form-group">
            <label>อีเมลใหม่</label>
            <input type="email" id="newEmail" class="form-control" placeholder="new@example.com">
          </div>
          <div>
            <button type="button" class="btn btn-primary" id="changeEmailBtn" onclick="doChangeEmail()">📧 เปลี่ยนอีเมล</button>
          </div>
        </div>
        <div id="emailMsg" class="msg-box"></div>
      </div>

      <!-- เปลี่ยนรหัสผ่าน -->
      <div class="section-card">
        <h3>🔑 เปลี่ยนรหัสผ่าน</h3>
        <div class="form-row">
          <div class="form-group">
            <label>รหัสผ่านใหม่</label>
            <input type="password" id="newPassword" class="form-control" placeholder="อย่างน้อย 6 ตัวอักษร" minlength="6">
          </div>
          <div class="form-group">
            <label>ยืนยันรหัสผ่านใหม่</label>
            <input type="password" id="confirmPassword" class="form-control" placeholder="พิมพ์อีกครั้ง" minlength="6">
          </div>
        </div>
        <div style="margin-top:var(--spacing-md)">
          <button type="button" class="btn btn-primary" id="changePwdBtn" onclick="doChangePassword()">🔑 เปลี่ยนรหัสผ่าน</button>
        </div>
        <div id="pwdMsg" class="msg-box"></div>
      </div>

    </div>
  </main>

  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script>
  var instrumentIcons = {
    'ร้องนำ': '🎤', 'ร้องประสาน': '🎤',
    'กีตาร์ไฟฟ้า': '🎸', 'กีตาร์โปร่ง': '🎸', 'กีตาร์เบส': '🎸',
    'คีย์บอร์ด': '🎹', 'กลอง': '🥁', 'เพอร์คัสชัน': '🥁',
    'ทรัมเปต': '🎺', 'แซกโซโฟน': '🎷', 'ไวโอลิน': '🎻',
    'ผู้จัดการวง': '📋'
  };
  var roleLabels = { admin: '🔧 แอดมิน', manager: '👔 ผู้จัดการวง', member: '🎸 สมาชิก' };

  function $el(id) { return document.getElementById(id); }
  function setVal(id, val) { var el = $el(id); if (el) el.value = val || ''; }
  function setTxt(id, val) { var el = $el(id); if (el) el.textContent = val || '—'; }

  function renderDisplay(p) {
    var title     = p.title      || '';
    var firstName = p.firstName  || p.first_name || '';
    var lastName  = p.lastName   || p.last_name  || '';
    var nickname  = p.nickname   || '';
    var inst      = p.instrument || '';
    var fullName  = [title !== 'ไม่ระบุ' ? title : '', firstName, lastName].filter(Boolean).join(' ') || nickname || '—';
    $el('displayFullName').textContent   = fullName;
    $el('displayNickname').textContent   = nickname ? '(' + nickname + ')' : '';
    $el('displayInstrument').textContent = inst;
    $el('avatarIcon').textContent = instrumentIcons[inst] || '🎤';
  }

  var addrFields = ['houseNo','moo','soi','road','subDistrict','district','province','postalCode'];
  function getAddrObj(prefix) {
    var obj = {};
    addrFields.forEach(function(f) { obj[f] = ($el(prefix + f) ? $el(prefix + f).value.trim() : ''); });
    return obj;
  }
  function copySameAddress() {
    if ($el('sameAsIdAddr').checked) {
      addrFields.forEach(function(f) { setVal('curAddr_' + f, $el('idAddr_' + f) ? $el('idAddr_' + f).value : ''); });
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (typeof requireAuth === 'function') requireAuth();
    renderMainNav('mainNav');

    // ── โหลดข้อมูล ──
    function loadProfile() {
      apiCall('getMyProfile', {}, function(r) {
        if (!r || !r.success) return;
        var p = r.data || {};
        setVal('title',        p.title      || 'นาย');
        setVal('firstName',    p.firstName  || p.first_name || '');
        setVal('lastName',     p.lastName   || p.last_name  || '');
        setVal('nickname',     p.nickname   || '');
        setVal('instrument',   p.instrument || '');
        setVal('phone',        p.phone      || '');
        setVal('birthDate',    p.birthDate  || p.birth_date || '');
        setVal('paymentMethod',  p.paymentMethod  || p.payment_method || '');
        setVal('paymentAccount', p.paymentAccount || p.payment_account || '');
        // ที่อยู่ตามบัตรประชาชน (JSON)
        var idAddr = p.idCardAddress || p.id_card_address || {};
        if (typeof idAddr === 'string') try { idAddr = JSON.parse(idAddr); } catch(e) { idAddr = {}; }
        setVal('idAddr_houseNo',     idAddr.houseNo || '');
        setVal('idAddr_moo',         idAddr.moo || '');
        setVal('idAddr_soi',         idAddr.soi || '');
        setVal('idAddr_road',        idAddr.road || '');
        setVal('idAddr_subDistrict', idAddr.subDistrict || '');
        setVal('idAddr_district',    idAddr.district || '');
        setVal('idAddr_province',    idAddr.province || '');
        setVal('idAddr_postalCode',  idAddr.postalCode || '');
        // ที่อยู่ปัจจุบัน (JSON)
        var curAddr = p.currentAddress || p.current_address || {};
        if (typeof curAddr === 'string') try { curAddr = JSON.parse(curAddr); } catch(e) { curAddr = {}; }
        setVal('curAddr_houseNo',     curAddr.houseNo || '');
        setVal('curAddr_moo',         curAddr.moo || '');
        setVal('curAddr_soi',         curAddr.soi || '');
        setVal('curAddr_road',        curAddr.road || '');
        setVal('curAddr_subDistrict', curAddr.subDistrict || '');
        setVal('curAddr_district',    curAddr.district || '');
        setVal('curAddr_province',    curAddr.province || '');
        setVal('curAddr_postalCode',  curAddr.postalCode || '');
        setTxt('profileEmail',  p.email    || '—');
        setTxt('profileBand',   p.bandName || p.band_name || '—');
        setTxt('profileRole',   roleLabels[p.role] || p.role || '—');
        setTxt('profileStatus', p.status === 'active' ? '✅ ใช้งาน' : p.status || '—');
        renderDisplay(p);
      });
    }
    loadProfile();

    // ── บันทึกข้อมูลส่วนตัว ──
    $el('profileForm').addEventListener('submit', function(e) {
      e.preventDefault();
      var firstName = $el('firstName').value.trim();
      var lastName  = $el('lastName').value.trim();
      var nickname  = $el('nickname').value.trim();
      if (!firstName || !lastName || !nickname) {
        if (typeof showToast === 'function') showToast('กรุณากรอกชื่อ นามสกุล และชื่อเล่น', 'error');
        return;
      }
      var btn = $el('saveBtn');
      btn.disabled = true; btn.textContent = 'กำลังบันทึก...';

      apiCall('updateMyProfile', {
        title:         $el('title').value,
        firstName:     firstName,
        lastName:      lastName,
        nickname:      nickname,
        instrument:    $el('instrument').value,
        phone:         ($el('phone') ? $el('phone').value.trim() : ''),
        birthDate:     $el('birthDate').value || '',
        paymentMethod:  $el('paymentMethod')  ? $el('paymentMethod').value  : '',
        paymentAccount: $el('paymentAccount') ? $el('paymentAccount').value.trim() : '',
        idCardAddress: getAddrObj('idAddr_'),
        currentAddress: getAddrObj('curAddr_')
      }, function(r) {
        btn.disabled = false; btn.textContent = '💾 บันทึกข้อมูล';
        if (r && r.success) {
          if (typeof showToast === 'function') showToast(r.message || 'บันทึกเรียบร้อย', 'success');
          renderDisplay({
            title:      $el('title').value,
            firstName:  firstName,
            lastName:   lastName,
            nickname:   nickname,
            instrument: $el('instrument').value
          });
          setTimeout(function() { renderMainNav('mainNav'); }, 300);
        } else {
          if (typeof showToast === 'function') showToast((r && r.message) || 'เกิดข้อผิดพลาด', 'error');
        }
      });
    });
  });

  // ── เปลี่ยนอีเมล ──
  function doChangeEmail() {
    var newEmail = ($el('newEmail').value || '').trim();
    var msgEl = $el('emailMsg');
    msgEl.className = 'msg-box'; msgEl.textContent = '';

    if (!newEmail || !newEmail.includes('@')) {
      msgEl.className = 'msg-box error'; msgEl.textContent = 'กรุณากรอกอีเมลให้ถูกต้อง';
      return;
    }
    var btn = $el('changeEmailBtn');
    btn.disabled = true; btn.textContent = 'กำลังดำเนินการ...';

    apiCall('changeEmail', { email: newEmail }, function(r) {
      btn.disabled = false; btn.textContent = '📧 เปลี่ยนอีเมล';
      if (r && r.success) {
        msgEl.className = 'msg-box success';
        msgEl.textContent = r.message || 'ส่งลิงก์ยืนยันไปยังอีเมลใหม่แล้ว กรุณาตรวจสอบกล่องจดหมาย';
        $el('newEmail').value = '';
      } else {
        msgEl.className = 'msg-box error';
        msgEl.textContent = (r && r.message) || 'เปลี่ยนอีเมลไม่สำเร็จ';
      }
    });
  }

  // ── เปลี่ยนรหัสผ่าน ──
  function doChangePassword() {
    var newPwd = ($el('newPassword').value || '');
    var confirmPwd = ($el('confirmPassword').value || '');
    var msgEl = $el('pwdMsg');
    msgEl.className = 'msg-box'; msgEl.textContent = '';

    if (newPwd.length < 6) {
      msgEl.className = 'msg-box error'; msgEl.textContent = 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร';
      return;
    }
    if (newPwd !== confirmPwd) {
      msgEl.className = 'msg-box error'; msgEl.textContent = 'รหัสผ่านไม่ตรงกัน กรุณาตรวจสอบ';
      return;
    }

    var btn = $el('changePwdBtn');
    btn.disabled = true; btn.textContent = 'กำลังดำเนินการ...';

    apiCall('changePassword', { password: newPwd }, function(r) {
      btn.disabled = false; btn.textContent = '🔑 เปลี่ยนรหัสผ่าน';
      if (r && r.success) {
        msgEl.className = 'msg-box success';
        msgEl.textContent = r.message || 'เปลี่ยนรหัสผ่านเรียบร้อยแล้ว';
        $el('newPassword').value = '';
        $el('confirmPassword').value = '';
      } else {
        msgEl.className = 'msg-box error';
        msgEl.textContent = (r && r.message) || 'เปลี่ยนรหัสผ่านไม่สำเร็จ';
      }
    });
  }
  </script>
</body>
</html>
