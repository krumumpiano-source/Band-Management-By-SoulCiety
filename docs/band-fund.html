<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>กองกลาง — Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <style>
    .fund-balance{background:linear-gradient(135deg,#2d3748,#4a5568);color:#fff;border-radius:var(--radius-xl);padding:var(--spacing-2xl);text-align:center;margin-bottom:var(--spacing-xl)}
    .fund-balance h2{font-size:3rem;font-weight:700;color:var(--premium-gold);margin:0}
    .fund-balance p{color:#cbd5e0;margin-top:8px}
    .tx-type-income{color:#276749;font-weight:600}
    .tx-type-expense{color:#c53030;font-weight:600}
    .fund-form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:var(--spacing-md)}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <div id="confirmModal"></div>
  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title" data-i18n="nav_fund">กองกลางวง</h1>
        <button class="btn btn-secondary" onclick="window.print()">🖨️ <span data-i18n="print">พิมพ์</span></button>
      </div>

      <div class="fund-balance">
        <p>ยอดคงเหลือปัจจุบัน</p>
        <h2 id="fundBalance">฿ 0</h2>
        <p id="fundUpdated"></p>
      </div>

      <!-- Add Transaction -->
      <div class="card" style="margin-bottom:var(--spacing-xl)">
        <div class="card-header"><h3 class="card-title">เพิ่มรายการ</h3></div>
        <form id="fundForm">
          <div class="fund-form-row">
            <div class="form-group"><label>ประเภท</label>
              <select id="txType">
                <option value="income">รายรับ</option>
                <option value="expense">รายจ่าย</option>
              </select>
            </div>
            <div class="form-group"><label>จำนวน (บาท) *</label><input type="number" id="txAmount" min="0" required></div>
            <div class="form-group"><label>วันที่</label><input type="date" id="txDate"></div>
            <div class="form-group"><label>หมวดหมู่</label>
              <select id="txCategory">
                <option value="กองกลาง">กองกลาง</option>
                <option value="ค่าซ้อม">ค่าซ้อม</option>
                <option value="อุปกรณ์">อุปกรณ์</option>
                <option value="ค่าเดินทาง">ค่าเดินทาง</option>
                <option value="อื่นๆ">อื่นๆ</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label>รายละเอียด *</label><input type="text" id="txDesc" required></div>
          <div style="display:flex;justify-content:flex-end">
            <button type="submit" class="btn btn-primary" id="saveTxBtn" data-i18n="save">บันทึก</button>
          </div>
        </form>
      </div>

      <!-- History -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ประวัติรายการ</h3>
          <div style="display:flex;gap:var(--spacing-sm)">
            <select id="txFilter" onchange="filterTx()">
              <option value="">ทั้งหมด</option>
              <option value="income">รายรับ</option>
              <option value="expense">รายจ่าย</option>
            </select>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table">
            <thead><tr><th>วันที่</th><th>ประเภท</th><th>หมวดหมู่</th><th>รายละเอียด</th><th>จำนวน</th><th></th></tr></thead>
            <tbody id="txBody"><tr><td colspan="6" class="text-center">กำลังโหลด...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script>
  var allTx = [];
  document.addEventListener('DOMContentLoaded', function() {
    requireAuth(); renderMainNav('mainNav'); applyTranslations();
    document.getElementById('txDate').value = new Date().toISOString().substring(0,10);
    loadFund();
  });

  function loadFund() {
    gasRun('getFundTransactions', {}, function(r) {
      allTx = (r && r.data && r.data.transactions) || [];
      var balance = (r && r.data && r.data.balance) || 0;
      document.getElementById('fundBalance').textContent = formatCurrency(balance);
      document.getElementById('fundUpdated').textContent = 'อัปเดตล่าสุด: ' + formatDate(new Date().toISOString());
      filterTx();
    });
  }

  function filterTx() {
    var filter = document.getElementById('txFilter').value;
    var rows = filter ? allTx.filter(function(t){return t.type===filter;}) : allTx;
    rows.sort(function(a,b){return new Date(b.date)-new Date(a.date);});
    var tbody = document.getElementById('txBody');
    if (!rows.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center">'+t('noData')+'</td></tr>'; return; }
    tbody.innerHTML = rows.map(function(tx) {
      var typeClass = tx.type === 'income' ? 'tx-type-income' : 'tx-type-expense';
      var sign = tx.type === 'income' ? '+' : '-';
      return '<tr>'
        +'<td>'+formatDate(tx.date)+'</td>'
        +'<td><span class="'+typeClass+'">'+(tx.type==='income'?'รายรับ':'รายจ่าย')+'</span></td>'
        +'<td>'+escapeHtml(tx.category||'')+'</td>'
        +'<td>'+escapeHtml(tx.description||'')+'</td>'
        +'<td class="'+typeClass+'">'+sign+formatCurrency(tx.amount||0)+'</td>'
        +'<td><button class="btn btn-danger btn-sm" onclick="deleteTx(\''+escapeHtml(tx.txId||'')+'\')">🗑️</button></td>'
        +'</tr>';
    }).join('');
  }

  document.getElementById('fundForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var btn = document.getElementById('saveTxBtn'); btn.disabled = true; btn.textContent = t('loading');
    gasRun('addFundTransaction', {
      type: document.getElementById('txType').value,
      amount: document.getElementById('txAmount').value,
      date: document.getElementById('txDate').value,
      category: document.getElementById('txCategory').value,
      description: document.getElementById('txDesc').value.trim()
    }, function(r) {
      btn.disabled = false; btn.textContent = t('save');
      if (r && r.success) { showToast(t('msg_saved'), 'success'); document.getElementById('fundForm').reset(); document.getElementById('txDate').value = new Date().toISOString().substring(0,10); loadFund(); }
      else showToast((r && r.message) || t('msg_error'), 'error');
    });
  });

  function deleteTx(id) {
    showConfirm(t('confirmDeleteTitle'), t('confirmDeleteMsg')).then(function(ok) {
      if (!ok) return;
      gasRun('deleteFundTransaction', { txId: id }, function(r) {
        if (r && r.success) { showToast(t('msg_deleted'), 'success'); loadFund(); }
        else showToast((r && r.message) || t('msg_error'), 'error');
      });
    });
  }
  </script>
</body>
</html>
