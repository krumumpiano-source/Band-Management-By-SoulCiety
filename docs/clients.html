<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ลูกค้า/ผู้จ้าง — Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <style>
    .client-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:var(--spacing-lg)}
    .client-card{background:var(--premium-white);border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);padding:var(--spacing-lg);position:relative;transition:box-shadow .2s}
    .client-card:hover{box-shadow:var(--shadow-md)}
    .client-card h4{margin:0 0 4px;font-size:var(--text-base);font-weight:600}
    .client-card .company{font-size:var(--text-sm);color:var(--premium-text-muted);margin-bottom:var(--spacing-sm)}
    .client-card .contact-info{font-size:var(--text-xs);color:var(--premium-text-light);line-height:1.7}
    .client-stat{display:flex;gap:var(--spacing-md);margin-top:var(--spacing-sm);border-top:1px solid var(--premium-light-gray);padding-top:var(--spacing-sm)}
    .client-stat-item{flex:1;text-align:center}
    .client-stat-item .val{font-size:var(--text-base);font-weight:700;color:var(--premium-gold)}
    .client-stat-item .lbl{font-size:10px;color:var(--premium-text-muted)}
    .card-edit-btn{position:absolute;top:12px;right:12px;opacity:0;transition:opacity .2s}
    .client-card:hover .card-edit-btn{opacity:1}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <div id="confirmModal"></div>

  <!-- Client Modal -->
  <div id="clientModal" class="modal-backdrop" style="display:none">
    <div class="modal" style="max-width:600px">
      <div class="modal-header">
        <h3 class="modal-title" id="clientModalTitle" data-i18n="client_add">เพิ่มลูกค้า</h3>
        <button class="modal-close" onclick="closeClientModal()">×</button>
      </div>
      <form id="clientForm">
        <input type="hidden" id="clientId">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-md)">
          <div class="form-group"><label data-i18n="client_name">ชื่อ-นามสกุล *</label><input type="text" id="cName" required></div>
          <div class="form-group"><label data-i18n="client_company">บริษัท/องค์กร</label><input type="text" id="cCompany"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-md)">
          <div class="form-group"><label data-i18n="client_contact">ผู้ติดต่อ</label><input type="text" id="cContact"></div>
          <div class="form-group"><label data-i18n="phone">เบอร์โทร</label><input type="tel" id="cPhone"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-md)">
          <div class="form-group"><label data-i18n="email">อีเมล</label><input type="email" id="cEmail"></div>
          <div class="form-group"><label data-i18n="client_line">LINE ID</label><input type="text" id="cLine"></div>
        </div>
        <div class="form-group"><label data-i18n="client_address">ที่อยู่</label><textarea id="cAddress" rows="2"></textarea></div>
        <div class="form-group"><label data-i18n="notes">หมายเหตุ</label><textarea id="cNotes" rows="2"></textarea></div>
        <div style="display:flex;justify-content:flex-end;gap:var(--spacing-sm)">
          <button type="button" class="btn btn-secondary" onclick="closeClientModal()" data-i18n="cancel">ยกเลิก</button>
          <button type="button" class="btn btn-danger" id="deleteClientBtn" style="display:none" onclick="deleteCurrentClient()" data-i18n="delete">ลบ</button>
          <button type="submit" class="btn btn-primary" id="saveClientBtn" data-i18n="save">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title" data-i18n="nav_clients">ลูกค้า/ผู้จ้าง</h1>
        <button class="btn btn-primary" onclick="openClientModal(null)">+ <span data-i18n="client_add">เพิ่มลูกค้า</span></button>
      </div>
      <div style="display:flex;gap:var(--spacing-md);margin-bottom:var(--spacing-lg)">
        <input type="text" id="clientSearch" placeholder="ค้นหา ชื่อ / บริษัท..." oninput="filterClients()" style="flex:1">
      </div>
      <div id="clientCards" class="client-cards">
        <div class="empty-state" style="grid-column:1/-1"><p data-i18n="loading">กำลังโหลด...</p></div>
      </div>
    </div>
  </main>

  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script>
  var allClients = [];
  document.addEventListener('DOMContentLoaded', function() {
    requireAuth(); renderMainNav('mainNav'); applyTranslations();
    loadClients();
  });

  function loadClients() {
    gasRun('getAllClients', {}, function(r) {
      allClients = (r && r.success && r.data) ? r.data : [];
      renderClients(allClients);
    });
  }

  function filterClients() {
    var q = document.getElementById('clientSearch').value.toLowerCase();
    renderClients(allClients.filter(function(c) {
      return !q || (c.name||'').toLowerCase().includes(q) || (c.company||'').toLowerCase().includes(q);
    }));
  }

  function renderClients(clients) {
    var container = document.getElementById('clientCards');
    if (!clients.length) { container.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><p>' + t('noData') + '</p></div>'; return; }
    container.innerHTML = clients.map(function(c) {
      return '<div class="client-card">'
        + '<button class="btn btn-ghost btn-sm card-edit-btn" onclick="openClientModal(\'' + escapeHtml(c.clientId||'') + '\')">✏️</button>'
        + '<h4>👤 ' + escapeHtml(c.name||'') + '</h4>'
        + '<div class="company">' + (c.company ? '🏢 '+escapeHtml(c.company) : '') + '</div>'
        + '<div class="contact-info">'
        + (c.phone ? '📞 ' + escapeHtml(c.phone) + '<br>' : '')
        + (c.email ? '✉️ ' + escapeHtml(c.email) + '<br>' : '')
        + (c.lineId ? '💬 ' + escapeHtml(c.lineId) : '')
        + '</div>'
        + '<div class="client-stat">'
        + '<div class="client-stat-item"><div class="val">' + (c.totalGigs||0) + '</div><div class="lbl">งานทั้งหมด</div></div>'
        + '<div class="client-stat-item"><div class="val">' + formatCurrency(c.totalRevenue||0) + '</div><div class="lbl">รายรับรวม</div></div>'
        + '</div>'
        + '</div>';
    }).join('');
  }

  function openClientModal(id) {
    document.getElementById('clientModal').style.display = 'flex';
    document.getElementById('clientForm').reset();
    document.getElementById('clientId').value = '';
    document.getElementById('deleteClientBtn').style.display = 'none';
    document.getElementById('clientModalTitle').textContent = id ? 'แก้ไขลูกค้า' : 'เพิ่มลูกค้า';
    if (id) {
      var c = allClients.find(function(x) { return x.clientId === id; });
      if (c) {
        document.getElementById('clientId').value = c.clientId || '';
        document.getElementById('cName').value = c.name || '';
        document.getElementById('cCompany').value = c.company || '';
        document.getElementById('cContact').value = c.contactPerson || '';
        document.getElementById('cPhone').value = c.phone || '';
        document.getElementById('cEmail').value = c.email || '';
        document.getElementById('cLine').value = c.lineId || '';
        document.getElementById('cAddress').value = c.address || '';
        document.getElementById('cNotes').value = c.notes || '';
        document.getElementById('deleteClientBtn').style.display = 'inline-flex';
      }
    }
  }

  function closeClientModal() { document.getElementById('clientModal').style.display = 'none'; }

  document.getElementById('clientForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var btn = document.getElementById('saveClientBtn'); btn.disabled = true; btn.textContent = t('loading');
    var id = document.getElementById('clientId').value;
    gasRun(id ? 'updateClient' : 'addClient', {
      clientId: id, name: document.getElementById('cName').value.trim(),
      company: document.getElementById('cCompany').value.trim(),
      contactPerson: document.getElementById('cContact').value.trim(),
      phone: document.getElementById('cPhone').value.trim(),
      email: document.getElementById('cEmail').value.trim(),
      lineId: document.getElementById('cLine').value.trim(),
      address: document.getElementById('cAddress').value.trim(),
      notes: document.getElementById('cNotes').value.trim()
    }, function(r) {
      btn.disabled = false; btn.textContent = t('save');
      if (r && r.success) { showToast(t('msg_saved'), 'success'); closeClientModal(); loadClients(); }
      else showToast((r && r.message) || t('msg_error'), 'error');
    });
  });

  function deleteCurrentClient() {
    var id = document.getElementById('clientId').value;
    showConfirm(t('confirmDeleteTitle'), t('confirmDeleteMsg')).then(function(ok) {
      if (!ok) return;
      gasRun('deleteClient', { clientId: id }, function(r) {
        if (r && r.success) { showToast(t('msg_deleted'), 'success'); closeClientModal(); loadClients(); }
        else showToast((r && r.message) || t('msg_error'), 'error');
      });
    });
  }
  </script>
</body>
</html>
