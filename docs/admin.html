<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Admin Panel ‚Äî Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <style>
    .admin-layout{display:grid;grid-template-columns:220px 1fr;gap:var(--spacing-xl)}
    @media(max-width:768px){.admin-layout{grid-template-columns:1fr}}
    .admin-nav{display:flex;flex-direction:column;gap:2px}
    .a-nav-item{padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--radius-md);cursor:pointer;font-size:var(--text-sm);color:var(--premium-text-muted);transition:all .15s}
    .a-nav-item.active,.a-nav-item:hover{background:var(--premium-gold);color:#fff}
    .a-panel{display:none}.a-panel.active{display:block}
    .role-select{font-size:var(--text-sm);padding:4px 8px;border:1px solid var(--premium-light-gray);border-radius:var(--radius-md)}
    .danger-zone{border:2px solid #fc8181;border-radius:var(--radius-lg);padding:var(--spacing-xl)}
    .danger-zone h3{color:#c53030;font-size:var(--text-base);margin-bottom:var(--spacing-md)}
    .system-info-row{display:flex;justify-content:space-between;padding:var(--spacing-xs) 0;border-bottom:1px dashed var(--premium-light-gray);font-size:var(--text-sm)}
    .system-info-row:last-child{border-bottom:none}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <div id="confirmModal"></div>
  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">üîß Admin Panel</h1>
        <span class="badge badge-danger">Admin Only</span>
      </div>
      <div class="admin-layout">
        <div>
          <div class="card">
            <div class="admin-nav">
              <div class="a-nav-item active" onclick="showPanel('users',this)">üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
              <div class="a-nav-item" onclick="showPanel('sysinfo',this)">üìä ‡∏£‡∏∞‡∏ö‡∏ö</div>
              <div class="a-nav-item" onclick="showPanel('backup',this)">üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
              <div class="a-nav-item" onclick="showPanel('danger',this)">‚ö†Ô∏è Danger Zone</div>
            </div>
          </div>
        </div>
        <div>
          <!-- Users Panel -->
          <div class="card a-panel active" id="panel-users">
            <div class="card-header"><h3 class="card-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
              <button class="btn btn-primary btn-sm" onclick="loadUsers()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            <div class="table-responsive">
              <table class="table">
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th>‡∏ß‡∏á</th><th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th><th>Role</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th></th></tr></thead>
                <tbody id="userTbody"><tr><td colspan="8" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- System Info Panel -->
          <div class="card a-panel" id="panel-sysinfo">
            <div class="card-header"><h3 class="card-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3></div>
            <div id="sysInfoContent">
              <div class="system-info-row"><span>‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô</span><span>1.0.0</span></div>
              <div class="system-info-row"><span>Platform</span><span>Google Apps Script (V8)</span></div>
              <div class="system-info-row"><span>Database</span><span>Google Sheets</span></div>
              <div class="system-info-row"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Sheets</span><span id="sheetCount">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span></div>
              <div class="system-info-row"><span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span><span id="userCount">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span></div>
              <div class="system-info-row"><span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</span><span id="jobCount">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span></div>
              <div class="system-info-row"><span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏•‡∏á</span><span id="songCount">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span></div>
              <div class="system-info-row"><span>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</span><span id="serverTime">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span></div>
            </div>
            <div style="margin-top:var(--spacing-lg)">
              <button class="btn btn-secondary" onclick="loadSysInfo()">üîÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
          </div>

          <!-- Backup Panel -->
          <div class="card a-panel" id="panel-backup">
            <div class="card-header"><h3 class="card-title">‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3></div>
            <p style="color:var(--premium-text-muted);font-size:var(--text-sm);margin-bottom:var(--spacing-xl)">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Google Sheets ‡πÄ‡∏™‡∏°‡∏≠ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Spreadsheet ‡πÄ‡∏õ‡πá‡∏ô .xlsx ‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤</p>
            <div style="display:flex;flex-direction:column;gap:var(--spacing-md)">
              <button class="btn btn-primary" onclick="triggerBackup()">üì• ‡∏™‡∏£‡πâ‡∏≤‡∏á Backup (Export JSON ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Drive)</button>
              <button class="btn btn-secondary" onclick="openSpreadsheet()">üìä ‡πÄ‡∏õ‡∏¥‡∏î Spreadsheet ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</button>
              <button class="btn btn-secondary" onclick="runSetup()">üîß ‡∏£‡∏±‡∏ô Setup (‡∏™‡∏£‡πâ‡∏≤‡∏á Sheets ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)</button>
            </div>
          </div>

          <!-- Danger Zone Panel -->
          <div class="card a-panel" id="panel-danger">
            <div class="card-header"><h3 class="card-title" style="color:#c53030">‚ö†Ô∏è Danger Zone</h3></div>
            <div class="danger-zone">
              <h3>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
              <p style="font-size:var(--text-sm);color:var(--premium-text-muted);margin-bottom:var(--spacing-md)">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Sheets</p>
              <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            <div class="danger-zone" style="margin-top:var(--spacing-lg)">
              <h3>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
              <p style="font-size:var(--text-sm);color:var(--premium-text-muted);margin-bottom:var(--spacing-md)">‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
              <button class="btn btn-danger" onclick="resetUsers()">üîê ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    requireAuth();
    var role = localStorage.getItem('userRole') || '';
    if (role !== 'admin') { showToast('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ', 'error'); setTimeout(function(){ window.location.href='dashboard.html'; },1500); return; }
    renderMainNav('mainNav'); applyTranslations();
    loadUsers(); loadSysInfo();
  });

  function showPanel(id, el) {
    document.querySelectorAll('.a-panel').forEach(function(p){p.classList.remove('active');});
    document.getElementById('panel-'+id).classList.add('active');
    document.querySelectorAll('.a-nav-item').forEach(function(n){n.classList.remove('active');});
    el.classList.add('active');
  }

  function loadUsers() {
    gasRun('getAllUsers', {}, function(r) {
      var users = (r && r.data) || [];
      var tbody = document.getElementById('userTbody');
      if (!users.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; return; }
      tbody.innerHTML = users.map(function(u) {
        var title     = u.title     || '';
        var firstName = u.firstName || u.first_name || '';
        var lastName  = u.lastName  || u.last_name  || '';
        var nickname  = u.nickname  || u.userName   || '';
        var fullName  = [title !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' ? title : '', firstName, lastName].filter(Boolean).join(' ') || nickname || '‚Äî';
        var userId    = u.id || '';
        return '<tr>'
          +'<td>'+escapeHtml(fullName)+'</td>'
          +'<td>'+escapeHtml(nickname)+'</td>'
          +'<td>'+escapeHtml(u.email||'')+'</td>'
          +'<td>'+escapeHtml(u.bandName||u.band_name||'‚Äî')+'</td>'
          +'<td><span style="font-size:var(--text-xs)">'+escapeHtml(u.instrument||'‚Äî')+'</span></td>'
          +'<td><select class="role-select" onchange="updateUserRole(\''+escapeHtml(userId)+'\',this.value)">'
          +'<option value="member"'+(u.role==='member'?' selected':'')+'>member</option>'
          +'<option value="manager"'+(u.role==='manager'?' selected':'')+'>manager</option>'
          +'<option value="admin"'+(u.role==='admin'?' selected':'')+'>admin</option>'
          +'</select></td>'
          +'<td><span class="badge '+(u.status==='active'?'badge-success':'badge-danger')+'">'+(u.status==='active'?'‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô':u.status||'‚Äî')+'</span></td>'
          +'<td><button class="btn btn-danger btn-sm" onclick="deleteUser(\''+escapeHtml(userId)+'\')">üóëÔ∏è</button></td>'
          +'</tr>';
      }).join('');
    });
  }

  function updateUserRole(id, role) {
    gasRun('updateUserRole', { userId: id, role: role }, function(r) {
      if (r && r.success) showToast(t('msg_saved'), 'success');
      else showToast((r && r.message) || t('msg_error'), 'error');
    });
  }

  function deleteUser(id) {
    showConfirm('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô?', '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?').then(function(ok) {
      if (!ok) return;
      gasRun('deleteUser', { userId: id }, function(r) {
        if (r && r.success) { showToast(t('msg_deleted'), 'success'); loadUsers(); }
        else showToast((r && r.message) || t('msg_error'), 'error');
      });
    });
  }

  function loadSysInfo() {
    gasRun('getSystemInfo', {}, function(r) {
      if (r && r.data) {
        var d = r.data;
        document.getElementById('sheetCount').textContent = d.sheetCount || '‚Äî';
        document.getElementById('userCount').textContent = d.userCount || '‚Äî';
        document.getElementById('jobCount').textContent = d.jobCount || '‚Äî';
        document.getElementById('songCount').textContent = d.songCount || '‚Äî';
        document.getElementById('serverTime').textContent = d.serverTime || new Date().toLocaleString('th-TH');
      }
    });
  }

  function triggerBackup() {
    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Backup...', 'info');
    gasRun('createBackup', {}, function(r) {
      if (r && r.success) showToast('Backup ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (r.url || ''), 'success');
      else showToast((r && r.message) || t('msg_error'), 'error');
    });
  }

  function openSpreadsheet() {
    gasRun('getSpreadsheetUrl', {}, function(r) {
      if (r && r.url) window.open(r.url, '_blank');
      else showToast(t('msg_error'), 'error');
    });
  }

  function runSetup() {
    showConfirm('‡∏£‡∏±‡∏ô Setup', '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Sheets ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠?').then(function(ok) {
      if (!ok) return;
      gasRun('runSetupFromAdmin', {}, function(r) {
        if (r && r.success) showToast('Setup ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        else showToast((r && r.message) || t('msg_error'), 'error');
      });
    });
  }

  function clearAllData() {
    showConfirm('‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å Sheet ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Users ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à?').then(function(ok) {
      if (!ok) return;
      gasRun('clearAllData', {}, function(r) {
        if (r && r.success) showToast('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        else showToast((r && r.message) || t('msg_error'), 'error');
      });
    });
  }

  function resetUsers() {
    showConfirm('‚ö†Ô∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à?').then(function(ok) {
      if (!ok) return;
      gasRun('resetUsers', {}, function(r) {
        if (r && r.success) { showToast('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà', 'success'); setTimeout(function(){ window.location.href='?page=index'; },2000); }
        else showToast((r && r.message) || t('msg_error'), 'error');
      });
    });
  }
  </script>
</body>
</html>
