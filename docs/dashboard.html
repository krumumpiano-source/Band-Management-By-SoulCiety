<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Dashboard ‚Äî Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <style>
    .stat-icon{width:52px;height:52px;border-radius:var(--radius-full);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
    .stat-icon.gold{background:#fef3c7}.stat-icon.blue{background:#dbeafe}.stat-icon.green{background:#d1fae5}.stat-icon.purple{background:#ede9fe}
    .stat-body h3{font-size:var(--text-2xl);font-weight:700;color:var(--premium-text)}.stat-body p{font-size:var(--text-sm);color:var(--premium-text-light)}
    .dash-row{display:grid;grid-template-columns:2fr 1fr;gap:var(--spacing-xl)}
    @media(max-width:900px){.dash-row{grid-template-columns:1fr}}
    .quick-actions{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--spacing-sm)}
    .quick-btn{padding:var(--spacing-md) var(--spacing-sm);border-radius:var(--radius-md);background:var(--premium-light-gray);border:none;cursor:pointer;text-align:center;font-size:var(--text-sm);font-family:var(--font-family-body);color:var(--premium-text);transition:background .2s,transform .1s;min-height:60px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;line-height:1.3}
    .quick-btn:hover{background:var(--premium-gold);color:#fff;transform:translateY(-1px)}
    .job-item{display:flex;align-items:center;gap:var(--spacing-md);padding:var(--spacing-md) 0;border-bottom:1px solid var(--premium-light-gray)}
    .job-item:last-child{border-bottom:none}
    .job-date-box{width:48px;text-align:center;background:var(--premium-off-white);border-radius:var(--radius-md);padding:6px;flex-shrink:0}
    .job-date-box .dd{font-size:var(--text-xl);font-weight:700;color:var(--premium-gold);line-height:1}
    .job-date-box .mm{font-size:10px;color:var(--premium-text-muted);text-transform:uppercase}
    .job-info h4{font-size:var(--text-sm);font-weight:600;margin:0}
    .job-info p{font-size:var(--text-xs);color:var(--premium-text-muted);margin:2px 0 0}
    .finance-row{display:flex;justify-content:space-between;padding:var(--spacing-sm) 0;border-bottom:1px solid var(--premium-light-gray);font-size:var(--text-sm)}
    .finance-row:last-child{border-bottom:none}
    .finance-row .label{color:var(--premium-text-light)}
    .finance-row .val-pos{color:#276749;font-weight:600}
    .finance-row .val-neg{color:#c53030;font-weight:600}
    .welcome-bar{background:linear-gradient(135deg,#2d3748,#4a5568);color:#fff;border-radius:var(--radius-xl);padding:var(--spacing-lg) var(--spacing-xl);margin-bottom:var(--spacing-xl);display:flex;align-items:center;justify-content:space-between}
    .welcome-bar h2{font-size:var(--text-xl);font-weight:700;margin:0}
    .welcome-bar p{font-size:var(--text-sm);color:#cbd5e0;margin:4px 0 0}
    .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--spacing-lg);margin-bottom:var(--spacing-xl)}
    .stat-card{background:var(--premium-white);border-radius:var(--radius-lg);box-shadow:var(--shadow-md);padding:var(--spacing-xl);display:flex;align-items:center;gap:var(--spacing-md)}
    @media(max-width:600px){
      .welcome-bar{padding:var(--spacing-md);border-radius:var(--radius-lg)}
      .welcome-bar>div:last-child{display:none}
      .stat-grid{grid-template-columns:repeat(2,1fr)!important;gap:var(--spacing-sm)!important}
      .stat-card{padding:var(--spacing-md);gap:var(--spacing-sm)}
      .stat-icon{width:40px;height:40px;font-size:18px}
      .stat-body h3{font-size:var(--text-xl)}
      .quick-actions{grid-template-columns:repeat(3,1fr)}
    }
    @media(max-width:380px){.quick-actions{grid-template-columns:repeat(2,1fr)}}
    /* === Quick Check-In === */
    .qci-header{display:flex;align-items:center;gap:12px;margin-bottom:var(--spacing-md)}
    .qci-date-badge{background:linear-gradient(135deg,var(--premium-gold),#b7791f);color:#fff;border-radius:var(--radius-lg);padding:8px 18px;font-size:var(--text-sm);font-weight:600;white-space:nowrap}
    .qci-step{margin-bottom:var(--spacing-md)}
    .qci-step-label{font-size:var(--text-sm);font-weight:600;color:var(--premium-text-light);margin-bottom:8px}
    .qci-btn-group{display:flex;flex-wrap:wrap;gap:8px}
    .qci-venue-btn,.qci-slot-btn{padding:10px 18px;border-radius:var(--radius-full);border:2px solid var(--premium-border);background:#fff;cursor:pointer;font-size:var(--text-sm);font-family:var(--font-family-body);color:var(--premium-text);transition:all .18s;font-weight:500}
    .qci-slot-btn{padding:12px 22px;font-size:var(--text-md)}
    .qci-venue-btn.selected{border-color:var(--premium-gold);background:var(--premium-gold);color:#fff;font-weight:700;transform:translateY(-1px);box-shadow:0 2px 8px rgba(203,162,60,.35)}
    .qci-slot-btn.selected{border-color:#276749;background:#276749;color:#fff;font-weight:700;transform:translateY(-1px);box-shadow:0 2px 8px rgba(39,103,73,.25)}
    .qci-summary{background:linear-gradient(135deg,#f0fff4,#c6f6d5);border:1px solid #9ae6b4;border-radius:var(--radius-lg);padding:var(--spacing-md) var(--spacing-lg);font-size:var(--text-sm);line-height:1.8;display:none}
    .qci-summary.show{display:block}
    .qci-summary strong{color:#065f46}
    .qci-done{background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:1px solid #6ee7b7;border-radius:var(--radius-lg);padding:var(--spacing-lg);text-align:center;display:none}
    .qci-done.show{display:block}
    .qci-done .done-icon{font-size:36px;margin-bottom:8px}
    .qci-done p{margin:4px 0;font-size:var(--text-sm);color:#065f46}
    .qci-done strong{font-size:var(--text-md);color:#064e3b}
    .qci-no-schedule{color:var(--premium-text-muted);font-size:var(--text-sm);font-style:italic;padding:10px 0;display:block}
    .qci-no-work{background:#f7fafc;border:1px dashed var(--premium-border);border-radius:var(--radius-lg);padding:var(--spacing-md) var(--spacing-lg);text-align:center;color:var(--premium-text-muted);font-size:var(--text-sm)}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <main>
    <div class="container">
      <div class="welcome-bar">
        <div>
          <h2>üéµ <span id="welcomeName"></span></h2>
          <p id="welcomeBand"></p>
        </div>
        <div style="font-size:32px">ü•Å</div>
      </div>

      <!-- ===== Quick Daily Check-In ===== -->
      <div class="card" id="qciCard" style="margin-bottom:var(--spacing-xl)">
        <div class="card-header">
          <div class="qci-header">
            <h3 class="card-title" style="margin:0">‚è∞ ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
            <div class="qci-date-badge" id="qciDateBadge"></div>
          </div>
        </div>

        <!-- Already checked-in state -->
        <div class="qci-done" id="qciDone">
          <div class="done-icon">‚úÖ</div>
          <strong id="qciDoneSummary">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß</strong>
          <p id="qciDoneDetail"></p>
          <button class="btn btn-ghost btn-sm" style="margin-top:8px" id="qciEditBtn">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤</button>
        </div>

        <!-- Check-in form -->
        <div id="qciForm">
          <!-- Venue picker (hidden when single venue via JS) -->
          <div class="qci-step" id="qciVenueStep">
            <div class="qci-step-label">üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</div>
            <div class="qci-btn-group" id="qciVenueBtns">
              <span class="qci-no-schedule">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
          </div>

          <!-- Time slots for today (auto-rendered from manager's schedule) -->
          <div class="qci-step" id="qciSlotStep">
            <div class="qci-step-label" id="qciSlotLabel">üïê ‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            <div class="qci-btn-group" id="qciSlotBtns">
              <span class="qci-no-schedule">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
          </div>

          <!-- Summary -->
          <div class="qci-summary" id="qciSummary">
            <strong>üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</strong><br>
            üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <strong id="sumDate"></strong><br>
            üìç ‡∏£‡πâ‡∏≤‡∏ô: <strong id="sumVenue"></strong><br>
            ‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: <strong id="sumSlots"></strong>
          </div>

          <!-- Confirm -->
          <div id="qciConfirmRow" style="display:none;margin-top:var(--spacing-md)">
            <button class="btn btn-primary" id="qciConfirmBtn">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
            <button class="btn btn-ghost" id="qciResetBtn" style="margin-left:8px">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
          </div>
        </div>
      </div>

      <!-- Stat Cards -->
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-icon gold">üé∏</div>
          <div class="stat-body"><h3 id="statMembers">‚Äî</h3><p data-i18n="nav_members">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ß‡∏á</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon blue">üìÖ</div>
          <div class="stat-body"><h3 id="statJobs">‚Äî</h3><p data-i18n="upcomingJobs">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green">üí∞</div>
          <div class="stat-body"><h3 id="statRevenue">‚Äî</h3><p data-i18n="revenueMonth">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon purple">üìÑ</div>
          <div class="stat-body"><h3 id="statQuotations">‚Äî</h3><p data-i18n="nav_quotation">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</p></div>
        </div>
      </div>

      <div class="dash-row">
        <!-- Upcoming Jobs -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title" data-i18n="upcomingJobs">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</h3>
            <a href="?page=schedule" class="btn btn-ghost btn-sm" data-i18n="viewAll">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
          </div>
          <div id="jobList">
            <div class="empty-state"><p data-i18n="noData">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>
          </div>
        </div>

        <!-- Right column -->
        <div>
          <!-- Quick Actions -->
          <div class="card" style="margin-bottom:var(--spacing-xl)">
            <div class="card-header"><h3 class="card-title" data-i18n="quickActions">‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î</h3></div>
            <div class="quick-actions">
              <button class="quick-btn" onclick="nav('schedule')">üìÖ <span data-i18n="nav_schedule">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô</span></button>
              <button class="quick-btn" onclick="nav('attendance-payroll')">üí≥ <span data-i18n="nav_payroll">‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</span></button>
              <button class="quick-btn" onclick="nav('quotation')">üìÉ <span data-i18n="nav_quotation">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</span></button>
              <button class="quick-btn" onclick="nav('band-info')">üéµ <span data-i18n="nav_bandInfo">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏á</span></button>
              <button class="quick-btn" onclick="nav('songs')">üéº <span data-i18n="nav_songs">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏•‡∏á</span></button>
              <button class="quick-btn" onclick="nav('equipment')">üé∏ <span data-i18n="nav_equipment">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</span></button>
            </div>
          </div>
          <!-- Finance Summary -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title" data-i18n="financeThisMonth">‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
              <a href="?page=statistics" class="btn btn-ghost btn-sm" data-i18n="viewAll">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            </div>
            <div id="financeList"><div class="empty-state"><p data-i18n="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script>
  function nav(page) {
    var isGas = typeof google !== 'undefined' && google.script;
    window.location.href = isGas ? '?page=' + page : page + '.html';
  }

  /* ===== Quick Check-In ===== */
  var qciBandId = '', qciBandSettings = { venues: [], scheduleData: {} };
  var qciSelectedVenue = '', qciSelectedSlots = [], qciExistingCheckIn = null;
  var QCI_DAY_NAMES_TH = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå'];

  function qciEsc(s) { var d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }

  function qciLoadSettings(cb) {
    var stored = localStorage.getItem('bandSettings');
    if (stored) { try { var s = JSON.parse(stored); qciBandSettings = { venues: s.venues||[], scheduleData: s.scheduleData||s.schedule||{} }; } catch(e){} }
    if (qciBandSettings.venues.length > 0) { cb(); return; }
    if (qciBandId && typeof gasRun === 'function') {
      gasRun('getBandSettings', { bandId: qciBandId }, function(r) {
        if (r && r.success && r.data) {
          qciBandSettings = { venues: r.data.venues||[], scheduleData: r.data.scheduleData||r.data.schedule||{} };
          try { localStorage.setItem('bandSettings', JSON.stringify(r.data)); } catch(e) {}
        }
        cb();
      });
    } else { cb(); }
  }

  /* Returns slots for today's day-of-week (empty = no schedule) */
  function qciGetSlotsForToday() {
    var dow = new Date().getDay();
    var dayData = qciBandSettings.scheduleData[dow] || qciBandSettings.scheduleData[String(dow)];
    if (dayData && dayData.timeSlots && dayData.timeSlots.length) {
      return dayData.timeSlots.map(function(s) {
        return { key: s.startTime + '-' + s.endTime, label: s.startTime + ' ‚Äì ' + s.endTime };
      });
    }
    return []; /* ‡πÑ‡∏°‡πà‡∏°‡∏µ fallback ‚Äî ‡πÅ‡∏™‡∏î‡∏á "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö" ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î */
  }

  /* Render venue buttons; auto-select + hide if only one venue */
  function qciRenderVenues() {
    var venueStep = document.getElementById('qciVenueStep');
    var container = document.getElementById('qciVenueBtns');
    if (!container) return;
    var venues = (qciBandSettings.venues || []);
    if (!venues.length) venues = [{ name: '‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å' }];

    if (venues.length === 1) {
      /* ‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πà‡∏≠‡∏ô venue step ‡πÄ‡∏•‡∏¢‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
      qciSelectedVenue = venues[0].name || venues[0].venueName || '‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å';
      if (venueStep) venueStep.style.display = 'none';
      qciRenderSlots();
      return;
    }

    if (venueStep) venueStep.style.display = 'block';
    container.innerHTML = venues.map(function(v) {
      var name = v.name || v.venueName || String(v);
      return '<button type="button" class="qci-venue-btn" data-venue="' + qciEsc(name) + '">üìç ' + qciEsc(name) + '</button>';
    }).join('');
    container.querySelectorAll('.qci-venue-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        container.querySelectorAll('.qci-venue-btn').forEach(function(b) { b.classList.remove('selected'); });
        btn.classList.add('selected');
        qciSelectedVenue = btn.dataset.venue;
        qciUpdateSummary();
      });
    });
    /* Auto-select first venue */
    var first = container.querySelector('.qci-venue-btn');
    if (first) first.click();
    qciRenderSlots();
  }

  /* Render time slot buttons from manager's schedule for today */
  function qciRenderSlots() {
    var container = document.getElementById('qciSlotBtns');
    var label = document.getElementById('qciSlotLabel');
    if (!container) return;
    var dow = new Date().getDay();
    if (label) label.textContent = 'üïê ‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô' + QCI_DAY_NAMES_TH[dow] + '‡∏ô‡∏µ‡πâ';
    var slots = qciGetSlotsForToday();
    if (!slots.length) {
      container.innerHTML = '<div class="qci-no-work">üéµ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô' + QCI_DAY_NAMES_TH[dow] + '‡∏ô‡∏µ‡πâ<br><span style="font-size:11px;opacity:.7">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span></div>';
      document.getElementById('qciSummary').classList.remove('show');
      document.getElementById('qciConfirmRow').style.display = 'none';
      return;
    }
    var existingSlots = (qciExistingCheckIn && qciExistingCheckIn.slots) ? qciExistingCheckIn.slots : [];
    container.innerHTML = slots.map(function(s) {
      var pre = existingSlots.indexOf(s.key) !== -1 ? ' selected' : '';
      return '<button type="button" class="qci-slot-btn' + pre + '" data-slot="' + qciEsc(s.key) + '">üïê ' + qciEsc(s.label) + '</button>';
    }).join('');
    if (existingSlots.length) qciSelectedSlots = existingSlots.slice();
    container.querySelectorAll('.qci-slot-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        btn.classList.toggle('selected');
        var slot = btn.dataset.slot;
        if (btn.classList.contains('selected')) {
          if (qciSelectedSlots.indexOf(slot) === -1) qciSelectedSlots.push(slot);
        } else {
          qciSelectedSlots = qciSelectedSlots.filter(function(s) { return s !== slot; });
        }
        qciUpdateSummary();
      });
    });
    qciUpdateSummary();
  }

  function qciUpdateSummary() {
    var summary = document.getElementById('qciSummary');
    var confirmRow = document.getElementById('qciConfirmRow');
    if (!summary || !confirmRow) return;
    if (qciSelectedVenue && qciSelectedSlots.length) {
      var today = new Date();
      var dateStr = today.toLocaleDateString('th-TH', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
      var slotStr = qciSelectedSlots.map(function(k) { var p=k.split('-'); return p[0]+' ‚Äì '+p[1]; }).join(' ¬∑ ');
      document.getElementById('sumDate').textContent = dateStr;
      document.getElementById('sumVenue').textContent = qciSelectedVenue;
      document.getElementById('sumSlots').textContent = slotStr;
      summary.classList.add('show');
      confirmRow.style.display = 'block';
    } else {
      summary.classList.remove('show');
      confirmRow.style.display = 'none';
    }
  }

  function qciShowDone(slots, venue) {
    var done = document.getElementById('qciDone');
    var form = document.getElementById('qciForm');
    var slotStr = (slots||[]).map(function(k){ var p=k.split('-'); return p[0]+' ‚Äì '+p[1]; }).join(' ¬∑ ');
    document.getElementById('qciDoneSummary').textContent = '‚úÖ ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
    document.getElementById('qciDoneDetail').textContent = 'üìç '+venue+' ¬∑ ‚è∞ '+slotStr;
    done.classList.add('show');
    form.style.display = 'none';
  }

  function qciCheckExisting() {
    if (!qciBandId || typeof gasRun !== 'function') return;
    var today = new Date().toISOString().split('T')[0];
    gasRun('getMyCheckIn', { date: today, venue: '', bandId: qciBandId }, function(r) {
      if (r && r.success && r.checkIn) {
        qciExistingCheckIn = r.checkIn;
        var ci = r.checkIn;
        if (ci.status === 'confirmed' || ci.status === 'pending') {
          qciShowDone(ci.slots, ci.venue);
        }
      }
    });
  }

  function qciConfirm() {
    if (!qciSelectedVenue) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô'); return; }
    if (!qciSelectedSlots.length) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏ß‡∏á'); return; }
    var btn = document.getElementById('qciConfirmBtn');
    btn.disabled = true; btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
    var today = new Date().toISOString().split('T')[0];
    gasRun('memberCheckIn', { bandId: qciBandId, date: today, venue: qciSelectedVenue, slots: qciSelectedSlots, notes: '' }, function(r) {
      btn.disabled = false; btn.textContent = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤';
      if (r && r.success) {
        qciShowDone(qciSelectedSlots, qciSelectedVenue);
        showDashToast('‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Äî ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', 'success');
      } else {
        alert((r && r.message) || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
      }
    });
  }

  function qciReset() {
    qciSelectedVenue = ''; qciSelectedSlots = []; qciExistingCheckIn = null;
    document.getElementById('qciDone').classList.remove('show');
    document.getElementById('qciForm').style.display = 'block';
    document.getElementById('qciSummary').classList.remove('show');
    document.getElementById('qciConfirmRow').style.display = 'none';
    document.querySelectorAll('.qci-venue-btn').forEach(function(b) { b.classList.remove('selected'); });
    qciSelectedSlots = [];
    qciRenderVenues();
  }

  function showDashToast(msg, type) {
    var t = document.getElementById('toast');
    if (!t) return;
    t.textContent = msg;
    t.style.background = type === 'success' ? '#276749' : type === 'error' ? '#c53030' : 'var(--premium-gold)';
    t.style.display = 'block'; t.classList.add('show');
    setTimeout(function(){ t.classList.remove('show'); setTimeout(function(){ t.style.display='none'; }, 300); }, 3500);
  }

  document.addEventListener('DOMContentLoaded', function() {
    requireAuth();
    renderMainNav('mainNav');
    applyTranslations();

    var name = localStorage.getItem('userName') || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
    var band = localStorage.getItem('bandName') || '';
    if (!band) {
      try { var bs = JSON.parse(localStorage.getItem('bandSettings') || '{}'); band = bs.bandName || ''; } catch(e) {}
    }
    if (!band) band = '‡∏ß‡∏á‡∏î‡∏ô‡∏ï‡∏£‡∏µ';
    document.getElementById('welcomeName').textContent = '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ' + name;
    document.getElementById('welcomeBand').textContent = 'üéµ ' + band;
    // Refresh band name from server (in case localStorage is stale/empty)
    var _wbBandId = localStorage.getItem('bandId') || '';
    if (_wbBandId) {
      gasRun('getBandSettings', { bandId: _wbBandId }, function(r) {
        if (r && r.success && r.data && r.data.bandName) {
          localStorage.setItem('bandName', r.data.bandName);
          document.getElementById('welcomeBand').textContent = 'üéµ ' + r.data.bandName;
        }
      });
    }

    // Quick Check-In init
    qciBandId = localStorage.getItem('bandId') || '';
    var today = new Date();
    var dateBadge = document.getElementById('qciDateBadge');
    if (dateBadge) dateBadge.textContent = today.toLocaleDateString('th-TH', { weekday:'long', day:'numeric', month:'long', year:'numeric' });

    qciLoadSettings(function() {
      qciRenderVenues(); /* venues ‚Üí auto-selects single venue ‚Üí renders slots */
      qciCheckExisting();
    });

    document.getElementById('qciConfirmBtn').addEventListener('click', qciConfirm);
    document.getElementById('qciResetBtn').addEventListener('click', qciReset);
    document.getElementById('qciEditBtn').addEventListener('click', function() {
      document.getElementById('qciDone').classList.remove('show');
      document.getElementById('qciForm').style.display = 'block';
      if (qciExistingCheckIn && qciExistingCheckIn.venue) {
        qciSelectedVenue = qciExistingCheckIn.venue;
        var vBtn = document.querySelector('.qci-venue-btn[data-venue="'+qciSelectedVenue+'"]');
        if (vBtn) vBtn.classList.add('selected');
        qciRenderSlots();
      }
    });

    loadDashboard();
  });

  function loadDashboard() {
    gasRun('getDashboardSummary', {}, function(r) {
      if (!r || !r.success) return;
      var d = r.data || {};
      document.getElementById('statMembers').textContent = d.memberCount != null ? d.memberCount : '‚Äî';
      document.getElementById('statJobs').textContent = d.upcomingJobs != null ? d.upcomingJobs : '‚Äî';
      document.getElementById('statRevenue').textContent = d.revenueMonth != null ? formatCurrency(d.revenueMonth) : '‚Äî';
      document.getElementById('statQuotations').textContent = d.quotationCount != null ? d.quotationCount : '‚Äî';

      // jobs
      var jl = document.getElementById('jobList');
      if (d.jobs && d.jobs.length) {
        jl.innerHTML = d.jobs.slice(0,5).map(function(j) {
          var dt = new Date(j.date);
          var dd = isNaN(dt) ? '?' : dt.getDate();
          var mm = isNaN(dt) ? '' : dt.toLocaleString('th-TH',{month:'short'});
          return '<div class="job-item"><div class="job-date-box"><div class="dd">'+dd+'</div><div class="mm">'+mm+'</div></div>'
            +'<div class="job-info"><h4>'+escapeHtml(j.venue||'')+'</h4>'
            +'<p>'+escapeHtml(j.band||'')+' ¬∑ '+escapeHtml(j.type||'')+'</p></div></div>';
        }).join('');
      } else { jl.innerHTML = '<div class="empty-state"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</p></div>'; }

      // finance
      var fl = document.getElementById('financeList');
      var fin = d.finance || {};
      fl.innerHTML = [
        ['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', formatCurrency(fin.income||0), 'val-pos'],
        ['‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', formatCurrency(fin.expense||0), 'val-neg'],
        ['‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á', formatCurrency(fin.fund||0), ''],
        ['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', formatCurrency((fin.income||0)-(fin.expense||0)), (fin.income||0)>=(fin.expense||0)?'val-pos':'val-neg'],
      ].map(function(row){
        return '<div class="finance-row"><span class="label">'+row[0]+'</span><span class="'+row[2]+'">'+row[1]+'</span></div>';
      }).join('');
    });
  }
  </script>
</body>
</html>
