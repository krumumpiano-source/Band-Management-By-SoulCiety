<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‚Äî Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <style>
    .stat-overview{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:var(--spacing-lg);margin-bottom:var(--spacing-xl)}
    .stat-ov-card{background:#fff;border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);padding:var(--spacing-xl);text-align:center}
    .stat-ov-card .ico{font-size:32px;margin-bottom:var(--spacing-sm)}
    .stat-ov-card .val{font-size:var(--text-2xl);font-weight:700;color:var(--premium-gold)}
    .stat-ov-card .lbl{font-size:var(--text-xs);color:var(--premium-text-muted);margin-top:4px}
    .bar-wrap{margin-bottom:var(--spacing-xl)}
    .bar-row{display:flex;align-items:center;gap:var(--spacing-md);margin-bottom:var(--spacing-sm)}
    .bar-row .label{width:100px;font-size:var(--text-sm);color:var(--premium-text-muted);text-align:right}
    .bar-track{flex:1;height:18px;background:var(--premium-off-white);border-radius:var(--radius-full);overflow:hidden}
    .bar-fill{height:100%;background:var(--premium-gold);border-radius:var(--radius-full);transition:width .5s}
    .bar-row .bar-val{width:80px;font-size:var(--text-sm);font-weight:600;color:var(--premium-gold)}
    .stats-row{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-xl)}
    @media(max-width:768px){.stats-row{grid-template-columns:1fr}}
    .year-select{display:flex;gap:var(--spacing-md);align-items:center;margin-bottom:var(--spacing-xl);flex-wrap:wrap}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title" data-i18n="nav_statistics">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h1>
        <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è <span data-i18n="print">‡∏û‡∏¥‡∏°‡∏û‡πå</span></button>
      </div>

      <div class="year-select">
        <label data-i18n="year">‡∏õ‡∏µ</label>
        <select id="yearPicker" onchange="loadStats()"></select>
        <label data-i18n="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
        <select id="monthPicker" onchange="loadStats()">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ</option>
          <option value="0">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option><option value="1">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option><option value="2">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
          <option value="3">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option><option value="4">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option><option value="5">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
          <option value="6">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option><option value="7">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option><option value="8">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
          <option value="9">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option><option value="10">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option><option value="11">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
        </select>
      </div>

      <!-- Overview Cards -->
      <div class="stat-overview" id="overviewCards">
        <div class="stat-ov-card"><div class="ico">üìÖ</div><div class="val" id="ovJobs">‚Äî</div><div class="lbl">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
        <div class="stat-ov-card"><div class="ico">üí∞</div><div class="val" id="ovIncome">‚Äî</div><div class="lbl">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°</div></div>
        <div class="stat-ov-card"><div class="ico">üí∏</div><div class="val" id="ovExpense">‚Äî</div><div class="lbl">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div></div>
        <div class="stat-ov-card"><div class="ico">üè¶</div><div class="val" id="ovProfit">‚Äî</div><div class="lbl">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div></div>
        <div class="stat-ov-card"><div class="ico">üìä</div><div class="val" id="ovAvgJob">‚Äî</div><div class="lbl">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏á‡∏≤‡∏ô</div></div>
      </div>

      <div class="stats-row">
        <!-- Monthly Bar Chart -->
        <div class="card">
          <div class="card-header"><h3 class="card-title">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3></div>
          <div id="monthlyBars" class="bar-wrap"></div>
        </div>
        <!-- Job type stats -->
        <div class="card">
          <div class="card-header"><h3 class="card-title">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</h3></div>
          <div id="jobTypeBars" class="bar-wrap"></div>
        </div>
      </div>

      <!-- Top members -->
      <div class="card" style="margin-top:var(--spacing-xl)">
        <div class="card-header"><h3 class="card-title">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î</h3></div>
        <div class="table-responsive">
          <table class="table">
            <thead><tr><th>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th><th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th><th>‡∏á‡∏≤‡∏ô</th><th>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</th></tr></thead>
            <tbody id="topMemberTbody"><tr><td colspan="4" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    requireAuth(); renderMainNav('mainNav'); applyTranslations();
    var yr = document.getElementById('yearPicker');
    var now = new Date().getFullYear();
    for (var y = now; y >= now-4; y--) { var o=document.createElement('option'); o.value=y; o.textContent=y+543; if(y===now)o.selected=true; yr.appendChild(o); }
    loadStats();
  });

  function loadStats() {
    var year = parseInt(document.getElementById('yearPicker').value);
    var month = document.getElementById('monthPicker').value;
    var bandId = localStorage.getItem('bandId') || '';
    gasRun('getStatistics', { year: year, month: month !== '' ? parseInt(month) : null, bandId: bandId }, function(r) {
      if (!r || !r.success) return;
      var d = r.data || {};
      document.getElementById('ovJobs').textContent = d.totalJobs || 0;
      document.getElementById('ovIncome').textContent = formatCurrency(d.totalIncome||0);
      document.getElementById('ovExpense').textContent = formatCurrency(d.totalExpense||0);
      document.getElementById('ovProfit').textContent = formatCurrency((d.totalIncome||0)-(d.totalExpense||0));
      document.getElementById('ovAvgJob').textContent = d.totalJobs ? formatCurrency(Math.round((d.totalIncome||0)/(d.totalJobs||1))) : '‚Äî';

      // Monthly bars
      var months = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
      var monthData = d.byMonth || [];
      var maxVal = Math.max.apply(null, monthData.map(function(m){return m.income||0;})) || 1;
      document.getElementById('monthlyBars').innerHTML = months.map(function(mn,i){
        var val = (monthData[i]||{}).income||0;
        return '<div class="bar-row"><span class="label">'+mn+'</span>'
          +'<div class="bar-track"><div class="bar-fill" style="width:'+Math.round(val/maxVal*100)+'%"></div></div>'
          +'<span class="bar-val">'+formatCurrency(val)+'</span></div>';
      }).join('');

      // Job type bars
      var typeData = d.byType || [];
      var maxType = Math.max.apply(null, typeData.map(function(t){return t.count||0;})) || 1;
      document.getElementById('jobTypeBars').innerHTML = typeData.map(function(t){
        return '<div class="bar-row"><span class="label" style="font-size:11px">'+escapeHtml(t.type||'')+'</span>'
          +'<div class="bar-track"><div class="bar-fill" style="width:'+Math.round((t.count||0)/maxType*100)+'%"></div></div>'
          +'<span class="bar-val">'+t.count+'</span></div>';
      }).join('') || '<p class="text-muted" style="padding:var(--spacing-md)">'+t('noData')+'</p>';

      // Members
      var mData = d.topMembers || [];
      document.getElementById('topMemberTbody').innerHTML = mData.length ? mData.map(function(m){
        return '<tr><td>'+escapeHtml(m.name||'')+'</td><td>'+escapeHtml(m.position||'')+'</td><td>'+m.jobCount+'</td><td>'+formatCurrency(m.totalEarned||0)+'</td></tr>';
      }).join('') : '<tr><td colspan="4" class="text-center">'+t('noData')+'</td></tr>';
    });
  }
  </script>
</body>
</html>
