<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>เซ็ตลิสต์ — Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <style>
    .setlist-layout{display:grid;grid-template-columns:1fr 2fr;gap:var(--spacing-xl)}
    @media(max-width:768px){.setlist-layout{grid-template-columns:1fr}}
    .setlist-slot{display:flex;align-items:center;gap:var(--spacing-sm);padding:var(--spacing-sm) 0;border-bottom:1px dashed var(--premium-light-gray)}
    .slot-num{width:28px;height:28px;border-radius:var(--radius-full);background:var(--premium-gold);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0}
    .slot-title{flex:1;font-size:var(--text-sm)}
    .song-pill{display:flex;align-items:center;justify-content:space-between;padding:var(--spacing-xs) var(--spacing-sm);background:var(--premium-off-white);border-radius:var(--radius-md);margin-bottom:6px;cursor:pointer;font-size:var(--text-sm)}
    .song-pill:hover{background:var(--premium-light-gray)}
    .duration-bar{height:4px;background:var(--premium-light-gray);border-radius:var(--radius-full);margin-top:var(--spacing-sm)}
    .duration-fill{height:100%;background:var(--premium-gold);border-radius:var(--radius-full);transition:width .5s}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title" data-i18n="setlist">เซ็ตลิสต์</h1>
        <div style="display:flex;gap:var(--spacing-sm)">
          <button class="btn btn-secondary" onclick="window.print()">🖨️ <span data-i18n="print">พิมพ์</span></button>
          <button class="btn btn-primary" onclick="saveSetlist()" data-i18n="save">บันทึก</button>
        </div>
      </div>
      <div class="setlist-layout">
        <!-- Song pool -->
        <div class="card">
          <div class="card-header"><h3 class="card-title" data-i18n="bandSongs">เพลงของวง</h3></div>
          <input type="text" id="songSearch" oninput="filterPool()" data-i18n-placeholder="searchSong" placeholder="ค้นหา..." style="margin-bottom:var(--spacing-sm)">
          <div id="songPool" style="max-height:400px;overflow-y:auto"></div>
        </div>
        <!-- Setlist builder -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title" id="setlistTitle">เซ็ตที่ 1</h3>
            <div>
              <button class="btn btn-ghost btn-sm" onclick="clearSetlist()">🗑 ล้าง</button>
              <select id="setlistPick" onchange="changeSet(this.value)" style="margin-left:8px;font-size:var(--text-sm)">
                <option value="1">เซ็ต 1</option>
                <option value="2">เซ็ต 2</option>
                <option value="3">เซ็ต 3</option>
              </select>
            </div>
          </div>
          <div id="setlistSlots"></div>
          <div style="margin-top:var(--spacing-md)">
            <div style="display:flex;justify-content:space-between;font-size:var(--text-sm);color:var(--premium-text-muted)">
              <span>ความยาวรวม</span>
              <span id="totalDuration">0 นาที</span>
            </div>
            <div class="duration-bar"><div class="duration-fill" id="durationFill" style="width:0%"></div></div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script>
  var allSongs = [], currentSet = 1;
  var sets = {1:[], 2:[], 3:[]};

  document.addEventListener('DOMContentLoaded', function() {
    requireAuth(); renderMainNav('mainNav'); applyTranslations();
    gasRun('getAllBandSongs', {}, function(r) {
      allSongs = (r && r.success && r.data) ? r.data : [];
      renderPool(allSongs);
    });
    gasRun('getSetlist', {}, function(r) {
      if (r && r.success && r.data) { sets = r.data; renderSlots(); }
    });
  });

  function filterPool() {
    var q = document.getElementById('songSearch').value.toLowerCase();
    renderPool(allSongs.filter(function(s){ return !q || (s.title||'').toLowerCase().includes(q); }));
  }

  function renderPool(songs) {
    document.getElementById('songPool').innerHTML = songs.map(function(s) {
      return '<div class="song-pill" onclick="addToSet(\''+escapeHtml(s.songId||'')+'\',\''+escapeHtml(s.title||'')+'\',\''+escapeHtml(s.artist||'')+'\','+parseFloat(s.duration||0)+')">'
        +'<span>'+escapeHtml(s.title||'')+'</span>'
        +'<span style="color:var(--premium-text-muted);font-size:11px">'+escapeHtml(s.artist||'')+'</span></div>';
    }).join('') || '<p class="text-muted">' + t('noData') + '</p>';
  }

  function addToSet(id, title, artist, dur) {
    var sl = sets[currentSet]; if (!sl) return;
    if (sl.find(function(x){return x.id===id;})) { showToast('เพลงนี้อยู่ในเซ็ตแล้ว','info'); return; }
    sl.push({id:id, title:title, artist:artist, duration:dur||4});
    renderSlots();
  }

  function removeFromSet(idx) { sets[currentSet].splice(idx,1); renderSlots(); }

  function renderSlots() {
    var sl = sets[currentSet] || [];
    var total = sl.reduce(function(a,s){return a+(parseFloat(s.duration)||0);},0);
    document.getElementById('totalDuration').textContent = total.toFixed(1) + ' นาที';
    document.getElementById('durationFill').style.width = Math.min(100, total/60*100) + '%';
    document.getElementById('setlistSlots').innerHTML = sl.length ? sl.map(function(s,i){
      return '<div class="setlist-slot"><div class="slot-num">'+(i+1)+'</div>'
        +'<div class="slot-title"><strong>'+escapeHtml(s.title)+'</strong>'
        +'<span style="color:var(--premium-text-muted);font-size:11px;margin-left:8px">'+escapeHtml(s.artist||'')+'</span></div>'
        +'<span style="font-size:11px;color:var(--premium-text-muted)">'+(s.duration||'?')+'m</span>'
        +'<button class="btn btn-danger btn-sm" onclick="removeFromSet('+i+')">×</button></div>';
    }).join('') : '<p style="color:var(--premium-text-muted);text-align:center;padding:var(--spacing-lg)">คลิกเพลงด้านซ้ายเพื่อเพิ่ม</p>';
  }

  function clearSetlist() { sets[currentSet] = []; renderSlots(); }

  function changeSet(v) { currentSet = parseInt(v); renderSlots(); }

  function saveSetlist() {
    gasRun('saveSetlist', { sets: sets }, function(r) {
      if (r && r.success) showToast(t('msg_saved'),'success');
      else showToast((r&&r.message)||t('msg_error'),'error');
    });
  }
  </script>
</body>
</html>
