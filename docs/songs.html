<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>โปรแกรมลิสเพลง SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script src="js/i18n.js"></script>
  <style>
:root{
  --panel:#0f172a;
  --line:#1e293b;
  --primary:#6366f1;
  --accent:#22d3ee;
  --danger:#ef4444;
  --success:#22c55e;
  --new:#38bdf8;
  --text:#e5e7eb;
  --muted:#94a3b8;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
  background:linear-gradient(180deg,#020617,#0b1020);
  color:var(--text);
  line-height:1.6;
}

#mainNav{}

.container{
  max-width:1200px;
  margin:auto;
  padding:16px;
}

.panel{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}

.filters{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:10px;
}

select,input,button{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#020617;
  color:var(--text);
  font-size:14px;
}

button{
  background:var(--primary);
  border:none;
  font-weight:600;
  cursor:pointer;
}

button:hover{
  opacity:.9;
}

button:disabled{
  opacity:.5;
  cursor:not-allowed;
}

.result-columns{
  display:flex;
  flex-direction:column;
  gap:0;
}

.result-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid var(--line);
  transition:background .15s;
  cursor:default;
}
.result-item:active{background:rgba(255,255,255,.04)}

.result-item-left{
  flex:1;
  min-width:0;
}

.song-title{
  font-size:15px;
  font-weight:600;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  margin-bottom:4px;
  line-height:1.3;
}

.song-badges{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:2px;
  padding:2px 7px;
  border-radius:20px;
  font-size:11px;
  font-weight:600;
  white-space:nowrap;
  line-height:1.6;
}
.badge-key{background:#1e293b;color:#94a3b8;border:1px solid #334155}
.badge-male{background:#1e3a5f;color:#60a5fa}
.badge-female{background:#3b1e4f;color:#d8b4fe}
.badge-duet{background:#1e3b2e;color:#86efac}
.badge-mood{background:#1c1f2e;color:#a5b4fc}
.badge-era{background:#1a1a1a;color:#6b7280}

.add-song-btn{
  flex-shrink:0;
  width:36px;
  height:36px;
  border-radius:50%;
  background:rgba(99,102,241,.15);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  cursor:pointer;
  user-select:none;
  transition:background .15s;
  -webkit-tap-highlight-color:transparent;
}
.add-song-btn:active{background:rgba(99,102,241,.4)}

.new-tag{
  color:var(--new);
  font-size:10px;
  font-style:italic;
  margin-left:5px;
  font-weight:400;
}

.result-loading,
.result-empty,
.result-error{
  text-align:center;
  padding:32px 16px;
  color:var(--muted);
}

.result-loading-text{
  margin-top:10px;
}

.result-error{
  color:var(--danger);
}

.pagination{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:12px;
  margin-top:12px;
}

.pagination button{
  width:auto;
  padding:8px 16px;
}

.page-info{
  font-size:13px;
  color:var(--muted);
}

.list{
  list-style:none;
  padding:0;
  margin:0;
}

.list li{
  padding:12px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  transition:opacity 0.2s ease, transform 0.2s ease;
  will-change:transform;
}

.list li:hover{
  opacity:0.95;
}

.play-left{
  display:flex;
  flex-direction:column;
  gap:2px;
}

.play-title{
  font-weight:600;
}

.play-meta{
  font-size:13px;
  color:var(--muted);
}

.transpose{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  margin-top:4px;
}

.transpose button{
  width:18px;
  height:18px;
  padding:0;
  border-radius:6px;
  background:#020617;
  border:1px solid var(--line);
  color:var(--text);
  cursor:pointer;
  font-weight:700;
}

.transpose span{
  color:var(--muted);
}

.tp-btn{
  cursor:pointer;
  user-select:none;
  padding:2px 6px;
  border-radius:4px;
  transition:background 0.2s;
}

.tp-btn:hover{
  background:var(--line);
}

.key-val{
  transition:color .12s ease;
}

.key-val.flash{
  color:var(--accent);
}

.key-val.transposed{
  color:var(--danger);
  font-weight:600;
}

.move-btn{
  cursor:pointer;
  padding:0 6px;
  user-select:none;
}

.move-btn:hover{
  opacity:.7;
}

.del{
  color:var(--danger);
  cursor:pointer;
  user-select:none;
}

.del:hover{
  opacity:.7;
}

.break{
  color:var(--accent);
  font-weight:600;
}

.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#020617;
  border:1px solid var(--line);
  padding:12px 18px;
  border-radius:14px;
  font-weight:600;
  color:var(--success);
  display:none;
  z-index:1000;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
  transition:opacity 0.3s ease, transform 0.3s ease;
  will-change:transform, opacity;
}

.toast.show{
  animation:toastSlideIn 0.3s ease;
}

@keyframes toastSlideIn{
  from{
    opacity:0;
    transform:translateX(-50%) translateY(20px);
  }
  to{
    opacity:1;
    transform:translateX(-50%) translateY(0);
  }
}

.spinner{
  width:40px;
  height:40px;
  border:3px solid var(--line);
  border-top-color:var(--primary);
  border-radius:50%;
  animation:spin 0.8s linear infinite;
  margin:0 auto;
  will-change:transform;
}

@keyframes spin{
  to{transform:rotate(360deg);}
}

.panel{
  contain:layout style paint;
}

.result-columns{
  contain:layout;
}

.list{
  contain:layout;
}

html{
  scroll-behavior:smooth;
}

.result-item,
.list li,
.key-val,
.tp-btn,
.move-btn{
  transform:translateZ(0);
  backface-visibility:hidden;
}

@media (max-width: 899px) {
  .result-columns { column-width: min(220px, 100%); }
  .container { padding: 12px; }
  .panel { padding: 12px; }
  .tp-btn, .move-btn, .del {
    min-width: 36px;
    min-height: 36px;
    padding: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .add-song-btn {
    min-width: 40px;
    min-height: 40px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
}

@media (max-width: 599px) {
  .result-columns { column-width: 100%; }
  .container { padding: 10px; }
  .panel { padding: 10px; }
  .filters {
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .action-buttons {
    flex-direction: column;
  }
  .action-buttons button {
    min-height: 44px;
  }
  .copy-options {
    flex-direction: column;
    gap: 8px;
  }
  .pagination {
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }
  .pagination button {
    min-height: 44px;
    padding: 10px 16px;
  }
  .list li {
    padding: 14px 10px;
    flex-wrap: wrap;
    gap: 8px;
  }
  .play-left { flex: 1; min-width: 0; }
  .list li > span {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
  }
  .tp-btn, .move-btn, .del {
    min-width: 40px;
    min-height: 40px;
  }
  .toast {
    left: 12px;
    right: 12px;
    width: auto;
    max-width: 100%;
    transform: none;
    bottom: max(12px, env(safe-area-inset-bottom));
  }
  .toast.show {
    animation: toastSlideInMobile 0.3s ease;
  }
  h2 { font-size: 1.25rem; }
  h3 { font-size: 1rem; }
}

@keyframes toastSlideInMobile {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}

@supports (padding: env(safe-area-inset-bottom)) {
  .container {
    padding-left: max(12px, env(safe-area-inset-left));
    padding-right: max(12px, env(safe-area-inset-right));
  }
  body { padding-bottom: env(safe-area-inset-bottom); }
  .toast {
    bottom: max(16px, env(safe-area-inset-bottom));
    padding-bottom: max(12px, env(safe-area-inset-bottom));
  }
}

@media (hover: none) {
  .result-item:hover,
  .list li:hover { transform: none; opacity: 1; }
  button:hover { opacity: 1; }
  .tp-btn:active, .move-btn:active, .del:active { opacity: 0.7; }
}

@media (max-width: 599px) {
  input, select {
    font-size: 16px;
  }
}
  </style>
</head>

<body>
<div id="mainNav"></div>

<div class="container">

  <h2>🎵 โปรแกรมลิสเพลง SoulCiety</h2>

  <!-- ── Filter Panel ── -->
  <div class="panel">
  <div class="filters">
    <select id="singer" onchange="onFilterChange()">
      <option value="">นักร้อง</option>
      <option value="ชาย">ชาย</option>
      <option value="หญิง">หญิง</option>
    </select>

    <select id="era" onchange="onFilterChange()">
      <option value="">ยุคเพลง</option>
      <option value="2523-2532">2523-2532</option>
      <option value="2533-2542">2533-2542</option>
      <option value="2543-2553">2543-2553</option>
      <option value="2554-ปัจจุบัน">2554-ปัจจุบัน</option>
      <option value="สากล">สากล</option>
      <option value="ลูกทุ่ง/อีสาน/เพื่อชีวิต">ลูกทุ่ง/อีสาน/เพื่อชีวิต</option>
    </select>

    <select id="speed" onchange="onFilterChange()">
      <option value="">ความเร็ว</option>
      <option value="ช้า">ช้า</option>
      <option value="กลาง">กลาง</option>
      <option value="เร็ว">เร็ว</option>
    </select>

    <select id="mood" onchange="onFilterChange()">
      <option value="">อารมณ์</option>
      <option value="สุข / สนุก">สุข / สนุก</option>
      <option value="เศร้า / เหงา">เศร้า / เหงา</option>
      <option value="นิ่ง / ผ่อนคลาย">นิ่ง / ผ่อนคลาย</option>
      <option value="หวาน / อบอุ่น">หวาน / อบอุ่น</option>
      <option value="มัน / ฮึกเหิม">มัน / ฮึกเหิม</option>
    </select>
  </div>

  <input id="searchText" placeholder="🔍 ค้นหาเพลง" oninput="applyTextFilter()" style="margin-top:10px">
</div>

<div class="panel">
  <h3>🎼 เพลงที่ค้นพบ</h3>
  <div id="result"></div>

  <div class="pagination">
    <button onclick="prevPage()" id="prevBtn">⬅ ก่อนหน้า</button>
    <div class="page-info" id="pageInfo"></div>
    <button onclick="nextPage()" id="nextBtn">ถัดไป ➡</button>
  </div>
</div>

  <div class="panel">
  <h3>📋 ลิสเพลงที่เลือก</h3>

  <div class="filters" style="margin-bottom:10px">
    <input type="date" id="useDate">

    <select id="venue">
      <option value="">เลือกร้าน</option>
      <option value="นิยมสุข">นิยมสุข</option>
      <option value="ฉ่ำ">ฉ่ำ</option>
    </select>

    <select id="timeSlot">
      <option value="">ช่วงเวลา</option>
      <option value="19:30-20:30">19:30-20:30</option>
      <option value="21:00-22:00">21:00-22:00</option>
      <option value="22:30-23:30">22:30-23:30</option>
    </select>
  </div>

  <div class="action-buttons" style="display:flex;gap:10px;margin:10px 0">
    <button onclick="addBreak()">➕ เพิ่มพัก</button>
    <button onclick="copyPlaylist()">📋 คัดลอกลิส</button>
    <button onclick="refreshPlaylist()" style="background:var(--danger)">🔄 รีเฟรชลิส</button>
  </div>

  <div class="copy-options" style="display:flex;gap:24px;font-size:13px;margin-bottom:10px">
    <label style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="copySpeed" checked>
      แสดงความเร็ว (BPM)
    </label>

    <label style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="copyKey" checked>
      แสดงคีย์
    </label>
  </div>

  <ul id="playlist" class="list"></ul>
</div>
</div>


<div id="toast" class="toast">คัดลอกลิสสำเร็จ</div>


<script>

let allResults = [];
let filteredResults = [];
let currentPage = 1;
const PER_PAGE = 15;

var domCache = {};
function getEl(id) {
  if (!domCache[id]) domCache[id] = document.getElementById(id);
  return domCache[id];
}

function debounce(func, wait) {
  var timeout;
  return function () {
    var later = function () {
      timeout = null;
      func();
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function throttle(func, limit) {
  var inThrottle;
  return function () {
    if (!inThrottle) {
      func();
      inThrottle = true;
      setTimeout(function () { inThrottle = false; }, limit);
    }
  };
}

function setLoading(loading) {
  var resultEl = getEl("result");
  if (!resultEl) return;
  if (loading) {
    resultEl.innerHTML = '<div class="result-loading"><div class="spinner"></div><div class="result-loading-text">กำลังโหลด...</div></div>';
    resultEl.classList.add("is-loading");
  } else {
    resultEl.classList.remove("is-loading");
  }
}

function getFilterValues() {
  var singerEl = getEl("singer");
  var eraEl = getEl("era");
  var speedEl = getEl("speed");
  var moodEl = getEl("mood");
  return {
    singer: singerEl ? singerEl.value : "",
    era: eraEl ? eraEl.value : "",
    speed: speedEl ? speedEl.value : "",
    mood: moodEl ? moodEl.value : ""
  };
}

function getDropdownFiltered() {
  var f = getFilterValues();
  return allResults.filter(function (s) {
    if (f.singer === "ชาย" && !s.male) return false;
    if (f.singer === "หญิง" && !s.female) return false;
    if (f.era && s.era.indexOf(f.era) < 0) return false;
    if (f.speed) {
      var bpm = s.bpm || 0;
      if (f.speed === "ช้า" && (bpm < 1 || bpm > 70)) return false;
      if (f.speed === "กลาง" && (bpm < 80 || bpm > 115)) return false;
      if (f.speed === "เร็ว" && bpm < 116) return false;
    }
    if (f.mood && s.mood !== f.mood) return false;
    return true;
  });
}

function applyFiltersAndRender() {
  var byDropdown = getDropdownFiltered();
  var q = "";
  var searchEl = getEl("searchText");
  if (searchEl && searchEl.value) q = searchEl.value.trim().toLowerCase();
  filteredResults = q
    ? byDropdown.filter(function (s) { return s.name.toLowerCase().indexOf(q) >= 0; })
    : byDropdown;
  currentPage = 1;
  renderPage();
}

var applyFiltersAndRenderDebounced = debounce(applyFiltersAndRender, 150);

function applyTextFilter() {
  applyFiltersAndRenderDebounced();
}

function onFilterChange() {
  applyFiltersAndRender();
}

function loadInitial() {
  setLoading(true);
  var bandName = localStorage.getItem('bandName') || '';
  var bandId   = localStorage.getItem('bandId')   || '';
  gasRun('getAllSongs', { source: 'global', bandName: bandName, bandId: bandId }, function(result) {
    if (result && result.success && result.data) {
      allResults = result.data;
      setLoading(false);
      applyFiltersAndRender();
    } else {
      setLoading(false);
      var msg = (result && result.message) ? result.message : "error";
      var resultEl = getEl("result");
      if (resultEl) resultEl.innerHTML = '<div class="result-loading result-error">โหลดข้อมูลไม่ได้: ' + msg + '</div>';
    }
  });
}

function escapeHtml(text) {
  var div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function renderPage() {
  var resultEl = getEl("result");
  var pageInfoEl = getEl("pageInfo");
  var prevBtn = getEl("prevBtn");
  var nextBtn = getEl("nextBtn");
  if (!resultEl) return;
  if (resultEl.classList.contains("is-loading")) return;

  var start = (currentPage - 1) * PER_PAGE;
  var pageItems = filteredResults.slice(start, start + PER_PAGE);
  var totalPages = Math.max(1, Math.ceil(filteredResults.length / PER_PAGE));

  var html = "";
  if (pageItems.length === 0) {
    html = '<div class="result-empty">ไม่พบเพลงที่ตรงกับตัวกรอง</div>';
  } else {
    var buf = [];
    for (var i = 0; i < pageItems.length; i++) {
      var s = pageItems[i];
      var idx = start + i;
      var nameEscaped = escapeHtml(s.name);
      var newTag = s.isNew ? '<span class="new-tag">New</span>' : '';
      // badges
      var badges = '';
      if (s.key)    badges += '<span class="badge badge-key">🎹 ' + escapeHtml(s.key) + (s.keyNote ? ' / ' + escapeHtml(s.keyNote) : '') + '</span>';
      if (s.singer === 'male')   badges += '<span class="badge badge-male">♂️ ชาย</span>';
      if (s.singer === 'female') badges += '<span class="badge badge-female">♀️ หญิง</span>';
      if (s.singer === 'duet')   badges += '<span class="badge badge-duet">🎤 คู่</span>';
      if (s.mood)   badges += '<span class="badge badge-mood">' + escapeHtml(s.mood) + '</span>';
      if (s.era)    badges += '<span class="badge badge-era">' + escapeHtml(s.era) + '</span>';

      buf.push(
        '<div class="result-item" data-index="' + idx + '">' +
        '<div class="result-item-left">' +
        '<div class="song-title">' + nameEscaped + newTag + '</div>' +
        (badges ? '<div class="song-badges">' + badges + '</div>' : '') +
        '</div>' +
        '<span class="add-song-btn" data-index="' + idx + '" title="เพิ่มในลิส">➕</span>' +
        '</div>'
      );
    }
    html = '<div class="result-columns">' + buf.join('') + '</div>';
  }

  resultEl.innerHTML = html;

  if (pageInfoEl) {
    pageInfoEl.textContent = filteredResults.length === 0
      ? "ไม่มีผลลัพธ์"
      : "หน้า " + currentPage + " / " + totalPages;
  }
  if (prevBtn) prevBtn.disabled = currentPage <= 1;
  if (nextBtn) nextBtn.disabled = currentPage >= totalPages || filteredResults.length === 0;
}

var nextPageThrottled = throttle(function () {
  var totalPages = Math.max(1, Math.ceil(filteredResults.length / PER_PAGE));
  if (currentPage < totalPages) {
    currentPage++;
    renderPage();
  }
}, 200);

var prevPageThrottled = throttle(function () {
  if (currentPage > 1) {
    currentPage--;
    renderPage();
  }
}, 200);

function nextPage() { nextPageThrottled(); }
function prevPage() { prevPageThrottled(); }

document.addEventListener("click", function (e) {
  if (e.target && e.target.classList && e.target.classList.contains("add-song-btn")) {
    var idx = parseInt(e.target.getAttribute("data-index"), 10);
    if (!isNaN(idx) && filteredResults[idx]) addSong(filteredResults[idx]);
  }
});

window.onload = function() {
  if (typeof requireAuth === 'function') requireAuth();
  if (typeof renderMainNav === 'function') renderMainNav('mainNav');
  if (typeof applyTranslations === 'function') applyTranslations();
  loadInitial();
};
</script>

<script>

const MAJOR_KEYS = [
  { degree:"C",  semi:0  },
  { degree:"1#", semi:7  },
  { degree:"2#", semi:2  },
  { degree:"3#", semi:9  },
  { degree:"4#", semi:4  },
  { degree:"5#", semi:11 },
  { degree:"6#", semi:6  },
  { degree:"1b", semi:5  },
  { degree:"2b", semi:10 },
  { degree:"3b", semi:3  },
  { degree:"4b", semi:8  },
  { degree:"5b", semi:1  }
];

const MAJOR_THEORY = [
  { degree:"7#", semi:1  },
  { degree:"7b", semi:11 }
];

const MINOR_KEYS = [
  { degree:"0",  semi:9  },
  { degree:"1#", semi:4  },
  { degree:"2#", semi:11 },
  { degree:"3#", semi:6  },
  { degree:"4#", semi:1  },
  { degree:"1b", semi:2  },
  { degree:"2b", semi:7  },
  { degree:"3b", semi:0  },
  { degree:"4b", semi:5  },
  { degree:"5b", semi:10 },
  { degree:"6b", semi:3  }
];

const MINOR_THEORY = [
  { degree:"7#", semi:10 },
  { degree:"7b", semi:8  }
];

function transposeKey(degree, step, mode="major"){
  if(!degree) return "-";

  const pool =
    mode === "minor"
      ? [...MINOR_KEYS, ...MINOR_THEORY]
      : [...MAJOR_KEYS, ...MAJOR_THEORY];

  const cur = pool.find(k => k.degree === degree);
  if(!cur) return degree;

  let newSemi = (cur.semi + step) % 12;
  if(newSemi < 0) newSemi += 12;

  let target = pool.find(
    k => k.semi === newSemi && !k.degree.startsWith("7")
  );
  if(target) return target.degree;

  target = pool.find(k => k.semi === newSemi);
  return target ? target.degree : degree;
}
</script>

<script>

let playlistData = [];

let playlistCache = {};
function getPlaylistEl(id){
  if(!playlistCache[id]) playlistCache[id] = document.getElementById(id);
  return playlistCache[id];
}

function addSong(song){
  if(!song) return;
  playlistData.push({
    ...song,
    transpose: 0,
    mode: "major"
  });
  renderPlaylist();
}

function addBreak(){
  playlistData.push({ break:true });
  renderPlaylist();
}

function refreshPlaylist(){
  if(confirm("ต้องการล้างลิสเพลงทั้งหมดหรือไม่?")){
    playlistData = [];
    renderPlaylist();
  }
}

function renderPlaylist(){
  const ul = getPlaylistEl("playlist");
  if(!ul) return;

  requestAnimationFrame(() => {
    ul.innerHTML = "";

    if(playlistData.length === 0){
      ul.innerHTML = '<li style="color:var(--muted);text-align:center;padding:20px;">ยังไม่มีเพลงในลิส</li>';
      return;
    }

    const fragment = document.createDocumentFragment();

    playlistData.forEach((s, i) => {
      const li = document.createElement("li");
      li.setAttribute("data-index", i);

      if(s.break){
        li.innerHTML = `
          <span class="break">พัก</span>
          <span>
            <span class="move-btn move-up" data-index="${i}" title="ย้ายขึ้น">⬆️</span>
            <span class="move-btn move-down" data-index="${i}" title="ย้ายลง">⬇️</span>
            <span class="del remove-item" data-index="${i}" title="ลบ">✕</span>
          </span>`;
        fragment.appendChild(li);
        return;
      }

      const transposedKey = transposeKey(s.key, s.transpose, s.mode);
      const nameEscaped = escapeHtml(s.name);

      li.innerHTML = `
        <div class="play-left">
          <div class="play-title">${i+1}. ${nameEscaped}</div>

          <div class="play-meta">
            BPM ${s.bpm || "-"} |
            Key
            <span class="key-val ${s.transpose!==0?"transposed":""}"
                  data-index="${i}">
              ${transposedKey}
            </span>
          </div>

          <div class="transpose">
            <span class="tp-btn tp-down" data-index="${i}" data-step="-1" title="ลดคีย์">−</span>
            <span class="tp-btn tp-up" data-index="${i}" data-step="1" title="เพิ่มคีย์">+</span>
          </div>
        </div>

        <span>
          <span class="move-btn move-up" data-index="${i}" title="ย้ายขึ้น">⬆️</span>
          <span class="move-btn move-down" data-index="${i}" title="ย้ายลง">⬇️</span>
          <span class="del remove-item" data-index="${i}" title="ลบ">✕</span>
        </span>`;
      fragment.appendChild(li);
    });

    ul.appendChild(fragment);
  });
}

function escapeHtml(text){
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function transposeSong(i,step){
  const s = playlistData[i];
  if(!s || s.break) return;

  s.transpose += step;

  const el = document.querySelector(`.key-val[data-index="${i}"]`);
  if(!el) return;

  requestAnimationFrame(() => {
    el.textContent = transposeKey(s.key, s.transpose, s.mode);
    el.classList.toggle("transposed", s.transpose!==0);
    el.classList.add("flash");
    setTimeout(()=>el.classList.remove("flash"),120);
  });
}

function moveUp(i){
  if(i<=0) return;
  [playlistData[i-1],playlistData[i]] =
  [playlistData[i],playlistData[i-1]];
  renderPlaylist();
}

function moveDown(i){
  if(i>=playlistData.length-1) return;
  [playlistData[i],playlistData[i+1]] =
  [playlistData[i+1],playlistData[i]];
  renderPlaylist();
}

function removeItem(i){
  if(i < 0 || i >= playlistData.length) return;
  playlistData.splice(i,1);
  renderPlaylist();
}

document.addEventListener("click", (e) => {
  const index = parseInt(e.target.getAttribute("data-index"));
  if(isNaN(index)) return;

  if(e.target.classList.contains("tp-up") || e.target.classList.contains("tp-down")){
    const step = parseInt(e.target.getAttribute("data-step"));
    transposeSong(index, step);
  } else if(e.target.classList.contains("move-up")){
    moveUp(index);
  } else if(e.target.classList.contains("move-down")){
    moveDown(index);
  } else if(e.target.classList.contains("remove-item")){
    removeItem(index);
  }
});

window.addEventListener("load", () => {
  const dateInput = getPlaylistEl("useDate");
  if(!dateInput) return;

  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, "0");
  const dd = String(today.getDate()).padStart(2, "0");

  dateInput.value = `${yyyy}-${mm}-${dd}`;
});
</script>

<script>

function formatThaiDate(dateStr){
  if(!dateStr) return "";

  const d = new Date(dateStr);
  if(isNaN(d.getTime())) return "";

  const months = [
    "มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน",
    "กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"
  ];

  return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
}

function copyPlaylist(){
  try {
    if(playlistData.length === 0){
      alert("ไม่มีเพลงในลิส");
      return;
    }

    const showSpeed = document.getElementById("copySpeed")?.checked;
    const showKey   = document.getElementById("copyKey")?.checked;

    const useDateEl = document.getElementById("useDate");
    const venueEl   = document.getElementById("venue");
    const timeEl    = document.getElementById("timeSlot");

    const date = useDateEl ? formatThaiDate(useDateEl.value) : "";
    const venueTxt = venueEl ? venueEl.value : "";
    const timeTxt  = timeEl ? timeEl.value : "";

    let header = "";
    if(date) header += date + "\n";
    if(venueTxt || timeTxt) header += `${venueTxt} ${timeTxt}`.trim() + "\n";
    if(header) header += "---\n";

    let n = 0;
    const body = playlistData.map(s=>{
      if(s.break) return "พัก";
      n++;

      const bpmTxt =
        showSpeed && s.bpm ? ` ${s.bpm}` : "";

      const keyTxt =
        showKey ? ` [${transposeKey(s.key, s.transpose, s.mode)}]` : "";

      return `${n}. ${s.name}${bpmTxt}${keyTxt}`;
    }).join("\n");

    const textToCopy = header + body;

    const ta = document.createElement("textarea");
    ta.value = textToCopy;
    ta.setAttribute("readonly", "");
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    ta.style.top = "0";

    document.body.appendChild(ta);
    ta.focus();
    ta.select();

    let success = false;
    try {
      success = document.execCommand("copy");
    } catch (err) {
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(textToCopy).then(() => {
          success = true;
        }).catch(() => {
          success = false;
        });
      }
    }

    document.body.removeChild(ta);

    if(!success){
      throw new Error("ไม่สามารถคัดลอกได้");
    }

    const toast = document.getElementById("toast");
    if(toast){
      toast.style.display = "block";
      toast.classList.add("show");
      setTimeout(()=>{
        toast.classList.remove("show");
        setTimeout(()=>toast.style.display="none",300);
      },2000);
    }

  } catch (err) {
    alert("คัดลอกไม่สำเร็จ: " + err.message);
  }
}
</script>
</body>
</html>