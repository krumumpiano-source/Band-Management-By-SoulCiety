/**
 * Band Management By SoulCiety — Supabase API Wrapper
 * แทนที่ gasRun() ทุก action ด้วย Supabase REST SDK
 *
 * Load order ใน HTML:
 *   1. i18n.js
 *   2. app.js          ← inject Supabase SDK + ไฟล์นี้ อัตโนมัติ
 *   3. nav.js
 */
(function (global) {
  'use strict';

  // ── ⚙️ CONFIG — แก้ค่านี้หลังสร้าง Supabase project ─────────────
  var SUPABASE_URL    = (global._SB_CONFIG && global._SB_CONFIG.url)    || '';
  var SUPABASE_ANON   = (global._SB_CONFIG && global._SB_CONFIG.anon)   || '';
  // ──────────────────────────────────────────────────────────────────

  // รอ SDK โหลดก่อน แล้ว init
  function waitForSDK(cb, tries) {
    tries = tries || 0;
    if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
      cb();
    } else if (tries < 100) {
      setTimeout(function () { waitForSDK(cb, tries + 1); }, 50);
    } else {
      console.error('Supabase SDK โหลดไม่สำเร็จ');
    }
  }

  waitForSDK(function () {
    var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession: true, storage: localStorage }
    });
    global._sb = sb;

    // ── Helpers ─────────────────────────────────────────────────────
    function getBandId()   { return localStorage.getItem('bandId')   || ''; }
    function getRole()     { return localStorage.getItem('userRole') || ''; }

    function saveSession(session, profile) {
      localStorage.setItem('auth_token',    session.access_token);
      // ข้อมูลส่วนตัว
      localStorage.setItem('userTitle',     profile.title      || '');
      localStorage.setItem('userFirstName', profile.first_name || '');
      localStorage.setItem('userLastName',  profile.last_name  || '');
      localStorage.setItem('userNickname',  profile.nickname   || '');
      localStorage.setItem('userInstrument',profile.instrument || '');
      // ชื่อแสดง: ชื่อเล่น ถ้ามี ไม่มีใช้ first_name หรือ user_name
      var displayName = profile.nickname || profile.first_name || profile.user_name || '';
      localStorage.setItem('userName',   displayName);
      localStorage.setItem('userEmail',  profile.email      || '');
      localStorage.setItem('bandId',     profile.band_id    || '');
      localStorage.setItem('bandName',   profile.band_name  || '');
      localStorage.setItem('userRole',     profile.role       || 'member');
      localStorage.setItem('bandProvince',  profile.province   || '');
    }

    function clearSession() {
      ['auth_token','bandId','bandName','bandManager','userRole','userName',
       'userTitle','userFirstName','userLastName','userNickname','userInstrument','userEmail',
       'bandProvince'].forEach(function (k) {
        localStorage.removeItem(k);
      });
    }

    // snake_case → camelCase (เพื่อ backward compat กับ frontend เดิม)
    function toCamel(obj) {
      if (!obj || typeof obj !== 'object' || Array.isArray(obj)) return obj;
      var result = {};
      Object.keys(obj).forEach(function (k) {
        var camel = k.replace(/_([a-z])/g, function (_, c) { return c.toUpperCase(); });
        result[camel] = obj[k];
      });
      return result;
    }
    function toCamelList(arr) { return (arr || []).map(toCamel); }

    // ── sbRun — interface เดิมกับ gasRun ──────────────────────────
    function sbRun(action, data, callback) {
      dispatch(action, data || {}).then(function (result) {
        if (result && result.authError) {
          clearSession();
          window.location.replace('index.html');
          return;
        }
        if (callback) callback(result);
      }).catch(function (err) {
        console.error('[sbRun]', action, err);
        if (callback) callback({ success: false, message: err.message || err.toString() });
      });
    }
    global.sbRun  = sbRun;
    global.gasRun = sbRun;   // override gasRun เดิมทั้งหมด

    // ── dispatch ────────────────────────────────────────────────────
    async function dispatch(action, d) {
      switch (action) {

        // ── Auth ───────────────────────────────────────────────────
        case 'login':               return doLogin(d);
        case 'register':            return doRegister(d);
        case 'registerBandRequest': return doRegisterBandRequest(d);
        case 'logout':              return doLogout();
        case 'requestPasswordReset': return doRequestPasswordReset(d);
        case 'resetPassword':          return doResetPassword(d);
        case 'lookupEmail':            return doLookupEmail(d);

        // ── Invite / Band Code ─────────────────────────────────────
        case 'generateInviteCode':  return doGenerateInviteCode(d);
        case 'lookupInviteCode':    return doLookupInviteCode(d);
        case 'getBandCode':         return doGetBandCode(d);

        // ── Band Requests (ขอสร้างวงใหม่) ──────────────────────────
        case 'submitBandRequest':       return doSubmitBandRequest(d);
        case 'getPendingBandRequests':   return doGetPendingBandRequests();
        case 'approveBandRequest':       return doApproveBandRequest(d);
        case 'rejectBandRequest':        return doRejectBandRequest(d);
        case 'getMyBandRequest':         return doGetMyBandRequest();

        // ── Songs ──────────────────────────────────────────────────
        case 'getAllSongs':
        case 'getSongs':
        case 'getAllBandSongs':    return doGetAllSongs(d);
        case 'getSong':            return doGetOne('band_songs', d.songId);
        case 'addSong':            return doInsert('band_songs', d.data || d);
        case 'updateSong':         return doUpdate('band_songs', d.songId, d.data || d);
        case 'deleteSong':         return doDelete('band_songs', d.songId);
        case 'savePlaylistHistory':return doInsert('playlist_history', d.data || d);
        case 'getPlaylistHistory': return doSelect('playlist_history', { band_id: getBandId() }, '-created_at', 50);

        // ── Band Members ───────────────────────────────────────────
        case 'getAllBandMembers':
        case 'getBandMembers':     return doGetBandMembers();
        case 'getBandProfiles':    return doGetBandProfiles(d);
        case 'addBandMember':      return doInsert('band_members', d.data || d);
        case 'updateBandMember':   return doUpdate('band_members', d.memberId, d.data || d);
        case 'deleteBandMember':   return doDelete('band_members', d.memberId);

        // ── Attendance ─────────────────────────────────────────────
        case 'addAttendancePayroll':    return doInsert('attendance_payroll', d.data || d);
        case 'getAllAttendancePayroll':  return doGetAttendance(d);
        case 'updateAttendancePayroll': return doUpdate('attendance_payroll', d.recordId, d.data || d);
        case 'deleteAttendancePayroll': return doDelete('attendance_payroll', d.recordId);

        // ── Check-in ───────────────────────────────────────────────
        case 'memberCheckIn':      return doMemberCheckIn(d);
        case 'getMyCheckIn':       return doGetMyCheckIn(d);
        case 'cancelCheckIn':      return doCancelCheckIn(d);
        case 'getCheckInsForDate': return doSelect('member_check_ins', { band_id: getBandId(), date: d.date });

        // ── Leave ──────────────────────────────────────────────────
        case 'requestLeave':       return doRequestLeave(d);
        case 'getMyLeaveRequests': return doSelect('leave_requests', { band_id: getBandId(), member_id: d.memberId }, '-date', 100);
        case 'getAllLeaveRequests': return doSelect('leave_requests', { band_id: getBandId() }, '-date', 200);
        case 'updateLeaveStatus':  return doUpdate('leave_requests', d.leaveId, { status: d.status });
        case 'assignSubstitute':   return doUpdate('leave_requests', d.leaveId, { substitute_id: d.substituteId, substitute_name: d.substituteName, status: 'approved' });
        case 'rejectLeave':        return doUpdate('leave_requests', d.leaveId, { status: 'rejected' });

        case 'getDashboardSummary': return doGetDashboardSummary();

        // ── Pending Members ────────────────────────────────────────
        case 'getPendingMembers':  return doGetPendingMembers(d);
        case 'approveMember':      return doApproveMember(d);
        case 'rejectMember':       return doRejectMember(d);

        // ── Setlist ────────────────────────────────────────────────
        case 'getSetlist':         return doGetSetlist(d);
        case 'saveSetlist':        return doSaveSetlist(d);

        // ── Band Fund (กองกลาง) ────────────────────────────────────
        case 'getFundTransactions':    return doGetFundTransactions(d);
        case 'addFundTransaction':     return doAddFundTransaction(d);
        case 'deleteFundTransaction':  return doDeleteFundTransaction(d);

        // ── External Payout ────────────────────────────────────────
        case 'addExternalPayout':      return doInsert('external_payouts', Object.assign({ band_id: getBandId() }, toSnakeObj(d)));
        case 'getAllExternalPayouts':   return doSelect('external_payouts', { band_id: getBandId() }, '-date');
        case 'deleteExternalPayout':   return doDelete('external_payouts', d.payoutId);

        // ── Statistics ─────────────────────────────────────────────
        case 'getStatistics':      return doGetStatistics(d);

        // ── Quotation PDF ──────────────────────────────────────────
        case 'generateQuotationPdf': return doGenerateQuotationPdf(d);

        // ── Band Settings ──────────────────────────────────────────
        case 'saveBandSettings':   return doSaveBandSettings(d);
        case 'getBandSettings':    return doGetBandSettings(d.bandId || getBandId());

        // ── Schedule ───────────────────────────────────────────────
        case 'saveSchedule':  return doSaveSchedule(d);
        case 'getSchedule':   return doGetSchedule(d);
        case 'addJob':        return doInsert('schedule', Object.assign({ band_id: getBandId() }, toSnakeObj(d)));
        case 'updateJob':     return doUpdate('schedule', d.scheduleId, d);
        case 'deleteJob':     return doDelete('schedule', d.scheduleId);

        // ── Equipment ──────────────────────────────────────────────
        case 'getAllEquipment':   return doSelect('equipment', { band_id: getBandId() }, 'name');
        case 'addEquipment':      return doInsert('equipment', d.data || d);
        case 'updateEquipment':   return doUpdate('equipment', d.equipmentId, d.data || d);
        case 'deleteEquipment':   return doDelete('equipment', d.equipmentId);

        // ── Clients ────────────────────────────────────────────────
        case 'getAllClients':   return doSelect('clients', { band_id: getBandId() }, 'name');
        case 'addClient':      return doInsert('clients', d.data || d);
        case 'updateClient':   return doUpdate('clients', d.clientId, d.data || d);
        case 'deleteClient':   return doDelete('clients', d.clientId);

        // ── Quotations ─────────────────────────────────────────────
        case 'getAllQuotations': return doSelect('quotations', { band_id: getBandId() }, '-date');
        case 'addQuotation':    return doInsert('quotations', d.data || d);
        case 'updateQuotation': return doUpdate('quotations', d.quotationId, d.data || d);
        case 'deleteQuotation': return doDelete('quotations', d.quotationId);

        // ── Profile ────────────────────────────────────────────────
        case 'getMyProfile':    return doGetMyProfile();
        case 'updateMyProfile': return doUpdateMyProfile(d);
        case 'changeEmail':     return doChangeEmail(d);
        case 'changePassword':  return doChangePassword(d);

        // ── Admin ──────────────────────────────────────────────────
        case 'getAllUsers':     return doAdminGetAllUsers();
        case 'updateUserRole':  return doUpdate('profiles', d.userId, { role: d.role });
        case 'deleteUser':      return doAdminDeleteUser(d.userId);
        case 'getSystemInfo':   return doGetSystemInfo();

        // ── Legacy (GAS-only, ไม่รองรับใน Supabase) ────────────────
        case 'createBackup':
        case 'getSpreadsheetUrl':
        case 'runSetupFromAdmin':
        case 'clearAllData':
        case 'resetUsers':
          return { success: false, message: 'ฟีเจอร์นี้ไม่พร้อมใช้งานในเวอร์ชัน Supabase' };

        default:
          return { success: false, message: 'Unknown action: ' + action };
      }
    }

    // ── camelCase payload → snake_case row ──────────────────────────
    function toSnakeObj(obj) {
      if (!obj || typeof obj !== 'object') return obj;
      var result = {};
      var fieldMap = {
        bandId: 'band_id', bandName: 'band_name', venueId: 'venue_id',
        venueName: 'venue_name', memberId: 'member_id', memberName: 'member_name',
        clientId: 'client_id', clientName: 'client_name', quotationId: 'quotation_id',
        leaveId: 'leave_id', substituteId: 'substitute_id', substituteName: 'substitute_name',
        substituteContact: 'substitute_contact',
        scheduleId: 'schedule_id', equipmentId: 'equipment_id',
        timeSlots: 'time_slots', dayOfWeek: 'day_of_week', totalPay: 'total_pay',
        totalAmount: 'total_amount', priceAdjustments: 'price_adjustments',
        defaultHourlyRate: 'default_hourly_rate', defaultPay: 'default_pay',
        joinedAt: 'joined_at', checkInAt: 'check_in_at', expiresAt: 'expires_at',
        eventDate: 'event_date', eventType: 'event_type', vatAmount: 'vat_amount',
        docUrl: 'doc_url', serialNo: 'serial_no', purchaseDate: 'purchase_date',
        contactPerson: 'contact_person', lineId: 'line_id',
        totalGigs: 'total_gigs', totalRevenue: 'total_revenue',
        effectiveFrom: 'effective_from', effectiveTo: 'effective_to',
        hourlyRate: 'hourly_rate', startTime: 'start_time', endTime: 'end_time',
        // profile fields
        firstName: 'first_name', lastName: 'last_name', userName: 'user_name',
        userId: 'user_id'
      };
      Object.keys(obj).forEach(function (k) {
        if (k === '_token' || k === 'action') return;
        var snakeKey = fieldMap[k] || k;
        result[snakeKey] = obj[k];
      });
      return result;
    }

    // ── Generic CRUD ─────────────────────────────────────────────
    async function doSelect(table, filters, order, limit) {
      var q = sb.from(table).select('*');
      if (filters) {
        Object.keys(filters).forEach(function (k) { q = q.eq(k, filters[k]); });
      }
      if (order) {
        var desc = order.startsWith('-');
        q = q.order(desc ? order.slice(1) : order, { ascending: !desc });
      }
      if (limit) q = q.limit(limit);
      var { data, error } = await q;
      if (error) throw error;
      return { success: true, data: toCamelList(data) };
    }

    async function doGetOne(table, id) {
      if (!id) return { success: false, message: 'ไม่พบ id' };
      var { data, error } = await sb.from(table).select('*').eq('id', id).single();
      if (error) throw error;
      return { success: true, data: toCamel(data) };
    }

    async function doInsert(table, payload) {
      var row = toSnakeObj(Object.assign({ band_id: getBandId() }, payload));
      delete row.action; delete row._token;
      var { data, error } = await sb.from(table).insert(row).select().single();
      if (error) throw error;
      return { success: true, data: toCamel(data) };
    }

    async function doUpdate(table, id, payload) {
      if (!id) return { success: false, message: 'ไม่พบ id' };
      var row = toSnakeObj(payload);
      delete row.action; delete row._token;
      row.updated_at = new Date().toISOString();
      var { data, error } = await sb.from(table).update(row).eq('id', id).select().single();
      if (error) throw error;
      return { success: true, data: toCamel(data) };
    }

    async function doDelete(table, id) {
      if (!id) return { success: false, message: 'ไม่พบ id' };
      var { error } = await sb.from(table).delete().eq('id', id);
      if (error) throw error;
      return { success: true };
    }

    // ── Auth ─────────────────────────────────────────────────────
    async function doLogin(d) {
      var { data, error } = await sb.auth.signInWithPassword({
        email: d.email, password: d.password
      });
      if (error) return { success: false, message: 'อีเมลหรือรหัสผ่านไม่ถูกต้อง' };

      // ดึง profile
      var { data: profile } = await sb.from('profiles').select('*').eq('id', data.user.id).single();
      saveSession(data.session, profile || {});
      var p = profile || {};
      var displayName = p.nickname || p.first_name || p.user_name || d.email.split('@')[0];
      return {
        success:    true,
        token:      data.session.access_token,
        userName:   displayName,
        userTitle:  p.title      || '',
        firstName:  p.first_name || '',
        lastName:   p.last_name  || '',
        nickname:   p.nickname   || '',
        instrument: p.instrument || '',
        bandId:     p.band_id    || '',
        bandName:   p.band_name  || '',
        role:       p.role       || 'member'
      };
    }

    async function doRegister(d) {
      var meta = {
        user_name:  d.nickname || d.firstName || d.name || d.email.split('@')[0],
        title:      d.title      || '',
        first_name: d.firstName  || '',
        last_name:  d.lastName   || '',
        nickname:   d.nickname   || '',
        instrument: d.instrument || '',
        band_name:  d.bandName   || '',
        role:       'member'
      };

      var { data, error } = await sb.auth.signUp({
        email: d.email, password: d.password,
        options: { data: meta }
      });
      if (error) return { success: false, message: error.message };

      // ต้องมี invite code เสมอ (สมัครผ่านรหัสวง)
      if (d.inviteCode && d.inviteCode.trim() && data.user) {
        var { data: result, error: rErr } = await sb.rpc('redeem_invite_code', {
          p_code:    d.inviteCode.toUpperCase(),
          p_user_id: data.user.id
        });
        if (rErr || !result.success) {
          // ลบ user ที่สร้างไปแล้ว
          await sb.auth.admin.deleteUser(data.user.id).catch(function(){});
          return { success: false, message: (result && result.message) || 'รหัสวงไม่ถูกต้อง' };
        }
        var provincePart = result.province ? ' (' + result.province + ')' : '';
        return { success: true, message: 'สมัครสำเร็จ! ส่งคำขอเข้าร่วมวง ' + result.band_name + provincePart + ' แล้ว รอผู้จัดการวงอนุมัติ' };
      }

      return { success: false, message: 'กรุณากรอกรหัสวง' };
    }

    // ── Register for band creation request (ขอสร้างวงใหม่) ─────────
    async function doRegisterBandRequest(d) {
      var meta = {
        user_name:  d.nickname || d.firstName || d.name || d.email.split('@')[0],
        title:      d.title      || '',
        first_name: d.firstName  || '',
        last_name:  d.lastName   || '',
        nickname:   d.nickname   || '',
        instrument: d.instrument || '',
        band_name:  d.bandName   || '',
        role:       'manager'
      };

      var { data, error } = await sb.auth.signUp({
        email: d.email, password: d.password,
        options: { data: meta }
      });
      if (error) return { success: false, message: error.message };
      if (!data.user) return { success: false, message: 'ไม่สามารถสร้างบัญชีได้' };

      // ส่งคำขอสร้างวง
      var fullName = (d.title && d.title !== 'ไม่ระบุ' ? d.title + ' ' : '') + (d.firstName || '') + ' ' + (d.lastName || '');
      var { data: result, error: rErr } = await sb.rpc('submit_band_request', {
        p_user_id:      data.user.id,
        p_band_name:    d.bandName || '',
        p_province:     d.province || '',
        p_member_count: parseInt(d.memberCount) || 1,
        p_name:         fullName.trim(),
        p_email:        d.email
      });
      if (rErr) return { success: false, message: rErr.message };
      return result;
    }

    async function doLogout() {
      await sb.auth.signOut();
      clearSession();
      return { success: true };
    }

    // ── Songs ─────────────────────────────────────────────────────
    async function doGetAllSongs(d) {
      var source = d.source || 'global';
      var q = sb.from('band_songs').select('*').order('name');
      if (source === 'band') q = q.eq('band_id', getBandId());
      var { data, error } = await q.limit(500);
      if (error) throw error;
      return { success: true, data: toCamelList(data) };
    }

    // ── Band Members ──────────────────────────────────────────────
    async function doGetBandMembers() {
      var { data, error } = await sb.from('band_members')
        .select('*')
        .eq('band_id', getBandId())
        .neq('status', 'inactive')
        .order('name');
      if (error) throw error;
      return { success: true, data: toCamelList(data) };
    }

    // ── Band Profiles (registered members) ─────────────────────────
    async function doGetBandProfiles(d) {
      var bandId = d.bandId || getBandId();
      var { data, error } = await sb.from('profiles')
        .select('id, email, user_name, nickname, first_name, last_name, instrument, phone, role, status, title, band_id, band_name, created_at')
        .eq('band_id', bandId)
        .eq('status', 'active')
        .order('role')
        .order('nickname');
      if (error) throw error;
      return { success: true, data: data || [] };
    }

    // ── Attendance ────────────────────────────────────────────────
    async function doGetAttendance(d) {
      var bandId   = d.bandId || getBandId();
      var year     = d.year   || String(new Date().getFullYear());
      var page     = Math.max(1, parseInt(d.page)     || 1);
      var pageSize = Math.min(200, parseInt(d.pageSize) || 50);

      var q = sb.from('attendance_payroll').select('*', { count: 'exact' })
        .eq('band_id', bandId)
        .order('date', { ascending: false });

      if (year && year !== 'all') q = q.like('date', year + '%');
      if (d.startDate) q = q.gte('date', d.startDate);
      if (d.endDate)   q = q.lte('date', d.endDate);

      var from = (page - 1) * pageSize;
      q = q.range(from, from + pageSize - 1);

      var { data, error, count } = await q;
      if (error) throw error;
      var totalPages = Math.ceil((count || 0) / pageSize) || 1;
      return { success: true, data: toCamelList(data), total: count, page: page, pageSize: pageSize, totalPages: totalPages, year: year };
    }

    // ── Leave Request ─────────────────────────────────────────────
    async function doRequestLeave(d) {
      var { data: authUser } = await sb.auth.getUser();
      var memberId = d.memberId || (authUser && authUser.user && authUser.user.id) || '';
      var memberName = d.memberName || '';
      if (!memberName && authUser && authUser.user) {
        var meta = authUser.user.user_metadata || {};
        memberName = meta.nickname || meta.first_name || authUser.user.email || '';
      }
      var row = {
        band_id: d.bandId || getBandId(),
        member_id: memberId,
        member_name: memberName,
        date: d.date || new Date().toISOString().slice(0, 10),
        venue: d.venue || '',
        slots: d.slots || '[]',
        reason: d.reason || 'ลางาน',
        substitute_name: d.substituteName || '',
        substitute_contact: d.substituteContact || '',
        status: 'pending'
      };
      var { data, error } = await sb.from('leave_requests').insert(row).select().single();
      if (error) throw error;

      // ── Auto check-in as "leave" so no separate check-in needed ──
      var slotsArr = [];
      try { slotsArr = typeof row.slots === 'string' ? JSON.parse(row.slots || '[]') : (row.slots || []); } catch(e){}
      var ciRow = {
        band_id:     row.band_id,
        member_id:   row.member_id,
        member_name: row.member_name,
        date:        row.date,
        venue:       row.venue || '',
        slots:       slotsArr,
        check_in_at: new Date().toISOString(),
        status:      'leave',
        notes:       row.reason + (row.substitute_name ? ' | คนแทน: ' + row.substitute_name : ''),
        substitute:  row.substitute_name ? { name: row.substitute_name, contact: row.substitute_contact || '' } : null
      };
      var { data: existCI } = await sb.from('member_check_ins')
        .select('id').eq('band_id', ciRow.band_id)
        .eq('member_id', ciRow.member_id).eq('date', ciRow.date).limit(1);
      if (existCI && existCI.length > 0) {
        await sb.from('member_check_ins').update(ciRow).eq('id', existCI[0].id);
      } else {
        await sb.from('member_check_ins').insert(ciRow);
      }

      return { success: true, data: toCamel(data) };
    }

    // ── Check-in ──────────────────────────────────────────────────
    async function doMemberCheckIn(d) {
      var { data: authUser } = await sb.auth.getUser();
      var memberId = d.memberId || (authUser && authUser.user && authUser.user.id) || '';
      if (!memberId) return { success: false, message: 'ไม่พบข้อมูลผู้ใช้ กรุณาล็อกอินใหม่' };
      var dateStr = d.date || new Date().toISOString().slice(0, 10);
      var bandId = d.bandId || getBandId();

      var { data: exist } = await sb.from('member_check_ins')
        .select('id').eq('band_id', bandId)
        .eq('member_id', memberId).eq('date', dateStr).limit(1);
      // Substitute info
      var subInfo = null;
      if (d.isSubstitute && d.substituteName) {
        subInfo = { name: d.substituteName, contact: d.substituteContact || '' };
      }

      if (exist && exist.length > 0) {
        // อัปเดตแทน insert ถ้ามีอยู่แล้ว
        var upPayload = {
          venue:       d.venue || '',
          slots:       d.slots || [],
          status:      'pending',
          check_in_at: new Date().toISOString()
        };
        if (subInfo) upPayload.substitute = subInfo;
        if (d.notes) upPayload.notes = d.notes;
        var { error: upErr } = await sb.from('member_check_ins').update(upPayload).eq('id', exist[0].id);
        if (upErr) throw upErr;
        return { success: true, message: subInfo ? 'ลงเวลาแทน ' + subInfo.name + ' เรียบร้อย' : 'อัปเดตเวลาเรียบร้อย' };
      }

      var insertPayload = {
        band_id:     bandId,
        member_id:   memberId,
        member_name: d.memberName || localStorage.getItem('userName') || '',
        date:        dateStr,
        venue:       d.venue || '',
        slots:       d.slots || [],
        check_in_at: new Date().toISOString(),
        status:      'pending'
      };
      if (subInfo) insertPayload.substitute = subInfo;
      if (d.notes) insertPayload.notes = d.notes;
      var { data, error } = await sb.from('member_check_ins').insert(insertPayload).select().single();
      if (error) throw error;
      return { success: true, data: toCamel(data) };
    }

    async function doGetMyCheckIn(d) {
      var { data: authUser } = await sb.auth.getUser();
      var memberId = d.memberId || (authUser && authUser.user && authUser.user.id) || '';
      if (!memberId) return { success: false };
      var dateStr = d.date || new Date().toISOString().slice(0, 10);
      var bandId = d.bandId || getBandId();
      var { data } = await sb.from('member_check_ins')
        .select('*').eq('band_id', bandId)
        .eq('member_id', memberId).eq('date', dateStr).limit(1);
      if (data && data.length > 0) {
        var row = toCamel(data[0]);
        return { success: true, checkIn: { id: row.id, venue: row.venue || '', slots: row.slots || [], status: row.status || 'pending', notes: row.notes || '', checkInAt: row.checkInAt || '', substitute: row.substitute || null } };
      }
      return { success: false };
    }

    async function doCancelCheckIn(d) {
      var { data: authUser } = await sb.auth.getUser();
      var memberId = d.memberId || (authUser && authUser.user && authUser.user.id) || '';
      if (!memberId) return { success: false, message: 'ไม่พบข้อมูลผู้ใช้' };
      var dateStr = d.date || new Date().toISOString().slice(0, 10);
      var bandId = d.bandId || getBandId();
      var { error } = await sb.from('member_check_ins')
        .delete().eq('band_id', bandId)
        .eq('member_id', memberId).eq('date', dateStr);
      if (error) throw error;
      // Also delete any leave_requests for same date
      await sb.from('leave_requests')
        .delete().eq('band_id', bandId)
        .eq('member_id', memberId).eq('date', dateStr);
      return { success: true, message: 'ยกเลิกการลงเวลาเรียบร้อย' };
    }

    // ── Schedule ──────────────────────────────────────────────────
    async function doGetSchedule(d) {
      var bandId = d.bandId || getBandId();
      var year   = d.year   || String(new Date().getFullYear());
      var q = sb.from('schedule').select('*').eq('band_id', bandId).order('date');
      if (year && year !== 'all') q = q.like('date', year + '%');
      var { data, error } = await q.limit(500);
      if (error) throw error;
      return { success: true, data: toCamelList(data) };
    }

    async function doSaveSchedule(d) {
      var bandId = d.bandId || getBandId();
      var items  = d.scheduleData || [];
      // ลบของเดิม
      await sb.from('schedule').delete().eq('band_id', bandId);
      // insert ใหม่
      if (items.length > 0) {
        var rows = items.map(function (item) {
          return Object.assign({ band_id: bandId }, toSnakeObj(item));
        });
        var { error } = await sb.from('schedule').insert(rows);
        if (error) throw error;
      }
      return { success: true, message: 'บันทึกตารางงานเรียบร้อย' };
    }

    // ── Band Settings ─────────────────────────────────────────────
    // ── Dashboard Summary ─────────────────────────────────────────
    async function doGetDashboardSummary() {
      var bandId = getBandId();
      var today = new Date().toISOString().split('T')[0];
      var firstOfMonth = today.substring(0, 7) + '-01';

      var [memberRes, jobRes, upcomingRes, quotRes, finRes] = await Promise.all([
        sb.from('band_members').select('id', { count: 'exact', head: true }).eq('band_id', bandId),
        sb.from('schedule').select('id,venue_name,date,type').eq('band_id', bandId).gte('date', today).order('date', { ascending: true }).limit(5),
        sb.from('schedule').select('id', { count: 'exact', head: true }).eq('band_id', bandId).gte('date', today),
        sb.from('quotations').select('id', { count: 'exact', head: true }).eq('band_id', bandId),
        sb.from('attendance_payroll').select('total_amount').eq('band_id', bandId).gte('date', firstOfMonth)
      ]);

      var income = 0;
      (finRes.data || []).forEach(function(r) { income += (r.total_amount || 0); });

      // fund/expense: future tables; use 0 for now
      return {
        success: true,
        data: {
          memberCount:    memberRes.count  || 0,
          upcomingJobs:   upcomingRes.count || 0,
          revenueMonth:   income,
          quotationCount: quotRes.count    || 0,
          jobs: (jobRes.data || []).map(function(j) {
            return { date: j.date, venue: j.venue_name || '', band: '', type: j.type || '' };
          }),
          finance: { income: income, expense: 0, fund: 0 }
        }
      };
    }

    async function doGetBandSettings(bandId) {
      var { data } = await sb.from('band_settings').select('settings').eq('band_id', bandId || getBandId()).single();
      return { success: true, data: (data && data.settings) || {} };
    }

    async function doSaveBandSettings(d) {
      var bandId = d.bandId || getBandId();
      var settings = Object.assign({}, d);
      delete settings.bandId; delete settings.action; delete settings._token;
      var { error } = await sb.from('band_settings').upsert({ band_id: bandId, settings: settings, updated_at: new Date().toISOString() }, { onConflict: 'band_id' });
      if (error) throw error;
      // Sync band_name to profiles so dashboard shows correct name after next login
      if (d.bandName) {
        var { data: authUser } = await sb.auth.getUser();
        if (authUser && authUser.user) {
          await sb.from('profiles').update({ band_name: d.bandName }).eq('id', authUser.user.id);
        }
        localStorage.setItem('bandName', d.bandName);
      }
      return { success: true };
    }

    // ── Band Code (รหัสประจำวง) ─────────────────────────────────
    async function doGetBandCode(d) {
      var bandId = d.bandId || getBandId();
      var { data, error } = await sb.from('invite_codes')
        .select('code')
        .eq('band_id', bandId)
        .eq('status', 'permanent')
        .limit(1)
        .maybeSingle();
      if (error) throw error;
      if (data && data.code) {
        return { success: true, code: data.code };
      }
      return { success: false };
    }

    async function doGenerateInviteCode(d) {
      var bandId   = d.bandId   || getBandId();
      var bandName = d.bandName || localStorage.getItem('bandName') || '';
      var province = d.province || localStorage.getItem('bandProvince') || '';
      var { data, error } = await sb.rpc('generate_band_code', {
        p_band_id:   bandId,
        p_band_name: bandName,
        p_province:  province
      });
      if (error) throw error;
      return { success: true, data: data };
    }

    async function doLookupInviteCode(d) {
      var code = (d.code || '').toUpperCase();
      if (!code) return { success: false, message: 'ไม่มีรหัส' };
      var { data, error } = await sb.rpc('lookup_invite_code', { p_code: code });
      if (error) return { success: false, message: error.message };
      if (!data || !data.success) return { success: false, message: (data && data.message) || 'รหัสวงไม่ถูกต้อง' };
      return { success: true, band_name: data.band_name, province: data.province, member_count: data.member_count };
    }

    // ── Band Requests (ขอสร้างวงใหม่) ─────────────────────────
    async function doSubmitBandRequest(d) {
      return doRegisterBandRequest(d);
    }

    async function doGetPendingBandRequests() {
      var { data, error } = await sb.rpc('get_pending_band_requests');
      if (error) throw error;
      return { success: true, data: data || [] };
    }

    async function doApproveBandRequest(d) {
      var { data, error } = await sb.rpc('approve_band_request', {
        p_request_id: d.requestId
      });
      if (error) throw error;
      return data;
    }

    async function doRejectBandRequest(d) {
      var { data, error } = await sb.rpc('reject_band_request', {
        p_request_id: d.requestId,
        p_notes: d.notes || ''
      });
      if (error) throw error;
      return data;
    }

    async function doGetMyBandRequest() {
      var { data: authUser } = await sb.auth.getUser();
      if (!authUser || !authUser.user) return { success: false };
      var { data, error } = await sb.from('band_requests')
        .select('*')
        .eq('requester_id', authUser.user.id)
        .order('created_at', { ascending: false })
        .limit(1)
        .maybeSingle();
      if (error) throw error;
      return { success: true, data: data ? toCamel(data) : null };
    }

    // ── Pending Members (อนุมัติสมาชิก) ──────────────────────────
    async function doGetPendingMembers(d) {
      var bandId = d.bandId || getBandId();
      var { data, error } = await sb.rpc('get_pending_members', { p_band_id: bandId });
      if (error) throw error;
      return { success: true, data: data || [] };
    }

    async function doApproveMember(d) {
      var bandId = d.bandId || getBandId();
      var { data, error } = await sb.rpc('approve_member', { p_user_id: d.userId, p_band_id: bandId });
      if (error) throw error;
      return data;
    }

    async function doRejectMember(d) {
      var bandId = d.bandId || getBandId();
      var { data, error } = await sb.rpc('reject_member', { p_user_id: d.userId, p_band_id: bandId });
      if (error) throw error;
      return data;
    }

    // ── Password Reset ──────────────────────────────────────────
    async function doRequestPasswordReset(d) {
      var email = (d.email || '').trim();
      if (!email) return { success: false, message: 'กรุณากรอกอีเมล' };
      var siteUrl = window.location.origin + window.location.pathname.replace(/[^/]*$/, '');
      var { error } = await sb.auth.resetPasswordForEmail(email, {
        redirectTo: siteUrl + 'index.html'
      });
      if (error) return { success: false, message: error.message };
      return { success: true, message: 'ส่งอีเมลรีเซ็ตรหัสผ่านแล้ว กรุณาตรวจสอบกล่องจดหมาย' };
    }

    async function doResetPassword(d) {
      var newPassword = (d.newPassword || '').trim();
      if (!newPassword || newPassword.length < 6) return { success: false, message: 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร' };
      var { error } = await sb.auth.updateUser({ password: newPassword });
      if (error) return { success: false, message: error.message };
      return { success: true, message: 'เปลี่ยนรหัสผ่านเรียบร้อย' };
    }

    // ── Lookup Email (ลืมอีเมล) ──────────────────────────────────
    async function doLookupEmail(d) {
      var name  = (d.name  || '').trim().toLowerCase();
      var phone = (d.phone || '').trim().replace(/[^0-9]/g, '');
      if (!name && !phone) return { success: false, message: 'กรุณากรอกชื่อหรือเบอร์โทร' };
      var { data, error } = await sb.rpc('lookup_email', { p_name: name, p_phone: phone });
      if (error) return { success: false, message: error.message };
      if (!data || data.length === 0) return { success: false, message: 'ไม่พบข้อมูลที่ตรงกัน กรุณาตรวจสอบอีกครั้ง' };
      return { success: true, results: data };
    }

    // ── Profile ───────────────────────────────────────────────────
    async function doGetMyProfile() {
      var { data: user } = await sb.auth.getUser();
      if (!user || !user.user) return { success: false, message: 'ไม่ได้ login' };
      var { data, error } = await sb.from('profiles').select('*').eq('id', user.user.id).single();
      if (error) throw error;
      return { success: true, data: toCamel(data) };
    }

    async function doUpdateMyProfile(d) {
      var { data: user } = await sb.auth.getUser();
      if (!user || !user.user) return { success: false, message: 'ไม่ได้ login' };
      var uid = user.user.id;

      var row = {
        title:           d.title          || '',
        first_name:      d.firstName      || '',
        last_name:       d.lastName       || '',
        nickname:        d.nickname        || '',
        instrument:      d.instrument      || '',
        phone:           d.phone           || '',
        id_card_number:  d.idCardNumber    || '',
        birth_date:      d.birthDate       || null,
        id_card_address: d.idCardAddress   || '',
        updated_at: new Date().toISOString()
      };
      if (d.nickname) row.user_name = d.nickname;

      var { data, error } = await sb.from('profiles').update(row).eq('id', uid).select().single();
      if (error) throw error;

      localStorage.setItem('userTitle',      row.title);
      localStorage.setItem('userFirstName',  row.first_name);
      localStorage.setItem('userLastName',   row.last_name);
      localStorage.setItem('userNickname',   row.nickname);
      localStorage.setItem('userInstrument', row.instrument);
      if (d.nickname) localStorage.setItem('userName', d.nickname);

      return { success: true, data: toCamel(data), message: 'บันทึกข้อมูลส่วนตัวเรียบร้อย' };
    }

    async function doChangeEmail(d) {
      if (!d.email) return { success: false, message: 'กรุณาระบุอีเมลใหม่' };
      var { data, error } = await sb.auth.updateUser({ email: d.email });
      if (error) throw error;
      return { success: true, message: 'ส่งลิงก์ยืนยันไปยังอีเมลใหม่แล้ว กรุณาตรวจสอบกล่องจดหมาย' };
    }

    async function doChangePassword(d) {
      if (!d.password || d.password.length < 6) return { success: false, message: 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร' };
      var { data, error } = await sb.auth.updateUser({ password: d.password });
      if (error) throw error;
      return { success: true, message: 'เปลี่ยนรหัสผ่านเรียบร้อยแล้ว' };
    }

    // ── Admin ─────────────────────────────────────────────────────
    async function doAdminGetAllUsers() {
      var { data, error } = await sb.from('profiles').select('*').order('email');
      if (error) throw error;
      return { success: true, data: toCamelList(data) };
    }

    async function doAdminDeleteUser(userId) {
      // ลบ profile (cascade ลบ auth user ด้วย)
      var { error } = await sb.from('profiles').delete().eq('id', userId);
      if (error) throw error;
      return { success: true };
    }

    async function doGetSystemInfo() {
      var [u, m, s, sg] = await Promise.all([
        sb.from('profiles').select('id', { count: 'exact', head: true }),
        sb.from('band_members').select('id', { count: 'exact', head: true }),
        sb.from('schedule').select('id', { count: 'exact', head: true }),
        sb.from('band_songs').select('id', { count: 'exact', head: true })
      ]);
      return { success: true, data: {
        userCount:     u.count || 0,
        memberCount:   m.count || 0,
        scheduleCount: s.count || 0,
        songCount:     sg.count || 0,
        serverTime:    new Date().toISOString()
      }};
    }

    // ── Setlist ─────────────────────────────────────────────────
    async function doGetSetlist(d) {
      var bandId = d.bandId || getBandId();
      var { data, error } = await sb.from('setlists')
        .select('*').eq('band_id', bandId)
        .order('created_at', { ascending: false }).limit(1).maybeSingle();
      if (error) throw error;
      return { success: true, data: (data && data.sets_data) || null };
    }

    async function doSaveSetlist(d) {
      var bandId = d.bandId || getBandId();
      // upsert: one active setlist per band
      var { error } = await sb.from('setlists').upsert({
        band_id:    bandId,
        sets_data:  d.sets || {},
        updated_at: new Date().toISOString()
      }, { onConflict: 'band_id' });
      if (error) throw error;
      return { success: true, message: 'บันทึก Setlist เรียบร้อย' };
    }

    // ── Band Fund (กองกลาง) ──────────────────────────────────────
    async function doGetFundTransactions(d) {
      var bandId = d.bandId || getBandId();
      var { data, error } = await sb.from('fund_transactions')
        .select('*').eq('band_id', bandId).order('date', { ascending: false });
      if (error) throw error;
      var rows = toCamelList(data || []);
      var balance = 0;
      (data || []).forEach(function(r) {
        if (r.type === 'income') balance += (r.amount || 0);
        else balance -= (r.amount || 0);
      });
      return { success: true, data: { transactions: rows, balance: balance } };
    }

    async function doAddFundTransaction(d) {
      var bandId = d.bandId || getBandId();
      var row = {
        band_id:     bandId,
        type:        d.type || 'income',
        amount:      parseFloat(d.amount) || 0,
        date:        d.date || new Date().toISOString().slice(0, 10),
        category:    d.category || '',
        description: d.description || ''
      };
      var { data, error } = await sb.from('fund_transactions').insert(row).select().single();
      if (error) throw error;
      return { success: true, data: toCamel(data) };
    }

    async function doDeleteFundTransaction(d) {
      return doDelete('fund_transactions', d.txId);
    }

    // ── Statistics ────────────────────────────────────────────────
    async function doGetStatistics(d) {
      var bandId = d.bandId || getBandId();
      var year   = d.year || new Date().getFullYear();
      var startDate = year + '-01-01';
      var endDate   = year + '-12-31';

      // Fetch schedule + attendance + fund in parallel
      var [jobsRes, attRes, fundRes, memberRes] = await Promise.all([
        sb.from('schedule').select('*').eq('band_id', bandId).gte('date', startDate).lte('date', endDate),
        sb.from('attendance_payroll').select('*').eq('band_id', bandId).gte('date', startDate).lte('date', endDate),
        sb.from('fund_transactions').select('*').eq('band_id', bandId).gte('date', startDate).lte('date', endDate),
        sb.from('band_members').select('id,name,position').eq('band_id', bandId)
      ]);

      var jobs = jobsRes.data || [];
      var att  = attRes.data || [];
      var fund = fundRes.data || [];

      // Filter by month if specified
      var filteredJobs = jobs;
      var filteredAtt = att;
      var filteredFund = fund;
      if (d.month) {
        var mStr = String(d.month).padStart(2, '0');
        var prefix = year + '-' + mStr;
        filteredJobs = jobs.filter(function(j) { return (j.date || '').startsWith(prefix); });
        filteredAtt = att.filter(function(a) { return (a.date || '').startsWith(prefix); });
        filteredFund = fund.filter(function(f) { return (f.date || '').startsWith(prefix); });
      }

      var totalIncome = 0, totalExpense = 0;
      filteredFund.forEach(function(f) {
        if (f.type === 'income') totalIncome += (f.amount || 0);
        else totalExpense += (f.amount || 0);
      });
      // Also count payroll
      filteredAtt.forEach(function(a) {
        totalIncome += (a.total_amount || 0);
      });

      // By month breakdown (always full year)
      var byMonth = [];
      for (var m = 0; m < 12; m++) {
        var mp = String(m + 1).padStart(2, '0');
        var pf = year + '-' + mp;
        var mi = 0;
        fund.filter(function(f) { return (f.date||'').startsWith(pf) && f.type === 'income'; })
          .forEach(function(f) { mi += (f.amount || 0); });
        att.filter(function(a) { return (a.date||'').startsWith(pf); })
          .forEach(function(a) { mi += (a.total_amount || 0); });
        byMonth.push({ income: mi });
      }

      // By type
      var typeCounts = {};
      filteredJobs.forEach(function(j) {
        var t = j.type || 'อื่นๆ';
        typeCounts[t] = (typeCounts[t] || 0) + 1;
      });
      var byType = Object.keys(typeCounts).map(function(k) { return { type: k, count: typeCounts[k] }; });

      // Top members
      var memberEarnings = {};
      filteredAtt.forEach(function(a) {
        var name = a.member_name || 'ไม่ระบุ';
        if (!memberEarnings[name]) memberEarnings[name] = { name: name, position: '', jobCount: 0, totalEarned: 0 };
        memberEarnings[name].jobCount++;
        memberEarnings[name].totalEarned += (a.total_amount || 0);
      });
      var topMembers = Object.values(memberEarnings).sort(function(a, b) { return b.totalEarned - a.totalEarned; }).slice(0, 10);

      return {
        success: true,
        data: {
          totalJobs:    filteredJobs.length,
          totalIncome:  totalIncome,
          totalExpense: totalExpense,
          byMonth:      byMonth,
          byType:       byType,
          topMembers:   topMembers
        }
      };
    }

    // ── Quotation PDF (client-side) ──────────────────────────────
    async function doGenerateQuotationPdf(d) {
      // Fetch quotation data
      var { data, error } = await sb.from('quotations').select('*').eq('id', d.quotationId).single();
      if (error || !data) return { success: false, message: 'ไม่พบใบเสนอราคา' };
      // Generate simple printable page
      var q = toCamel(data);
      var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>ใบเสนอราคา</title>'
        + '<style>body{font-family:Sarabun,sans-serif;padding:40px}table{width:100%;border-collapse:collapse;margin:20px 0}'
        + 'th,td{border:1px solid #ccc;padding:8px;text-align:left}th{background:#f5f5f5}.total{font-size:1.3em;font-weight:bold;text-align:right;margin-top:20px}</style></head>'
        + '<body><h1>ใบเสนอราคา</h1>'
        + '<p><strong>ลูกค้า:</strong> ' + (q.clientName || '-') + '</p>'
        + '<p><strong>วันที่:</strong> ' + (q.date || '-') + '</p>'
        + '<p><strong>รายละเอียด:</strong> ' + (q.description || '-') + '</p>'
        + '<p class="total">รวมทั้งสิ้น: ฿' + (q.totalAmount || q.amount || 0).toLocaleString() + '</p>'
        + '<p style="margin-top:40px;text-align:center;color:#888">Band Management By SoulCiety</p>'
        + '</body></html>';
      var blob = new Blob([html], { type: 'text/html' });
      var url = URL.createObjectURL(blob);
      return { success: true, url: url };
    }

    // ── Restore session จาก Supabase ─────────────────────────────
    sb.auth.onAuthStateChange(function (event, session) {
      if (event === 'SIGNED_IN' && session) {
        localStorage.setItem('auth_token', session.access_token);
      }
      if (event === 'SIGNED_OUT') {
        clearSession();
      }
      if (event === 'TOKEN_REFRESHED' && session) {
        localStorage.setItem('auth_token', session.access_token);
      }
    });

    console.log('[SoulCiety] Supabase API พร้อมใช้งาน');
  }); // end waitForSDK

})(window);
