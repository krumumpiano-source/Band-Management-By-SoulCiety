<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ตั้งค่าวง — Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <style>
    /* ── Band Info / Members ───────────────────── */
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-md)}
    @media(max-width:600px){.info-grid{grid-template-columns:1fr}}
    .invite-box{background:linear-gradient(135deg,#1a202c,#2d3748);border:1px solid var(--premium-gold);border-radius:var(--radius-lg);padding:var(--spacing-lg);margin-top:var(--spacing-md)}
    .invite-code-display{font-family:monospace;font-size:2rem;font-weight:700;letter-spacing:.25em;color:var(--premium-gold);text-align:center;padding:14px;background:#111827;border-radius:var(--radius-md);margin:var(--spacing-md) 0;cursor:pointer;user-select:all;transition:background .15s}
    .invite-code-display:hover{background:#1f2937}
    .invite-code-display.empty{font-size:var(--text-sm);color:#4b5563;letter-spacing:normal;font-weight:400;font-family:inherit}
    .invite-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .invite-hint{font-size:var(--text-xs);color:#6b7280;text-align:center;margin-top:8px}
    .invite-expires{font-size:var(--text-xs);color:#9ca3af;text-align:center;margin-top:2px;min-height:16px}
    .member-item{display:flex;align-items:flex-end;gap:var(--spacing-md);padding:var(--spacing-md);background:var(--premium-off-white);border-radius:var(--radius-md);margin-bottom:var(--spacing-sm);flex-wrap:wrap}
    .member-item .form-group{flex:1;min-width:130px;margin-bottom:0}
    .member-remove{padding:8px 12px;background:#e53e3e;color:#fff;border:none;border-radius:var(--radius-sm);cursor:pointer;font-size:15px;flex-shrink:0;align-self:flex-end}
    /* ── Venue Names (simplified) ──────────────── */
    .vn-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .vn-num{width:24px;text-align:center;font-weight:700;color:var(--premium-gold);flex-shrink:0;font-size:var(--text-sm)}
    .vn-input{flex:1;padding:8px 12px;border:1px solid #e2e8f0;border-radius:var(--radius-sm);font-size:var(--text-sm);font-family:inherit;background:var(--premium-white)}
    .vn-input:focus{border-color:var(--premium-gold);outline:none;box-shadow:0 0 0 3px rgba(249,207,69,.2)}
    .vn-del{padding:6px 10px;background:#e53e3e;color:#fff;border:none;border-radius:var(--radius-sm);cursor:pointer;flex-shrink:0;font-size:13px}
    /* ── Payroll Settings ──────────────────────── */
    .payroll-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:var(--spacing-sm)}
    .payroll-row label{font-weight:600;font-size:var(--text-sm);white-space:nowrap;color:var(--premium-text)}
    .payroll-row select{padding:8px 12px;border:1px solid #e2e8f0;border-radius:var(--radius-sm);font-family:inherit;font-size:var(--text-sm);background:var(--premium-white)}
    /* ── Schedule Grid (Horizontal) ────────────── */
    .sg-outer{border:1px solid #e2e8f0;border-radius:var(--radius-md);background:var(--premium-white);overflow:hidden}
    .sg-grid{width:100%;border-collapse:collapse;table-layout:fixed;display:block}
    .sg-header-row{display:flex;align-items:stretch;background:linear-gradient(135deg,#1a202c,#2d3748);border-bottom:2px solid var(--premium-gold)}
    .sg-corner{width:80px;min-width:80px;flex-shrink:0;border-right:1px solid #374151;display:flex;align-items:center;justify-content:center;height:36px;font-size:10px;color:#6b7280}
    .sg-time-axis{position:relative;flex:1;height:36px;overflow:visible}
    .sg-tick{position:absolute;transform:translateX(-50%);font-size:11px;color:#9ca3af;top:9px;white-space:nowrap;user-select:none;font-weight:600}
    .sg-tick-line{position:absolute;top:26px;bottom:-2px;width:1px;background:rgba(249,207,69,.35);pointer-events:none}
    .sg-row{display:flex;align-items:stretch;border-bottom:1px solid #e8ecf0}
    .sg-row:last-child{border-bottom:none}
    .sg-day-label{width:80px;min-width:80px;flex-shrink:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:14px;font-weight:700;background:linear-gradient(180deg,#1a202c 0%,#2d3748 100%);color:#f3f4f6;border-right:1px solid #374151;min-height:80px;gap:2px}
    .sg-day-sub{font-size:9px;font-weight:400;color:#9ca3af;letter-spacing:.05em}
    .sg-track{position:relative;flex:1;min-height:80px;cursor:pointer;background:#fafafa;transition:background .12s;overflow:hidden}
    .sg-track:hover{background:#f3f0ea}
    .sg-hour-line{position:absolute;top:0;bottom:0;width:1px;background:#e2e8f0;pointer-events:none;z-index:0}
    .sg-hour-line.half{background:#efefef;opacity:.7}
    .sg-slot{position:absolute;top:6px;bottom:6px;border-radius:7px;padding:5px 9px;overflow:hidden;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.18);z-index:2;transition:filter .15s,box-shadow .15s,transform .1s;user-select:none;display:flex;flex-direction:column;justify-content:center;gap:1px;min-width:16px}
    .sg-slot:hover{filter:brightness(1.08);z-index:5;box-shadow:0 4px 14px rgba(0,0,0,.28);transform:translateY(-1px)}
    .sg-slot:active{transform:translateY(0)}
    .sg-slot-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;font-weight:800;letter-spacing:0.01em;line-height:1.2}
    .sg-slot-time{font-size:12px;opacity:.95;white-space:nowrap;font-weight:600;line-height:1.2}
    .sg-slot-members{font-size:11px;opacity:.8;white-space:nowrap;line-height:1.2}
    .sg-track-hint{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:11px;color:#c0cad8;pointer-events:none;user-select:none;letter-spacing:.02em}
    .sg-legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:var(--spacing-md)}
    .sg-legend-item{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--premium-text);font-weight:500}
    .sg-legend-dot{width:14px;height:14px;border-radius:4px;flex-shrink:0;box-shadow:0 1px 3px rgba(0,0,0,.15)}
    .sg-empty{text-align:center;padding:40px 16px;color:var(--premium-text-muted);font-size:var(--text-sm)}
    /* ── Modals ─────────────────────────────────── */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:1000;align-items:center;justify-content:center;padding:16px}
    .modal-box{background:var(--premium-white);border-radius:var(--radius-lg);padding:var(--spacing-xl);max-width:500px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.4)}
    .modal-title{font-size:var(--text-lg);font-weight:700;margin-bottom:var(--spacing-lg);display:flex;align-items:center;gap:8px;color:var(--premium-text)}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;padding-top:var(--spacing-md);border-top:1px solid #e2e8f0;margin-top:var(--spacing-md);flex-wrap:wrap}
    .sd-member-row{display:flex;align-items:center;gap:6px;margin-bottom:0;flex-wrap:wrap;padding:8px 10px;background:var(--premium-off-white);border-radius:0}
    .sd-member-row select,.sd-member-row input{padding:7px 10px;border:1px solid #e2e8f0;border-radius:var(--radius-sm);font-size:var(--text-sm);font-family:inherit;background:var(--premium-white)}
    .sd-member-row select.sd-m-sel{flex:1;min-width:130px}
    .sd-member-row input.sd-m-rate{width:85px;min-width:60px;flex-shrink:0}
    .sd-member-row select.sd-m-rtype{min-width:100px}
    .sd-m-check-label{display:flex;align-items:center;gap:7px;cursor:pointer;flex:1;min-width:130px;padding:0}
    .sd-m-check-label input[type=checkbox]{width:17px;height:17px;cursor:pointer;accent-color:var(--premium-gold);flex-shrink:0}
    .sd-m-name{font-size:var(--text-sm);color:var(--premium-text);transition:all .15s;white-space:nowrap}
    .sd-m-pos{font-size:11px;color:var(--premium-text-muted);font-weight:400}
    .sd-m-del{padding:5px 9px;background:#e53e3e;color:#fff;border:none;border-radius:var(--radius-sm);cursor:pointer;flex-shrink:0;font-size:13px}
    .bulk-rate-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px;background:rgba(249,207,69,.08);border:1px solid rgba(249,207,69,.3);border-radius:var(--radius-sm);margin-bottom:var(--spacing-md)}
    .bulk-rate-row label{font-size:var(--text-xs);font-weight:600;color:var(--premium-text-muted);white-space:nowrap}
    .bulk-rate-row input,.bulk-rate-row select{padding:6px 10px;border:1px solid #e2e8f0;border-radius:var(--radius-sm);font-size:var(--text-sm);font-family:inherit}
    .empty-state-small{color:var(--premium-text-muted);font-size:var(--text-sm);margin:6px 0}
    /* ── Member block ─────────────────────────── */
    .sd-member-block{border:1px solid #e2e8f0;border-radius:var(--radius-sm);margin-bottom:8px;overflow:hidden}
    .sd-member-block .sd-member-row{border-radius:0;margin-bottom:0;background:var(--premium-white)}
    /* ── Toast ─────────────────────────────────── */
    #toast{display:none;position:fixed;bottom:24px;right:24px;background:var(--premium-gold);color:#1a202c;padding:12px 20px;border-radius:var(--radius-md);z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.25);font-weight:600}
    #toast.toast-error{background:#e53e3e;color:#fff}
    #toast.toast-success{background:#38a169;color:#fff}
    #toast.show{display:block}
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-md)}
    @media(max-width:600px){.info-grid{grid-template-columns:1fr}}

    /* Invite code */
    .invite-box{background:linear-gradient(135deg,#1a202c,#2d3748);border:1px solid var(--premium-gold);border-radius:var(--radius-lg);padding:var(--spacing-lg);margin-top:var(--spacing-md)}
    .invite-code-display{font-family:monospace;font-size:2rem;font-weight:700;letter-spacing:.25em;color:var(--premium-gold);text-align:center;padding:14px;background:#111827;border-radius:var(--radius-md);margin:var(--spacing-md) 0;cursor:pointer;user-select:all;transition:background .15s}
    .invite-code-display:hover{background:#1f2937}
    .invite-code-display.empty{font-size:var(--text-sm);color:#4b5563;letter-spacing:normal;font-weight:400;font-family:inherit}
    .invite-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .invite-hint{font-size:var(--text-xs);color:#6b7280;text-align:center;margin-top:8px}
    .invite-expires{font-size:var(--text-xs);color:#9ca3af;text-align:center;margin-top:2px;min-height:16px}

    /* Members */
    .member-item{display:flex;align-items:flex-end;gap:var(--spacing-md);padding:var(--spacing-md);background:var(--premium-off-white);border-radius:var(--radius-md);margin-bottom:var(--spacing-sm);flex-wrap:wrap}
    .member-item .form-group{flex:1;min-width:130px;margin-bottom:0}
    .member-remove{padding:8px 12px;background:#e53e3e;color:#fff;border:none;border-radius:var(--radius-sm);cursor:pointer;font-size:15px;flex-shrink:0;align-self:flex-end}

    /* Venue accordion — ① ร้าน → ② วัน → ③ เวลา → ④ สมาชิก */
</style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"><span class="toast-message"></span></div>
  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">⚙️ ตั้งค่าวง</h1>
        <button id="saveBtn" class="btn btn-primary">💾 บันทึกทั้งหมด</button>
      </div>

      <!-- Band Info -->
      <div class="card">
        <div class="card-header" style="justify-content:space-between">
          <h3 class="card-title">🎵 ข้อมูลวง</h3>
          <button type="button" class="btn btn-primary btn-sm" onclick="saveBandInfo(this)">💾 บันทึก</button>
        </div>
        <div class="info-grid">
          <div class="form-group"><label>ชื่อวง</label><input type="text" id="bandName" placeholder="ชื่อวงดนตรี"></div>
          <div class="form-group"><label>ผู้จัดการวง</label><input type="text" id="bandManager" placeholder="ชื่อผู้จัดการวง"></div>
        </div>
      </div>

      <!-- Members + Invite Code -->
      <div class="card">
        <div class="card-header" style="justify-content:space-between">
          <h3 class="card-title">👥 สมาชิกวง</h3>
          <div style="display:flex;gap:8px">
            <button id="addMemberBtn" class="btn btn-secondary btn-sm">➕ เพิ่มสมาชิก</button>
            <button type="button" class="btn btn-primary btn-sm" onclick="saveMembers(this)">💾 บันทึก</button>
          </div>
        </div>
        <div id="noMembers" style="display:none"><p class="empty-state-small">ยังไม่มีสมาชิก กดปุ่ม ➕ เพื่อเพิ่ม</p></div>
        <div id="membersList"></div>
        <div class="invite-box">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:4px">
            <div>
              <div style="font-weight:700;color:var(--premium-gold);font-size:var(--text-sm)">🔑 รหัสประจำวง</div>
              <div style="font-size:var(--text-xs);color:#9ca3af;margin-top:2px">แชร์รหัสนี้ให้สมาชิกใช้ในหน้าสมัครเพื่อขอเข้าร่วมวง</div>
            </div>
          </div>
          <div id="inviteCodeDisplay" class="invite-code-display empty" title="คลิกเพื่อคัดลอก" onclick="copyBandCode()">ยังไม่มีรหัสประจำวง</div>
          <div class="invite-actions">
            <button type="button" class="btn btn-sm btn-secondary" id="genInviteBtn" onclick="generateBandCode()">🔑 สร้างรหัสประจำวง</button>
            <button type="button" class="btn btn-sm btn-primary" id="copyInviteBtn" style="display:none" onclick="copyBandCode()">📋 คัดลอก</button>
          </div>
          <div class="invite-hint">รหัสใช้ได้ตลอด ไม่มีวันหมดอายุ • สมาชิกกรอกรหัสนี้ในหน้าสมัคร → ผู้จัดการวงอนุมัติ</div>
        </div>
        <!-- Pending Members -->
        <div id="pendingMembersBox" style="display:none;margin-top:var(--spacing-md)">
          <div style="font-weight:700;color:var(--premium-gold);font-size:var(--text-sm);margin-bottom:8px">⏳ คำขอเข้าร่วมวง</div>
          <div id="pendingMembersList"></div>
        </div>
      </div>

      <!-- Venue Names (simplified — just names) -->
      <div class="card">
        <div class="card-header" style="justify-content:space-between">
          <h3 class="card-title">🏪 ร้าน</h3>
          <div style="display:flex;gap:8px">
            <button id="addVenueNameBtn" class="btn btn-secondary btn-sm">➕ เพิ่มร้าน</button>
            <button type="button" class="btn btn-primary btn-sm" onclick="saveVenueNames(this)">💾 บันทึกร้าน</button>
          </div>
        </div>
        <p style="font-size:var(--text-xs);color:var(--premium-text-muted);margin-bottom:var(--spacing-sm)">เพิ่มชื่อร้านก่อน จากนั้นเพิ่มช่วงงานในตารางด้านล่าง ชื่อร้านจะปรากฏให้เลือกในตาราง</p>
        <div id="venueNamesList"></div>
      </div>

      <!-- Payroll Settings -->
      <div class="card">
        <div class="card-header" style="justify-content:space-between">
          <h3 class="card-title">💰 การเบิกค่าแรง</h3>
          <button type="button" class="btn btn-primary btn-sm" onclick="savePayroll(this)">💾 บันทึก</button>
        </div>
        <div class="payroll-row">
          <label>รูปแบบการเบิก</label>
          <select id="payrollPeriod">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
        <div id="payrollWeeklySettings" style="display:none">
          <div class="payroll-row" style="margin-top:8px;padding:10px;background:rgba(249,207,69,.06);border:1px solid rgba(249,207,69,.25);border-radius:var(--radius-sm)">
            <label>เริ่มต้น</label>
            <select id="weekStart">
              <option value="0">อาทิตย์</option><option value="1">จันทร์</option><option value="2">อังคาร</option>
              <option value="3">พุธ</option><option value="4">พฤหัสบดี</option><option value="5">ศุกร์</option><option value="6">เสาร์</option>
            </select>
            <label>สิ้นสุด</label>
            <select id="weekEnd">
              <option value="0">อาทิตย์</option><option value="1">จันทร์</option><option value="2">อังคาร</option>
              <option value="3">พุธ</option><option value="4">พฤหัสบดี</option><option value="5">ศุกร์</option><option value="6">เสาร์</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Schedule Timetable (Horizontal: rows = days, cols = time) -->
      <div class="card">
        <div class="card-header" style="justify-content:space-between;flex-wrap:wrap;gap:8px">
          <h3 class="card-title">📅 ตารางงานสัปดาห์</h3>
          <button type="button" class="btn btn-secondary btn-sm" onclick="openSlotModal(new Date().getDay(),null,null,null)">➕ เพิ่มช่วงงาน</button>
        </div>
        <p style="font-size:var(--text-xs);color:var(--premium-text-muted);margin-bottom:var(--spacing-sm)">
          คลิกพื้นที่ว่างในแถววัน → เพิ่มช่วงงาน &nbsp;|&nbsp; คลิกบล็อกสีที่มีอยู่ → จัดการสมาชิก+ค่าแรง
        </p>
        <div class="sg-outer">
          <div id="schedGridWrap"></div>
        </div>
        <div id="schedLegend" class="sg-legend"></div>
      </div>

    </div><!-- /container -->
  </main>

  <!-- ═══ Modal: Add / Edit Slot ═══ -->
  <div id="slotModal" class="modal-overlay" onclick="if(event.target===this)closeSlotModal()">
    <div class="modal-box">
      <div class="modal-title">📌 ช่วงงาน — <span id="smDayLabel" style="color:var(--premium-gold)"></span></div>
      <div class="form-group">
        <label>ร้าน <span style="color:#e53e3e">*</span></label>
        <select id="smVenue" style="width:100%;padding:10px 12px;border:1px solid #e2e8f0;border-radius:var(--radius-sm);font-family:inherit;font-size:var(--text-sm);background:var(--premium-white)">
          <option value="">— เลือกร้าน —</option>
        </select>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="form-group">
          <label>เวลาเริ่มต้น <small style="color:var(--premium-text-muted)">(HH:MM)</small></label>
          <input type="text" id="smStart" maxlength="5" placeholder="18:00" inputmode="numeric"
            style="font-family:monospace;font-size:1.2rem;text-align:center;letter-spacing:.1em">
        </div>
        <div class="form-group">
          <label>เวลาสิ้นสุด <small style="color:var(--premium-text-muted)">(HH:MM)</small></label>
          <input type="text" id="smEnd" maxlength="5" placeholder="21:00" inputmode="numeric"
            style="font-family:monospace;font-size:1.2rem;text-align:center;letter-spacing:.1em">
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" id="smDeleteBtn" class="btn btn-sm" style="background:#e53e3e;color:#fff;margin-right:auto;display:none" onclick="deleteSlotFromModal()">🗑️ ลบช่วงนี้</button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="closeSlotModal()">ยกเลิก</button>
        <button type="button" class="btn btn-sm btn-primary" onclick="confirmSlotModal()">✅ บันทึก</button>
      </div>
    </div>
  </div>

  <!-- ═══ Modal: Slot Detail (Members + Rates) ═══ -->
  <div id="slotDetailModal" class="modal-overlay" onclick="if(event.target===this)closeSlotDetailModal()">
    <div class="modal-box">
      <div class="modal-title">👥 <span id="sdTitle" style="font-size:var(--text-md)"></span></div>
      <!-- Bulk rate -->
      <div class="bulk-rate-row" id="bulkRateRow">
        <label>💰 ตั้งค่าแรงพร้อมกัน (เฉพาะผู้ที่เลือก)</label>
        <input type="number" id="bulkRate" placeholder="จำนวน" min="0" style="width:90px">
        <select id="bulkType">
          <option value="shift">บาท/เบรค</option>
          <option value="hourly">บาท/ชม</option>
          <option value="fixed">บาท คงที่</option>
        </select>
        <button type="button" class="btn btn-sm" style="background:var(--premium-gold);color:#1a202c;font-weight:700" onclick="applyBulkRate()">ใช้กับทุกคนที่เลือก</button>
      </div>
      <!-- Member list -->
      <div style="font-size:var(--text-xs);color:var(--premium-text-muted);margin-bottom:8px">
        ✅ ติ๊กเลือกสมาชิกที่ร่วมเบรคนี้ · กำหนดค่าแรงแต่ละคนได้อิสระ
      </div>
      <div id="sdMemberList"></div>
      <div class="modal-actions">
        <button type="button" class="btn btn-sm btn-secondary" onclick="editThisSlot()">✏️ แก้ไขเวลา/ร้าน</button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="closeSlotDetailModal()">ปิด</button>
        <button type="button" class="btn btn-sm btn-primary" onclick="saveSlotDetail()">💾 บันทึก</button>
      </div>
    </div>
  </div>

  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script src="js/band-settings.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof requireAuth === 'function') requireAuth();
      if (typeof renderMainNav === 'function') renderMainNav('mainNav');
      if (typeof applyTranslations === 'function') applyTranslations();
    });
  </script>
</body>
</html>
