<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>เบิกจ่าย — Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    .attendance-table th,.attendance-table td{padding:6px 10px;border:1px solid var(--premium-border,#e2e8f0);font-size:13px;white-space:nowrap}
    .attendance-table th{background:var(--premium-off-white,#f8f8f6);font-weight:600}
    .attendance-table td.sticky-col{position:sticky;left:0;background:var(--premium-white,#fff);z-index:1;min-width:120px}
    .payout-table th,.payout-table td{padding:6px 10px;border:1px solid var(--premium-border,#e2e8f0);font-size:13px}
    .payout-table th{background:var(--premium-off-white,#f8f8f6);font-weight:600}
    .section-divider{margin:var(--spacing-xl) 0;border:none;border-top:2px solid var(--premium-border,#e2e8f0)}
    .band-info-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--spacing-md);margin-bottom:var(--spacing-lg)}
    @media(max-width:640px){.band-info-grid{grid-template-columns:1fr}}
    .info-item{background:var(--premium-off-white,#f8f9fa);border-radius:var(--radius-md);padding:var(--spacing-sm) var(--spacing-md)}
    .info-label{font-size:12px;color:var(--premium-text-muted);margin-bottom:2px}
    .info-value{font-weight:600}
    .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:var(--spacing-md);align-items:flex-end}
    #toast{display:none;position:fixed;bottom:24px;right:24px;background:var(--premium-gold);color:#fff;padding:12px 20px;border-radius:var(--radius-md);z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,.25)}
    #toast.show{display:block}
    #dailyDateGroup,#weeklyDateGroup,#monthlyDateGroup{display:none}
    #bandInfoCard{display:none}
    .action-btns{display:flex;flex-wrap:wrap;gap:var(--spacing-sm);margin-top:var(--spacing-md)}
    input[type=number].payout-input{width:80px;text-align:right;border:1px solid var(--premium-border,#ccc);border-radius:4px;padding:2px 6px;font-size:13px}
    input[type=number].payout-input:focus{outline:2px solid var(--premium-gold)}
    .total-row td{font-weight:700;background:var(--premium-off-white);color:var(--premium-gold)}
    /* Check-in status badges */
    .ap-ci-badge{display:block;font-size:10px;line-height:1;margin-top:2px;pointer-events:none}
    .ap-ci-pending{color:#d69e2e}
    .ap-ci-confirmed{color:#38a169}
    .ap-ci-absent{color:#a0aec0;font-size:11px}
    /* Legend */
    .ap-legend{display:flex;flex-wrap:wrap;gap:14px;font-size:12px;color:var(--premium-text-muted);margin:8px 0 4px}
    .ap-legend span{display:inline-flex;align-items:center;gap:4px}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"><span class="toast-message"></span></div>

  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">� <span data-i18n="nav_attendance">เบิกจ่าย</span></h1>
      </div>

      <!-- Filter Form -->
      <div class="card" style="margin-bottom:var(--spacing-lg)">
        <div class="card-header"><h3 class="card-title">⚙️ ตั้งค่าการบันทึก</h3></div>
        <div class="filter-grid">
          <div class="form-group">
            <label>ประเภทการบันทึก</label>
            <select id="recordType">
              <option value="daily">รายวัน</option>
              <option value="weekly">รายสัปดาห์</option>
              <option value="monthly">รายเดือน</option>
            </select>
          </div>
          <div class="form-group" id="dailyDateGroup">
            <label>วันที่ทำงาน</label>
            <input type="date" id="workDate">
          </div>
          <div class="form-group" id="weeklyDateGroup">
            <label>วันที่เริ่ม</label>
            <input type="date" id="startDate">
          </div>
          <div class="form-group" id="weeklyDateGroup2" style="display:none">
            <label>วันที่สิ้นสุด</label>
            <input type="date" id="endDate">
          </div>
          <div class="form-group" id="monthlyDateGroup">
            <label>เดือน/ปี</label>
            <input type="month" id="monthYear">
          </div>
          <div class="form-group">
            <label>สถานที่ (Venue)</label>
            <select id="venue"><option value="">-- เลือกสถานที่ --</option></select>
          </div>
          <div class="form-group" style="display:flex;align-items:flex-end">
            <button id="apLoadBtn" class="btn btn-primary" style="width:100%">▶️ โหลดตาราง</button>
          </div>
        </div>
      </div>

      <!-- Band Info Card -->
      <div id="bandInfoCard" class="card" style="margin-bottom:var(--spacing-lg)">
        <div class="card-header"><h3 class="card-title">🎸 ข้อมูลวง</h3></div>
        <div class="band-info-grid">
          <div class="info-item"><div class="info-label">ชื่อวง</div><div class="info-value" id="bandNameDisplay">-</div></div>
          <div class="info-item"><div class="info-label">หัวหน้าวง</div><div class="info-value" id="bandManagerDisplay">-</div></div>
          <div class="info-item"><div class="info-label">จำนวนสมาชิก</div><div class="info-value" id="memberCountDisplay">-</div></div>
        </div>
      </div>

      <!-- Attendance Table -->
      <div class="card" style="margin-bottom:var(--spacing-lg)">
        <div class="card-header">
          <h3 class="card-title" id="attendanceTableTitle">📋 ตารางเข้างาน</h3>
        </div>
        <div class="ap-legend">
          <span>✅ ลงเวลาแล้ว (ยืนยัน)</span>
          <span>⏳ รอยืนยัน</span>
          <span style="color:#d69e2e">█ อยู่ในตารางแต่ยังไม่ลงเวลา</span>
        </div>
        <p style="font-size:12px;color:var(--premium-text-muted);margin:0 0 8px">ข้อมูลจากการลงเวลาจริงของสมาชิก — ผู้จัดการสามารถติ๊กเพิ่มเติมได้</p>
        <div class="table-responsive">
          <table class="table attendance-table" style="min-width:600px">
            <thead id="attendanceTableHead"></thead>
            <tbody id="attendanceTableBody">
              <tr><td colspan="10" style="text-align:center;color:var(--premium-text-muted);padding:2rem">กรุณากรอกข้อมูลด้านบนแล้วกด "โหลดตาราง"</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Payout Table -->
      <div class="card" style="margin-bottom:var(--spacing-lg)">
        <div class="card-header"><h3 class="card-title">💰 ตารางจ่ายเงิน</h3></div>
        <div class="ap-legend" style="font-size:12px;color:var(--premium-text-muted);margin-bottom:8px">
          คำนวณจากตารางเข้างาน × อัตราค่าแรงในตั้งค่าวง — หากแสดง - แสดงว่ายังไม่ได้ตั้งอัตราค่าแรงในตั้งค่าวง
        </div>
        <div class="table-responsive">
          <table class="table payout-table" style="min-width:500px">
            <thead id="payoutTableHead"></thead>
            <tbody id="payoutTableBody">
              <tr><td colspan="10" style="text-align:center;color:var(--premium-text-muted);padding:2rem">จะแสดงหลังโหลดตารางเข้างาน</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Substitute Summary -->
      <div id="subSummarySection" class="card" style="display:none;margin-top:var(--spacing-lg);border:2px solid #d6bcfa;background:linear-gradient(135deg,#faf5ff,#f3e8ff)">
        <div style="padding:var(--spacing-lg)"></div>
      </div>

      <!-- Action Buttons -->
      <div class="action-btns">
        <button id="saveBtn" class="btn btn-primary">💾 บันทึกข้อมูล</button>
        <button id="generateVenueReceiptBtn" class="btn btn-secondary">🧾 เบิกร้าน</button>
        <button id="generateMemberReceiptBtn" class="btn btn-secondary">🧾 แจ้งจ่ายรายคน</button>
      </div>
    </div>
  </main>

  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script src="js/attendance-payroll.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof requireAuth === 'function') requireAuth();
      if (typeof renderMainNav === 'function') renderMainNav('mainNav');
      if (typeof applyTranslations === 'function') applyTranslations();
      if (typeof apInitPage === 'function') apInitPage();
    });
  </script>
</body>
</html>
