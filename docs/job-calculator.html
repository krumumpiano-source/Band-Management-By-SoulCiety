<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>คำนวณค่าตัว — Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <style>
    .calc-layout{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-xl)}
    @media(max-width:768px){.calc-layout{grid-template-columns:1fr}}
    .result-big{font-size:var(--text-3xl,2.5rem);font-weight:700;color:var(--premium-gold);text-align:center;padding:var(--spacing-xl) 0}
    .breakdown-row{display:flex;justify-content:space-between;padding:var(--spacing-xs) 0;border-bottom:1px dashed var(--premium-light-gray);font-size:var(--text-sm)}
    .breakdown-row:last-child{border-bottom:none;font-weight:700;color:var(--premium-gold)}
    .member-rate-row{display:flex;align-items:center;gap:var(--spacing-sm);padding:var(--spacing-xs) 0;border-bottom:1px solid var(--premium-light-gray)}
    .member-rate-row label{flex:1;font-size:var(--text-sm)}
    .member-rate-row input{width:100px;font-size:var(--text-sm)}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <main>
    <div class="container">
      <div class="page-header"><h1 class="page-title" data-i18n="nav_calculator">คำนวณค่าตัว</h1></div>
      <div class="calc-layout">
        <!-- Input -->
        <div class="card">
          <div class="card-header"><h3 class="card-title">ข้อมูลงาน</h3></div>
          <div class="form-group"><label>ค่าตัวรวม (บาท) *</label><input type="number" id="totalAmount" value="20000" min="0" oninput="recalc()"></div>
          <div class="form-group"><label>เปอร์เซ็นต์กองกลาง (%)</label><input type="number" id="fundPct" value="10" min="0" max="100" step="0.5" oninput="recalc()"></div>
          <div class="form-group"><label>ค่าใช้จ่ายอื่นๆ (บาท)</label><input type="number" id="otherExpense" value="0" min="0" oninput="recalc()"></div>
          <div class="form-group">
            <label>การแบ่งแบบ</label>
            <select id="splitMode" onchange="recalc()">
              <option value="equal">เท่ากัน</option>
              <option value="custom">กำหนดเอง (อัตราชั่วโมง)</option>
            </select>
          </div>
          <div id="customRateSection" style="display:none">
            <div class="card-header" style="padding:0 0 var(--spacing-sm)"><h4 style="margin:0;font-size:var(--text-sm)">อัตราค่าตัว/คน</h4></div>
            <div id="memberRates"></div>
          </div>
          <div id="memberCountSection">
            <div class="form-group"><label>จำนวนสมาชิก</label><input type="number" id="memberCount" value="5" min="1" oninput="recalc()"></div>
          </div>
        </div>
        <!-- Result -->
        <div class="card">
          <div class="card-header"><h3 class="card-title">ผลลัพธ์</h3></div>
          <div class="result-big" id="resultPerPerson">฿0</div>
          <div id="breakdown"></div>
        </div>
      </div>
    </div>
  </main>
  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script>
  var members=[];
  document.addEventListener('DOMContentLoaded', function(){
    requireAuth(); renderMainNav('mainNav'); applyTranslations();
    apiCall('getAllBandMembers',{},function(r){
      members=(r&&r.data)||[];
      buildMemberRates();
      recalc();
    });
    recalc();
    document.getElementById('splitMode').addEventListener('change', function(){
      var isCustom=this.value==='custom';
      document.getElementById('customRateSection').style.display=isCustom?'block':'none';
      document.getElementById('memberCountSection').style.display=isCustom?'none':'block';
      recalc();
    });
  });
  function buildMemberRates(){
    document.getElementById('memberRates').innerHTML=members.map(function(m){
      return '<div class="member-rate-row"><label>'+escapeHtml(m.name||'')+'</label>'
        +'<input type="number" class="member-rate-input" data-id="'+escapeHtml(m.memberId||m.name)+'" value="'+(m.defaultHourlyRate||500)+'" min="0" oninput="recalc()"></div>';
    }).join('');
  }
  function recalc(){
    var total=parseFloat(document.getElementById('totalAmount').value)||0;
    var fundPct=parseFloat(document.getElementById('fundPct').value)||0;
    var other=parseFloat(document.getElementById('otherExpense').value)||0;
    var fund=Math.round(total*(fundPct/100));
    var distributable=total-fund-other;
    if(distributable<0) distributable=0;
    var mode=document.getElementById('splitMode').value;
    var perPerson=0, breakdownRows='';
    if(mode==='equal'){
      var count=parseInt(document.getElementById('memberCount').value)||1;
      perPerson=Math.floor(distributable/count);
      breakdownRows='<div class="breakdown-row"><span>ค่าตัวรวม</span><span>'+formatCurrency(total)+'</span></div>'
        +'<div class="breakdown-row"><span>กองกลาง ('+fundPct+'%)</span><span>-'+formatCurrency(fund)+'</span></div>'
        +'<div class="breakdown-row"><span>ค่าใช้จ่ายอื่นๆ</span><span>-'+formatCurrency(other)+'</span></div>'
        +'<div class="breakdown-row"><span>แจกจ่าย</span><span>'+formatCurrency(distributable)+'</span></div>'
        +'<div class="breakdown-row"><span>÷ '+count+' คน</span><span>= '+formatCurrency(perPerson)+'</span></div>';
      document.getElementById('resultPerPerson').textContent=formatCurrency(perPerson);
    } else {
      var rates=Array.from(document.querySelectorAll('.member-rate-input')).map(function(i){return parseFloat(i.value)||0;});
      var sumRates=rates.reduce(function(a,b){return a+b;},0);
      breakdownRows='<div class="breakdown-row"><span>แจกจ่าย</span><span>'+formatCurrency(distributable)+'</span></div>';
      if(members.length){
        members.forEach(function(m,i){
          var rate=parseFloat(document.querySelectorAll('.member-rate-input')[i]&&document.querySelectorAll('.member-rate-input')[i].value)||0;
          var share=sumRates>0?Math.floor(distributable*(rate/sumRates)):0;
          breakdownRows+='<div class="breakdown-row"><span>'+escapeHtml(m.name||'')+'</span><span>'+formatCurrency(share)+'</span></div>';
        });
      }
      document.getElementById('resultPerPerson').textContent='(ดูด้านล่าง)';
    }
    document.getElementById('breakdown').innerHTML=breakdownRows;
  }
  </script>
</body>
</html>
