<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ลงเวลาเข้างาน — Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <?!= include('css_theme') ?>
  <?!= include('css_nav') ?>
  <?!= include('css_browser-compat') ?>
  <style>
    .ci-card{max-width:560px;margin:0 auto}
    .ci-member-header{display:flex;align-items:center;gap:var(--spacing-md);padding:var(--spacing-lg);background:linear-gradient(135deg,var(--premium-gold),#b7791f);border-radius:var(--radius-lg);color:#fff;margin-bottom:var(--spacing-xl)}
    .ci-avatar{width:56px;height:56px;background:rgba(255,255,255,.25);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0}
    .ci-member-info h2{margin:0;font-size:var(--text-lg,1.1rem);font-weight:700}
    .ci-role-badge{display:inline-block;padding:3px 10px;border-radius:var(--radius-full,999px);background:rgba(255,255,255,.25);font-size:12px;margin-top:4px;font-weight:600}
    .ci-role-badge--admin{background:rgba(229,62,62,.7)}
    .ci-role-badge--manager{background:rgba(49,130,206,.7)}
    .ci-role-badge--member{background:rgba(56,161,89,.5)}
    .ci-form-row{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-md);margin-bottom:var(--spacing-md)}
    @media(max-width:500px){.ci-form-row{grid-template-columns:1fr}}
    .ci-day-label{font-size:var(--text-sm);color:var(--premium-text-muted);margin-bottom:var(--spacing-sm);font-weight:600}
    .ci-slot-label{display:flex;align-items:center;gap:var(--spacing-sm);padding:var(--spacing-md) var(--spacing-lg);background:var(--premium-off-white,#f8f8f6);border:2px solid #e2e8f0;border-radius:var(--radius-md);cursor:pointer;margin-bottom:var(--spacing-sm);transition:all .15s;user-select:none}
    .ci-slot-label.checked{border-color:var(--premium-gold);background:#fffbeb}
    .ci-slot-label input[type=checkbox]{accent-color:var(--premium-gold);width:18px;height:18px;flex-shrink:0}
    .ci-slot-time{font-weight:600;font-size:var(--text-base)}
    .ci-slot-shortcuts{display:flex;gap:var(--spacing-sm);margin-bottom:var(--spacing-md)}
    .btn-xs{padding:4px 12px;font-size:12px;border-radius:var(--radius-sm);border:1px solid var(--premium-border,#ccc);background:none;cursor:pointer;color:var(--premium-text-muted)}
    .btn-xs:hover{background:var(--premium-off-white)}
    .ci-status{padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--radius-md);font-size:var(--text-sm);font-weight:600;margin-top:var(--spacing-md);display:none}
    .ci-status--success{background:#d4edda;color:#155724;display:block}
    .ci-status--error{background:#f8d7da;color:#721c24;display:block}
    .ci-status--info{background:#d1ecf1;color:#0c5460;display:block}
    .ci-no-slots{color:var(--premium-text-muted);font-size:var(--text-sm);padding:var(--spacing-md) 0}
    .ci-submit-btn{width:100%;padding:14px;font-size:var(--text-base,1rem);font-weight:700;margin-top:var(--spacing-lg)}
    .ci-manager-link{margin-top:var(--spacing-lg);text-align:center;font-size:var(--text-sm)}
    .ci-manager-link a{color:var(--premium-gold);font-weight:600;text-decoration:none}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"><span class="toast-message"></span></div>

  <main>
    <div class="container">
      <div class="ci-card">
        <div class="ci-member-header">
          <div class="ci-avatar">🎵</div>
          <div class="ci-member-info">
            <h2>สวัสดี, <span id="ciMemberName">สมาชิก</span></h2>
            <span id="ciRoleBadge" class="ci-role-badge">สมาชิก</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">⏰ ลงเวลาเข้างาน</h3>
          </div>

          <div class="ci-form-row">
            <div class="form-group">
              <label>📅 วันที่</label>
              <input type="date" id="ciDate" class="form-control">
            </div>
            <div class="form-group">
              <label>🏪 สถานที่</label>
              <select id="ciVenue" class="form-control"><option value="">กำลังโหลด...</option></select>
            </div>
          </div>

          <div id="ciStatus" class="ci-status"></div>

          <div class="form-group" style="margin-top:var(--spacing-md)">
            <label>🕐 ช่วงเวลาที่ทำงาน</label>
            <div id="ciDayLabel" class="ci-day-label"></div>
            <div class="ci-slot-shortcuts">
              <button type="button" class="btn-xs" id="ciSelectAll">เลือกทั้งหมด</button>
              <button type="button" class="btn-xs" id="ciSelectNone">ล้างทั้งหมด</button>
            </div>
            <div id="ciSlotsContainer"></div>
            <div id="ciNoSlots" class="ci-no-slots">เลือกวันที่และสถานที่ก่อนเพื่อดูช่วงเวลา</div>
          </div>

          <div class="form-group">
            <label>📝 หมายเหตุ (ถ้ามี)</label>
            <textarea id="ciNotes" rows="2" class="form-control" placeholder="เช่น มาสาย 15 นาที, ลาก่อนช่วงสุดท้าย..."></textarea>
          </div>

          <button id="ciSubmitBtn" class="btn btn-primary ci-submit-btn">✅ บันทึกเวลาเข้างาน</button>
        </div>

        <div id="ciManagerLink" class="ci-manager-link" style="display:none">
          <a href="?page=attendance-payroll">📋 ไปหน้าเบิกจ่าย (ดูการลงเวลาของสมาชิกทั้งหมด)</a>
        </div>
      </div>
    </div>
  </main>

  <?!= include('js_i18n') ?>
  <?!= include('js_app') ?>
  <?!= include('js_nav') ?>
  <script>
  /* ===== CHECK-IN PAGE LOGIC ===== */
  var ciCurrentBandId = null;
  var ciMemberName = '';
  var ciUserRole = '';
  var ciBandSettings = { scheduleData: {}, venues: [] };
  var ciSelectedVenue = '';
  var ciSelectedDate = '';
  var ciExistingCheckIn = null;

  function ciGetEl(id) { return document.getElementById(id); }
  function ciEscHtml(text) {
    if (!text) return '';
    var d = document.createElement('div'); d.textContent = text; return d.innerHTML;
  }
  function ciShowToast(msg, type) {
    if (typeof showToast === 'function') { showToast(msg, type); return; }
    alert(msg);
  }
  function ciSetStatus(msg, cls) {
    var el = ciGetEl('ciStatus');
    if (!el) return;
    el.textContent = msg;
    el.className = 'ci-status' + (msg ? ' ci-status--' + (cls || 'info') : '');
    el.style.display = msg ? 'block' : 'none';
  }

  function ciLoadSettings(callback) {
    var stored = localStorage.getItem('bandSettings');
    if (stored) {
      try {
        var s = JSON.parse(stored);
        ciBandSettings = { scheduleData: s.scheduleData || s.schedule || {}, venues: s.venues || [] };
      } catch(e) {}
    }
    if (ciBandSettings.venues.length > 0) { callback(); return; }
    if (ciCurrentBandId && typeof apiCall === 'function') {
      apiCall('getBandSettings', { bandId: ciCurrentBandId }, function(r) {
        if (r && r.success && r.data) {
          ciBandSettings = { scheduleData: r.data.scheduleData || {}, venues: r.data.venues || [] };
          try { localStorage.setItem('bandSettings', JSON.stringify(r.data)); } catch(e) {}
        }
        callback();
      });
    } else { callback(); }
  }

  function ciRenderVenues() {
    var sel = ciGetEl('ciVenue');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- เลือกสถานที่ --</option>';
    (ciBandSettings.venues || []).forEach(function(v) {
      var name = v.name || v.venueName || String(v);
      var opt = document.createElement('option');
      opt.value = name; opt.textContent = name;
      if (name === ciSelectedVenue) opt.selected = true;
      sel.appendChild(opt);
    });
    if (!ciBandSettings.venues.length) {
      var opt = document.createElement('option');
      opt.value = 'ร้านหลัก'; opt.textContent = 'ร้านหลัก (ค่าเริ่มต้น)';
      sel.appendChild(opt);
    }
  }

  function ciGetSlotsForDate(dateStr) {
    var dow = new Date(dateStr).getDay();
    var dayData = ciBandSettings.scheduleData[dow] || ciBandSettings.scheduleData[String(dow)];
    if (dayData && dayData.timeSlots && dayData.timeSlots.length > 0) {
      return dayData.timeSlots.map(function(s) {
        return { key: s.startTime + '-' + s.endTime, label: s.startTime + ' – ' + s.endTime };
      });
    }
    return [
      { key: '19:30-20:30', label: '19:30 – 20:30' },
      { key: '21:00-22:00', label: '21:00 – 22:00' },
      { key: '22:30-23:30', label: '22:30 – 23:30' }
    ];
  }

  function ciRenderSlots() {
    var container = ciGetEl('ciSlotsContainer');
    var noSlotsMsg = ciGetEl('ciNoSlots');
    if (!container) return;
    var date = ciGetEl('ciDate') ? ciGetEl('ciDate').value : ciSelectedDate;
    if (!date) { container.innerHTML = ''; if (noSlotsMsg) noSlotsMsg.style.display = 'block'; return; }
    ciSelectedDate = date;
    var slots = ciGetSlotsForDate(date);
    var existingSlots = (ciExistingCheckIn && ciExistingCheckIn.slots) ? ciExistingCheckIn.slots : [];
    if (noSlotsMsg) noSlotsMsg.style.display = 'none';
    var dayNames = ['วันอาทิตย์','วันจันทร์','วันอังคาร','วันพุธ','วันพฤหัสบดี','วันศุกร์','วันเสาร์'];
    var dayLabel = ciGetEl('ciDayLabel');
    if (dayLabel) dayLabel.textContent = dayNames[new Date(date).getDay()];
    container.innerHTML = slots.map(function(slot) {
      var checked = existingSlots.indexOf(slot.key) !== -1;
      return '<label class="ci-slot-label' + (checked ? ' checked' : '') + '">'
        + '<input type="checkbox" name="ciSlot" value="' + ciEscHtml(slot.key) + '"' + (checked ? ' checked' : '') + '>'
        + '<span class="ci-slot-time">🕐 ' + ciEscHtml(slot.label) + '</span>'
        + '</label>';
    }).join('');
    container.querySelectorAll('input[name="ciSlot"]').forEach(function(cb) {
      cb.addEventListener('change', function() {
        cb.closest('label').classList.toggle('checked', cb.checked);
      });
    });
  }

  function ciLoadExistingCheckIn() {
    ciExistingCheckIn = null; ciSetStatus('', '');
    if (!ciSelectedDate || typeof apiCall !== 'function') { ciRenderSlots(); return; }
    apiCall('getMyCheckIn', { date: ciSelectedDate, venue: ciSelectedVenue, bandId: ciCurrentBandId }, function(r) {
      if (r && r.success && r.checkIn) {
        ciExistingCheckIn = r.checkIn;
        ciSetStatus('✅ คุณลงเวลาแล้ว (สถานะ: ' + (r.checkIn.status === 'confirmed' ? 'ได้รับการยืนยัน' : 'รอการยืนยัน') + ')', 'success');
      }
      ciRenderSlots();
    });
  }

  function ciSubmit() {
    var date = ciGetEl('ciDate') ? ciGetEl('ciDate').value : '';
    var venue = ciGetEl('ciVenue') ? ciGetEl('ciVenue').value : '';
    var notes = ciGetEl('ciNotes') ? ciGetEl('ciNotes').value : '';
    var checked = [];
    document.querySelectorAll('input[name="ciSlot"]:checked').forEach(function(cb) { checked.push(cb.value); });
    if (!date) { ciShowToast('กรุณาเลือกวันที่', 'error'); return; }
    if (!venue) { ciShowToast('กรุณาเลือกสถานที่', 'error'); return; }
    if (!checked.length) { ciShowToast('กรุณาเลือกช่วงเวลาอย่างน้อย 1 ช่วง', 'error'); return; }
    var btn = ciGetEl('ciSubmitBtn');
    if (btn) { btn.disabled = true; btn.textContent = '⏳ กำลังบันทึก...'; }
    apiCall('memberCheckIn', { bandId: ciCurrentBandId, date: date, venue: venue, slots: checked, notes: notes }, function(r) {
      if (btn) { btn.disabled = false; btn.textContent = '✅ บันทึกเวลาเข้างาน'; }
      if (r && r.success) {
        ciShowToast(r.message || 'ลงเวลาเรียบร้อยแล้ว', 'success');
        ciSetStatus('✅ ลงเวลาเรียบร้อย — รอผู้จัดการยืนยัน', 'success');
        ciExistingCheckIn = { slots: checked, status: 'pending' };
      } else {
        ciShowToast((r && r.message) || 'เกิดข้อผิดพลาด กรุณาลองใหม่', 'error');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    requireAuth(); renderMainNav('mainNav'); applyTranslations();
    ciCurrentBandId = localStorage.getItem('bandId') || '';
    ciMemberName = localStorage.getItem('userName') || 'คุณ';
    ciUserRole = localStorage.getItem('userRole') || 'member';
    var today = new Date().toISOString().split('T')[0];
    ciSelectedDate = today;
    var dateInput = ciGetEl('ciDate');
    if (dateInput) { dateInput.value = today; dateInput.max = today; }
    var nameEl = ciGetEl('ciMemberName');
    if (nameEl) nameEl.textContent = ciMemberName;
    var roleBadge = ciGetEl('ciRoleBadge');
    if (roleBadge) {
      var roleLabels = { admin: 'แอดมิน', manager: 'ผู้จัดการวง', member: 'สมาชิก' };
      roleBadge.textContent = roleLabels[ciUserRole] || ciUserRole;
      roleBadge.className = 'ci-role-badge ci-role-badge--' + ciUserRole;
    }
    if (ciUserRole === 'manager' || ciUserRole === 'admin') {
      var el = ciGetEl('ciManagerLink'); if (el) el.style.display = 'block';
    }
    ciLoadSettings(function() { ciRenderVenues(); ciLoadExistingCheckIn(); });
    if (dateInput) {
      dateInput.addEventListener('change', function() {
        ciSelectedDate = this.value; ciExistingCheckIn = null; ciLoadExistingCheckIn();
      });
    }
    var venueEl = ciGetEl('ciVenue');
    if (venueEl) {
      venueEl.addEventListener('change', function() {
        ciSelectedVenue = this.value; ciExistingCheckIn = null; ciLoadExistingCheckIn();
      });
    }
    var submitBtn = ciGetEl('ciSubmitBtn');
    if (submitBtn) submitBtn.addEventListener('click', ciSubmit);
    var selAll = ciGetEl('ciSelectAll');
    if (selAll) selAll.addEventListener('click', function() {
      document.querySelectorAll('input[name="ciSlot"]').forEach(function(cb) { cb.checked = true; cb.closest('label').classList.add('checked'); });
    });
    var selNone = ciGetEl('ciSelectNone');
    if (selNone) selNone.addEventListener('click', function() {
      document.querySelectorAll('input[name="ciSlot"]').forEach(function(cb) { cb.checked = false; cb.closest('label').classList.remove('checked'); });
    });
  });
  </script>
</body>
</html>
