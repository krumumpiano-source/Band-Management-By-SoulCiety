<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard ‚Äî Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <?!= include('css_theme') ?>
  <?!= include('css_nav') ?>
  <?!= include('css_browser-compat') ?>
  <style>
    .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--spacing-lg);margin-bottom:var(--spacing-xl)}
    .stat-card{background:var(--premium-white);border-radius:var(--radius-lg);box-shadow:var(--shadow-md);padding:var(--spacing-xl);display:flex;align-items:center;gap:var(--spacing-md)}
    .stat-icon{width:52px;height:52px;border-radius:var(--radius-full);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
    .stat-icon.gold{background:#fef3c7}.stat-icon.blue{background:#dbeafe}.stat-icon.green{background:#d1fae5}.stat-icon.purple{background:#ede9fe}
    .stat-body h3{font-size:var(--text-2xl);font-weight:700;color:var(--premium-text)}.stat-body p{font-size:var(--text-sm);color:var(--premium-text-light)}
    .dash-row{display:grid;grid-template-columns:2fr 1fr;gap:var(--spacing-xl)}
    @media(max-width:768px){.dash-row{grid-template-columns:1fr}}
    .quick-actions{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-sm)}
    .quick-btn{padding:var(--spacing-md);border-radius:var(--radius-md);background:var(--premium-light-gray);border:none;cursor:pointer;text-align:center;font-size:var(--text-sm);font-family:var(--font-family-body);color:var(--premium-text);transition:background .2s,transform .1s}
    .quick-btn:hover{background:var(--premium-gold);color:#fff;transform:translateY(-1px)}
    .job-item{display:flex;align-items:center;gap:var(--spacing-md);padding:var(--spacing-md) 0;border-bottom:1px solid var(--premium-light-gray)}
    .job-item:last-child{border-bottom:none}
    .job-date-box{width:48px;text-align:center;background:var(--premium-off-white);border-radius:var(--radius-md);padding:6px}
    .job-date-box .dd{font-size:var(--text-xl);font-weight:700;color:var(--premium-gold);line-height:1}
    .job-date-box .mm{font-size:10px;color:var(--premium-text-muted);text-transform:uppercase}
    .job-info h4{font-size:var(--text-sm);font-weight:600;margin:0}
    .job-info p{font-size:var(--text-xs);color:var(--premium-text-muted);margin:2px 0 0}
    .finance-row{display:flex;justify-content:space-between;padding:var(--spacing-sm) 0;border-bottom:1px solid var(--premium-light-gray);font-size:var(--text-sm)}
    .finance-row:last-child{border-bottom:none}
    .finance-row .label{color:var(--premium-text-light)}
    .finance-row .val-pos{color:#276749;font-weight:600}
    .finance-row .val-neg{color:#c53030;font-weight:600}
    .welcome-bar{background:linear-gradient(135deg,#2d3748,#4a5568);color:#fff;border-radius:var(--radius-xl);padding:var(--spacing-xl) var(--spacing-2xl);margin-bottom:var(--spacing-xl);display:flex;align-items:center;justify-content:space-between}
    .welcome-bar h2{font-size:var(--text-xl);font-weight:700;margin:0}
    .welcome-bar p{font-size:var(--text-sm);color:#cbd5e0;margin:4px 0 0}
    @media(max-width:480px){.welcome-bar{flex-direction:column;align-items:flex-start;gap:var(--spacing-sm)}.quick-actions{grid-template-columns:1fr}}
    /* === Quick Check-In === */
    .qci-header{display:flex;align-items:center;gap:12px;margin-bottom:var(--spacing-md)}
    .qci-date-badge{background:linear-gradient(135deg,var(--premium-gold),#b7791f);color:#fff;border-radius:var(--radius-lg);padding:8px 18px;font-size:var(--text-sm);font-weight:600;white-space:nowrap}
    .qci-step{margin-bottom:var(--spacing-md)}
    .qci-step-label{font-size:var(--text-sm);font-weight:600;color:var(--premium-text-light);margin-bottom:8px}
    .qci-btn-group{display:flex;flex-wrap:wrap;gap:8px}
    .qci-venue-btn,.qci-slot-btn{padding:10px 18px;border-radius:var(--radius-full);border:2px solid var(--premium-border);background:#fff;cursor:pointer;font-size:var(--text-sm);font-family:var(--font-family-body);color:var(--premium-text);transition:all .18s;font-weight:500}
    .qci-slot-btn{padding:12px 22px;font-size:var(--text-md)}
    .qci-venue-btn.selected{border-color:var(--premium-gold);background:var(--premium-gold);color:#fff;font-weight:700;transform:translateY(-1px);box-shadow:0 2px 8px rgba(203,162,60,.35)}
    .qci-slot-btn.selected{border-color:#276749;background:#276749;color:#fff;font-weight:700;transform:translateY(-1px);box-shadow:0 2px 8px rgba(39,103,73,.25)}
    .qci-summary{background:linear-gradient(135deg,#f0fff4,#c6f6d5);border:1px solid #9ae6b4;border-radius:var(--radius-lg);padding:var(--spacing-md) var(--spacing-lg);font-size:var(--text-sm);line-height:1.8;display:none}
    .qci-summary.show{display:block}
    .qci-summary strong{color:#065f46}
    .qci-done{background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:1px solid #6ee7b7;border-radius:var(--radius-lg);padding:var(--spacing-lg);text-align:center;display:none}
    .qci-done.show{display:block}
    .qci-done .done-icon{font-size:36px;margin-bottom:8px}
    .qci-done p{margin:4px 0;font-size:var(--text-sm);color:#065f46}
    .qci-done strong{font-size:var(--text-md);color:#064e3b}
    .qci-no-schedule{color:var(--premium-text-muted);font-size:var(--text-sm);font-style:italic;padding:10px 0;display:block}
    .qci-no-work{background:#f7fafc;border:1px dashed var(--premium-border);border-radius:var(--radius-lg);padding:var(--spacing-md) var(--spacing-lg);text-align:center;color:var(--premium-text-muted);font-size:var(--text-sm)}
    /* Leave button */
    .qci-leave-btn{padding:10px 20px;font-size:var(--text-sm,0.875rem);font-weight:700;border-radius:var(--radius-md);border:2px solid #e53e3e;background:#fff;color:#e53e3e;cursor:pointer;transition:all .2s;font-family:var(--font-family-body);display:inline-flex;align-items:center;gap:6px}
    .qci-leave-btn:hover{background:#e53e3e;color:#fff}
    .qci-leave-form{display:none;background:linear-gradient(135deg,#fff5f5,#fed7d7);border:2px solid #feb2b2;border-radius:var(--radius-lg);padding:var(--spacing-lg);margin-top:var(--spacing-md);animation:qciLeaveIn .2s ease}
    .qci-leave-form.show{display:block}
    @keyframes qciLeaveIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:none}}
    .qci-leave-form h4{margin:0 0 8px;font-size:var(--text-md);font-weight:700;color:#c53030}
    .qci-leave-form p{margin:0 0 12px;font-size:var(--text-sm);color:var(--premium-text-muted)}
    .qci-leave-form input{width:100%;box-sizing:border-box;padding:12px 14px;border:2px solid #feb2b2;border-radius:var(--radius-md);font-size:var(--text-base);font-family:var(--font-family-body);transition:border-color .2s}
    .qci-leave-form input:focus{outline:none;border-color:#e53e3e}
    .qci-leave-actions{display:flex;gap:8px;margin-top:12px}
    .qci-leave-actions .btn-leave-ok{padding:10px 24px;border:none;background:#e53e3e;color:#fff;border-radius:var(--radius-md);cursor:pointer;font-size:var(--text-sm);font-weight:700;font-family:var(--font-family-body);transition:background .2s}
    .qci-leave-actions .btn-leave-ok:hover{background:#c53030}
    .qci-leave-actions .btn-leave-cancel{padding:10px 24px;border:1px solid #ccc;background:#fff;border-radius:var(--radius-md);cursor:pointer;font-size:var(--text-sm);font-family:var(--font-family-body)}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <main>
    <div class="container">
      <div class="welcome-bar">
        <div>
          <h2>üéµ <span id="welcomeName"></span></h2>
          <p id="welcomeBand"></p>
        </div>
        <div style="font-size:32px">ü•Å</div>
      </div>

      <!-- ===== Pending Members Approval ===== -->
      <div class="card" id="dashPendingCard" style="margin-bottom:var(--spacing-xl);display:none;border:2px solid var(--premium-gold)">
        <div class="card-header" style="background:linear-gradient(135deg,#fffbeb,#fef3c7)">
          <h3 class="card-title" style="margin:0">‚è≥ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ß‡∏á</h3>
          <span id="dashPendingBadge" style="background:var(--premium-gold);color:#1a202c;padding:2px 10px;border-radius:12px;font-size:var(--text-xs);font-weight:700"></span>
        </div>
        <div id="dashPendingList" style="padding:4px 0"></div>
      </div>

      <!-- ===== Quick Daily Check-In ===== -->
      <div class="card" id="qciCard" style="margin-bottom:var(--spacing-xl)">
        <div class="card-header">
          <div class="qci-header">
            <h3 class="card-title" style="margin:0">‚è∞ ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;padding:0 var(--spacing-lg) var(--spacing-md);flex-wrap:wrap">
          <button class="btn btn-ghost btn-sm" id="qciPrevDay" style="padding:4px 10px;font-size:16px">‚óÄ</button>
          <div class="qci-date-badge" id="qciDateBadge"></div>
          <button class="btn btn-ghost btn-sm" id="qciNextDay" style="padding:4px 10px;font-size:16px">‚ñ∂</button>
          <input type="date" id="qciDatePicker" style="border:1px solid var(--premium-border);border-radius:var(--radius-md);padding:6px 10px;font-size:var(--text-sm);font-family:var(--font-family-body)">
          <button class="btn btn-ghost btn-sm" id="qciTodayBtn" style="font-size:var(--text-xs)">üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>
        <div class="qci-done" id="qciDone">
          <div class="done-icon">‚úÖ</div>
          <strong id="qciDoneSummary">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß</strong>
          <p id="qciDoneDetail"></p>
          <button class="btn btn-ghost btn-sm" style="margin-top:8px" id="qciEditBtn">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤</button>
        </div>
        <div id="qciForm">
          <div class="qci-step" id="qciVenueStep">
            <div class="qci-step-label">üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</div>
            <div class="qci-btn-group" id="qciVenueBtns"><span class="qci-no-schedule">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></div>
          </div>
          <div class="qci-step" id="qciSlotStep">
            <div class="qci-step-label" id="qciSlotLabel">üïê ‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            <div class="qci-btn-group" id="qciSlotBtns"><span class="qci-no-schedule">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></div>
          </div>
          <div class="qci-summary" id="qciSummary">
            <strong>üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</strong><br>
            üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <strong id="sumDate"></strong><br>
            üìç ‡∏£‡πâ‡∏≤‡∏ô: <strong id="sumVenue"></strong><br>
            ‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: <strong id="sumSlots"></strong>
          </div>
          <div id="qciConfirmRow" style="display:none;margin-top:var(--spacing-md)">
            <button class="btn btn-primary" id="qciConfirmBtn">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</button>
            <button class="btn btn-ghost" id="qciResetBtn" style="margin-left:8px">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
          </div>
          <!-- Leave button (always visible) -->
          <div style="margin-top:var(--spacing-md);display:flex;align-items:center;gap:var(--spacing-md);flex-wrap:wrap">
            <button type="button" class="qci-leave-btn" id="qciLeaveBtn">üö´ ‡∏•‡∏≤</button>
            <a href="?page=leave" style="font-size:var(--text-xs);color:var(--premium-gold);font-weight:600;text-decoration:none">üîÑ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
          </div>
          <!-- Leave inline form -->
          <div class="qci-leave-form" id="qciLeaveForm">
            <h4>üö´ ‡∏•‡∏≤‡∏á‡∏≤‡∏ô</h4>
            <p>‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ó‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô"</p>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:10px;font-size:var(--text-sm);font-weight:600;user-select:none">
              <input type="checkbox" id="qciLeaveNoSub" style="accent-color:#e53e3e;width:18px;height:18px"> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô
            </label>
            <input type="text" id="qciLeaveSubName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢, ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡∏ó...">
            <div class="qci-leave-actions">
              <button type="button" class="btn-leave-ok" id="qciLeaveSubmit">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏≤</button>
              <button type="button" class="btn-leave-cancel" id="qciLeaveCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Stat Cards -->
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-icon gold">üé∏</div>
          <div class="stat-body"><h3 id="statMembers">‚Äî</h3><p data-i18n="nav_members">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ß‡∏á</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon blue">üìÖ</div>
          <div class="stat-body"><h3 id="statJobs">‚Äî</h3><p data-i18n="upcomingJobs">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green">üí∞</div>
          <div class="stat-body"><h3 id="statRevenue">‚Äî</h3><p data-i18n="revenueMonth">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon purple">üìÑ</div>
          <div class="stat-body"><h3 id="statQuotations">‚Äî</h3><p data-i18n="nav_quotation">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</p></div>
        </div>
      </div>

      <div class="dash-row">
        <!-- Upcoming Jobs -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title" data-i18n="upcomingJobs">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</h3>
            <a href="?page=schedule" class="btn btn-ghost btn-sm" data-i18n="viewAll">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
          </div>
          <div id="jobList">
            <div class="empty-state"><p data-i18n="noData">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>
          </div>
        </div>

        <!-- Right column -->
        <div>
          <!-- Quick Actions -->
          <div class="card" style="margin-bottom:var(--spacing-xl)">
            <div class="card-header"><h3 class="card-title" data-i18n="quickActions">‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î</h3></div>
            <div class="quick-actions">
              <button class="quick-btn" onclick="nav('schedule')">üìÖ <span data-i18n="nav_schedule">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô</span></button>
              <button class="quick-btn" onclick="nav('attendance-payroll')">üí≥ <span data-i18n="nav_payroll">‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</span></button>
              <button class="quick-btn" onclick="nav('quotation')">üìÉ <span data-i18n="nav_quotation">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</span></button>
              <button class="quick-btn" onclick="nav('band-info')">üéµ <span data-i18n="nav_bandInfo">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏á</span></button>
              <button class="quick-btn" onclick="nav('songs')">üéº <span data-i18n="nav_songs">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏•‡∏á</span></button>
              <button class="quick-btn" onclick="nav('equipment')">üé∏ <span data-i18n="nav_equipment">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</span></button>
            </div>
          </div>
          <!-- Finance Summary -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title" data-i18n="financeThisMonth">‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
              <a href="?page=statistics" class="btn btn-ghost btn-sm" data-i18n="viewAll">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            </div>
            <div id="financeList"><div class="empty-state"><p data-i18n="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <?!= include('js_i18n') ?>
  <?!= include('js_app') ?>
  <?!= include('js_nav') ?>
  <script>
  function nav(page) {
    var isGas = typeof google !== 'undefined' && google.script;
    window.location.href = isGas ? '?page=' + page : page + '.html';
  }
  document.addEventListener('DOMContentLoaded', function() {
    requireAuth();
    renderMainNav('mainNav');
    applyTranslations();

    var name = localStorage.getItem('userName') || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
    var band = localStorage.getItem('bandName') || '‡∏ß‡∏á‡∏î‡∏ô‡∏ï‡∏£‡∏µ';
    document.getElementById('welcomeName').textContent = '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ' + name;
    document.getElementById('welcomeBand').textContent = 'üéµ ' + band;

    // Quick Check-In init
    var qciBandId = localStorage.getItem('bandId') || '';
    var qciBandSettings = { venues: [], scheduleData: {} };
    var qciSelectedVenue = '', qciSelectedSlots = [], qciExistingCheckIn = null;
    var qciSelectedDate = new Date();
    var QCI_DAY_NAMES_TH = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå'];
    function qciEsc(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}

    function qciUpdateDateBadge(){
      var db=document.getElementById('qciDateBadge');
      if(db)db.textContent=qciSelectedDate.toLocaleDateString('th-TH',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
      var dp=document.getElementById('qciDatePicker');
      if(dp)dp.value=qciSelectedDate.toISOString().split('T')[0];
    }
    function qciNavDate(offset){
      qciSelectedDate=new Date(qciSelectedDate.getTime()+offset*86400000);
      qciOnDateChange();
    }
    function qciOnDateChange(){
      qciUpdateDateBadge();
      qciSelectedSlots=[];qciExistingCheckIn=null;
      document.getElementById('qciDone').classList.remove('show');
      document.getElementById('qciForm').style.display='block';
      document.getElementById('qciSummary').classList.remove('show');
      document.getElementById('qciConfirmRow').style.display='none';
      qciRenderSlots();
      qciCheckExisting();
    }
    qciUpdateDateBadge();

    // Date navigation
    document.getElementById('qciPrevDay').addEventListener('click',function(){qciNavDate(-1);});
    document.getElementById('qciNextDay').addEventListener('click',function(){qciNavDate(1);});
    document.getElementById('qciTodayBtn').addEventListener('click',function(){qciSelectedDate=new Date();qciOnDateChange();});
    var _dp=document.getElementById('qciDatePicker');
    if(_dp)_dp.addEventListener('change',function(){var p=this.value.split('-');qciSelectedDate=new Date(parseInt(p[0]),parseInt(p[1])-1,parseInt(p[2]));qciOnDateChange();});

    function qciGetSlotsForDate(){
      var dow=qciSelectedDate.getDay();
      var dd=qciBandSettings.scheduleData[dow]||qciBandSettings.scheduleData[String(dow)];
      var slots=[];
      if(Array.isArray(dd)){slots=dd;}else if(dd&&dd.timeSlots&&dd.timeSlots.length){slots=dd.timeSlots;}
      // Filter by selected venue if slots have venueId
      if(qciSelectedVenue&&slots.length&&slots[0]&&slots[0].venueId!==undefined){
        var venueId=qciGetVenueId(qciSelectedVenue);
        if(venueId){var filtered=slots.filter(function(s){return s.venueId===venueId;});if(filtered.length)slots=filtered;}
      }
      return slots.map(function(s){return{key:s.startTime+'-'+s.endTime,label:s.startTime+' \u2013 '+s.endTime};});
    }
    function qciGetVenueId(name){
      var venues=qciBandSettings.venues||[];
      for(var i=0;i<venues.length;i++){var v=venues[i];var vn=v.name||v.venueName||String(v);if(vn===name)return v.id||v.venueId||'';}
      return '';
    }
    function qciUpdateSummary(){
      var summary=document.getElementById('qciSummary'),confirmRow=document.getElementById('qciConfirmRow');
      if(!summary||!confirmRow)return;
      if(qciSelectedVenue&&qciSelectedSlots.length){
        var ds=qciSelectedDate.toLocaleDateString('th-TH',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
        var ss=qciSelectedSlots.map(function(k){var p=k.split('-');return p[0]+' ‚Äì '+p[1];}).join(' ¬∑ ');
        document.getElementById('sumDate').textContent=ds;
        document.getElementById('sumVenue').textContent=qciSelectedVenue;
        document.getElementById('sumSlots').textContent=ss;
        summary.classList.add('show');confirmRow.style.display='block';
      }else{summary.classList.remove('show');confirmRow.style.display='none';}
    }
    function qciRenderSlots(){
      var container=document.getElementById('qciSlotBtns'),label=document.getElementById('qciSlotLabel');
      if(!container)return;
      var dow=qciSelectedDate.getDay();
      var isToday=qciSelectedDate.toDateString()===new Date().toDateString();
      if(label)label.textContent='üïê ‡∏£‡∏≠‡∏ö‡∏ß‡∏±‡∏ô'+QCI_DAY_NAMES_TH[dow]+(isToday?'‡∏ô‡∏µ‡πâ':'');
      var slots=qciGetSlotsForDate();
      if(!slots.length){
        container.innerHTML='<div class="qci-no-work">üéµ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô'+QCI_DAY_NAMES_TH[dow]+'<br><span style="font-size:11px;opacity:.7">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span></div>';
        document.getElementById('qciSummary').classList.remove('show');
        document.getElementById('qciConfirmRow').style.display='none';return;
      }
      var existing=(qciExistingCheckIn&&qciExistingCheckIn.slots)?qciExistingCheckIn.slots:[];
      container.innerHTML=slots.map(function(s){var pre=existing.indexOf(s.key)!==-1?' selected':'';return'<button type="button" class="qci-slot-btn'+pre+'" data-slot="'+qciEsc(s.key)+'">üïê '+qciEsc(s.label)+'</button>';}).join('');
      if(existing.length)qciSelectedSlots=existing.slice();
      container.querySelectorAll('.qci-slot-btn').forEach(function(btn){
        btn.addEventListener('click',function(){
          btn.classList.toggle('selected');
          var slot=btn.dataset.slot;
          if(btn.classList.contains('selected')){if(qciSelectedSlots.indexOf(slot)===-1)qciSelectedSlots.push(slot);}else{qciSelectedSlots=qciSelectedSlots.filter(function(s){return s!==slot;});}
          qciUpdateSummary();
        });
      });
      qciUpdateSummary();
    }
    function qciRenderVenues(){
      var venueStep=document.getElementById('qciVenueStep'),container=document.getElementById('qciVenueBtns');
      if(!container)return;
      var venues=(qciBandSettings.venues||[]);
      if(!venues.length)venues=[{name:'‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å'}];
      if(venues.length===1){qciSelectedVenue=venues[0].name||venues[0].venueName||'‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å';if(venueStep)venueStep.style.display='none';qciRenderSlots();return;}
      if(venueStep)venueStep.style.display='block';
      container.innerHTML=venues.map(function(v){var name=v.name||v.venueName||String(v);return'<button type="button" class="qci-venue-btn" data-venue="'+qciEsc(name)+'">üìç '+qciEsc(name)+'</button>';}).join('');
      container.querySelectorAll('.qci-venue-btn').forEach(function(btn){
        btn.addEventListener('click',function(){
          container.querySelectorAll('.qci-venue-btn').forEach(function(b){b.classList.remove('selected');});
          btn.classList.add('selected');qciSelectedVenue=btn.dataset.venue;
          qciSelectedSlots=[];
          qciRenderSlots();
        });
      });
      var first=container.querySelector('.qci-venue-btn');if(first)first.click();
      qciRenderSlots();
    }
    function qciShowDone(slots,venue){
      var done=document.getElementById('qciDone'),form=document.getElementById('qciForm');
      var ss=(slots||[]).map(function(k){var p=k.split('-');return p[0]+' ‚Äì '+p[1];}).join(' ¬∑ ');
      var isToday=qciSelectedDate.toDateString()===new Date().toDateString();
      var dateLabel=isToday?'‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ':qciSelectedDate.toLocaleDateString('th-TH',{day:'numeric',month:'short'});
      document.getElementById('qciDoneSummary').textContent='‚úÖ ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß'+dateLabel;
      document.getElementById('qciDoneDetail').textContent='üìç '+venue+' ¬∑ ‚è∞ '+ss;
      done.classList.add('show');form.style.display='none';
    }
    function qciCheckExisting(){
      if(!qciBandId||typeof gasRun!=='function')return;
      var dateStr=qciSelectedDate.toISOString().split('T')[0];
      gasRun('getMyCheckIn',{date:dateStr,venue:'',bandId:qciBandId},function(r){
          if(r&&r.success&&r.checkIn){qciExistingCheckIn=r.checkIn;var ci=r.checkIn;if(ci.status==='confirmed'||ci.status==='pending')qciShowDone(ci.slots,ci.venue);}
        });
    }
    function qciLoadAndRender(){
      var stored=localStorage.getItem('bandSettings');
      if(stored){try{var s=JSON.parse(stored);qciBandSettings={venues:s.venues||[],scheduleData:s.scheduleData||s.schedule||{}};}catch(e){}}
      qciRenderVenues();
      qciCheckExisting();
      if(qciBandId&&typeof gasRun==='function'){
        if(!qciBandSettings.venues.length)gasRun('getBandSettings',{bandId:qciBandId},function(r){
          if(r&&r.success&&r.data){qciBandSettings={venues:r.data.venues||[],scheduleData:r.data.scheduleData||r.data.schedule||{}};try{localStorage.setItem('bandSettings',JSON.stringify(r.data));}catch(e){}qciRenderVenues();}
        });
      }
    }
    document.getElementById('qciConfirmBtn').addEventListener('click',function(){
      if(!qciSelectedVenue){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô');return;}
      if(!qciSelectedSlots.length){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏ß‡∏á');return;}
      var btn=document.getElementById('qciConfirmBtn');btn.disabled=true;btn.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      var dateStr=qciSelectedDate.toISOString().split('T')[0];
      gasRun('memberCheckIn',{bandId:qciBandId,date:dateStr,venue:qciSelectedVenue,slots:qciSelectedSlots,notes:''},function(r){
        btn.disabled=false;btn.textContent='‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤';
        if(r&&r.success){qciShowDone(qciSelectedSlots,qciSelectedVenue);}else{alert((r&&r.message)||'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');}
      });
    });
    document.getElementById('qciResetBtn').addEventListener('click',function(){
      qciSelectedVenue='';qciSelectedSlots=[];qciExistingCheckIn=null;
      document.getElementById('qciDone').classList.remove('show');
      document.getElementById('qciForm').style.display='block';
      document.getElementById('qciSummary').classList.remove('show');
      document.getElementById('qciConfirmRow').style.display='none';
      qciRenderVenues();
    });

    // ===== Leave Button (simple inline form) =====
    var qciLeaveBtn = document.getElementById('qciLeaveBtn');
    var qciLeaveForm = document.getElementById('qciLeaveForm');
    if (qciLeaveBtn && qciLeaveForm) {
      qciLeaveBtn.addEventListener('click', function() {
        qciLeaveForm.classList.toggle('show');
        if (qciLeaveForm.classList.contains('show')) {
          var input = document.getElementById('qciLeaveSubName');
          if (input) { input.value = ''; input.focus(); }
        }
      });
      document.getElementById('qciLeaveCancel').addEventListener('click', function() {
        qciLeaveForm.classList.remove('show');
      });
      var _noSubCb = document.getElementById('qciLeaveNoSub');
      if (_noSubCb) _noSubCb.addEventListener('change', function() {
        var inp = document.getElementById('qciLeaveSubName');
        if (inp) { inp.disabled = this.checked; inp.style.opacity = this.checked ? '0.4' : '1'; if (this.checked) inp.value = ''; }
      });
      document.getElementById('qciLeaveSubmit').addEventListener('click', qciSubmitLeaveSimple);
      var leaveInput = document.getElementById('qciLeaveSubName');
      if (leaveInput) leaveInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') qciSubmitLeaveSimple();
      });
    }
    function qciSubmitLeaveSimple() {
      var noSub = document.getElementById('qciLeaveNoSub') && document.getElementById('qciLeaveNoSub').checked;
      var subName = (document.getElementById('qciLeaveSubName') ? document.getElementById('qciLeaveSubName').value : '').trim();
      if (!noSub && !subName) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô"', 'error'); return; }
      if (noSub) subName = '';
      var dateStr = qciSelectedDate.toISOString().split('T')[0];
      var venue = qciSelectedVenue || '';
      // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô = ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏Ñ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏•‡∏≤‡πÄ‡∏â‡∏¢‡πÜ
      var slots = noSub ? [] : (qciSelectedSlots.length ? qciSelectedSlots : []);
      var reason = noSub ? '‡∏•‡∏≤‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô)' : '‡∏•‡∏≤‡∏á‡∏≤‡∏ô';
      var btn = document.getElementById('qciLeaveSubmit');
      if (btn) { btn.disabled = true; btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; }
      gasRun('requestLeave', { bandId: qciBandId, memberId: localStorage.getItem('odooMemberId') || localStorage.getItem('memberId') || '', memberName: localStorage.getItem('userName') || '', date: dateStr, venue: venue, slots: JSON.stringify(slots), reason: reason, substituteName: subName, substituteContact: '' }, function(r) {
        if (btn) { btn.disabled = false; btn.textContent = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏≤'; }
        if (r && r.success) {
          showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' + (subName ? ' ‚Äî ‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô: ' + subName : ' (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô)'), 'success');
          document.getElementById('qciLeaveForm').classList.remove('show');
          document.getElementById('qciLeaveSubName').value = '';
        } else { showToast((r && r.message) || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
      });
    }

    document.getElementById('qciEditBtn').addEventListener('click',function(){
      document.getElementById('qciDone').classList.remove('show');
      document.getElementById('qciForm').style.display='block';
      if(qciExistingCheckIn&&qciExistingCheckIn.venue){qciSelectedVenue=qciExistingCheckIn.venue;var vb=document.querySelector('.qci-venue-btn[data-venue="'+qciSelectedVenue+'"]');if(vb)vb.classList.add('selected');qciRenderSlots();}
    });
    qciLoadAndRender();

    loadDashboard();
    // Load pending member requests (manager/admin only)
    var _role = localStorage.getItem('userRole') || '';
    if (_role === 'manager' || _role === 'admin') {
      loadDashPendingMembers();
    }
  });

  function loadDashPendingMembers() {
    var bandId = localStorage.getItem('bandId') || '';
    if (!bandId) return;
    gasRun('getPendingMembers', { bandId: bandId }, function(r) {
      var card = document.getElementById('dashPendingCard');
      var list = document.getElementById('dashPendingList');
      var badge = document.getElementById('dashPendingBadge');
      if (!card || !list) return;
      if (!r || !r.success || !r.data || r.data.length === 0) { card.style.display = 'none'; return; }
      card.style.display = '';
      badge.textContent = r.data.length + ' ‡∏Ñ‡∏≥‡∏Ç‡∏≠';
      list.innerHTML = r.data.map(function(m) {
        var name = (m.nickname || m.first_name || m.user_name || m.email || '?');
        var detail = (m.instrument ? m.instrument + ' ¬∑ ' : '') + (m.email || '');
        var created = m.created_at ? new Date(m.created_at).toLocaleDateString('th-TH') : '';
        return '<div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--premium-off-white);border-radius:var(--radius-sm);margin-bottom:6px;flex-wrap:wrap">' +
          '<div style="flex:1;min-width:120px">' +
            '<div style="font-weight:700;font-size:var(--text-sm)">' + escapeHtml(name) + '</div>' +
            '<div style="font-size:var(--text-xs);color:var(--premium-text-muted)">' + escapeHtml(detail) + (created ? ' ¬∑ ' + created : '') + '</div>' +
          '</div>' +
          '<button class="btn btn-sm btn-primary" style="padding:4px 12px" onclick="dashApproveMember(\'' + m.id + '\')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>' +
          '<button class="btn btn-sm" style="padding:4px 12px;background:#e53e3e;color:#fff" onclick="dashRejectMember(\'' + m.id + '\')">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>' +
        '</div>';
      }).join('');
    });
  }
  function dashApproveMember(userId) {
    if (!confirm('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ß‡∏á?')) return;
    gasRun('approveMember', { userId: userId, bandId: localStorage.getItem('bandId') }, function(r) {
      if (r && r.success) { showToast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); loadDashPendingMembers(); }
      else showToast((r && r.message) || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    });
  }
  function dashRejectMember(userId) {
    if (!confirm('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ß‡∏á‡∏ô‡∏µ‡πâ?')) return;
    gasRun('rejectMember', { userId: userId, bandId: localStorage.getItem('bandId') }, function(r) {
      if (r && r.success) { showToast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); loadDashPendingMembers(); }
      else showToast((r && r.message) || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    });
  }

  function loadDashboard() {
    gasRun('getDashboardSummary', {}, function(r) {
      if (!r || !r.success) return;
      var d = r.data || {};
      document.getElementById('statMembers').textContent = d.memberCount != null ? d.memberCount : '‚Äî';
      document.getElementById('statJobs').textContent = d.upcomingJobs != null ? d.upcomingJobs : '‚Äî';
      document.getElementById('statRevenue').textContent = d.revenueMonth != null ? formatCurrency(d.revenueMonth) : '‚Äî';
      document.getElementById('statQuotations').textContent = d.quotationCount != null ? d.quotationCount : '‚Äî';

      // jobs
      var jl = document.getElementById('jobList');
      if (d.jobs && d.jobs.length) {
        jl.innerHTML = d.jobs.slice(0,5).map(function(j) {
          var dt = new Date(j.date);
          var dd = isNaN(dt) ? '?' : dt.getDate();
          var mm = isNaN(dt) ? '' : dt.toLocaleString('th-TH',{month:'short'});
          return '<div class="job-item"><div class="job-date-box"><div class="dd">'+dd+'</div><div class="mm">'+mm+'</div></div>'
            +'<div class="job-info"><h4>'+escapeHtml(j.venue||'')+'</h4>'
            +'<p>'+escapeHtml(j.band||'')+' ¬∑ '+escapeHtml(j.type||'')+'</p></div></div>';
        }).join('');
      } else { jl.innerHTML = '<div class="empty-state"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</p></div>'; }

      // finance
      var fl = document.getElementById('financeList');
      var fin = d.finance || {};
      fl.innerHTML = [
        ['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', formatCurrency(fin.income||0), 'val-pos'],
        ['‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', formatCurrency(fin.expense||0), 'val-neg'],
        ['‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á', formatCurrency(fin.fund||0), ''],
        ['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', formatCurrency((fin.income||0)-(fin.expense||0)), (fin.income||0)>=(fin.expense||0)?'val-pos':'val-neg'],
      ].map(function(row){
        return '<div class="finance-row"><span class="label">'+row[0]+'</span><span class="'+row[2]+'">'+row[1]+'</span></div>';
      }).join('');
    });
  }
  </script>
</body>
</html>
