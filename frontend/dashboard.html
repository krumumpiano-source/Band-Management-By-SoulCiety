<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Dashboard — Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <style>
    .stat-icon{width:52px;height:52px;border-radius:var(--radius-full);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
    .stat-icon.gold{background:#fef3c7}.stat-icon.blue{background:#dbeafe}.stat-icon.green{background:#d1fae5}.stat-icon.purple{background:#ede9fe}
    .stat-body h3{font-size:var(--text-2xl);font-weight:700;color:var(--premium-text)}.stat-body p{font-size:var(--text-sm);color:var(--premium-text-light)}
    .dash-row{display:grid;grid-template-columns:2fr 1fr;gap:var(--spacing-xl)}
    @media(max-width:900px){.dash-row{grid-template-columns:1fr}}
    .quick-actions{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--spacing-sm)}
    .quick-btn{padding:var(--spacing-md) var(--spacing-sm);border-radius:var(--radius-md);background:var(--premium-light-gray);border:none;cursor:pointer;text-align:center;font-size:var(--text-sm);font-family:var(--font-family-body);color:var(--premium-text);transition:background .2s,transform .1s;min-height:60px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;line-height:1.3}
    .quick-btn:hover{background:var(--premium-gold);color:#fff;transform:translateY(-1px)}
    .job-item{display:flex;align-items:center;gap:var(--spacing-md);padding:var(--spacing-md) 0;border-bottom:1px solid var(--premium-light-gray)}
    .job-item:last-child{border-bottom:none}
    .job-date-box{width:48px;text-align:center;background:var(--premium-off-white);border-radius:var(--radius-md);padding:6px;flex-shrink:0}
    .job-date-box .dd{font-size:var(--text-xl);font-weight:700;color:var(--premium-gold);line-height:1}
    .job-date-box .mm{font-size:10px;color:var(--premium-text-muted);text-transform:uppercase}
    .job-info h4{font-size:var(--text-sm);font-weight:600;margin:0}
    .job-info p{font-size:var(--text-xs);color:var(--premium-text-muted);margin:2px 0 0}
    .finance-row{display:flex;justify-content:space-between;padding:var(--spacing-sm) 0;border-bottom:1px solid var(--premium-light-gray);font-size:var(--text-sm)}
    .finance-row:last-child{border-bottom:none}
    .finance-row .label{color:var(--premium-text-light)}
    .finance-row .val-pos{color:#276749;font-weight:600}
    .finance-row .val-neg{color:#c53030;font-weight:600}
    .welcome-bar{background:linear-gradient(135deg,#2d3748,#4a5568);color:#fff;border-radius:var(--radius-xl);padding:var(--spacing-lg) var(--spacing-xl);margin-bottom:var(--spacing-xl);display:flex;align-items:center;justify-content:space-between}
    .welcome-bar h2{font-size:var(--text-xl);font-weight:700;margin:0}
    .welcome-bar p{font-size:var(--text-sm);color:#cbd5e0;margin:4px 0 0}
    .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--spacing-lg);margin-bottom:var(--spacing-xl)}
    .stat-card{background:var(--premium-white);border-radius:var(--radius-lg);box-shadow:var(--shadow-md);padding:var(--spacing-xl);display:flex;align-items:center;gap:var(--spacing-md)}
    @media(max-width:600px){
      .welcome-bar{padding:var(--spacing-md);border-radius:var(--radius-lg)}
      .welcome-bar>div:last-child{display:none}
      .stat-grid{grid-template-columns:repeat(2,1fr)!important;gap:var(--spacing-sm)!important}
      .stat-card{padding:var(--spacing-md);gap:var(--spacing-sm)}
      .stat-icon{width:40px;height:40px;font-size:18px}
      .stat-body h3{font-size:var(--text-xl)}
      .quick-actions{grid-template-columns:repeat(3,1fr)}
    }
    @media(max-width:380px){.quick-actions{grid-template-columns:repeat(2,1fr)}}
    /* === Quick Check-In === */
    .qci-header{display:flex;align-items:center;gap:12px;margin-bottom:var(--spacing-md)}
    .qci-date-badge{background:linear-gradient(135deg,var(--premium-gold),#b7791f);color:#fff;border-radius:var(--radius-lg);padding:8px 18px;font-size:var(--text-sm);font-weight:600;white-space:nowrap}
    .qci-step{margin-bottom:var(--spacing-md)}
    .qci-step-label{font-size:var(--text-sm);font-weight:600;color:var(--premium-text-light);margin-bottom:8px}
    .qci-btn-group{display:flex;flex-wrap:wrap;gap:8px}
    .qci-venue-btn,.qci-slot-btn{padding:10px 18px;border-radius:var(--radius-full);border:2px solid var(--premium-border);background:#fff;cursor:pointer;font-size:var(--text-sm);font-family:var(--font-family-body);color:var(--premium-text);transition:all .18s;font-weight:500}
    .qci-slot-btn{padding:12px 22px;font-size:var(--text-md)}
    .qci-venue-btn.selected{border-color:var(--premium-gold);background:var(--premium-gold);color:#fff;font-weight:700;transform:translateY(-1px);box-shadow:0 2px 8px rgba(203,162,60,.35)}
    .qci-slot-btn.selected{border-color:#276749;background:#276749;color:#fff;font-weight:700;transform:translateY(-1px);box-shadow:0 2px 8px rgba(39,103,73,.25)}
    .qci-summary{background:linear-gradient(135deg,#f0fff4,#c6f6d5);border:1px solid #9ae6b4;border-radius:var(--radius-lg);padding:var(--spacing-md) var(--spacing-lg);font-size:var(--text-sm);line-height:1.8;display:none}
    .qci-summary.show{display:block}
    .qci-summary strong{color:#065f46}
    .qci-done{background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:1px solid #6ee7b7;border-radius:var(--radius-lg);padding:var(--spacing-lg);text-align:center;display:none}
    .qci-done.show{display:block}
    .qci-done .done-icon{font-size:36px;margin-bottom:8px}
    .qci-done p{margin:4px 0;font-size:var(--text-sm);color:#065f46}
    .qci-done strong{font-size:var(--text-md);color:#064e3b}
    .qci-no-schedule{color:var(--premium-text-muted);font-size:var(--text-sm);font-style:italic;padding:10px 0;display:block}
    .qci-no-work{background:#f7fafc;border:1px dashed var(--premium-border);border-radius:var(--radius-lg);padding:var(--spacing-md) var(--spacing-lg);text-align:center;color:var(--premium-text-muted);font-size:var(--text-sm)}

    /* Leave button */
    .qci-leave-btn{padding:10px 20px;font-size:var(--text-sm,0.875rem);font-weight:700;border-radius:var(--radius-md);border:2px solid #e53e3e;background:#fff;color:#e53e3e;cursor:pointer;transition:all .2s;font-family:var(--font-family-body);display:inline-flex;align-items:center;gap:6px}
    .qci-leave-btn:hover{background:#e53e3e;color:#fff}
    /* Leave inline form */
    .qci-leave-form{display:none;background:linear-gradient(135deg,#fff5f5,#fed7d7);border:2px solid #feb2b2;border-radius:var(--radius-lg);padding:var(--spacing-lg);margin-top:var(--spacing-md);animation:qciLeaveIn .2s ease}
    .qci-leave-form.show{display:block}
    @keyframes qciLeaveIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:none}}
    .qci-leave-form h4{margin:0 0 8px;font-size:var(--text-md);font-weight:700;color:#c53030}
    .qci-leave-form p{margin:0 0 12px;font-size:var(--text-sm);color:var(--premium-text-muted)}
    .qci-leave-form input{width:100%;box-sizing:border-box;padding:12px 14px;border:2px solid #feb2b2;border-radius:var(--radius-md);font-size:var(--text-base);font-family:var(--font-family-body);transition:border-color .2s}
    .qci-leave-form input:focus{outline:none;border-color:#e53e3e}
    .qci-leave-actions{display:flex;gap:8px;margin-top:12px}
    .qci-leave-actions .btn-leave-ok{padding:10px 24px;border:none;background:#e53e3e;color:#fff;border-radius:var(--radius-md);cursor:pointer;font-size:var(--text-sm);font-weight:700;font-family:var(--font-family-body);transition:background .2s}
    .qci-leave-actions .btn-leave-ok:hover{background:#c53030}
    .qci-leave-actions .btn-leave-cancel{padding:10px 24px;border:1px solid #ccc;background:#fff;border-radius:var(--radius-md);cursor:pointer;font-size:var(--text-sm);font-family:var(--font-family-body)}
    /* Earnings tabs */
    .earn-tab{padding:6px 16px;border-radius:var(--radius-full);border:1px solid var(--premium-border);background:#fff;cursor:pointer;font-size:var(--text-xs);font-weight:600;font-family:var(--font-family-body);color:var(--premium-text-muted);transition:all .2s}
    .earn-tab.active{background:#276749;color:#fff;border-color:#276749}
    .earn-tab:hover:not(.active){background:var(--premium-off-white)}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <main>
    <div class="container">
      <div class="welcome-bar">
        <div>
          <h2>🎵 <span id="welcomeName"></span></h2>
          <p id="welcomeBand"></p>
        </div>
        <div style="font-size:32px">🥁</div>
      </div>

      <!-- ===== Band Code Card (manager/admin) ===== -->
      <div class="card" id="dashBandCodeCard" style="margin-bottom:var(--spacing-xl);display:none;border:2px solid var(--premium-gold);background:linear-gradient(135deg,#fffbeb,#fef9c3)">
        <div style="padding:var(--spacing-lg) var(--spacing-xl);text-align:center">
          <div style="font-size:var(--text-sm);color:var(--premium-text-muted);margin-bottom:8px">🔑 รหัสประจำวง — แจกสมาชิกเพื่อสมัครเข้าร่วมวง</div>
          <div id="dashBandCode" style="font-family:monospace;font-size:2rem;font-weight:700;letter-spacing:.3em;color:var(--premium-gold);user-select:all">------</div>
          <button class="btn btn-ghost btn-sm" id="copyBandCodeBtn" style="margin-top:8px;font-size:var(--text-xs)">📋 คัดลอกรหัสวง</button>
          <div style="font-size:11px;color:var(--premium-text-light);margin-top:6px">สมาชิกสามารถใช้รหัสนี้ที่หน้า "สมัครสมาชิก" เพื่อเข้าร่วมวง</div>
        </div>
      </div>

      <!-- ===== Pending Band Approval (for manager who just created band) ===== -->
      <div class="card" id="dashPendingBandCard" style="margin-bottom:var(--spacing-xl);display:none;border:2px solid #f59e0b;background:linear-gradient(135deg,#fffbeb,#fef3c7)">
        <div style="padding:var(--spacing-lg) var(--spacing-xl);text-align:center">
          <div style="font-size:36px;margin-bottom:8px">⏳</div>
          <h3 style="color:#92400e;margin-bottom:8px">รอแอดมินอนุมัติการสร้างวง</h3>
          <p style="font-size:var(--text-sm);color:#78350f;line-height:1.7">
            คำขอสร้างวงของคุณถูกส่งไปยังแอดมินแล้ว<br>
            กรุณารอการอนุมัติ (ปกติไม่เกิน 24 ชม.)<br>
            เมื่ออนุมัติแล้ว รหัสวงจะปรากฏที่หน้านี้
          </p>
        </div>
      </div>

      <!-- ===== Pending Members Approval ===== -->
      <div class="card" id="dashPendingCard" style="margin-bottom:var(--spacing-xl);display:none;border:2px solid var(--premium-gold)">
        <div class="card-header" style="background:linear-gradient(135deg,#fffbeb,#fef3c7)">
          <h3 class="card-title" style="margin:0">⏳ คำขอเข้าร่วมวง</h3>
          <span id="dashPendingBadge" style="background:var(--premium-gold);color:#1a202c;padding:2px 10px;border-radius:12px;font-size:var(--text-xs);font-weight:700"></span>
        </div>
        <div id="dashPendingList" style="padding:4px 0"></div>
      </div>

      <!-- ===== Quick Daily Check-In ===== -->
      <div class="card" id="qciCard" style="margin-bottom:var(--spacing-xl)">
        <div class="card-header">
          <div class="qci-header">
            <h3 class="card-title" style="margin:0">⏰ ลงเวลาประจำวัน</h3>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;padding:0 var(--spacing-lg) var(--spacing-md);flex-wrap:wrap">
          <button class="btn btn-ghost btn-sm" id="qciPrevDay" style="padding:4px 10px;font-size:16px">◀</button>
          <div class="qci-date-badge" id="qciDateBadge"></div>
          <button class="btn btn-ghost btn-sm" id="qciNextDay" style="padding:4px 10px;font-size:16px">▶</button>
          <input type="date" id="qciDatePicker" style="border:1px solid var(--premium-border);border-radius:var(--radius-md);padding:6px 10px;font-size:var(--text-sm);font-family:var(--font-family-body)">
          <button class="btn btn-ghost btn-sm" id="qciTodayBtn" style="font-size:var(--text-xs)">📅 วันนี้</button>
        </div>

        <!-- Already checked-in state -->
        <div class="qci-done" id="qciDone">
          <div class="done-icon">✅</div>
          <strong id="qciDoneSummary">ลงเวลาแล้ว</strong>
          <p id="qciDoneDetail"></p>
          <div style="margin-top:8px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
            <button class="btn btn-ghost btn-sm" id="qciEditBtn">✏️ แก้ไขเวลา</button>
            <button class="btn btn-sm" id="qciCancelBtn" style="background:#e53e3e;color:#fff;border:none;border-radius:8px;padding:6px 16px;font-size:13px;cursor:pointer">❌ ยกเลิกลงเวลา</button>
          </div>
        </div>

        <!-- Check-in form -->
        <div id="qciForm">
          <!-- Venue picker (hidden when single venue via JS) -->
          <div class="qci-step" id="qciVenueStep">
            <div class="qci-step-label">📍 สถานที่</div>
            <div class="qci-btn-group" id="qciVenueBtns">
              <span class="qci-no-schedule">⏳ กำลังโหลด...</span>
            </div>
          </div>

          <!-- Time slots for today (auto-rendered from manager's schedule) -->
          <div class="qci-step" id="qciSlotStep">
            <div class="qci-step-label" id="qciSlotLabel">🕐 รอบวันนี้</div>
            <div class="qci-btn-group" id="qciSlotBtns">
              <span class="qci-no-schedule">⏳ กำลังโหลด...</span>
            </div>
          </div>

          <!-- Summary -->
          <div class="qci-summary" id="qciSummary">
            <strong>📋 สรุปการลงเวลา</strong><br>
            📅 วันที่: <strong id="sumDate"></strong><br>
            📍 ร้าน: <strong id="sumVenue"></strong><br>
            ⏰ ช่วงเวลา: <strong id="sumSlots"></strong>
          </div>

          <!-- Confirm -->
          <div id="qciConfirmRow" style="display:none;margin-top:var(--spacing-md)">
            <button class="btn btn-primary" id="qciConfirmBtn">✅ ยืนยันลงเวลา</button>
            <button class="btn btn-ghost" id="qciResetBtn" style="margin-left:8px">🔄 รีเซ็ต</button>
          </div>
          <!-- Leave button (always visible) -->
          <div style="margin-top:var(--spacing-md);display:flex;align-items:center;gap:var(--spacing-md);flex-wrap:wrap">
            <button type="button" class="qci-leave-btn" id="qciLeaveBtn">🚫 ลา</button>
            <a href="leave.html" style="font-size:var(--text-xs);color:var(--premium-gold);font-weight:600;text-decoration:none">🔄 จัดการใบลาทั้งหมด</a>
          </div>
          <!-- Leave inline form -->
          <div class="qci-leave-form" id="qciLeaveForm">
            <h4>🚫 ลางาน</h4>
            <p>กรอกชื่อคนมาทำงานแทน หรือเลือก "ไม่มีคนแทน"</p>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:10px;font-size:var(--text-sm);font-weight:600;user-select:none">
              <input type="checkbox" id="qciLeaveNoSub" style="accent-color:#e53e3e;width:18px;height:18px"> ไม่มีคนแทน
            </label>
            <input type="text" id="qciLeaveSubName" placeholder="ชื่อคนแทน เช่น สมชาย, คุณแพท...">
            <div class="qci-leave-actions">
              <button type="button" class="btn-leave-ok" id="qciLeaveSubmit">✅ ยืนยันลา</button>
              <button type="button" class="btn-leave-cancel" id="qciLeaveCancel">ยกเลิก</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== My Earnings Summary ===== -->
      <div class="card" id="earningsSummaryCard" style="margin-bottom:var(--spacing-xl)">
        <div class="card-header" style="background:linear-gradient(135deg,#f0fff4,#c6f6d5);flex-wrap:wrap;gap:8px">
          <h3 class="card-title" style="margin:0">📊 สรุปรายได้ของฉัน</h3>
          <div id="earningsTabs" style="display:flex;gap:4px">
            <button class="earn-tab active" data-period="week">สัปดาห์</button>
            <button class="earn-tab" data-period="month">เดือน</button>
            <button class="earn-tab" data-period="year">ปี</button>
          </div>
        </div>
        <div style="padding:var(--spacing-lg)">
          <div id="earningsPeriodLabel" style="font-size:var(--text-xs);color:var(--premium-text-muted);margin-bottom:var(--spacing-md);text-align:center"></div>
          <!-- Hours + Earnings boxes -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-md);margin-bottom:var(--spacing-md)">
            <div style="background:var(--premium-off-white);border-radius:var(--radius-md);padding:var(--spacing-md);text-align:center">
              <div style="font-size:var(--text-xs);color:var(--premium-text-muted)">⏰ ชั่วโมงทำงาน</div>
              <div id="earnHours" style="font-size:var(--text-xl);font-weight:700;color:var(--premium-text)">—</div>
            </div>
            <div style="background:var(--premium-off-white);border-radius:var(--radius-md);padding:var(--spacing-md);text-align:center">
              <div style="font-size:var(--text-xs);color:var(--premium-text-muted)">💰 รายได้</div>
              <div id="earnAmount" style="font-size:var(--text-xl);font-weight:700;color:#276749">—</div>
            </div>
          </div>
          <!-- Breakdown -->
          <div id="earnBreakdown" style="font-size:var(--text-sm);color:var(--premium-text-light);line-height:1.8"></div>
          <!-- Substitute deduction -->
          <div id="earnSubInfo" style="display:none;margin-top:var(--spacing-md);background:linear-gradient(135deg,#faf5ff,#f3e8ff);border:1px solid #d6bcfa;border-radius:var(--radius-md);padding:var(--spacing-md)">
          </div>
        </div>
      </div>

      <div class="dash-row">
        <!-- Upcoming Jobs -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title" data-i18n="upcomingJobs">งานที่กำลังจะมาถึง</h3>
            <a href="?page=schedule" class="btn btn-ghost btn-sm" data-i18n="viewAll">ดูทั้งหมด</a>
          </div>
          <div id="jobList">
            <div class="empty-state"><p data-i18n="noData">ไม่มีข้อมูล</p></div>
          </div>
        </div>

        <!-- Right column -->
        <div>
          <!-- Quick Actions -->
          <div class="card" style="margin-bottom:var(--spacing-xl)">
            <div class="card-header"><h3 class="card-title" data-i18n="quickActions">ทางลัด</h3></div>
            <div class="quick-actions">
              <button class="quick-btn" onclick="nav('schedule')">📅 <span data-i18n="nav_schedule">ตารางงาน</span></button>
              <button class="quick-btn" onclick="nav('attendance-payroll')">💳 <span data-i18n="nav_payroll">เบิกเงิน</span></button>
              <button class="quick-btn" onclick="nav('quotation')">📃 <span data-i18n="nav_quotation">ใบเสนอราคา</span></button>
              <button class="quick-btn" onclick="nav('band-info')">🎵 <span data-i18n="nav_bandInfo">ข้อมูลวง</span></button>
              <button class="quick-btn" onclick="nav('songs')">🎼 <span data-i18n="nav_songs">รายการเพลง</span></button>
              <button class="quick-btn" onclick="nav('equipment')">🎸 <span data-i18n="nav_equipment">อุปกรณ์</span></button>
            </div>
          </div>
          <!-- Finance Summary -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title" data-i18n="financeThisMonth">การเงินเดือนนี้</h3>
              <a href="?page=statistics" class="btn btn-ghost btn-sm" data-i18n="viewAll">ดูทั้งหมด</a>
            </div>
            <div id="financeList"><div class="empty-state"><p data-i18n="loading">กำลังโหลด...</p></div></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script src="js/nav.js"></script>
  <script>
  function nav(page) {
    window.location.href = page + '.html';
  }

  /* ===== Quick Check-In ===== */
  var qciBandId = '', qciBandSettings = { venues: [], scheduleData: {} };
  var qciSelectedVenue = '', qciSelectedSlots = [], qciExistingCheckIn = null;
  var qciSelectedDate = new Date();
  var QCI_DAY_NAMES_TH = ['อาทิตย์','จันทร์','อังคาร','พุธ','พฤหัส','ศุกร์','เสาร์'];

  function qciEsc(s) { var d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }

  function qciUpdateDateBadge() {
    var dateBadge = document.getElementById('qciDateBadge');
    if (dateBadge) dateBadge.textContent = qciSelectedDate.toLocaleDateString('th-TH', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
    var dp = document.getElementById('qciDatePicker');
    if (dp) dp.value = qciSelectedDate.toISOString().split('T')[0];
  }
  function qciNavDate(offset) {
    qciSelectedDate = new Date(qciSelectedDate.getTime() + offset * 86400000);
    qciOnDateChange();
  }
  function qciOnDateChange() {
    qciUpdateDateBadge();
    qciSelectedSlots = []; qciExistingCheckIn = null;
    document.getElementById('qciDone').classList.remove('show');
    document.getElementById('qciForm').style.display = 'block';
    document.getElementById('qciSummary').classList.remove('show');
    document.getElementById('qciConfirmRow').style.display = 'none';
    qciRenderSlots();
    qciCheckExisting();
  }

  function qciLoadSettings(cb) {
    var stored = localStorage.getItem('bandSettings');
    if (stored) { try { var s = JSON.parse(stored); qciBandSettings = { venues: s.venues||[], scheduleData: s.scheduleData||s.schedule||{} }; } catch(e){} }
    if (qciBandSettings.venues.length > 0) { cb(); return; }
    if (qciBandId && typeof apiCall === 'function') {
      apiCall('getBandSettings', { bandId: qciBandId }, function(r) {
        if (r && r.success && r.data) {
          qciBandSettings = { venues: r.data.venues||[], scheduleData: r.data.scheduleData||r.data.schedule||{} };
          try { localStorage.setItem('bandSettings', JSON.stringify(r.data)); } catch(e) {}
        }
        cb();
      });
    } else { cb(); }
  }

  /* Returns slots for selected date's day-of-week, filtered by selected venue */
  function qciGetSlotsForDate() {
    var dow = qciSelectedDate.getDay();
    var dayData = qciBandSettings.scheduleData[dow] || qciBandSettings.scheduleData[String(dow)];
    var slots = [];
    if (Array.isArray(dayData)) {
      slots = dayData;
    } else if (dayData && dayData.timeSlots && dayData.timeSlots.length) {
      slots = dayData.timeSlots;
    }
    // Filter by selected venue if slots have venueId
    if (qciSelectedVenue && slots.length && slots[0] && slots[0].venueId !== undefined) {
      var venueId = qciGetVenueId(qciSelectedVenue);
      if (venueId) {
        var filtered = slots.filter(function(s) { return s.venueId === venueId; });
        if (filtered.length) slots = filtered;
      }
    }
    return slots.map(function(s) {
      return { key: s.startTime + '-' + s.endTime, label: s.startTime + ' \u2013 ' + s.endTime };
    });
  }

  /* Lookup venue ID from venue name */
  function qciGetVenueId(name) {
    var venues = qciBandSettings.venues || [];
    for (var i = 0; i < venues.length; i++) {
      var v = venues[i];
      var vName = v.name || v.venueName || String(v);
      if (vName === name) return v.id || v.venueId || '';
    }
    return '';
  }

  /* Render venue buttons; auto-select + hide if only one venue */
  function qciRenderVenues() {
    var venueStep = document.getElementById('qciVenueStep');
    var container = document.getElementById('qciVenueBtns');
    if (!container) return;
    var venues = (qciBandSettings.venues || []);
    if (!venues.length) venues = [{ name: 'ร้านหลัก' }];

    if (venues.length === 1) {
      /* เดิมซ่อน venue step เลยถ้ามีร้านเดียว */
      qciSelectedVenue = venues[0].name || venues[0].venueName || 'ร้านหลัก';
      if (venueStep) venueStep.style.display = 'none';
      qciRenderSlots();
      return;
    }

    if (venueStep) venueStep.style.display = 'block';
    container.innerHTML = venues.map(function(v) {
      var name = v.name || v.venueName || String(v);
      return '<button type="button" class="qci-venue-btn" data-venue="' + qciEsc(name) + '">📍 ' + qciEsc(name) + '</button>';
    }).join('');
    container.querySelectorAll('.qci-venue-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        container.querySelectorAll('.qci-venue-btn').forEach(function(b) { b.classList.remove('selected'); });
        btn.classList.add('selected');
        qciSelectedVenue = btn.dataset.venue;
        qciSelectedSlots = [];
        qciRenderSlots();
      });
    });
    /* Auto-select first venue */
    var first = container.querySelector('.qci-venue-btn');
    if (first) first.click();
    qciRenderSlots();
  }

  /* Render time slot buttons from manager's schedule for today */
  function qciRenderSlots() {
    var container = document.getElementById('qciSlotBtns');
    var label = document.getElementById('qciSlotLabel');
    if (!container) return;
    var dow = qciSelectedDate.getDay();
    var isToday = qciSelectedDate.toDateString() === new Date().toDateString();
    if (label) label.textContent = '🕐 รอบวัน' + QCI_DAY_NAMES_TH[dow] + (isToday ? 'นี้' : '');
    var slots = qciGetSlotsForDate();
    if (!slots.length) {
      container.innerHTML = '<div class="qci-no-work">🎵 ไม่มีรอบสำหรับวัน' + QCI_DAY_NAMES_TH[dow] + '<br><span style="font-size:11px;opacity:.7">ผู้จัดการยังไม่ได้กำหนดตารางวันนี้</span></div>';
      document.getElementById('qciSummary').classList.remove('show');
      document.getElementById('qciConfirmRow').style.display = 'none';
      return;
    }
    var existingSlots = (qciExistingCheckIn && qciExistingCheckIn.slots) ? qciExistingCheckIn.slots : [];
    container.innerHTML = slots.map(function(s) {
      var pre = existingSlots.indexOf(s.key) !== -1 ? ' selected' : '';
      return '<button type="button" class="qci-slot-btn' + pre + '" data-slot="' + qciEsc(s.key) + '">🕐 ' + qciEsc(s.label) + '</button>';
    }).join('');
    if (existingSlots.length) qciSelectedSlots = existingSlots.slice();
    container.querySelectorAll('.qci-slot-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        btn.classList.toggle('selected');
        var slot = btn.dataset.slot;
        if (btn.classList.contains('selected')) {
          if (qciSelectedSlots.indexOf(slot) === -1) qciSelectedSlots.push(slot);
        } else {
          qciSelectedSlots = qciSelectedSlots.filter(function(s) { return s !== slot; });
        }
        qciUpdateSummary();
      });
    });
    qciUpdateSummary();
  }

  function qciUpdateSummary() {
    var summary = document.getElementById('qciSummary');
    var confirmRow = document.getElementById('qciConfirmRow');
    if (!summary || !confirmRow) return;
    if (qciSelectedVenue && qciSelectedSlots.length) {
      var dateStr = qciSelectedDate.toLocaleDateString('th-TH', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
      var slotStr = qciSelectedSlots.map(function(k) { var p=k.split('-'); return p[0]+' – '+p[1]; }).join(' · ');
      document.getElementById('sumDate').textContent = dateStr;
      document.getElementById('sumVenue').textContent = qciSelectedVenue;
      document.getElementById('sumSlots').textContent = slotStr;
      summary.classList.add('show');
      confirmRow.style.display = 'block';
    } else {
      summary.classList.remove('show');
      confirmRow.style.display = 'none';
    }
  }

  function qciShowDone(slots, venue, status, subName) {
    var done = document.getElementById('qciDone');
    var form = document.getElementById('qciForm');
    var slotStr = (slots||[]).map(function(k){ var p=k.split('-'); return p[0]+' – '+p[1]; }).join(' · ');
    var isToday = qciSelectedDate.toDateString() === new Date().toDateString();
    var dateLabel = isToday ? 'วันนี้' : qciSelectedDate.toLocaleDateString('th-TH', { day:'numeric', month:'short' });
    var icon = done.querySelector('.done-icon');
    if (status === 'leave') {
      if (icon) icon.textContent = '🚫';
      done.style.background = 'linear-gradient(135deg,#fff5f5,#fed7d7)';
      document.getElementById('qciDoneSummary').innerHTML = '🚫 ลางาน' + dateLabel;
      var detail = '';
      if (venue) detail += '📍 ' + qciEsc(venue);
      if (slotStr) detail += (detail ? ' · ' : '') + '⏰ ' + slotStr;
      if (subName) detail += '<br><span style="color:#805ad5;font-weight:600">🔄 คนแทน: ' + qciEsc(subName) + '</span>';
      else detail += '<br><span style="color:#e53e3e;font-size:13px">ไม่มีคนแทน</span>';
      document.getElementById('qciDoneDetail').innerHTML = detail;
    } else {
      if (icon) icon.textContent = '✅';
      done.style.background = '';
      document.getElementById('qciDoneSummary').textContent = '✅ ลงเวลาแล้ว' + dateLabel;
      document.getElementById('qciDoneDetail').textContent = '📍 '+venue+' · ⏰ '+slotStr;
    }
    done.classList.add('show');
    form.style.display = 'none';
  }

  function qciCheckExisting() {
    if (!qciBandId || typeof apiCall !== 'function') return;
    var dateStr = qciSelectedDate.toISOString().split('T')[0];
    apiCall('getMyCheckIn', { date: dateStr, venue: '', bandId: qciBandId }, function(r) {
      if (r && r.success && r.checkIn) {
        qciExistingCheckIn = r.checkIn;
        var ci = r.checkIn;
        if (ci.status === 'confirmed' || ci.status === 'pending' || ci.status === 'leave') {
          var subName = '';
          if (ci.status === 'leave') {
            if (ci.substitute && ci.substitute.name) subName = ci.substitute.name;
            else if (ci.notes) { var _m = ci.notes.match(/คนแทน:\s*(.+)/); if (_m) subName = _m[1].trim(); }
          }
          qciShowDone(ci.slots, ci.venue, ci.status, subName);
        }
      }
    });
  }

  function qciConfirm() {
    if (!qciSelectedVenue) { alert('กรุณาเลือกสถานที่ก่อน'); return; }
    if (!qciSelectedSlots.length) { alert('กรุณาเลือกช่วงเวลาอย่างน้อย 1 ช่วง'); return; }
    var btn = document.getElementById('qciConfirmBtn');
    btn.disabled = true; btn.textContent = '⏳ กำลังบันทึก...';
    var dateStr = qciSelectedDate.toISOString().split('T')[0];
    apiCall('memberCheckIn', { bandId: qciBandId, date: dateStr, venue: qciSelectedVenue, slots: qciSelectedSlots, notes: '' }, function(r) {
      btn.disabled = false; btn.textContent = '✅ ยืนยันลงเวลา';
      if (r && r.success) {
        qciShowDone(qciSelectedSlots, qciSelectedVenue, 'pending');
        showDashToast('ลงเวลาเรียบร้อย — รอผู้จัดการยืนยัน', 'success');
      } else {
        alert((r && r.message) || 'เกิดข้อผิดพลาด กรุณาลองใหม่');
      }
    });
  }

  function qciReset() {
    qciSelectedVenue = ''; qciSelectedSlots = []; qciExistingCheckIn = null;
    document.getElementById('qciDone').classList.remove('show');
    document.getElementById('qciForm').style.display = 'block';
    document.getElementById('qciSummary').classList.remove('show');
    document.getElementById('qciConfirmRow').style.display = 'none';
    document.querySelectorAll('.qci-venue-btn').forEach(function(b) { b.classList.remove('selected'); });
    qciSelectedSlots = [];
    qciRenderVenues();
  }

  function showDashToast(msg, type) {
    var t = document.getElementById('toast');
    if (!t) return;
    t.textContent = msg;
    t.style.background = type === 'success' ? '#276749' : type === 'error' ? '#c53030' : 'var(--premium-gold)';
    t.style.display = 'block'; t.classList.add('show');
    setTimeout(function(){ t.classList.remove('show'); setTimeout(function(){ t.style.display='none'; }, 300); }, 3500);
  }

  // ===== LEAVE BUTTON (simple: just enter substitute name) =====
  function qciSubmitLeave() {
    var noSub = document.getElementById('qciLeaveNoSub') && document.getElementById('qciLeaveNoSub').checked;
    var subName = (document.getElementById('qciLeaveSubName') ? document.getElementById('qciLeaveSubName').value : '').trim();
    if (!noSub && !subName) { showDashToast('กรุณากรอกชื่อคนแทน หรือเลือก "ไม่มีคนแทน"', 'error'); return; }
    if (noSub) subName = '';

    var dateStr = qciSelectedDate.toISOString().split('T')[0];
    var venue = qciSelectedVenue || '';
    // ไม่มีคนแทน = ไม่ต้องเลือกรอบเวลา แค่บันทึกว่าลาเฉยๆ
    var slots = noSub ? [] : (qciSelectedSlots.length ? qciSelectedSlots : []);
    var reason = noSub ? 'ลางาน (ไม่มีคนแทน)' : 'ลางาน';

    var btn = document.getElementById('qciLeaveSubmit');
    if (btn) { btn.disabled = true; btn.textContent = '⏳ กำลังบันทึก...'; }

    var payload = {
      bandId: qciBandId,
      memberId: localStorage.getItem('odooMemberId') || localStorage.getItem('memberId') || '',
      memberName: localStorage.getItem('userName') || '',
      date: dateStr,
      venue: venue,
      slots: JSON.stringify(slots),
      reason: reason,
      substituteName: subName,
      substituteContact: ''
    };

    if (typeof apiCall === 'function') {
      apiCall('requestLeave', payload, function(r) {
        if (btn) { btn.disabled = false; btn.textContent = '✅ ยืนยันลา'; }
        if (r && r.success) {
          showDashToast('บันทึกลาเรียบร้อย' + (subName ? ' — คนแทน: ' + subName : ' (ไม่มีคนแทน)'), 'success');
          document.getElementById('qciLeaveForm').classList.remove('show');
          document.getElementById('qciLeaveSubName').value = '';
          qciShowDone(slots, venue, 'leave', subName);
        } else {
          showDashToast((r && r.message) || 'เกิดข้อผิดพลาด กรุณาลองใหม่', 'error');
        }
      });
    } else {
      // Fallback: redirect to leave page
      if (btn) { btn.disabled = false; btn.textContent = '✅ ยืนยันลา'; }
      var params = '?date=' + encodeURIComponent(dateStr) +
        '&venue=' + encodeURIComponent(venue) +
        '&sub=' + encodeURIComponent(subName);
      window.location.href = 'leave.html' + params;
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    requireAuth();
    renderMainNav('mainNav');
    applyTranslations();

    var name = localStorage.getItem('userName') || 'ผู้ใช้งาน';
    var band = localStorage.getItem('bandName') || '';
    if (!band) {
      try { var bs = JSON.parse(localStorage.getItem('bandSettings') || '{}'); band = bs.bandName || ''; } catch(e) {}
    }
    if (!band) band = 'วงดนตรี';
    document.getElementById('welcomeName').textContent = 'สวัสดี, ' + name;
    document.getElementById('welcomeBand').textContent = '🎵 ' + band;
    // Refresh band name from server (in case localStorage is stale/empty)
    var _wbBandId = localStorage.getItem('bandId') || '';
    if (_wbBandId) {
      apiCall('getBandSettings', { bandId: _wbBandId }, function(r) {
        if (r && r.success && r.data && r.data.bandName) {
          localStorage.setItem('bandName', r.data.bandName);
          document.getElementById('welcomeBand').textContent = '🎵 ' + r.data.bandName;
        }
      });
    }

    // Quick Check-In init
    qciBandId = localStorage.getItem('bandId') || '';
    qciSelectedDate = new Date();
    qciUpdateDateBadge();

    // Date navigation
    document.getElementById('qciPrevDay').addEventListener('click', function() { qciNavDate(-1); });
    document.getElementById('qciNextDay').addEventListener('click', function() { qciNavDate(1); });
    document.getElementById('qciTodayBtn').addEventListener('click', function() { qciSelectedDate = new Date(); qciOnDateChange(); });
    var dp = document.getElementById('qciDatePicker');
    if (dp) dp.addEventListener('change', function() {
      var parts = this.value.split('-');
      qciSelectedDate = new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
      qciOnDateChange();
    });

    qciLoadSettings(function() {
      qciRenderVenues(); /* venues → auto-selects single venue → renders slots */
      qciCheckExisting();
      loadEarningsSummary('week'); // ต้องรอ settings โหลดเสร็จก่อน
    });

    document.getElementById('qciConfirmBtn').addEventListener('click', qciConfirm);
    document.getElementById('qciResetBtn').addEventListener('click', qciReset);

    // ===== Leave Button (simple inline form) =====
    var qciLeaveBtn = document.getElementById('qciLeaveBtn');
    var qciLeaveForm = document.getElementById('qciLeaveForm');
    if (qciLeaveBtn && qciLeaveForm) {
      qciLeaveBtn.addEventListener('click', function() {
        qciLeaveForm.classList.toggle('show');
        if (qciLeaveForm.classList.contains('show')) {
          var input = document.getElementById('qciLeaveSubName');
          if (input) { input.value = ''; input.focus(); }
        }
      });
      document.getElementById('qciLeaveCancel').addEventListener('click', function() {
        qciLeaveForm.classList.remove('show');
      });
      var _noSubCb = document.getElementById('qciLeaveNoSub');
      if (_noSubCb) _noSubCb.addEventListener('change', function() {
        var inp = document.getElementById('qciLeaveSubName');
        if (inp) { inp.disabled = this.checked; inp.style.opacity = this.checked ? '0.4' : '1'; if (this.checked) inp.value = ''; }
      });
      document.getElementById('qciLeaveSubmit').addEventListener('click', qciSubmitLeave);
      // Enter key to submit
      var leaveInput = document.getElementById('qciLeaveSubName');
      if (leaveInput) leaveInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') qciSubmitLeave();
      });
    }

    document.getElementById('qciEditBtn').addEventListener('click', function() {
      document.getElementById('qciDone').classList.remove('show');
      document.getElementById('qciForm').style.display = 'block';
      if (qciExistingCheckIn && qciExistingCheckIn.venue) {
        qciSelectedVenue = qciExistingCheckIn.venue;
        var vBtn = document.querySelector('.qci-venue-btn[data-venue="'+qciSelectedVenue+'"]');
        if (vBtn) vBtn.classList.add('selected');
        qciRenderSlots();
      }
    });

    document.getElementById('qciCancelBtn').addEventListener('click', function() {
      if (!confirm('ต้องการยกเลิกการลงเวลาวันนี้ใช่หรือไม่?')) return;
      var btn = document.getElementById('qciCancelBtn');
      if (btn) { btn.disabled = true; btn.textContent = '⏳ กำลังยกเลิก...'; }
      var dateStr = qciSelectedDate.toISOString().split('T')[0];
      apiCall('cancelCheckIn', { bandId: qciBandId, date: dateStr }, function(r) {
        if (btn) { btn.disabled = false; btn.textContent = '❌ ยกเลิกลงเวลา'; }
        if (r && r.success) {
          showDashToast('ยกเลิกการลงเวลาเรียบร้อย', 'success');
          qciExistingCheckIn = null;
          document.getElementById('qciDone').classList.remove('show');
          document.getElementById('qciForm').style.display = 'block';
          qciReset();
        } else {
          showDashToast((r && r.message) || 'เกิดข้อผิดพลาด', 'error');
        }
      });
    });

    loadDashboard();
    // loadEarningsSummary ถูกเรียกใน qciLoadSettings callback แทน (รอ schedule data)
    // Tab switching
    document.querySelectorAll('.earn-tab').forEach(function(btn) {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.earn-tab').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        loadEarningsSummary(btn.dataset.period);
      });
    });
    // Load pending member requests (manager/admin only)
    var _role = localStorage.getItem('userRole') || '';
    if (_role === 'manager' || _role === 'admin') {
      loadDashPendingMembers();
      loadDashBandCode();
    }
    // show pending band approval for managers without band_id
    var _bandId = localStorage.getItem('bandId') || '';
    if (_role === 'manager' && !_bandId) {
      document.getElementById('dashPendingBandCard').style.display = '';
    }
  });

  function loadDashBandCode() {
    var bandId = localStorage.getItem('bandId') || '';
    if (!bandId) return;
    apiCall('getBandCode', { bandId: bandId }, function(r) {
      if (r && r.success && r.code) {
        var card = document.getElementById('dashBandCodeCard');
        var codeEl = document.getElementById('dashBandCode');
        if (card && codeEl) {
          card.style.display = '';
          codeEl.textContent = r.code;
        }
      }
    });
    // Copy button
    var copyBtn = document.getElementById('copyBandCodeBtn');
    if (copyBtn) {
      copyBtn.addEventListener('click', function() {
        var code = document.getElementById('dashBandCode').textContent.trim();
        if (!code || code === '------') return;
        if (navigator.clipboard) {
          navigator.clipboard.writeText(code).then(function() {
            showDashToast('คัดลอกรหัสวง ' + code + ' แล้ว', 'success');
          });
        } else {
          // fallback
          var ta = document.createElement('textarea');
          ta.value = code; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy');
          document.body.removeChild(ta);
          showDashToast('คัดลอกรหัสวง ' + code + ' แล้ว', 'success');
        }
      });
    }
  }

  function loadDashPendingMembers() {
    var bandId = localStorage.getItem('bandId') || '';
    if (!bandId) return;
    apiCall('getPendingMembers', { bandId: bandId }, function(r) {
      var card = document.getElementById('dashPendingCard');
      var list = document.getElementById('dashPendingList');
      var badge = document.getElementById('dashPendingBadge');
      if (!card || !list) return;
      if (!r || !r.success || !r.data || r.data.length === 0) { card.style.display = 'none'; return; }
      card.style.display = '';
      badge.textContent = r.data.length + ' คำขอ';
      list.innerHTML = r.data.map(function(m) {
        var name = (m.nickname || m.first_name || m.user_name || m.email || '?');
        var detail = (m.instrument ? m.instrument + ' · ' : '') + (m.email || '');
        var created = m.created_at ? new Date(m.created_at).toLocaleDateString('th-TH') : '';
        return '<div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--premium-off-white);border-radius:var(--radius-sm);margin-bottom:6px;flex-wrap:wrap">' +
          '<div style="flex:1;min-width:120px">' +
            '<div style="font-weight:700;font-size:var(--text-sm)">' + escapeHtml(name) + '</div>' +
            '<div style="font-size:var(--text-xs);color:var(--premium-text-muted)">' + escapeHtml(detail) + (created ? ' · ' + created : '') + '</div>' +
          '</div>' +
          '<button class="btn btn-sm btn-primary" style="padding:4px 12px" onclick="dashApproveMember(\'' + m.id + '\')">✅ อนุมัติ</button>' +
          '<button class="btn btn-sm" style="padding:4px 12px;background:#e53e3e;color:#fff" onclick="dashRejectMember(\'' + m.id + '\')">❌ ปฏิเสธ</button>' +
        '</div>';
      }).join('');
    });
  }
  function dashApproveMember(userId) {
    if (!confirm('อนุมัติสมาชิกคนนี้เข้าร่วมวง?')) return;
    apiCall('approveMember', { userId: userId, bandId: localStorage.getItem('bandId') }, function(r) {
      if (r && r.success) { showDashToast('อนุมัติเรียบร้อย', 'success'); loadDashPendingMembers(); }
      else showDashToast((r && r.message) || 'เกิดข้อผิดพลาด', 'error');
    });
  }
  function dashRejectMember(userId) {
    if (!confirm('ปฏิเสธคำขอเข้าร่วมวงนี้?')) return;
    apiCall('rejectMember', { userId: userId, bandId: localStorage.getItem('bandId') }, function(r) {
      if (r && r.success) { showDashToast('ปฏิเสธเรียบร้อย', 'success'); loadDashPendingMembers(); }
      else showDashToast((r && r.message) || 'เกิดข้อผิดพลาด', 'error');
    });
  }

  /* ===== Earnings Summary (week/month/year) ===== */
  var _earnCache = {}; // cache loaded data per period

  function loadEarningsSummary(period) {
    var bandId = localStorage.getItem('bandId') || '';
    if (!bandId || typeof apiCall !== 'function') return;

    // Settings
    var settings = qciBandSettings || {};
    var scheduleData = settings.scheduleData || {};
    var weekStart = 1, weekEnd = 0;
    try {
      var stored = JSON.parse(localStorage.getItem('bandSettings') || '{}');
      scheduleData = stored.scheduleData || stored.schedule || scheduleData;
      if (stored.payroll) {
        if (stored.payroll.weekStart !== undefined) weekStart = parseInt(stored.payroll.weekStart, 10);
        if (stored.payroll.weekEnd !== undefined) weekEnd = parseInt(stored.payroll.weekEnd, 10);
      }
    } catch(e) {}

    // Calculate date range based on period
    var today = new Date();
    var startDate, endDate, periodLabel;

    if (period === 'week') {
      var dow = today.getDay();
      var diff = (dow - weekStart + 7) % 7;
      startDate = new Date(today); startDate.setDate(today.getDate() - diff);
      var span = (weekEnd - weekStart + 7) % 7; if (span === 0) span = 6;
      endDate = new Date(startDate); endDate.setDate(startDate.getDate() + span);
      periodLabel = '📅 สัปดาห์: ' + startDate.toLocaleDateString('th-TH', {day:'numeric',month:'short'}) + ' – ' + endDate.toLocaleDateString('th-TH', {day:'numeric',month:'short',year:'numeric'});
    } else if (period === 'month') {
      startDate = new Date(today.getFullYear(), today.getMonth(), 1);
      endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      periodLabel = '📅 เดือน: ' + today.toLocaleDateString('th-TH', {month:'long',year:'numeric'});
    } else {
      startDate = new Date(today.getFullYear(), 0, 1);
      endDate = new Date(today.getFullYear(), 11, 31);
      periodLabel = '📅 ปี: ' + today.getFullYear();
    }

    document.getElementById('earningsPeriodLabel').textContent = periodLabel;
    // Reset display
    document.getElementById('earnHours').textContent = '⏳';
    document.getElementById('earnAmount').textContent = '⏳';
    document.getElementById('earnBreakdown').innerHTML = '<span style="color:var(--premium-text-muted)">กำลังโหลด...</span>';
    document.getElementById('earnSubInfo').style.display = 'none';

    // Build date list
    var dates = [];
    for (var d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      dates.push(new Date(d).toISOString().split('T')[0]);
    }

    // Helpers
    function parseMin(t) { if (!t) return 0; var p = t.split(':').map(Number); return p[0]*60 + (p[1]||0); }
    function calcH(s, e) { var d = e - s; if (d < 0) d += 1440; return d / 60; }
    function getSlotsForDow(dow) {
      var dayData = scheduleData[dow] || scheduleData[String(dow)];
      if (Array.isArray(dayData)) return dayData;
      if (dayData && dayData.timeSlots) return dayData.timeSlots;
      return [];
    }
    function getMemberRate(slot, mid) {
      var members = slot.members || [];
      for (var i = 0; i < members.length; i++) {
        if (members[i].memberId === mid) return { rate: members[i].rate || 0, type: members[i].rateType || 'shift', assigned: true };
      }
      return { rate: 0, type: 'shift', assigned: false };
    }
    function slotPay(slot, mid) {
      var r = getMemberRate(slot, mid);
      if (r.rate <= 0) return 0;
      if (r.type === 'hourly') return calcH(parseMin(slot.startTime), parseMin(slot.endTime)) * r.rate;
      return r.rate;
    }

    // Get current user's member ID
    var myId = '';
    try {
      var authStr = localStorage.getItem('sb-wsorngsyowgxikiepice-auth-token') || '';
      if (authStr) { var authData = JSON.parse(authStr); myId = (authData.user && authData.user.id) || ''; }
    } catch(e) {}
    if (!myId) myId = localStorage.getItem('odooMemberId') || localStorage.getItem('memberId') || '';
    if (!myId) { document.getElementById('earnHours').textContent = '—'; document.getElementById('earnAmount').textContent = '—'; document.getElementById('earnBreakdown').innerHTML = ''; return; }

    // Load all check-ins + leave for the date range
    var allCheckIns = [], loadedCount = 0;
    var leaveLoaded = false, ciLoaded = false;
    var myLeaves = [];

    function renderEarnings() {
      if (!ciLoaded || !leaveLoaded) return;

      var myCheckins = {};
      allCheckIns.forEach(function(ci) {
        if (ci.memberId !== myId) return;
        if (!myCheckins[ci.date]) myCheckins[ci.date] = { slots: [], status: ci.status, substitute: ci.substitute || null };
        (ci.slots || []).forEach(function(s) {
          if (myCheckins[ci.date].slots.indexOf(s) === -1) myCheckins[ci.date].slots.push(s);
        });
        if (ci.status) myCheckins[ci.date].status = ci.status;
        if (ci.substitute) myCheckins[ci.date].substitute = ci.substitute;
      });

      // Substitute deductions from leave (deduplicate by date)
      var subDeductions = [];
      var _subDateDone = {};
      myLeaves.forEach(function(lv) {
        if (!lv.substituteName) return;
        var dk = lv.date + '|' + lv.substituteName;
        if (_subDateDone[dk]) return;   // ป้องกันนับซ้ำจาก leave_request ที่ซ้ำกัน
        _subDateDone[dk] = true;
        var existing = subDeductions.find(function(x) { return x.subName === lv.substituteName; });
        if (!existing) { existing = { subName: lv.substituteName, shifts: 0, amount: 0, dates: [] }; subDeductions.push(existing); }
        existing.dates.push(lv.date);
        // Only count slots that are actually in the leave request
        var lvSlots = lv.slots || [];
        if (typeof lvSlots === 'string') { try { lvSlots = JSON.parse(lvSlots); } catch(e) { lvSlots = []; } }
        var lvDow = new Date(lv.date).getDay();
        // Fallback: if leave has no specific slots, use check-in slots for that date
        var ciForDate = myCheckins[lv.date];
        var ciSlotsForDate = ciForDate ? ciForDate.slots : [];
        getSlotsForDow(lvDow).forEach(function(slot) {
          var sk = (slot.startTime || '') + '-' + (slot.endTime || '');
          var mr = getMemberRate(slot, myId);
          var slotMatch = lvSlots.length > 0 ? lvSlots.indexOf(sk) !== -1 : (ciSlotsForDate.length > 0 ? ciSlotsForDate.indexOf(sk) !== -1 : true);
          if (mr.assigned && slotMatch) { existing.shifts++; existing.amount += slotPay(slot, myId); }
        });
      });

      // Calculate hours + earnings
      var totalHours = 0, totalEarnings = 0, totalShifts = 0;
      var breakdown = [];
      var DN = ['อา.','จ.','อ.','พ.','พฤ.','ศ.','ส.'];

      dates.forEach(function(dateStr) {
        var dtObj = new Date(dateStr), dayDow = dtObj.getDay();
        var daySlots = getSlotsForDow(dayDow);
        if (!daySlots.length) return;
        var ci = myCheckins[dateStr];
        var ciSlots = ci ? ci.slots : [];
        var isLeave = ci && ci.status === 'leave';
        // Collect leave slot keys for this date
        var leaveSlotKeys = [];
        var hasSub = false;
        if (isLeave) {
          myLeaves.forEach(function(lv) {
            if (lv.date !== dateStr) return;
            var lvSlots = lv.slots || [];
            if (typeof lvSlots === 'string') { try { lvSlots = JSON.parse(lvSlots); } catch(e) { lvSlots = []; } }
            if (lv.substituteName) {
              hasSub = true;
              lvSlots.forEach(function(s) { if (leaveSlotKeys.indexOf(s) === -1) leaveSlotKeys.push(s); });
            }
          });
        }
        var dayHours = 0, dayAmt = 0, daySlotCount = 0;

        daySlots.forEach(function(slot) {
          var sk = (slot.startTime || '') + '-' + (slot.endTime || '');
          var mr = getMemberRate(slot, myId);
          if (!mr.assigned) return;
          // ลามีคนแทนเฉพาะ slot ที่ลา = ยังได้เงิน, slot อื่นต้อง check-in จริง
          var isLeaveSlotWithSub = isLeave && hasSub && leaveSlotKeys.indexOf(sk) !== -1;
          if (ciSlots.indexOf(sk) !== -1 || isLeaveSlotWithSub) {
            dayHours += calcH(parseMin(slot.startTime), parseMin(slot.endTime));
            dayAmt += slotPay(slot, myId);
            daySlotCount++;
          }
        });

        if (daySlotCount > 0 || isLeave) {
          totalShifts += daySlotCount;
          var label = DN[dayDow] + ' ' + dtObj.toLocaleDateString('th-TH', {day:'numeric',month:'short'});
          if (isLeave && !hasSub) {
            label += ' 🚫ลา (ไม่มีคนแทน)';
            breakdown.push(label + ': 0 ฿');
          } else if (isLeave && hasSub) {
            label += ' 🚫ลา (มีคนแทน)';
            breakdown.push(label + ': ' + daySlotCount + ' เบรค = ' + dayAmt.toLocaleString('th-TH') + ' ฿');
          } else {
            breakdown.push(label + ': ' + daySlotCount + ' เบรค = ' + dayAmt.toLocaleString('th-TH') + ' ฿');
          }
          totalHours += dayHours;
          totalEarnings += dayAmt;
        }
      });

      // Render
      document.getElementById('earnHours').textContent = totalHours > 0 ? totalHours.toFixed(1) + ' ชม.' : '0';
      document.getElementById('earnAmount').textContent = totalEarnings > 0 ? totalEarnings.toLocaleString('th-TH') + ' ฿' : '0 ฿';

      var bdEl = document.getElementById('earnBreakdown');
      if (period === 'week') {
        bdEl.innerHTML = breakdown.length ? breakdown.join('<br>') : '<span style="color:var(--premium-text-muted)">ยังไม่มีข้อมูลเข้างาน</span>';
      } else {
        // For month/year show summary instead of daily detail
        bdEl.innerHTML = breakdown.length
          ? '<span style="font-weight:600">รวม ' + totalShifts + ' เบรค / ' + breakdown.length + ' วัน</span>'
          : '<span style="color:var(--premium-text-muted)">ยังไม่มีข้อมูลเข้างาน</span>';
      }

      // Substitute info
      var subEl = document.getElementById('earnSubInfo');
      if (subDeductions.length) {
        subEl.style.display = 'block';
        var subHtml = '<div style="font-weight:700;font-size:var(--text-sm);color:#553c9a;margin-bottom:6px">🔄 ต้องจ่ายคนแทน</div>';
        var totalSubAmt = 0;
        subDeductions.forEach(function(sd) {
          totalSubAmt += sd.amount;
          subHtml += '<div style="font-size:var(--text-sm);padding:4px 0;display:flex;justify-content:space-between;align-items:center">' +
            '<span>🔄 ' + qciEsc(sd.subName) + ' (' + sd.shifts + ' เบรค)</span>' +
            '<strong style="color:#e53e3e">' + sd.amount.toLocaleString('th-TH') + ' ฿</strong></div>';
        });
        if (totalSubAmt > 0) {
          var net = totalEarnings - totalSubAmt;
          subHtml += '<div style="margin-top:8px;padding-top:8px;border-top:1px solid #d6bcfa;display:flex;justify-content:space-between;font-weight:700;font-size:var(--text-sm)">' +
            '<span>💰 คงเหลือหลังจ่ายคนแทน</span>' +
            '<span style="color:' + (net >= 0 ? '#276749' : '#e53e3e') + '">' + net.toLocaleString('th-TH') + ' ฿</span></div>';
        }
        subEl.innerHTML = subHtml;
      } else {
        subEl.style.display = 'none';
      }
    }

    // Fetch check-ins — batch by date
    dates.forEach(function(dateStr) {
      apiCall('getCheckInsForDate', { bandId: bandId, date: dateStr }, function(r) {
        if (r && r.success && r.data) allCheckIns = allCheckIns.concat(r.data);
        if (++loadedCount >= dates.length) { ciLoaded = true; renderEarnings(); }
      });
    });

    // Fetch leave requests
    apiCall('getAllLeaveRequests', { bandId: bandId }, function(r) {
      if (r && r.success && r.data) {
        var dSet = {}; dates.forEach(function(d) { dSet[d] = true; });
        myLeaves = r.data.filter(function(lv) { return dSet[lv.date] && lv.memberId === myId; });
      }
      leaveLoaded = true; renderEarnings();
    });
  }

  function loadDashboard() {
    apiCall('getDashboardSummary', {}, function(r) {
      if (!r || !r.success) return;
      var d = r.data || {};

      // jobs
      var jl = document.getElementById('jobList');
      if (d.jobs && d.jobs.length) {
        jl.innerHTML = d.jobs.slice(0,5).map(function(j) {
          var dt = new Date(j.date);
          var dd = isNaN(dt) ? '?' : dt.getDate();
          var mm = isNaN(dt) ? '' : dt.toLocaleString('th-TH',{month:'short'});
          return '<div class="job-item"><div class="job-date-box"><div class="dd">'+dd+'</div><div class="mm">'+mm+'</div></div>'
            +'<div class="job-info"><h4>'+escapeHtml(j.venue||'')+'</h4>'
            +'<p>'+escapeHtml(j.band||'')+' · '+escapeHtml(j.type||'')+'</p></div></div>';
        }).join('');
      } else { jl.innerHTML = '<div class="empty-state"><p>ยังไม่มีงาน</p></div>'; }

      // finance
      var fl = document.getElementById('financeList');
      var fin = d.finance || {};
      fl.innerHTML = [
        ['รายรับทั้งหมด', formatCurrency(fin.income||0), 'val-pos'],
        ['รายจ่ายทั้งหมด', formatCurrency(fin.expense||0), 'val-neg'],
        ['กองกลาง', formatCurrency(fin.fund||0), ''],
        ['คงเหลือ', formatCurrency((fin.income||0)-(fin.expense||0)), (fin.income||0)>=(fin.expense||0)?'val-pos':'val-neg'],
      ].map(function(row){
        return '<div class="finance-row"><span class="label">'+row[0]+'</span><span class="'+row[2]+'">'+row[1]+'</span></div>';
      }).join('');
    });
  }
  </script>
</body>
</html>
