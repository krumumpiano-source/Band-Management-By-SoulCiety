<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÄ‡∏ö‡∏¥‡∏Å-‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß ‚Äî Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <?!= include('css_theme') ?>
  <?!= include('css_nav') ?>
  <?!= include('css_browser-compat') ?>
  <style>
    .member-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:var(--spacing-md)}
    .member-att-card{background:var(--premium-white);border-radius:var(--radius-lg);padding:var(--spacing-md);box-shadow:var(--shadow-sm);text-align:center;border-top:3px solid var(--premium-gold)}
    .member-att-card .name{font-weight:600;margin:var(--spacing-sm) 0 4px}
    .member-att-card .role{font-size:var(--text-xs);color:var(--premium-text-muted)}
    .att-toggle{display:flex;gap:4px;justify-content:center;margin:var(--spacing-sm) 0}
    .att-btn{width:32px;height:32px;border-radius:var(--radius-full);border:2px solid var(--premium-light-gray);background:#fff;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .15s}
    .att-btn.present{border-color:#276749;background:#c6f6d5}.att-btn.absent{border-color:#c53030;background:#fed7d7}.att-btn.substitute{border-color:#d69e2e;background:#fefcbf}
    .summary-bar{background:var(--premium-white);border-radius:var(--radius-lg);padding:var(--spacing-lg);box-shadow:var(--shadow-sm);margin-bottom:var(--spacing-xl);display:flex;gap:var(--spacing-xl);flex-wrap:wrap}
    .summary-item{flex:1 1 120px;text-align:center}
    .summary-item .val{font-size:var(--text-2xl);font-weight:700;color:var(--premium-gold)}
    .summary-item .lbl{font-size:var(--text-xs);color:var(--premium-text-muted);margin-top:2px}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <div id="confirmModal"></div>

  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title" data-i18n="nav_payroll">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö/‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß</h1>
        <a href="?page=external-payout" class="btn btn-secondary" data-i18n="nav_externalPayout">‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏ô‡∏≠‡∏Å</a>
      </div>

      <!-- Job Selector -->
      <div class="card" style="margin-bottom:var(--spacing-xl)">
        <div class="card-header"><h3 class="card-title" data-i18n="selectJob">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</h3></div>
        <div style="display:flex;gap:var(--spacing-md);flex-wrap:wrap">
          <select id="jobPicker" onchange="loadJobDetail()" style="flex:1">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô ‚Äî</option>
          </select>
          <button class="btn btn-primary" onclick="saveAttendance()" data-i18n="save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
        <div id="jobInfo" style="margin-top:var(--spacing-md);display:none">
          <div class="summary-bar">
            <div class="summary-item"><div class="val" id="sumTotal">0</div><div class="lbl">‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div></div>
            <div class="summary-item"><div class="val" id="sumPresent">0</div><div class="lbl">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</div></div>
            <div class="summary-item"><div class="val" id="sumAbsent">0</div><div class="lbl">‡∏Ç‡∏≤‡∏î</div></div>
            <div class="summary-item"><div class="val" id="sumEach">0</div><div class="lbl">‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß/‡∏Ñ‡∏ô (‡∏ö‡∏≤‡∏ó)</div></div>
          </div>
        </div>
      </div>

      <!-- Members -->
      <div class="card">
        <div class="card-header"><h3 class="card-title" data-i18n="attendance">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h3></div>
        <div id="memberGrid" class="member-grid">
          <div class="empty-state"><p data-i18n="selectJobFirst">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô</p></div>
        </div>
      </div>

      <!-- History table -->
      <div class="card" style="margin-top:var(--spacing-xl)">
        <div class="card-header"><h3 class="card-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß</h3></div>
        <div class="table-responsive">
          <table class="table" id="historyTable">
            <thead><tr>
              <th>‡∏á‡∏≤‡∏ô</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏£‡∏ß‡∏°</th><th>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</th><th>‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß/‡∏Ñ‡∏ô</th><th></th>
            </tr></thead>
            <tbody id="historyBody"><tr><td colspan="6" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <?!= include('js_i18n') ?>
  <?!= include('js_app') ?>
  <?!= include('js_nav') ?>
  <script>
  var jobs=[], members=[], currentJobId='', attendance={};
  var pricingData=null;

  document.addEventListener('DOMContentLoaded', function(){
    requireAuth(); renderMainNav('mainNav'); applyTranslations();
    loadPayrollPricing();
    var bandId = localStorage.getItem('bandId') || '';
    var year = new Date().getFullYear();
    Promise.all([
      new Promise(function(res){ gasRun('getSchedule',{ bandId: bandId, year: year },function(r){ jobs=(r&&r.data)||[]; res(); }); }),
      new Promise(function(res){ gasRun('getAllBandMembers',{ bandId: bandId },function(r){ members=(r&&r.data)||[]; res(); }); })
    ]).then(function(){
      var sel=document.getElementById('jobPicker');
      jobs.sort(function(a,b){return new Date(b.date)-new Date(a.date);});
      jobs.forEach(function(j){
        var o=document.createElement('option'); o.value=j.scheduleId||''; o.textContent=formatDate(j.date)+' ‚Äî '+(j.venueName||j.venue||'');
        sel.appendChild(o);
      });
    });
    loadHistory();
  });

  function loadPayrollPricing(){
    try { var c=localStorage.getItem('pricingData'); if(c) pricingData=JSON.parse(c); } catch(e){}
    gasRun('getPricing',{bandId:localStorage.getItem('bandId')||''},function(r){
      if(r&&r.success&&r.data){ pricingData=r.data; localStorage.setItem('pricingData',JSON.stringify(pricingData)); }
    });
  }

  function getPositionRate(position){
    if(!pricingData||!pricingData.positions||!position) return null;
    var match=pricingData.positions.find(function(p){ return p.name===position; });
    return match ? match.rate : null;
  }

  function loadJobDetail(){
    currentJobId=document.getElementById('jobPicker').value;
    if(!currentJobId){ document.getElementById('jobInfo').style.display='none'; document.getElementById('memberGrid').innerHTML='<div class="empty-state"><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô</p></div>'; return; }
    document.getElementById('jobInfo').style.display='block';
    var job=jobs.find(function(j){return j.scheduleId===currentJobId;});
    var payment=job?parseFloat(job.totalPay||job.payment||0):0;
    attendance={};
    members.forEach(function(m){ attendance[m.memberId||m.name]={status:'present',memberId:m.memberId,name:m.name}; });
    renderMembers(payment);
  }

  function renderMembers(totalPay){
    var present=Object.values(attendance).filter(function(a){return a.status==='present';}).length;
    var hasPositionRates=pricingData&&pricingData.positions&&pricingData.positions.length>0;
    var each=present>0?Math.floor(totalPay/present):0;

    // Calculate position-based rates if available
    var positionPayMap={};
    if(hasPositionRates){
      var totalRateWeight=0;
      members.forEach(function(m){
        var att=attendance[m.memberId||m.name]||{status:'present'};
        if(att.status==='present'){
          var rate=getPositionRate(m.position||m.role)||each;
          totalRateWeight+=rate;
        }
      });
      members.forEach(function(m){
        var att=attendance[m.memberId||m.name]||{status:'present'};
        if(att.status==='present'&&totalRateWeight>0){
          var rate=getPositionRate(m.position||m.role)||each;
          positionPayMap[m.memberId||m.name]=Math.floor(totalPay*(rate/totalRateWeight));
        } else {
          positionPayMap[m.memberId||m.name]=0;
        }
      });
    }

    document.getElementById('sumTotal').textContent=formatCurrency(totalPay);
    document.getElementById('sumPresent').textContent=present;
    document.getElementById('sumAbsent').textContent=members.length-present;
    document.getElementById('sumEach').textContent=hasPositionRates?'‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á':formatCurrency(each);
    document.getElementById('memberGrid').innerHTML=members.map(function(m){
      var att=attendance[m.memberId||m.name]||{status:'present'};
      var memberPay=hasPositionRates?(positionPayMap[m.memberId||m.name]||0):(att.status==='present'?each:0);
      var posRate=getPositionRate(m.position||m.role);
      var rateHint=posRate?'<div style="font-size:9px;color:var(--premium-gold)">‡∏≠‡∏±‡∏ï‡∏£‡∏≤: '+formatCurrency(posRate)+'</div>':'';
      return '<div class="member-att-card">'
        +'<div style="font-size:36px">üë§</div>'
        +'<div class="name">'+escapeHtml(m.name||'')+'</div>'
        +'<div class="role">'+escapeHtml(m.position||m.role||'')+'</div>'
        +rateHint
        +'<div class="att-toggle">'
        +'<button class="att-btn '+(att.status==='present'?'present':'')+'" onclick="setAtt(\''+escapeHtml(m.memberId||m.name)+'\',\'present\')" title="‡∏°‡∏≤‡∏£‡πà‡∏ß‡∏°">‚úì</button>'
        +'<button class="att-btn '+(att.status==='absent'?'absent':'')+'" onclick="setAtt(\''+escapeHtml(m.memberId||m.name)+'\',\'absent\')" title="‡∏Ç‡∏≤‡∏î">‚úó</button>'
        +'<button class="att-btn '+(att.status==='substitute'?'substitute':'')+'" onclick="setAtt(\''+escapeHtml(m.memberId||m.name)+'\',\'substitute\')" title="‡∏°‡∏≤‡πÅ‡∏ó‡∏ô">S</button>'
        +'</div>'
        +'<div style="font-size:var(--text-xs);color:var(--premium-text-muted)">‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß: '+formatCurrency(memberPay)+'</div>'
        +'</div>';
    }).join('') || '<div class="empty-state"><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p></div>';
  }

  function setAtt(id,status){
    if(attendance[id]) attendance[id].status=status;
    var job=jobs.find(function(j){return j.scheduleId===currentJobId;});
    renderMembers(job?parseFloat(job.totalPay||job.payment||0):0);
  }

  function saveAttendance(){
    if(!currentJobId){ showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô','info'); return; }
    var job=jobs.find(function(j){return j.scheduleId===currentJobId;});
    gasRun('addAttendancePayroll',{ scheduleId:currentJobId, bandId:localStorage.getItem('bandId')||'', venue:job?(job.venueName||job.venue||''):currentJobId, date:job?job.date:'', attendance:attendance, totalAmount:job?(job.totalPay||job.payment||0):0 },function(r){
      if(r&&r.success){ showToast(t('msg_saved'),'success'); loadHistory(); }
      else showToast((r&&r.message)||t('msg_error'),'error');
    });
  }

  function loadHistory(){
    var bandId = localStorage.getItem('bandId') || '';
    gasRun('getAllAttendancePayroll',{ bandId: bandId },function(r){
      var rows=(r&&r.data)||[];
      var tbody=document.getElementById('historyBody');
      if(!rows.length){ tbody.innerHTML='<tr><td colspan="6" class="text-center">'+t('noData')+'</td></tr>'; return; }
      tbody.innerHTML=rows.map(function(row){
        return '<tr><td>'+escapeHtml(row.venue||'')+'</td><td>'+formatDate(row.date)+'</td>'
          +'<td>'+formatCurrency(row.totalAmount||0)+'</td><td>'+escapeHtml(String(row.presentCount||''))+'</td>'
          +'<td>'+formatCurrency(row.payPerPerson||0)+'</td>'
          +'<td><button class="btn btn-danger btn-sm" onclick="deleteAttRecord(\''+escapeHtml(row.id||row.recordId||'')+"')\">\uD83D\uDDD1\uFE0F</button></td></tr>';
      }).join('');
    });
  }

  function deleteAttRecord(id){
    showConfirm(t('confirmDeleteTitle'),t('confirmDeleteMsg')).then(function(ok){
      if(!ok) return;
      gasRun('deleteAttendancePayroll',{recordId:id},function(r){
        if(r&&r.success){ showToast(t('msg_deleted'),'success'); loadHistory(); }
        else showToast((r&&r.message)||t('msg_error'),'error');
      });
    });
  }
  </script>
</body>
</html>
