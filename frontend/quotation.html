<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ใบเสนอราคา — Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <?!= include('css_theme') ?>
  <?!= include('css_nav') ?>
  <?!= include('css_browser-compat') ?>
  <style>
    .q-modal-form .form-r{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-md)}
    @media(max-width:480px){.q-modal-form .form-r{grid-template-columns:1fr}}
    .item-row{display:grid;grid-template-columns:3fr 1fr 1fr 40px;gap:var(--spacing-sm);align-items:center;margin-bottom:var(--spacing-sm)}
    .item-row input{font-size:var(--text-sm)}
    .print-badge{cursor:pointer}
    @media print{
      .card-header .btn,.btn{display:none!important}
      #mainNav{display:none!important}
    }
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <div id="confirmModal"></div>

  <!-- Quotation Modal -->
  <div id="quotModal" class="modal-backdrop" style="display:none">
    <div class="modal q-modal-form" style="max-width:700px;max-height:90vh;overflow-y:auto">
      <div class="modal-header">
        <h3 class="modal-title" id="quotModalTitle" data-i18n="quot_new">ใบเสนอราคาใหม่</h3>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <form id="quotForm">
        <input type="hidden" id="quotId">
        <div class="form-r">
          <div class="form-group"><label data-i18n="client">ลูกค้า</label><input type="text" id="qClient"></div>
          <div class="form-group"><label data-i18n="date">วันที่</label><input type="date" id="qDate"></div>
        </div>
        <div class="form-r">
          <div class="form-group"><label>วันที่แสดง</label><input type="date" id="qEventDate"></div>
          <div class="form-group"><label>สถานที่</label><input type="text" id="qVenue"></div>
        </div>
        <div class="form-group"><label>รายการ</label>
          <div style="display:flex;gap:var(--spacing-sm);margin-bottom:var(--spacing-sm);flex-wrap:wrap">
            <button type="button" class="btn btn-ghost btn-sm" onclick="addItem()">+ เพิ่มรายการ</button>
            <button type="button" class="btn btn-secondary btn-sm" onclick="showServiceCatalog()" id="catalogBtn" style="display:none">📋 เลือกจากรายการบริการ</button>
          </div>
          <div id="serviceCatalog" style="display:none;background:var(--premium-off-white);border:1px solid var(--premium-gold);border-radius:var(--radius-md);padding:var(--spacing-md);margin-bottom:var(--spacing-md)">
            <div style="font-size:var(--text-sm);font-weight:600;margin-bottom:var(--spacing-sm)">📋 รายการบริการสำเร็จรูป (กดเลือกเพื่อเพิ่ม)</div>
            <div id="catalogItems"></div>
            <button type="button" class="btn btn-ghost btn-sm" onclick="hideServiceCatalog()" style="margin-top:var(--spacing-sm)">ปิด</button>
          </div>
          <div id="qItems"></div>
        </div>
        <div class="form-r">
          <div class="form-group"><label>ส่วนลด (บาท)</label><input type="number" id="qDiscount" value="0" min="0" oninput="calcTotal()"></div>
          <div class="form-group"><label>VAT (%)</label><input type="number" id="qVat" value="7" min="0" oninput="calcTotal()"></div>
        </div>
        <div style="text-align:right;background:var(--premium-off-white);padding:var(--spacing-md);border-radius:var(--radius-md);margin-bottom:var(--spacing-md)">
          <div style="font-size:var(--text-sm);color:var(--premium-text-muted)">ก่อน VAT: <span id="qSubtotal">0</span></div>
          <div style="font-size:var(--text-sm);color:var(--premium-text-muted)">VAT: <span id="qVatAmt">0</span></div>
          <div style="font-size:var(--text-xl);font-weight:700;color:var(--premium-gold)">รวม: <span id="qTotal">0</span></div>
        </div>
        <div class="form-group"><label>หมายเหตุ</label><textarea id="qNotes" rows="2"></textarea></div>
        <div style="display:flex;justify-content:flex-end;gap:var(--spacing-sm)">
          <button type="button" class="btn btn-secondary" onclick="closeModal()" data-i18n="cancel">ยกเลิก</button>
          <button type="submit" class="btn btn-primary" id="saveQuotBtn" data-i18n="save">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title" data-i18n="nav_quotation">ใบเสนอราคา</h1>
        <button class="btn btn-primary" onclick="openModal(null)">+ <span data-i18n="quot_new">ใบเสนอราคาใหม่</span></button>
      </div>
      <div class="card">
        <div class="table-responsive">
          <table class="table">
            <thead><tr>
              <th data-i18n="quot_no">เลขที่</th>
              <th data-i18n="client">ลูกค้า</th>
              <th data-i18n="date">วันที่</th>
              <th data-i18n="quot_eventDate">วันแสดง</th>
              <th data-i18n="quot_total">ยอดรวม</th>
              <th data-i18n="status">สถานะ</th>
              <th></th>
            </tr></thead>
            <tbody id="quotBody"><tr><td colspan="7" class="text-center">กำลังโหลด...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <?!= include('js_i18n') ?>
  <?!= include('js_app') ?>
  <?!= include('js_nav') ?>
  <script>
  var quotations=[];
  var pricingData=null;
  document.addEventListener('DOMContentLoaded', function(){
    requireAuth(); renderMainNav('mainNav'); applyTranslations();
    loadQuotPricing();
    loadQuotations();
  });

  function loadQuotPricing(){
    try { var c=localStorage.getItem('pricingData'); if(c) pricingData=JSON.parse(c); } catch(e){}
    apiCall('getPricing',{bandId:localStorage.getItem('bandId')||''},function(r){
      if(r&&r.success&&r.data){ pricingData=r.data; localStorage.setItem('pricingData',JSON.stringify(pricingData)); }
      if(pricingData&&pricingData.services&&pricingData.services.length){
        document.getElementById('catalogBtn').style.display='inline-flex';
      }
    });
    if(pricingData&&pricingData.services&&pricingData.services.length){
      document.getElementById('catalogBtn').style.display='inline-flex';
    }
  }

  function showServiceCatalog(){
    if(!pricingData||!pricingData.services||!pricingData.services.length){ showToast('ยังไม่มีรายการบริการ กรุณาตั้งค่าในตารางราคา','info'); return; }
    var cat=document.getElementById('serviceCatalog');
    cat.style.display='block';
    document.getElementById('catalogItems').innerHTML=pricingData.services.map(function(s,i){
      return '<div style="display:flex;align-items:center;gap:var(--spacing-sm);padding:6px 0;border-bottom:1px solid #e2e8f0;cursor:pointer" onclick="addFromCatalog('+i+')">'
        +'<span style="flex:1;font-size:var(--text-sm)">'+escapeHtml(s.desc)+'</span>'
        +'<span style="font-size:var(--text-xs);color:var(--premium-text-muted)">×'+s.qty+'</span>'
        +'<span style="font-size:var(--text-sm);font-weight:600;color:var(--premium-gold)">'+formatCurrency(s.price)+'</span>'
        +'<span style="font-size:16px">➕</span>'
        +'</div>';
    }).join('');
  }

  function hideServiceCatalog(){ document.getElementById('serviceCatalog').style.display='none'; }

  function addFromCatalog(idx){
    if(!pricingData||!pricingData.services[idx]) return;
    var s=pricingData.services[idx];
    addItem(s.desc, s.qty, s.price);
    calcTotal();
    showToast('เพิ่ม "'+s.desc+'" แล้ว','success');
  }

  function loadQuotations(){
    apiCall('getAllQuotations',{},function(r){
      quotations=(r&&r.data)||[];
      var tbody=document.getElementById('quotBody');
      if(!quotations.length){ tbody.innerHTML='<tr><td colspan="7" class="text-center">'+t('noData')+'</td></tr>'; return; }
      tbody.innerHTML=quotations.map(function(q){
        var badgeMap={draft:'badge-secondary',sent:'badge-info',approved:'badge-success',cancelled:'badge-danger'};
        return '<tr>'
          +'<td>'+escapeHtml(q.quotNo||q.quotationId||'')+'</td>'
          +'<td>'+escapeHtml(q.client||'')+'</td>'
          +'<td>'+formatDate(q.date)+'</td>'
          +'<td>'+formatDate(q.eventDate)+'</td>'
          +'<td>'+formatCurrency(q.total||0)+'</td>'
          +'<td><span class="badge '+(badgeMap[q.status]||'')+'">'+escapeHtml(q.status||'draft')+'</span></td>'
          +'<td style="display:flex;gap:4px">'
          +'<button class="btn btn-ghost btn-sm print-badge" onclick="openModal(\''+escapeHtml(q.quotationId||'')+'\')">✏️</button>'
          +'<button class="btn btn-secondary btn-sm" onclick="generatePdf(\''+escapeHtml(q.quotationId||'')+'\')">📄 PDF</button>'
          +'<button class="btn btn-danger btn-sm" onclick="deleteQuot(\''+escapeHtml(q.quotationId||'')+'\')">🗑️</button>'
          +'</td></tr>';
      }).join('');
    });
  }

  function openModal(id){
    document.getElementById('quotModal').style.display='flex';
    document.getElementById('quotForm').reset();
    document.getElementById('quotId').value='';
    document.getElementById('qDate').value=new Date().toISOString().substring(0,10);
    document.getElementById('qItems').innerHTML='';
    addItem(); addItem(); addItem();
    calcTotal();
    document.getElementById('quotModalTitle').textContent=id?'แก้ไขใบเสนอราคา':'ใบเสนอราคาใหม่';
    if(id){
      var q=quotations.find(function(x){return x.quotationId===id;});
      if(q){
        document.getElementById('quotId').value=q.quotationId||'';
        document.getElementById('qClient').value=q.client||'';
        document.getElementById('qDate').value=(q.date||'').substring(0,10);
        document.getElementById('qEventDate').value=(q.eventDate||'').substring(0,10);
        document.getElementById('qVenue').value=q.venue||'';
        document.getElementById('qDiscount').value=q.discount||0;
        document.getElementById('qVat').value=q.vatRate||7;
        document.getElementById('qNotes').value=q.notes||'';
        document.getElementById('qItems').innerHTML='';
        var items=[];
        try{ items=typeof q.items==='string'?JSON.parse(q.items):q.items||[]; }catch(e){ items=[]; }
        items.forEach(function(item){ addItem(item.desc,item.qty,item.price); });
        if(!items.length){addItem();addItem();}
        calcTotal();
      }
    }
  }

  function closeModal(){ document.getElementById('quotModal').style.display='none'; }

  function addItem(desc,qty,price){
    var row=document.createElement('div'); row.className='item-row';
    row.innerHTML='<input type="text" placeholder="รายการ" class="item-desc" value="'+(desc?escapeHtml(String(desc)):'')+'" oninput="calcTotal()">'
      +'<input type="number" placeholder="จำนวน" class="item-qty" value="'+(qty||1)+'" min="0" oninput="calcTotal()">'
      +'<input type="number" placeholder="ราคา/หน่วย" class="item-price" value="'+(price||0)+'" min="0" oninput="calcTotal()">'
      +'<button type="button" class="btn btn-danger btn-sm" onclick="this.parentNode.remove();calcTotal()">×</button>';
    document.getElementById('qItems').appendChild(row);
  }

  function calcTotal(){
    var items=Array.from(document.querySelectorAll('.item-row'));
    var subtotal=items.reduce(function(s,r){
      var qty=parseFloat(r.querySelector('.item-qty').value)||0;
      var price=parseFloat(r.querySelector('.item-price').value)||0;
      return s+qty*price;
    },0);
    var discount=parseFloat(document.getElementById('qDiscount').value)||0;
    var vatRate=parseFloat(document.getElementById('qVat').value)||0;
    var afterDiscount=subtotal-discount;
    var vat=Math.round(afterDiscount*(vatRate/100));
    var total=afterDiscount+vat;
    document.getElementById('qSubtotal').textContent=formatCurrency(afterDiscount);
    document.getElementById('qVatAmt').textContent=formatCurrency(vat)+(vatRate?(' ('+vatRate+'%)'):'');
    document.getElementById('qTotal').textContent=formatCurrency(total);
  }

  document.getElementById('quotForm').addEventListener('submit', function(e){
    e.preventDefault();
    var btn=document.getElementById('saveQuotBtn'); btn.disabled=true; btn.textContent=t('loading');
    var items=Array.from(document.querySelectorAll('.item-row')).map(function(r){
      return {desc:r.querySelector('.item-desc').value,qty:r.querySelector('.item-qty').value,price:r.querySelector('.item-price').value};
    }).filter(function(i){return i.desc||i.price;});
    var discount=parseFloat(document.getElementById('qDiscount').value)||0;
    var vatRate=parseFloat(document.getElementById('qVat').value)||0;
    var id=document.getElementById('quotId').value;
    var action=id?'updateQuotation':'addQuotation';
    apiCall(action,{
      quotationId:id, client:document.getElementById('qClient').value.trim(),
      date:document.getElementById('qDate').value, eventDate:document.getElementById('qEventDate').value,
      venue:document.getElementById('qVenue').value.trim(), items:JSON.stringify(items),
      discount:discount, vatRate:vatRate, notes:document.getElementById('qNotes').value
    },function(r){
      btn.disabled=false; btn.textContent=t('save');
      if(r&&r.success){ showToast(t('msg_saved'),'success'); closeModal(); loadQuotations(); }
      else showToast((r&&r.message)||t('msg_error'),'error');
    });
  });

  function generatePdf(id){
    showToast('กำลังสร้าง PDF...','info');
    apiCall('generateQuotationPdf',{quotationId:id},function(r){
      if(r&&r.success&&r.url){ window.open(r.url,'_blank'); showToast(t('msg_success'),'success'); }
      else showToast((r&&r.message)||t('msg_error'),'error');
    });
  }

  function deleteQuot(id){
    showConfirm(t('confirmDeleteTitle'),t('confirmDeleteMsg')).then(function(ok){
      if(!ok) return;
      apiCall('deleteQuotation',{quotationId:id},function(r){
        if(r&&r.success){ showToast(t('msg_deleted'),'success'); loadQuotations(); }
        else showToast((r&&r.message)||t('msg_error'),'error');
      });
    });
  }
  </script>
</body>
</html>
