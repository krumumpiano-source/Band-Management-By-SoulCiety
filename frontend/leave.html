<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>คนลาคนแทน — Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <?!= include('css_theme') ?>
  <?!= include('css_nav') ?>
  <?!= include('css_browser-compat') ?>
  <style>
    .leave-header{background:linear-gradient(135deg,#2d3748,#4a5568);color:#fff;border-radius:var(--radius-xl);padding:var(--spacing-xl) var(--spacing-2xl);margin-bottom:var(--spacing-xl);display:flex;align-items:center;gap:var(--spacing-md)}
    .leave-header h2{font-size:var(--text-xl);font-weight:700;margin:0}
    .leave-header p{font-size:var(--text-sm);color:#cbd5e0;margin:4px 0 0}
    .leave-tabs{display:flex;gap:var(--spacing-sm);margin-bottom:var(--spacing-xl);flex-wrap:wrap}
    .leave-tab{padding:8px 20px;border-radius:var(--radius-full);cursor:pointer;font-size:var(--text-sm);background:var(--premium-light-gray);border:none;font-family:var(--font-family-body);color:var(--premium-text);transition:background .2s, color .2s}
    .leave-tab.active{background:var(--premium-gold);color:#fff;font-weight:600}
    .tab-panel{display:none}.tab-panel.active{display:block}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-md)}
    @media(max-width:600px){.form-row{grid-template-columns:1fr}}
    .slot-btns{display:flex;flex-wrap:wrap;gap:var(--spacing-sm);margin:var(--spacing-sm) 0}
    .slot-btn{padding:8px 16px;border-radius:var(--radius-full);border:2px solid var(--premium-border);background:#fff;cursor:pointer;font-size:var(--text-sm);font-family:var(--font-family-body);color:var(--premium-text);transition:all .2s}
    .slot-btn.selected{border-color:var(--premium-gold);background:var(--premium-gold);color:#fff;font-weight:600}
    .leave-list{display:flex;flex-direction:column;gap:var(--spacing-md)}
    .leave-card{background:var(--premium-white);border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);padding:var(--spacing-lg);border-left:4px solid var(--premium-border)}
    .leave-card.pending{border-left-color:#ed8936}.leave-card.approved{border-left-color:#276749}.leave-card.rejected{border-left-color:#c53030}
    .leave-card-head{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px}
    .leave-card-head h4{margin:0;font-size:var(--text-md);font-weight:600}
    .leave-badge{padding:4px 12px;border-radius:var(--radius-full);font-size:12px;font-weight:600}
    .leave-badge.pending{background:#fef3c7;color:#92400e}.leave-badge.approved{background:#d1fae5;color:#065f46}.leave-badge.rejected{background:#fee2e2;color:#991b1b}
    .leave-card-body{margin:8px 0 0;font-size:var(--text-sm);color:var(--premium-text-light)}
    .leave-card-body span{color:var(--premium-text);font-weight:500}
    .sub-info{font-size:12px;color:var(--premium-text-muted);margin-top:6px}
    .assign-form{background:var(--premium-off-white);border-radius:var(--radius-md);padding:var(--spacing-md);margin-top:10px}
    .assign-form h5{margin:0 0 8px;font-size:var(--text-sm);font-weight:600}
    .member-select-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
    .member-chip{padding:6px 14px;border-radius:var(--radius-full);border:2px solid var(--premium-border);cursor:pointer;font-size:var(--text-sm);font-family:var(--font-family-body);background:#fff;transition:all .2s}
    .member-chip.selected{border-color:var(--premium-gold);background:var(--premium-gold);color:#fff}
    .empty-card{text-align:center;padding:var(--spacing-2xl);color:var(--premium-text-muted)}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>

  <main>
    <div class="container">
      <div class="leave-header">
        <div style="font-size:36px">🔄</div>
        <div>
          <h2>คนลาคนแทน</h2>
          <p>ขอลางาน และจัดการคนแทน</p>
        </div>
      </div>

      <div class="leave-tabs" id="leaveTabs">
        <button class="leave-tab active" data-tab="myRequest">คำขอลาของฉัน</button>
        <button class="leave-tab" data-tab="requestLeave">ขอลางาน</button>
      </div>

      <!-- Tab: My Leave Requests -->
      <div class="tab-panel active" id="tab-myRequest">
        <div class="card">
          <div class="card-header"><h3 class="card-title">รายการขอลาของฉัน</h3></div>
          <div id="myLeaveList"><div class="empty-card">⏳ กำลังโหลด...</div></div>
        </div>
      </div>

      <!-- Tab: Request Leave Form -->
      <div class="tab-panel" id="tab-requestLeave">
        <div class="card">
          <div class="card-header"><h3 class="card-title">ขอลางาน</h3></div>
          <div class="form-group">
            <label class="form-label">วันที่ต้องการลา</label>
            <input type="date" id="leaveDate" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">สถานที่</label>
            <select id="leaveVenue" class="form-control"><option value="">กำลังโหลด...</option></select>
          </div>
          <div class="form-group">
            <label class="form-label">ช่วงเวลาที่ต้องการลา</label>
            <div class="slot-btns" id="leaveSlotBtns">
              <p style="color:var(--premium-text-muted);font-size:var(--text-sm)">เลือกวันที่ก่อน</p>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">เหตุผล (ไม่บังคับ)</label>
            <textarea id="leaveReason" class="form-control" rows="3" placeholder="เช่น ป่วย ธุระด่วน ฯลฯ"></textarea>
          </div>
          <button class="btn btn-primary" id="leaveSubmitBtn">✅ ส่งคำขอลา</button>
        </div>
      </div>

      <!-- Tab: All Requests (Manager/Admin) -->
      <div class="tab-panel" id="tab-allRequests">
        <div class="card">
          <div class="card-header"><h3 class="card-title">คำขอลาทั้งหมดในวง</h3></div>
          <div id="allLeaveList"><div class="empty-card">⏳ กำลังโหลด...</div></div>
        </div>
      </div>
    </div>
  </main>

  <?!= include('js_i18n') ?>
  <?!= include('js_app') ?>
  <?!= include('js_nav') ?>
  <script>
  var lvBandId = '';
  var lvUserRole = '';
  var lvIsManager = false;
  var lvBandSettings = { venues: [], members: [] };
  var lvSelectedSlots = [];

  function lvEsc(s) { var d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }
  function lvFmt(s) { if (!s) return ''; return new Date(s).toLocaleDateString('th-TH', {day:'numeric',month:'long',year:'numeric'}); }

  // ===== TABS =====
  function lvActivateTab(tabName) {
    document.querySelectorAll('.leave-tab').forEach(function(b) { b.classList.remove('active'); });
    document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
    var btn = document.querySelector('[data-tab="' + tabName + '"]');
    var panel = document.getElementById('tab-' + tabName);
    if (btn) btn.classList.add('active');
    if (panel) panel.classList.add('active');
    if (tabName === 'allRequests') lvLoadAllRequests();
    if (tabName === 'myRequest') lvLoadMyRequests();
  }

  document.getElementById('leaveTabs').addEventListener('click', function(e) {
    var btn = e.target.closest('.leave-tab');
    if (btn && btn.dataset.tab) lvActivateTab(btn.dataset.tab);
  });

  // ===== LOAD SETTINGS =====
  function lvLoadSettings(cb) {
    var stored = localStorage.getItem('bandSettings');
    if (stored) {
      try {
        var s = JSON.parse(stored);
        lvBandSettings.venues = s.venues || [];
        lvBandSettings.members = s.members || [];
      } catch(e) {}
    }
    if (lvBandSettings.venues.length > 0) { cb(); return; }
    if (lvBandId && typeof apiCall === 'function') {
      apiCall('getBandSettings', { bandId: lvBandId }, function(r) {
        if (r && r.success && r.data) {
          lvBandSettings.venues = r.data.venues || [];
          lvBandSettings.members = r.data.members || [];
          try { localStorage.setItem('bandSettings', JSON.stringify(r.data)); } catch(e) {}
        }
        cb();
      });
    } else { cb(); }
  }

  function lvRenderVenues() {
    var sel = document.getElementById('leaveVenue');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- เลือกสถานที่ --</option>';
    (lvBandSettings.venues || []).forEach(function(v) {
      var name = v.name || v.venueName || String(v);
      var opt = document.createElement('option'); opt.value = name; opt.textContent = name;
      sel.appendChild(opt);
    });
    if (!lvBandSettings.venues.length) {
      sel.innerHTML = '<option value="ร้านหลัก">ร้านหลัก</option>';
    }
  }

  function lvGetSlots(dateStr) {
    if (!dateStr) return [];
    var dow = new Date(dateStr).getDay();
    return ['19:30-20:30', '21:00-22:00', '22:30-23:30'];
  }

  function lvRenderSlots() {
    var date = document.getElementById('leaveDate').value;
    var container = document.getElementById('leaveSlotBtns');
    lvSelectedSlots = [];
    if (!date) {
      container.innerHTML = '<p style="color:var(--premium-text-muted);font-size:var(--text-sm)">เลือกวันที่ก่อน</p>';
      return;
    }
    var slots = lvGetSlots(date);
    container.innerHTML = slots.map(function(key) {
      var parts = key.split('-');
      return '<button type="button" class="slot-btn" data-slot="' + lvEsc(key) + '">🕐 ' + lvEsc(parts[0] + ' – ' + parts[1]) + '</button>';
    }).join('');
    container.querySelectorAll('.slot-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var slot = btn.dataset.slot;
        if (btn.classList.contains('selected')) {
          btn.classList.remove('selected');
          lvSelectedSlots = lvSelectedSlots.filter(function(s) { return s !== slot; });
        } else {
          btn.classList.add('selected');
          lvSelectedSlots.push(slot);
        }
      });
    });
  }

  document.getElementById('leaveSubmitBtn').addEventListener('click', function() {
    var date = document.getElementById('leaveDate').value;
    var venue = document.getElementById('leaveVenue').value;
    var reason = document.getElementById('leaveReason').value;
    if (!date) { showToast('กรุณาเลือกวันที่', 'error'); return; }
    if (!venue) { showToast('กรุณาเลือกสถานที่', 'error'); return; }
    if (!lvSelectedSlots.length) { showToast('กรุณาเลือกช่วงเวลาที่ต้องการลา', 'error'); return; }
    var btn = document.getElementById('leaveSubmitBtn');
    btn.disabled = true; btn.textContent = '⏳ กำลังส่ง...';
    apiCall('requestLeave', { bandId: lvBandId, memberId: localStorage.getItem('odooMemberId') || localStorage.getItem('memberId') || '', memberName: localStorage.getItem('userName') || '', date: date, venue: venue, slots: JSON.stringify(lvSelectedSlots), reason: reason }, function(r) {
      btn.disabled = false; btn.textContent = '✅ ส่งคำขอลา';
      if (r && r.success) {
        showToast('ส่งคำขอลาเรียบร้อยแล้ว รอผู้จัดการดำเนินการ', 'success');
        document.getElementById('leaveDate').value = '';
        document.getElementById('leaveReason').value = '';
        lvSelectedSlots = [];
        document.querySelectorAll('.slot-btn').forEach(function(b) { b.classList.remove('selected'); });
        lvActivateTab('myRequest');
      } else {
        showToast((r && r.message) || 'เกิดข้อผิดพลาด กรุณาลองใหม่', 'error');
      }
    });
  });

  function lvLoadMyRequests() {
    var container = document.getElementById('myLeaveList');
    container.innerHTML = '<div class="empty-card">⏳ กำลังโหลด...</div>';
    apiCall('getMyLeaveRequests', { bandId: lvBandId }, function(r) {
      if (!r || !r.success || !r.data || !r.data.length) {
        container.innerHTML = '<div class="empty-card">📋 ยังไม่มีรายการขอลา</div>'; return;
      }
      container.innerHTML = r.data.map(function(item) {
        var badge = item.status === 'approved' ? 'approved' : (item.status === 'rejected' ? 'rejected' : 'pending');
        var badgeText = { approved: 'มีคนแทนแล้ว', rejected: 'ปฏิเสธ', pending: 'รอดำเนินการ' }[badge] || badge;
        var slots = Array.isArray(item.slots) ? item.slots.map(function(s) { var p=s.split('-');return p[0]+' – '+p[1]; }).join(', ') : (item.slots||'');
        return '<div class="leave-card '+badge+'">'
          +'<div class="leave-card-head"><h4>📅 '+lvEsc(lvFmt(item.date))+' · '+lvEsc(item.venue||'')+'</h4>'
          +'<span class="leave-badge '+badge+'">'+badgeText+'</span></div>'
          +'<div class="leave-card-body">⏰ ช่วงเวลา: <span>'+lvEsc(slots)+'</span>'
          +(item.reason ? '<br>หมายเหตุ: <span>'+lvEsc(item.reason)+'</span>' : '')
          +(item.substitute ? '<br>คนแทน: <span>'+lvEsc(item.substitute)+'</span>' : '')
          +'</div><div class="sub-info">ส่งเมื่อ: '+lvEsc(item.createdAt ? new Date(item.createdAt).toLocaleDateString('th-TH') : '')+'</div></div>';
      }).join('');
    });
  }

  function lvLoadAllRequests() {
    var container = document.getElementById('allLeaveList');
    container.innerHTML = '<div class="empty-card">⏳ กำลังโหลด...</div>';
    apiCall('getAllLeaveRequests', { bandId: lvBandId }, function(r) {
      if (!r || !r.success || !r.data || !r.data.length) {
        container.innerHTML = '<div class="empty-card">📋 ยังไม่มีคำขอลาในวง</div>'; return;
      }
      var members = lvBandSettings.members || [];
      container.innerHTML = r.data.map(function(item) {
        var badge = item.status === 'approved' ? 'approved' : (item.status === 'rejected' ? 'rejected' : 'pending');
        var badgeText = { approved: 'มีคนแทนแล้ว', rejected: 'ปฏิเสธ', pending: 'รอดำเนินการ' }[badge] || badge;
        var slots = Array.isArray(item.slots) ? item.slots.map(function(s) { var p=s.split('-');return p[0]+' – '+p[1]; }).join(', ') : (item.slots||'');
        var assignSection = badge === 'pending' ? (
          '<div class="assign-form"><h5>จัดคนแทน</h5>'
          +'<div class="member-select-grid" id="memberChips_'+lvEsc(item.id)+'">'
          +members.filter(function(m){ return m.name !== item.memberName; }).map(function(m){
            return '<button type="button" class="member-chip" data-member="'+lvEsc(m.name||m)+'">'+lvEsc(m.name||m)+'</button>';
          }).join('')+'</div>'
          +'<input type="text" class="form-control" style="font-size:var(--text-sm);margin-bottom:8px" placeholder="หรือพิมพ์ชื่อคนนอกวง..." id="subInput_'+lvEsc(item.id)+'">'
          +'<button type="button" class="btn btn-primary btn-sm" onclick="lvAssign(\''+lvEsc(item.id)+'\')">✅ ยืนยัน</button>'
          +' <button type="button" class="btn btn-ghost btn-sm" onclick="lvReject(\''+lvEsc(item.id)+'\')">❌ ปฏิเสธ</button></div>'
        ) : '';
        return '<div class="leave-card '+badge+'" id="leaveCard_'+lvEsc(item.id)+'">'
          +'<div class="leave-card-head"><h4>👤 '+lvEsc(item.memberName||'')+' · '+lvEsc(lvFmt(item.date))+'</h4>'
          +'<span class="leave-badge '+badge+'">'+badgeText+'</span></div>'
          +'<div class="leave-card-body">📍 ร้าน: <span>'+lvEsc(item.venue||'')+'</span> · ⏰ <span>'+lvEsc(slots)+'</span>'
          +(item.reason ? '<br>เหตุผล: <span>'+lvEsc(item.reason)+'</span>' : '')
          +(item.substitute ? '<br>คนแทน: <span>'+lvEsc(item.substitute)+'</span>' : '')
          +'</div>'+assignSection+'</div>';
      }).join('');
      document.querySelectorAll('.member-chip').forEach(function(chip) {
        chip.addEventListener('click', function() {
          var gridId = chip.closest('.member-select-grid').id;
          var itemId = gridId.replace('memberChips_','');
          chip.closest('.member-select-grid').querySelectorAll('.member-chip').forEach(function(c){ c.classList.remove('selected'); });
          chip.classList.add('selected');
          var inp = document.getElementById('subInput_'+itemId);
          if (inp) inp.value = chip.dataset.member;
        });
      });
    });
  }

  function lvAssign(itemId) {
    var inp = document.getElementById('subInput_'+itemId);
    var substitute = inp ? inp.value.trim() : '';
    if (!substitute) { showToast('กรุณาเลือกหรือพิมพ์ชื่อคนแทน', 'error'); return; }
    apiCall('assignSubstitute', { bandId: lvBandId, leaveId: itemId, substitute: substitute }, function(r) {
      if (r && r.success) { showToast('จัดคนแทนเรียบร้อยแล้ว', 'success'); lvLoadAllRequests(); }
      else showToast((r && r.message) || 'เกิดข้อผิดพลาด', 'error');
    });
  }

  function lvReject(itemId) {
    if (!confirm('ต้องการปฏิเสธคำขอลานี้ใช่หรือไม่?')) return;
    apiCall('rejectLeave', { bandId: lvBandId, leaveId: itemId }, function(r) {
      if (r && r.success) { showToast('ปฏิเสธคำขอลาแล้ว', 'success'); lvLoadAllRequests(); }
      else showToast((r && r.message) || 'เกิดข้อผิดพลาด', 'error');
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    requireAuth(); renderMainNav('mainNav'); applyTranslations();
    lvBandId = localStorage.getItem('bandId') || '';
    lvUserRole = localStorage.getItem('userRole') || 'member';
    lvIsManager = (lvUserRole === 'manager' || lvUserRole === 'admin');

    if (lvIsManager) {
      var tabsEl = document.getElementById('leaveTabs');
      if (!document.querySelector('[data-tab="allRequests"]')) {
        var btn = document.createElement('button');
        btn.className = 'leave-tab'; btn.dataset.tab = 'allRequests';
        btn.textContent = '👥 คำขอลาทั้งหมด';
        tabsEl.appendChild(btn);
      }
    }

    var ldEl = document.getElementById('leaveDate');
    if (ldEl) { ldEl.addEventListener('change', lvRenderSlots); }
    var lvEl = document.getElementById('leaveVenue');
    if (lvEl) { lvEl.addEventListener('change', lvRenderSlots); }

    lvLoadSettings(function() { lvRenderVenues(); lvLoadMyRequests(); });
  });
  </script>
</body>
</html>
