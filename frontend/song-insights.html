<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>วิเคราะห์เพลง — Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <?!= include('css_theme') ?>
  <?!= include('css_nav') ?>
  <?!= include('css_browser-compat') ?>
  <style>
    .insight-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:var(--spacing-xl)}
    .bar-row{display:flex;align-items:center;gap:var(--spacing-md);margin-bottom:var(--spacing-sm)}
    .bar-row .label{width:120px;font-size:var(--text-sm);color:var(--premium-text-muted);text-align:right;flex-shrink:0}
    .bar-track{flex:1;height:16px;background:var(--premium-off-white);border-radius:var(--radius-full);overflow:hidden}
    .bar-fill{height:100%;background:var(--premium-gold);border-radius:var(--radius-full);transition:width .5s}
    .bar-val{width:40px;font-size:var(--text-sm);font-weight:600;color:var(--premium-gold);flex-shrink:0}
    .popular-song{display:flex;align-items:center;gap:var(--spacing-md);padding:var(--spacing-sm) 0;border-bottom:1px dashed var(--premium-light-gray)}
    .rank-num{width:28px;height:28px;border-radius:var(--radius-full);background:var(--premium-gold);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0}
    .rank-num.second{background:#a0aec0}.rank-num.third{background:#c6a15b}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <main>
    <div class="container">
      <div class="page-header"><h1 class="page-title" data-i18n="nav_songInsights">วิเคราะห์เพลง</h1></div>
      <div id="insightContent">
        <div class="insight-grid">
          <!-- Key Distribution -->
          <div class="card">
            <div class="card-header"><h3 class="card-title">สัดส่วนตามคีย์</h3></div>
            <div id="keyBars"><div class="empty-state"><p data-i18n="loading">กำลังโหลด...</p></div></div>
          </div>
          <!-- Tempo Distribution -->
          <div class="card">
            <div class="card-header"><h3 class="card-title">สัดส่วนตามจังหวะ</h3></div>
            <div id="tempoBars"><div class="empty-state"><p data-i18n="loading">กำลังโหลด...</p></div></div>
          </div>
          <!-- Genre Distribution -->
          <div class="card">
            <div class="card-header"><h3 class="card-title">สัดส่วนตามแนวดนตรี</h3></div>
            <div id="genreBars"><div class="empty-state"><p data-i18n="loading">กำลังโหลด...</p></div></div>
          </div>
          <!-- Most Used in Setlist -->
          <div class="card">
            <div class="card-header"><h3 class="card-title">เพลงที่ใช้บ่อยในเซ็ตลิสต์</h3></div>
            <div id="popularSongs"><div class="empty-state"><p data-i18n="loading">กำลังโหลด...</p></div></div>
          </div>
        </div>
        <!-- Full song table -->
        <div class="card" style="margin-top:var(--spacing-xl)">
          <div class="card-header"><h3 class="card-title">รายการเพลงทั้งหมด</h3>
            <span id="songCount" style="color:var(--premium-text-muted);font-size:var(--text-sm)"></span>
          </div>
          <div class="table-responsive">
            <table class="table">
              <thead><tr><th>#</th><th>ชื่อเพลง</th><th>ศิลปิน</th><th>คีย์</th><th>จังหวะ</th><th>แนวดนตรี</th><th>ความยาว</th></tr></thead>
              <tbody id="songTableBody"><tr><td colspan="7" class="text-center">กำลังโหลด...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>
  <?!= include('js_i18n') ?>
  <?!= include('js_app') ?>
  <?!= include('js_nav') ?>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    requireAuth(); renderMainNav('mainNav'); applyTranslations();
    apiCall('getAllBandSongs', {}, function(r) {
      var songs = (r && r.success && r.data) ? r.data : [];
      document.getElementById('songCount').textContent = songs.length + ' เพลง';
      // Key distribution
      renderDistBar('keyBars', countBy(songs,'key'));
      // Tempo distribution
      renderDistBar('tempoBars', countBy(songs,'tempo'));
      // Genre distribution
      renderDistBar('genreBars', countBy(songs,'genre'));
      // Popular (fake for now — use setlist data if available)
      document.getElementById('popularSongs').innerHTML = songs.slice(0,5).map(function(s,i){
        return '<div class="popular-song">'
          +'<div class="rank-num'+(i===1?' second':i===2?' third':'')+'">'+( i+1)+'</div>'
          +'<div><strong>'+escapeHtml(s.title||'')+'</strong><br><span style="font-size:var(--text-xs);color:var(--premium-text-muted)">'+escapeHtml(s.artist||'')+'</span></div>'
          +'</div>';
      }).join('') || '<div class="empty-state"><p>'+t('noData')+'</p></div>';
      // Full table
      var tbody = document.getElementById('songTableBody');
      tbody.innerHTML = songs.length ? songs.map(function(s,i){
        return '<tr><td>'+(i+1)+'</td><td>'+escapeHtml(s.title||'')+'</td><td>'+escapeHtml(s.artist||'')+'</td>'
          +'<td>'+escapeHtml(s.key||'')+'</td><td>'+escapeHtml(s.tempo||'')+'</td><td>'+escapeHtml(s.genre||'')+'</td>'
          +'<td>'+(s.duration?s.duration+' นาที':'')+'</td></tr>';
      }).join('') : '<tr><td colspan="7" class="text-center">'+t('noData')+'</td></tr>';
    });
  });

  function countBy(arr, field) {
    var counts = {};
    arr.forEach(function(s){ var v = s[field]||'ไม่ระบุ'; counts[v] = (counts[v]||0)+1; });
    return counts;
  }

  function renderDistBar(containerId, counts) {
    var max = Math.max.apply(null, Object.values(counts)) || 1;
    var html = Object.entries(counts).sort(function(a,b){return b[1]-a[1];}).slice(0,8).map(function(e){
      return '<div class="bar-row"><span class="label">'+escapeHtml(e[0])+'</span>'
        +'<div class="bar-track"><div class="bar-fill" style="width:'+Math.round(e[1]/max*100)+'%"></div></div>'
        +'<span class="bar-val">'+e[1]+'</span></div>';
    }).join('');
    document.getElementById(containerId).innerHTML = html || '<div class="empty-state"><p>'+t('noData')+'</p></div>';
  }
  </script>
</body>
</html>
