<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>à¸ªà¸–à¸´à¸•à¸´ â€” Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <?!= include('css_theme') ?>
  <?!= include('css_nav') ?>
  <?!= include('css_browser-compat') ?>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    /* â”€â”€ Period Tabs â”€â”€ */
    .period-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:var(--spacing-lg)}
    .period-tab{padding:8px 18px;border-radius:var(--radius-full);border:1.5px solid var(--premium-border);background:#fff;font-size:var(--text-sm);font-weight:600;cursor:pointer;transition:.2s}
    .period-tab.active{background:var(--premium-gold);color:#fff;border-color:var(--premium-gold)}
    .period-nav{display:flex;align-items:center;gap:var(--spacing-md);margin-bottom:var(--spacing-lg);flex-wrap:wrap}
    .period-nav .nav-btn{width:36px;height:36px;border-radius:50%;border:1.5px solid var(--premium-border);background:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .period-nav .nav-btn:hover{background:var(--premium-off-white)}
    .period-label{font-weight:700;font-size:var(--text-base);color:var(--premium-text)}

    /* â”€â”€ Member selector (manager) â”€â”€ */
    .member-selector{margin-bottom:var(--spacing-lg);display:flex;gap:var(--spacing-md);align-items:center;flex-wrap:wrap}
    .member-selector select{padding:8px 14px;border-radius:var(--radius-md);border:1.5px solid var(--premium-border);font-size:var(--text-sm);font-family:inherit;min-width:180px}
    .member-selector .mgr-badge{background:#805ad5;color:#fff;font-size:11px;padding:2px 10px;border-radius:var(--radius-full);font-weight:600}

    /* â”€â”€ Overview Cards â”€â”€ */
    .stat-overview{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:var(--spacing-md);margin-bottom:var(--spacing-xl)}
    .stat-card{background:#fff;border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);padding:var(--spacing-lg);text-align:center;border-left:4px solid var(--premium-gold)}
    .stat-card .ico{font-size:28px;margin-bottom:4px}
    .stat-card .val{font-size:var(--text-xl);font-weight:700;color:var(--premium-text)}
    .stat-card .lbl{font-size:var(--text-xs);color:var(--premium-text-muted);margin-top:2px}
    .stat-card.green{border-left-color:#38a169} .stat-card.green .val{color:#276749}
    .stat-card.purple{border-left-color:#805ad5} .stat-card.purple .val{color:#553c9a}
    .stat-card.red{border-left-color:#e53e3e} .stat-card.red .val{color:#c53030}
    .stat-card.blue{border-left-color:#3182ce} .stat-card.blue .val{color:#2b6cb0}

    /* â”€â”€ Charts â”€â”€ */
    .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-xl);margin-bottom:var(--spacing-xl)}
    @media(max-width:768px){.charts-grid{grid-template-columns:1fr}}
    .chart-card{background:#fff;border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);padding:var(--spacing-lg)}
    .chart-card h3{font-size:var(--text-sm);font-weight:700;margin-bottom:var(--spacing-md);color:var(--premium-text)}
    .chart-canvas-wrap{position:relative;width:100%;max-height:280px}

    /* â”€â”€ Detail Table â”€â”€ */
    .detail-card{background:#fff;border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);padding:var(--spacing-lg);margin-bottom:var(--spacing-xl)}
    .detail-card h3{font-size:var(--text-sm);font-weight:700;margin-bottom:var(--spacing-md)}
    .detail-table{width:100%;border-collapse:collapse;font-size:var(--text-sm)}
    .detail-table th,.detail-table td{padding:8px 10px;border-bottom:1px solid var(--premium-border);text-align:left}
    .detail-table th{background:var(--premium-off-white);font-weight:600;color:var(--premium-text-muted);font-size:var(--text-xs)}
    .detail-table .leave-row{background:#fff5f5}
    .detail-table .no-sub{color:#e53e3e;font-weight:600}
    .detail-table .has-sub{color:#805ad5;font-weight:600}
    .detail-table tr:last-child td{border-bottom:none}

    /* â”€â”€ Manager All-Members Table â”€â”€ */
    .all-members-card{background:#fff;border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);padding:var(--spacing-lg);margin-bottom:var(--spacing-xl)}
    .all-members-card h3{font-size:var(--text-sm);font-weight:700;margin-bottom:var(--spacing-md)}
    .all-members-table{width:100%;border-collapse:collapse;font-size:var(--text-sm)}
    .all-members-table th,.all-members-table td{padding:8px 10px;border-bottom:1px solid var(--premium-border);text-align:center}
    .all-members-table th{background:var(--premium-off-white);font-weight:600;color:var(--premium-text-muted);font-size:var(--text-xs)}
    .all-members-table td:first-child{text-align:left;font-weight:600}

    /* Print */
    @media print{.period-tabs,.period-nav .nav-btn,.member-selector,.page-header button{display:none!important}.charts-grid{break-inside:avoid}}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">ğŸ“Š à¸ªà¸–à¸´à¸•à¸´à¹à¸¥à¸°à¸£à¸²à¸¢à¸‡à¸²à¸™</h1>
        <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ à¸à¸´à¸¡à¸à¹Œ</button>
      </div>

      <!-- Period Tabs -->
      <div class="period-tabs" id="periodTabs">
        <button class="period-tab" data-period="day">à¸£à¸²à¸¢à¸§à¸±à¸™</button>
        <button class="period-tab active" data-period="week">à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ</button>
        <button class="period-tab" data-period="month">à¹€à¸”à¸·à¸­à¸™</button>
        <button class="period-tab" data-period="year">à¸›à¸µ</button>
      </div>

      <!-- Period Navigation -->
      <div class="period-nav">
        <button class="nav-btn" id="prevPeriod">â—€</button>
        <span class="period-label" id="periodLabel">â€”</span>
        <button class="nav-btn" id="nextPeriod">â–¶</button>
      </div>

      <!-- Manager: member selector -->
      <div class="member-selector" id="memberSelector" style="display:none">
        <span class="mgr-badge">ğŸ‘‘ à¸œà¸¹à¹‰à¸ˆà¸±à¸”à¸à¸²à¸£</span>
        <select id="memberPicker">
          <option value="__all">ğŸ“Š à¸—à¸¸à¸à¸„à¸™à¸£à¸§à¸¡</option>
        </select>
      </div>

      <!-- Overview Cards -->
      <div class="stat-overview" id="overviewCards"></div>

      <!-- Charts -->
      <div class="charts-grid" id="chartsArea">
        <div class="chart-card">
          <h3>ğŸ“ˆ à¸£à¸²à¸¢à¹„à¸”à¹‰à¸•à¸²à¸¡à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²</h3>
          <div class="chart-canvas-wrap"><canvas id="chartEarnings"></canvas></div>
        </div>
        <div class="chart-card">
          <h3>â±ï¸ à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡à¸—à¸³à¸‡à¸²à¸™</h3>
          <div class="chart-canvas-wrap"><canvas id="chartHours"></canvas></div>
        </div>
        <div class="chart-card">
          <h3>ğŸš« à¸ªà¸£à¸¸à¸›à¸§à¸±à¸™à¸¥à¸²</h3>
          <div class="chart-canvas-wrap"><canvas id="chartLeave"></canvas></div>
        </div>
        <div class="chart-card">
          <h3>ğŸ”„ à¸„à¹ˆà¸²à¸ˆà¹‰à¸²à¸‡à¸„à¸™à¹à¸—à¸™</h3>
          <div class="chart-canvas-wrap"><canvas id="chartSub"></canvas></div>
        </div>
      </div>

      <!-- Daily Detail Table -->
      <div class="detail-card" id="detailCard">
        <h3>ğŸ“‹ à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹à¸•à¹ˆà¸¥à¸°à¸§à¸±à¸™</h3>
        <div style="overflow-x:auto">
          <table class="detail-table" id="detailTable">
            <thead><tr><th>à¸§à¸±à¸™à¸—à¸µà¹ˆ</th><th>à¸ªà¸–à¸²à¸™à¸°</th><th>à¹€à¸šà¸£à¸„</th><th>à¸Šà¸¡.</th><th>à¸£à¸²à¸¢à¹„à¸”à¹‰</th><th>à¸„à¸™à¹à¸—à¸™</th><th>à¸ˆà¹ˆà¸²à¸¢à¸„à¸™à¹à¸—à¸™</th></tr></thead>
            <tbody id="detailTbody"><tr><td colspan="7" style="text-align:center;color:var(--premium-text-muted)">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Manager: All Members Summary -->
      <div class="all-members-card" id="allMembersCard" style="display:none">
        <h3>ğŸ‘¥ à¸ªà¸£à¸¸à¸›à¸ªà¸¡à¸²à¸Šà¸´à¸à¸—à¸±à¹‰à¸‡à¸§à¸‡</h3>
        <div style="overflow-x:auto">
          <table class="all-members-table">
            <thead><tr><th>à¸ªà¸¡à¸²à¸Šà¸´à¸</th><th>à¹€à¸šà¸£à¸„</th><th>à¸Šà¸¡.</th><th>à¸£à¸²à¸¢à¹„à¸”à¹‰</th><th>à¸¥à¸²(à¸¡à¸µà¹à¸—à¸™)</th><th>à¸¥à¸²(à¹„à¸¡à¹ˆà¸¡à¸µ)</th><th>à¸ˆà¹ˆà¸²à¸¢à¸„à¸™à¹à¸—à¸™</th><th>à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­</th></tr></thead>
            <tbody id="allMembersTbody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </main>

  <?!= include('js_i18n') ?>
  <?!= include('js_app') ?>
  <?!= include('js_nav') ?>
  <script>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Statistics â€” Band Management By SoulCiety
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  (function() {
    'use strict';

    // â”€â”€ State â”€â”€
    var currentPeriod = 'week';
    var periodOffset  = 0;
    var scheduleData  = {};
    var bandMembers   = [];
    var weekStart = 1, weekEnd = 0;
    var myId = '', myRole = '', bandId = '';
    var selectedMemberId = '__self';

    // â”€â”€ Chart instances â”€â”€
    var chartEarningsInst, chartHoursInst, chartLeaveInst, chartSubInst;

    // â”€â”€ DOM Ready â”€â”€
    document.addEventListener('DOMContentLoaded', function() {
      requireAuth();
      renderMainNav('mainNav');
      applyTranslations();

      bandId = localStorage.getItem('bandId') || '';
      myRole = localStorage.getItem('userRole') || '';
      try {
        var authStr = localStorage.getItem('sb-wsorngsyowgxikiepice-auth-token') || '';
        if (authStr) { var ad = JSON.parse(authStr); myId = (ad.user && ad.user.id) || ''; }
      } catch(e) {}
      if (!myId) myId = localStorage.getItem('odooMemberId') || localStorage.getItem('memberId') || '';

      // Tab clicks
      document.querySelectorAll('.period-tab').forEach(function(btn) {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.period-tab').forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          currentPeriod = btn.dataset.period;
          periodOffset = 0;
          loadAll();
        });
      });
      document.getElementById('prevPeriod').addEventListener('click', function() { periodOffset--; loadAll(); });
      document.getElementById('nextPeriod').addEventListener('click', function() { periodOffset++; loadAll(); });
      document.getElementById('memberPicker').addEventListener('change', function() {
        selectedMemberId = this.value;
        renderStats();
      });

      // Load band settings first, then stats
      loadBandSettings(function() { loadAll(); });
    });

    // â”€â”€ Load Band Settings â”€â”€
    function loadBandSettings(cb) {
      var stored = null;
      try { stored = JSON.parse(localStorage.getItem('bandSettings') || 'null'); } catch(e) {}
      function apply(s) {
        scheduleData = s.scheduleData || s.schedule || {};
        bandMembers  = s.members || [];
        if (s.payroll) {
          if (s.payroll.weekStart !== undefined) weekStart = parseInt(s.payroll.weekStart, 10);
          if (s.payroll.weekEnd   !== undefined) weekEnd   = parseInt(s.payroll.weekEnd, 10);
        }
        setupMemberSelector();
      }
      if (stored && (stored.schedule || stored.scheduleData) && stored.members) {
        apply(stored);
        if (cb) cb();
        // Also refresh in background
        if (bandId && typeof apiCall === 'function') {
          apiCall('getBandSettings', { bandId: bandId }, function(r) {
            if (r && r.success && r.data) {
              try { localStorage.setItem('bandSettings', JSON.stringify(r.data)); } catch(e) {}
              apply(r.data);
            }
          });
        }
        return;
      }
      if (bandId && typeof apiCall === 'function') {
        apiCall('getBandSettings', { bandId: bandId }, function(r) {
          if (r && r.success && r.data) {
            try { localStorage.setItem('bandSettings', JSON.stringify(r.data)); } catch(e) {}
            apply(r.data);
          }
          if (cb) cb();
        });
      } else { if (cb) cb(); }
    }

    // â”€â”€ Setup member selector for managers â”€â”€
    function setupMemberSelector() {
      var isManager = (myRole === 'admin' || myRole === 'manager');
      var sel = document.getElementById('memberSelector');
      var picker = document.getElementById('memberPicker');
      if (!isManager || !bandMembers.length) { sel.style.display = 'none'; selectedMemberId = '__self'; return; }

      sel.style.display = 'flex';
      picker.innerHTML = '<option value="__all">ğŸ“Š à¸—à¸¸à¸à¸„à¸™à¸£à¸§à¸¡</option><option value="__self">ğŸ‘¤ à¸‚à¸­à¸‡à¸‰à¸±à¸™</option>';
      bandMembers.forEach(function(m) {
        var o = document.createElement('option');
        o.value = m.memberId || m.id;
        o.textContent = 'ğŸ‘¤ ' + (m.name || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­');
        picker.appendChild(o);
      });
      selectedMemberId = '__all';
      picker.value = '__all';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Date Range Calculation
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function getDateRange() {
      var today = new Date();
      var start, end, label;
      var DN = ['à¸­à¸².','à¸ˆ.','à¸­.','à¸.','à¸à¸¤.','à¸¨.','à¸ª.'];

      if (currentPeriod === 'day') {
        var d = new Date(today);
        d.setDate(d.getDate() + periodOffset);
        start = end = new Date(d);
        label = DN[d.getDay()] + ' ' + formatThaiDateFull(d);
      } else if (currentPeriod === 'week') {
        var ref = new Date(today);
        ref.setDate(ref.getDate() + periodOffset * 7);
        var dow = ref.getDay();
        var diff = (dow - weekStart + 7) % 7;
        start = new Date(ref); start.setDate(ref.getDate() - diff);
        var span = (weekEnd - weekStart + 7) % 7; if (span === 0) span = 6;
        end = new Date(start); end.setDate(start.getDate() + span);
        label = formatThaiDateFull(start, {year:false}) + ' â€“ ' + formatThaiDateFull(end);
      } else if (currentPeriod === 'month') {
        var mRef = new Date(today.getFullYear(), today.getMonth() + periodOffset, 1);
        start = new Date(mRef.getFullYear(), mRef.getMonth(), 1);
        end = new Date(mRef.getFullYear(), mRef.getMonth() + 1, 0);
        label = THAI_MONTHS_LONG[mRef.getMonth()] + ' ' + (mRef.getFullYear() + 543);
      } else { // year
        var yRef = today.getFullYear() + periodOffset;
        start = new Date(yRef, 0, 1);
        end = new Date(yRef, 11, 31);
        label = 'à¸›à¸µ ' + (yRef + 543);
      }
      // Build date strings
      var dates = [];
      for (var dd = new Date(start); dd <= end; dd.setDate(dd.getDate() + 1)) {
        dates.push(new Date(dd).toISOString().split('T')[0]);
      }
      return { start: start, end: end, dates: dates, label: label };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Helpers
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function parseMin(t) { if (!t) return 0; var p = t.split(':').map(Number); return p[0]*60 + (p[1]||0); }
    function calcH(s, e) { var d = e - s; if (d < 0) d += 1440; return d / 60; }
    function getSlotsForDow(dow) {
      var dayData = scheduleData[dow] || scheduleData[String(dow)];
      if (Array.isArray(dayData)) return dayData;
      if (dayData && dayData.timeSlots) return dayData.timeSlots;
      return [];
    }
    function getMemberRate(slot, mid) {
      var members = slot.members || [];
      for (var i = 0; i < members.length; i++) {
        if (members[i].memberId === mid) return { rate: members[i].rate || 0, type: members[i].rateType || 'shift', assigned: true };
      }
      return { rate: 0, type: 'shift', assigned: false };
    }
    function slotPay(slot, mid) {
      var r = getMemberRate(slot, mid);
      if (r.rate <= 0) return 0;
      if (r.type === 'hourly') return calcH(parseMin(slot.startTime), parseMin(slot.endTime)) * r.rate;
      return r.rate;
    }
    function slotHours(slot) {
      return calcH(parseMin(slot.startTime), parseMin(slot.endTime));
    }
    var DN_SHORT = ['à¸­à¸².','à¸ˆ.','à¸­.','à¸.','à¸à¸¤.','à¸¨.','à¸ª.'];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Data Loading
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    var _allCheckIns = [], _allLeaves = [], _currentRange = null;

    function loadAll() {
      var range = getDateRange();
      _currentRange = range;
      document.getElementById('periodLabel').textContent = range.label;

      // Show loading
      document.getElementById('overviewCards').innerHTML = '<div class="stat-card"><div class="ico">â³</div><div class="val">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</div></div>';
      document.getElementById('detailTbody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--premium-text-muted)">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</td></tr>';

      _allCheckIns = [];
      _allLeaves = [];

      if (range.dates.length === 0) { renderStats(); return; }

      var dateFrom = range.dates[0], dateTo = range.dates[range.dates.length - 1];
      var ciDone = false, lvDone = false;

      // Single range query for check-ins
      apiCall('getCheckInsForRange', { bandId: bandId, dateFrom: dateFrom, dateTo: dateTo }, function(r) {
        if (r && r.success && r.data) _allCheckIns = r.data;
        ciDone = true;
        if (lvDone) renderStats();
      });

      // Single range query for leave requests
      apiCall('getLeaveRequestsForRange', { bandId: bandId, dateFrom: dateFrom, dateTo: dateTo }, function(r) {
        if (r && r.success && r.data) _allLeaves = r.data;
        lvDone = true;
        if (ciDone) renderStats();
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Compute Stats for a Single Member
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function computeMemberStats(mid) {
      var range = _currentRange;
      if (!range) return null;

      // Build check-in map for this member
      var myCheckins = {};
      _allCheckIns.forEach(function(ci) {
        if (ci.memberId !== mid) return;
        if (!myCheckins[ci.date]) myCheckins[ci.date] = { slots: [], status: ci.status, substitute: ci.substitute || null };
        (ci.slots || []).forEach(function(s) {
          if (myCheckins[ci.date].slots.indexOf(s) === -1) myCheckins[ci.date].slots.push(s);
        });
        if (ci.status) myCheckins[ci.date].status = ci.status;
        if (ci.substitute) myCheckins[ci.date].substitute = ci.substitute;
      });

      // Leaves for this member (deduplicated)
      var myLeaves = _allLeaves.filter(function(lv) { return lv.memberId === mid; });
      var subDeductions = [];
      var _subDateDone = {};
      myLeaves.forEach(function(lv) {
        if (!lv.substituteName) return;
        var dk = lv.date + '|' + lv.substituteName;
        if (_subDateDone[dk]) return;
        _subDateDone[dk] = true;
        var existing = subDeductions.find(function(x) { return x.subName === lv.substituteName; });
        if (!existing) { existing = { subName: lv.substituteName, shifts: 0, amount: 0 }; subDeductions.push(existing); }
        // Only count slots that are actually in the leave request
        var lvSlots = lv.slots || [];
        if (typeof lvSlots === 'string') { try { lvSlots = JSON.parse(lvSlots); } catch(e) { lvSlots = []; } }
        var lvDow = new Date(lv.date).getDay();
        // Fallback: if leave has no specific slots, use check-in slots for that date
        var ciForDate = myCheckins[lv.date];
        var ciSlotsForDate = ciForDate ? ciForDate.slots : [];
        getSlotsForDow(lvDow).forEach(function(slot) {
          var sk = (slot.startTime || '') + '-' + (slot.endTime || '');
          var mr = getMemberRate(slot, mid);
          var slotMatch = lvSlots.length > 0 ? lvSlots.indexOf(sk) !== -1 : (ciSlotsForDate.length > 0 ? ciSlotsForDate.indexOf(sk) !== -1 : true);
          if (mr.assigned && slotMatch) {
            existing.shifts++; existing.amount += slotPay(slot, mid);
          }
        });
      });

      var totalBreaks = 0, totalHours = 0, totalEarnings = 0;
      var leaveDaysWithSub = 0, leaveDaysNoSub = 0;
      var daily = [];

      range.dates.forEach(function(dateStr) {
        var dtObj = new Date(dateStr), dayDow = dtObj.getDay();
        var daySlots = getSlotsForDow(dayDow);
        if (!daySlots.length) return;

        var ci = myCheckins[dateStr];
        var ciSlots = ci ? ci.slots : [];
        var isLeave = ci && ci.status === 'leave';
        // Collect leave slot keys for this date
        var leaveSlotKeys = [];
        var hasSub = false;
        if (isLeave) {
          myLeaves.forEach(function(lv) {
            if (lv.date !== dateStr) return;
            var lvSlots = lv.slots || [];
            if (typeof lvSlots === 'string') { try { lvSlots = JSON.parse(lvSlots); } catch(e) { lvSlots = []; } }
            if (lv.substituteName) {
              hasSub = true;
              lvSlots.forEach(function(s) { if (leaveSlotKeys.indexOf(s) === -1) leaveSlotKeys.push(s); });
            }
          });
        }
        var noSub  = isLeave && !hasSub;
        var dayBreaks = 0, dayHours = 0, dayAmt = 0;
        var subNameForDay = '';
        var subCostForDay = 0;

        if (isLeave) {
          if (hasSub) {
            leaveDaysWithSub++;
            var lvForDay = myLeaves.find(function(lv) { return lv.date === dateStr && lv.substituteName; });
            subNameForDay = lvForDay ? lvForDay.substituteName : '';
            daySlots.forEach(function(slot) {
              var sk = (slot.startTime || '') + '-' + (slot.endTime || '');
              var mr = getMemberRate(slot, mid);
              if (!mr.assigned) return;
              // Only count slots that are in the leave request; fallback to check-in slots
              var _slotMatch = leaveSlotKeys.length > 0 ? leaveSlotKeys.indexOf(sk) !== -1 : (ciSlots.length > 0 ? ciSlots.indexOf(sk) !== -1 : true);
              if (_slotMatch) {
                dayBreaks++;
                dayHours += slotHours(slot);
                dayAmt += slotPay(slot, mid);
                subCostForDay += slotPay(slot, mid);
              }
            });
          } else {
            leaveDaysNoSub++;
          }
        } else {
          daySlots.forEach(function(slot) {
            var sk = (slot.startTime || '') + '-' + (slot.endTime || '');
            var mr = getMemberRate(slot, mid);
            if (!mr.assigned) return;
            if (ciSlots.indexOf(sk) !== -1) {
              dayBreaks++;
              dayHours += slotHours(slot);
              dayAmt += slotPay(slot, mid);
            }
          });
        }

        totalBreaks += dayBreaks;
        totalHours += dayHours;
        totalEarnings += dayAmt;

        if (dayBreaks > 0 || isLeave) {
          daily.push({
            date: dateStr, dow: dayDow, breaks: dayBreaks, hours: dayHours, earnings: dayAmt,
            isLeave: isLeave, hasSub: hasSub, noSub: noSub, subName: subNameForDay, subCost: subCostForDay
          });
        }
      });

      var totalSubFromDeductions = 0;
      subDeductions.forEach(function(sd) { totalSubFromDeductions += sd.amount; });

      return {
        totalBreaks: totalBreaks, totalHours: totalHours,
        totalEarnings: totalEarnings,
        leaveDaysWithSub: leaveDaysWithSub, leaveDaysNoSub: leaveDaysNoSub,
        totalSubCost: totalSubFromDeductions,
        netEarnings: totalEarnings - totalSubFromDeductions,
        daily: daily, subDeductions: subDeductions
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Render
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderStats() {
      var sel = selectedMemberId;
      var isManager = (myRole === 'admin' || myRole === 'manager');

      if (sel === '__all' && isManager) {
        renderAllMembersView();
      } else {
        var mid = (sel === '__self' || sel === '__all') ? myId : sel;
        var stats = computeMemberStats(mid);
        if (!stats) {
          document.getElementById('overviewCards').innerHTML = '<div class="stat-card"><div class="ico">ğŸ“­</div><div class="val">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</div><div class="lbl">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸‡à¹€à¸§à¸¥à¸²à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸™à¸µà¹‰</div></div>';
          document.getElementById('detailTbody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--premium-text-muted)">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</td></tr>';
          destroyCharts();
          return;
        }
        renderSingleMember(stats, mid);
        document.getElementById('allMembersCard').style.display = 'none';
      }
    }

    function renderSingleMember(s, mid) {
      var cardsHtml = ''
        + card('â±ï¸', s.totalBreaks + ' à¹€à¸šà¸£à¸„', 'à¹€à¸šà¸£à¸„à¸—à¸³à¸‡à¸²à¸™ (' + s.totalHours.toFixed(1) + ' à¸Šà¸¡.)', '')
        + card('ğŸ’°', formatCurrency(s.totalEarnings) + ' à¸¿', 'à¸£à¸²à¸¢à¹„à¸”à¹‰à¸£à¸§à¸¡', 'green')
        + card('ğŸš«', (s.leaveDaysWithSub + s.leaveDaysNoSub) + ' à¸§à¸±à¸™', 'à¸¥à¸² (à¸¡à¸µà¹à¸—à¸™ ' + s.leaveDaysWithSub + ' / à¹„à¸¡à¹ˆà¸¡à¸µ ' + s.leaveDaysNoSub + ')', 'purple')
        + card('ğŸ”„', formatCurrency(s.totalSubCost) + ' à¸¿', 'à¸ˆà¹ˆà¸²à¸¢à¸„à¸™à¹à¸—à¸™à¸£à¸§à¸¡', 'red')
        + card('ğŸ’µ', formatCurrency(s.netEarnings) + ' à¸¿', 'à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­à¸«à¸¥à¸±à¸‡à¸«à¸±à¸à¸„à¸™à¹à¸—à¸™', 'blue');
      document.getElementById('overviewCards').innerHTML = cardsHtml;

      renderDetailTable(s);
      renderCharts(s);
      document.getElementById('detailCard').style.display = '';
      document.getElementById('allMembersCard').style.display = 'none';
    }

    function renderAllMembersView() {
      var allStats = [];
      var totB = 0, totH = 0, totE = 0, totLW = 0, totLN = 0, totSC = 0;

      bandMembers.forEach(function(m) {
        var mid = m.memberId || m.id;
        var s = computeMemberStats(mid);
        if (!s) return;
        allStats.push({ name: m.name || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸', mid: mid, stats: s });
        totB += s.totalBreaks; totH += s.totalHours; totE += s.totalEarnings;
        totLW += s.leaveDaysWithSub; totLN += s.leaveDaysNoSub; totSC += s.totalSubCost;
      });

      var cardsHtml = ''
        + card('ğŸ‘¥', bandMembers.length + ' à¸„à¸™', 'à¸ªà¸¡à¸²à¸Šà¸´à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”', '')
        + card('â±ï¸', totB + ' à¹€à¸šà¸£à¸„', 'à¹€à¸šà¸£à¸„à¸£à¸§à¸¡ (' + totH.toFixed(1) + ' à¸Šà¸¡.)', '')
        + card('ğŸ’°', formatCurrency(totE) + ' à¸¿', 'à¸£à¸²à¸¢à¹„à¸”à¹‰à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸§à¸‡', 'green')
        + card('ğŸš«', (totLW + totLN) + ' à¸§à¸±à¸™', 'à¸¥à¸²à¸£à¸§à¸¡ (à¹à¸—à¸™ ' + totLW + ' / à¹„à¸¡à¹ˆà¸¡à¸µ ' + totLN + ')', 'purple')
        + card('ğŸ”„', formatCurrency(totSC) + ' à¸¿', 'à¸ˆà¹ˆà¸²à¸¢à¸„à¸™à¹à¸—à¸™à¸—à¸±à¹‰à¸‡à¸§à¸‡', 'red');
      document.getElementById('overviewCards').innerHTML = cardsHtml;

      var tbody = document.getElementById('allMembersTbody');
      if (!allStats.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--premium-text-muted)">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</td></tr>';
      } else {
        tbody.innerHTML = allStats.sort(function(a,b) { return b.stats.totalEarnings - a.stats.totalEarnings; }).map(function(ms) {
          var s = ms.stats;
          return '<tr><td>' + escapeHtml(ms.name) + '</td>'
            + '<td>' + s.totalBreaks + '</td>'
            + '<td>' + s.totalHours.toFixed(1) + '</td>'
            + '<td style="color:#276749;font-weight:600">' + formatCurrency(s.totalEarnings) + '</td>'
            + '<td>' + s.leaveDaysWithSub + '</td>'
            + '<td style="color:#e53e3e">' + s.leaveDaysNoSub + '</td>'
            + '<td style="color:#805ad5">' + formatCurrency(s.totalSubCost) + '</td>'
            + '<td style="font-weight:700;color:' + (s.netEarnings >= 0 ? '#276749' : '#e53e3e') + '">' + formatCurrency(s.netEarnings) + '</td></tr>';
        }).join('');
      }

      document.getElementById('allMembersCard').style.display = '';
      document.getElementById('detailCard').style.display = 'none';
      renderChartsAllMembers(allStats);
    }

    function card(ico, val, lbl, cls) {
      return '<div class="stat-card ' + (cls||'') + '"><div class="ico">' + ico + '</div><div class="val">' + val + '</div><div class="lbl">' + lbl + '</div></div>';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Detail Table
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderDetailTable(s) {
      var tbody = document.getElementById('detailTbody');
      if (!s.daily.length) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--premium-text-muted)">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸™à¸µà¹‰</td></tr>';
        return;
      }
      tbody.innerHTML = s.daily.map(function(d) {
        var dt = new Date(d.date);
        var dateLabel = DN_SHORT[d.dow] + ' ' + dt.getDate() + '/' + (dt.getMonth()+1);
        var status = d.isLeave ? (d.hasSub ? '<span class="has-sub">ğŸš« à¸¥à¸² (à¸¡à¸µà¹à¸—à¸™)</span>' : '<span class="no-sub">ğŸš« à¸¥à¸² (à¹„à¸¡à¹ˆà¸¡à¸µà¹à¸—à¸™)</span>') : 'âœ… à¹€à¸‚à¹‰à¸²à¸‡à¸²à¸™';
        var subInfo = d.subName ? 'ğŸ”„ ' + escapeHtml(d.subName) : '-';
        var subCostStr = d.subCost > 0 ? '<span style="color:#e53e3e">' + formatCurrency(d.subCost) + '</span>' : '-';
        return '<tr class="' + (d.isLeave ? 'leave-row' : '') + '">'
          + '<td style="white-space:nowrap">' + dateLabel + '</td>'
          + '<td>' + status + '</td>'
          + '<td style="text-align:center">' + d.breaks + '</td>'
          + '<td style="text-align:center">' + d.hours.toFixed(1) + '</td>'
          + '<td style="text-align:right;font-weight:600;color:#276749">' + formatCurrency(d.earnings) + '</td>'
          + '<td>' + subInfo + '</td>'
          + '<td style="text-align:right">' + subCostStr + '</td></tr>';
      }).join('')
      + '<tr style="background:var(--premium-off-white);font-weight:700">'
        + '<td>à¸£à¸§à¸¡</td><td></td>'
        + '<td style="text-align:center">' + s.totalBreaks + '</td>'
        + '<td style="text-align:center">' + s.totalHours.toFixed(1) + '</td>'
        + '<td style="text-align:right;color:#276749">' + formatCurrency(s.totalEarnings) + '</td>'
        + '<td></td>'
        + '<td style="text-align:right;color:#e53e3e">' + formatCurrency(s.totalSubCost) + '</td></tr>'
      + '<tr style="background:#ebf8ff;font-weight:700">'
        + '<td colspan="4">ğŸ’µ à¸„à¸‡à¹€à¸«à¸¥à¸·à¸­à¸«à¸¥à¸±à¸‡à¸«à¸±à¸à¸„à¸™à¹à¸—à¸™</td>'
        + '<td colspan="3" style="text-align:right;color:' + (s.netEarnings >= 0 ? '#276749' : '#e53e3e') + ';font-size:var(--text-base)">' + formatCurrency(s.netEarnings) + ' à¸¿</td></tr>';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Charts (Chart.js)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function destroyCharts() {
      if (chartEarningsInst) { chartEarningsInst.destroy(); chartEarningsInst = null; }
      if (chartHoursInst)    { chartHoursInst.destroy();    chartHoursInst = null; }
      if (chartLeaveInst)    { chartLeaveInst.destroy();    chartLeaveInst = null; }
      if (chartSubInst)      { chartSubInst.destroy();      chartSubInst = null; }
    }

    function renderCharts(s) {
      destroyCharts();
      if (typeof Chart === 'undefined') return;

      var labels = s.daily.map(function(d) { return DN_SHORT[d.dow] + ' ' + new Date(d.date).getDate(); });

      // Earnings bar
      chartEarningsInst = new Chart(document.getElementById('chartEarnings'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'à¸£à¸²à¸¢à¹„à¸”à¹‰ (à¸¿)',
            data: s.daily.map(function(d) { return d.earnings; }),
            backgroundColor: s.daily.map(function(d) { return d.isLeave ? (d.hasSub ? '#d6bcfa' : '#fed7d7') : '#c6f6d5'; }),
            borderRadius: 4
          }]
        },
        options: chartOpts('à¸¿')
      });

      // Hours bar
      chartHoursInst = new Chart(document.getElementById('chartHours'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡',
            data: s.daily.map(function(d) { return Math.round(d.hours * 10) / 10; }),
            backgroundColor: '#bee3f8',
            borderRadius: 4
          }]
        },
        options: chartOpts('à¸Šà¸¡.')
      });

      // Leave doughnut
      var workDays = s.daily.filter(function(d) { return !d.isLeave; }).length;
      chartLeaveInst = new Chart(document.getElementById('chartLeave'), {
        type: 'doughnut',
        data: {
          labels: ['à¹€à¸‚à¹‰à¸²à¸‡à¸²à¸™', 'à¸¥à¸² (à¸¡à¸µà¹à¸—à¸™)', 'à¸¥à¸² (à¹„à¸¡à¹ˆà¸¡à¸µà¹à¸—à¸™)'],
          datasets: [{
            data: [workDays, s.leaveDaysWithSub, s.leaveDaysNoSub],
            backgroundColor: ['#c6f6d5', '#d6bcfa', '#fed7d7']
          }]
        },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom', labels: { font: { family: 'Sarabun', size: 12 } } } } }
      });

      // Sub cost bar
      if (s.subDeductions.length) {
        chartSubInst = new Chart(document.getElementById('chartSub'), {
          type: 'bar',
          data: {
            labels: s.subDeductions.map(function(sd) { return sd.subName; }),
            datasets: [{
              label: 'à¸ˆà¹ˆà¸²à¸¢à¸„à¸™à¹à¸—à¸™ (à¸¿)',
              data: s.subDeductions.map(function(sd) { return sd.amount; }),
              backgroundColor: '#e9d8fd',
              borderRadius: 4
            }]
          },
          options: chartOpts('à¸¿')
        });
      } else {
        // No sub data â€” show placeholder
        var cvs = document.getElementById('chartSub');
        cvs.style.minHeight = '120px';
        var ctx = cvs.getContext('2d');
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        ctx.font = '14px Sarabun';
        ctx.fillStyle = '#a0aec0';
        ctx.textAlign = 'center';
        ctx.fillText('à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸™à¹à¸—à¸™', cvs.width / 2, 60);
      }
    }

    function renderChartsAllMembers(allStats) {
      destroyCharts();
      if (typeof Chart === 'undefined' || !allStats.length) return;

      var names = allStats.map(function(ms) { return ms.name; });

      chartEarningsInst = new Chart(document.getElementById('chartEarnings'), {
        type: 'bar',
        data: { labels: names, datasets: [{ label: 'à¸£à¸²à¸¢à¹„à¸”à¹‰ (à¸¿)', data: allStats.map(function(ms) { return ms.stats.totalEarnings; }), backgroundColor: '#c6f6d5', borderRadius: 4 }] },
        options: chartOpts('à¸¿')
      });

      chartHoursInst = new Chart(document.getElementById('chartHours'), {
        type: 'bar',
        data: { labels: names, datasets: [{ label: 'à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡', data: allStats.map(function(ms) { return Math.round(ms.stats.totalHours * 10) / 10; }), backgroundColor: '#bee3f8', borderRadius: 4 }] },
        options: chartOpts('à¸Šà¸¡.')
      });

      chartLeaveInst = new Chart(document.getElementById('chartLeave'), {
        type: 'bar',
        data: {
          labels: names,
          datasets: [
            { label: 'à¸¥à¸² (à¸¡à¸µà¹à¸—à¸™)', data: allStats.map(function(ms) { return ms.stats.leaveDaysWithSub; }), backgroundColor: '#d6bcfa', borderRadius: 4 },
            { label: 'à¸¥à¸² (à¹„à¸¡à¹ˆà¸¡à¸µà¹à¸—à¸™)', data: allStats.map(function(ms) { return ms.stats.leaveDaysNoSub; }), backgroundColor: '#fed7d7', borderRadius: 4 }
          ]
        },
        options: Object.assign({}, chartOpts('à¸§à¸±à¸™'), { plugins: { legend: { display: true, position: 'bottom', labels: { font: { family: 'Sarabun', size: 11 } } } }, scales: { x: { stacked: true, ticks: { font: { family: 'Sarabun', size: 11 } } }, y: { stacked: true, beginAtZero: true, ticks: { font: { family: 'Sarabun', size: 11 } } } } })
      });

      chartSubInst = new Chart(document.getElementById('chartSub'), {
        type: 'bar',
        data: { labels: names, datasets: [{ label: 'à¸ˆà¹ˆà¸²à¸¢à¸„à¸™à¹à¸—à¸™ (à¸¿)', data: allStats.map(function(ms) { return ms.stats.totalSubCost; }), backgroundColor: '#e9d8fd', borderRadius: 4 }] },
        options: chartOpts('à¸¿')
      });
    }

    function chartOpts(unit) {
      return {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: function(ctx) { return ctx.parsed.y.toLocaleString('th-TH') + ' ' + unit; } } }
        },
        scales: {
          y: { beginAtZero: true, ticks: { font: { family: 'Sarabun', size: 11 } } },
          x: { ticks: { font: { family: 'Sarabun', size: 11 }, maxRotation: 45, minRotation: 0 } }
        }
      };
    }

  })();
  </script>
</body>
</html>
