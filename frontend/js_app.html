<script>
/**
 * Band Management By SoulCiety — Core App (GitHub Pages + Supabase)
 * Auth guard, API integration, Toast, Confirm Dialog, Lang toggle
 * หมายเหตุ: renderMainNav อยู่ใน js_nav.html เท่านั้น (ไม่ซ้ำที่นี่)
 */
(function(global){
  'use strict';

  // ——— Auth ———
  function ensureDemoSession() {
    if (localStorage.getItem('auth_token')) return;
    localStorage.setItem('auth_token', 'demo_' + Date.now());
    localStorage.setItem('userName', typeof t === 'function' ? t('user') : 'ผู้ใช้');
    localStorage.setItem('bandName', typeof t === 'function' ? t('yourBand') : 'วงของคุณ');
  }
  global.ensureDemoSession = ensureDemoSession;

  function requireAuth() {
    if (window.location.protocol === 'file:') { ensureDemoSession(); return; }
    if (!localStorage.getItem('auth_token')) window.location.replace('index.html');
  }
  global.requireAuth = requireAuth;

  // ——— Translations ———
  function applyTranslations() {
    document.querySelectorAll('[data-i18n]').forEach(function(node) {
      var key = node.getAttribute('data-i18n');
      if (key && typeof t === 'function') node.textContent = t(key);
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(function(node) {
      var key = node.getAttribute('data-i18n-placeholder');
      if (key && typeof t === 'function') node.placeholder = t(key);
    });
    document.querySelectorAll('[data-i18n-title]').forEach(function(node) {
      var key = node.getAttribute('data-i18n-title');
      if (key && typeof t === 'function') node.title = t(key);
    });
  }
  global.applyTranslations = applyTranslations;

  // ——— API Integration (Supabase via sbRun) ———
  function apiCall(action, data, callback) {
    if (typeof window.sbRun === 'function') {
      window.sbRun(action, data, callback);
    } else if (callback) {
      callback({ success: false, message: 'API not available' });
    }
  }
  global.apiCall = apiCall;

  // ——— Auth token helper ———
  function getAuthToken() { return localStorage.getItem('auth_token') || ''; }
  global.getAuthToken = getAuthToken;

  // ——— Toast ———
  function showToast(message, type) {
    type = type || 'success';
    var el = document.getElementById('toast');
    if (!el) {
      el = document.createElement('div');
      el.id = 'toast';
      document.body.appendChild(el);
    }
    el.textContent = message;
    el.className = type;
    el.classList.add('show');
    clearTimeout(el._timer);
    el._timer = setTimeout(function() { el.classList.remove('show'); }, 3000);
  }
  global.showToast = showToast;

  // ——— Confirm Dialog ———
  function showConfirm(options) {
    return new Promise(function(resolve) {
      var title = (options && options.title) || (typeof t === 'function' ? t('confirmDeleteTitle') : 'ยืนยัน');
      var msg   = (options && options.message) || (typeof t === 'function' ? t('confirmDeleteMsg') : 'ต้องการลบใช่หรือไม่?');
      var confirmText = (options && options.confirmText) || (typeof t === 'function' ? t('delete') : 'ลบ');
      var cancelText  = (options && options.cancelText)  || (typeof t === 'function' ? t('cancel') : 'ยกเลิก');

      var overlay = document.createElement('div');
      overlay.className = 'confirm-overlay active';
      overlay.innerHTML =
        '<div class="confirm-box">' +
          '<h3>' + escapeHtml(title) + '</h3>' +
          '<p>' + escapeHtml(msg) + '</p>' +
          '<div class="confirm-actions">' +
            '<button class="btn btn-secondary" id="_confirmCancel">' + escapeHtml(cancelText) + '</button>' +
            '<button class="btn btn-danger" id="_confirmOk">' + escapeHtml(confirmText) + '</button>' +
          '</div>' +
        '</div>';
      document.body.appendChild(overlay);

      function cleanup(result) {
        document.body.removeChild(overlay);
        resolve(result);
      }
      overlay.querySelector('#_confirmOk').addEventListener('click', function() { cleanup(true); });
      overlay.querySelector('#_confirmCancel').addEventListener('click', function() { cleanup(false); });
      overlay.addEventListener('click', function(e) { if (e.target === overlay) cleanup(false); });
    });
  }
  global.showConfirm = showConfirm;

  // ——— Lang Toggle (for auth pages) ———
  function renderLangToggle(containerId) {
    var el = document.getElementById(containerId || 'langToggle');
    if (!el) return;
    var lang = typeof getLang === 'function' ? getLang() : 'th';
    el.innerHTML =
      '<div class="lang-switcher">' +
        '<button type="button" class="lang-btn' + (lang === 'th' ? ' active' : '') + '" data-lang="th">TH</button>' +
        '<button type="button" class="lang-btn' + (lang === 'en' ? ' active' : '') + '" data-lang="en">EN</button>' +
      '</div>';
    el.querySelectorAll('[data-lang]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (typeof setLang === 'function') setLang(btn.dataset.lang);
        renderLangToggle(containerId);
        if (typeof renderMainNav === 'function') renderMainNav('mainNav');
        applyTranslations();
      });
    });
  }
  global.renderLangToggle = renderLangToggle;

  // ——— escapeHtml fallback (ถ้า js_i18n ยังไม่โหลด) ———
  if (!global.escapeHtml) {
    global.escapeHtml = function(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    };
  }

  // ——— Number formatter ———
  function formatCurrency(num) {
    num = parseFloat(num) || 0;
    return num.toLocaleString(typeof getLang === 'function' && getLang() === 'en' ? 'en-US' : 'th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
  }
  global.formatCurrency = formatCurrency;

  function formatDate(dateStr) {
    if (!dateStr) return '-';
    try {
      var d = new Date(dateStr);
      var lang = typeof getLang === 'function' ? getLang() : 'th';
      return d.toLocaleDateString(lang === 'en' ? 'en-US' : 'th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
    } catch(e) { return dateStr; }
  }
  global.formatDate = formatDate;

})(typeof window !== 'undefined' ? window : this);
</script>
