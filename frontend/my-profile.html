<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‚Äî Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/compat.css">
  <style>
    .profile-avatar-wrap {
      display: flex; flex-direction: column; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg);
    }
    .profile-avatar {
      width: 90px; height: 90px; background: var(--premium-gold); border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 2.5rem; box-shadow: var(--shadow-lg);
    }
    .profile-name-display { text-align: center; }
    .profile-name-display .full-name { font-size: var(--text-xl); font-weight: 700; color: var(--premium-text); }
    .profile-name-display .nickname { font-size: var(--text-base); color: var(--premium-text-muted); }
    .profile-name-display .instrument { font-size: var(--text-sm); color: var(--premium-gold); font-weight: 600; }
    .form-section-label {
      font-size: var(--text-xs); font-weight: 600; color: var(--premium-text-muted); text-transform: uppercase;
      letter-spacing: .05em; margin: var(--spacing-lg) 0 var(--spacing-xs); border-bottom: 1px solid var(--premium-light-gray); padding-bottom: 4px;
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); }
    .form-row-3 { display: grid; grid-template-columns: auto 1fr 1fr; gap: var(--spacing-md); }
    @media(max-width:576px) { .form-row, .form-row-3 { grid-template-columns: 1fr; } }
    .info-readonly {
      background: var(--premium-light-gray); border-radius: var(--radius-md);
      padding: var(--spacing-sm) var(--spacing-md); font-size: var(--text-sm); color: var(--premium-text-muted);
    }
    .section-card {
      background: var(--premium-white); border-radius: var(--radius-lg); box-shadow: var(--shadow-md);
      padding: var(--spacing-xl); margin-bottom: var(--spacing-lg);
    }
    .section-card h3 { font-size: var(--text-lg); font-weight: 700; color: var(--premium-text); margin: 0 0 var(--spacing-md); }
    .change-row { display: flex; gap: var(--spacing-md); align-items: flex-end; flex-wrap: wrap; }
    .change-row .form-group { flex: 1; min-width: 200px; }
    .msg-box { padding: 8px 12px; border-radius: var(--radius-md); font-size: var(--text-sm); margin-top: var(--spacing-sm); display: none; }
    .msg-box.success { display: block; background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
    .msg-box.error { display: block; background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <main>
    <div class="container" style="max-width:720px">
      <div class="page-header">
        <h1 class="page-title">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h1>
      </div>

      <!-- Avatar + ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• -->
      <div class="section-card">
        <div class="profile-avatar-wrap">
          <div class="profile-avatar" id="avatarIcon">üé§</div>
          <div class="profile-name-display">
            <div class="full-name" id="displayFullName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            <div class="nickname" id="displayNickname"></div>
            <div class="instrument" id="displayInstrument"></div>
          </div>
        </div>
      </div>

      <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
      <div class="section-card">
        <h3>üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
        <form id="profileForm">
          <div class="form-section-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
          <div class="form-row-3">
            <div class="form-group">
              <label>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
              <select id="title" class="form-control">
                <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
                <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                <option value="‡∏î.‡∏ä.">‡∏î.‡∏ä.</option>
                <option value="‡∏î.‡∏ç.">‡∏î.‡∏ç.</option>
                <option value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
              </select>
            </div>
            <div class="form-group">
              <label>‡∏ä‡∏∑‡πà‡∏≠ <span style="color:#c53030">*</span></label>
              <input type="text" id="firstName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required>
            </div>
            <div class="form-group">
              <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span style="color:#c53030">*</span></label>
              <input type="text" id="lastName" class="form-control" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô <span style="color:#c53030">*</span></label>
              <input type="text" id="nickname" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" required>
              <small style="color:var(--premium-text-muted)">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</small>
            </div>
            <div class="form-group">
              <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á / ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏ô‡∏ï‡∏£‡∏µ</label>
              <select id="instrument" class="form-control">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                <option value="‡∏£‡πâ‡∏≠‡∏á‡∏ô‡∏≥">üé§ ‡∏£‡πâ‡∏≠‡∏á‡∏ô‡∏≥</option>
                <option value="‡∏£‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô">üé§ ‡∏£‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô</option>
                <option value="‡∏Å‡∏µ‡∏ï‡∏≤‡∏£‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤">üé∏ ‡∏Å‡∏µ‡∏ï‡∏≤‡∏£‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option>
                <option value="‡∏Å‡∏µ‡∏ï‡∏≤‡∏£‡πå‡πÇ‡∏õ‡∏£‡πà‡∏á">üé∏ ‡∏Å‡∏µ‡∏ï‡∏≤‡∏£‡πå‡πÇ‡∏õ‡∏£‡πà‡∏á</option>
                <option value="‡∏Å‡∏µ‡∏ï‡∏≤‡∏£‡πå‡πÄ‡∏ö‡∏™">üé∏ ‡∏Å‡∏µ‡∏ï‡∏≤‡∏£‡πå‡πÄ‡∏ö‡∏™</option>
                <option value="‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î">üéπ ‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î</option>
                <option value="‡∏Å‡∏•‡∏≠‡∏á">ü•Å ‡∏Å‡∏•‡∏≠‡∏á</option>
                <option value="‡πÄ‡∏û‡∏≠‡∏£‡πå‡∏Ñ‡∏±‡∏™‡∏ä‡∏±‡∏ô">ü•Å ‡πÄ‡∏û‡∏≠‡∏£‡πå‡∏Ñ‡∏±‡∏™‡∏ä‡∏±‡∏ô</option>
                <option value="‡∏ó‡∏£‡∏±‡∏°‡πÄ‡∏õ‡∏ï">üé∫ ‡∏ó‡∏£‡∏±‡∏°‡πÄ‡∏õ‡∏ï</option>
                <option value="‡πÅ‡∏ã‡∏Å‡πÇ‡∏ã‡πÇ‡∏ü‡∏ô">üé∑ ‡πÅ‡∏ã‡∏Å‡πÇ‡∏ã‡πÇ‡∏ü‡∏ô</option>
                <option value="‡πÑ‡∏ß‡πÇ‡∏≠‡∏•‡∏¥‡∏ô">üéª ‡πÑ‡∏ß‡πÇ‡∏≠‡∏•‡∏¥‡∏ô</option>
                <option value="‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏á">üìã ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏á</option>
                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
              <input type="tel" id="phone" class="form-control" placeholder="0xx-xxx-xxxx">
            </div>
          </div>

          <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô -->
          <div class="form-section-label">ü™™ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</div>
          <div class="form-row">
            <div class="form-group">
              <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)</label>
              <input type="text" id="idCardNumber" class="form-control" placeholder="x-xxxx-xxxxx-xx-x" maxlength="17" autocomplete="off">
            </div>
            <div class="form-group">
              <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
              <input type="date" id="birthDate" class="form-control">
            </div>
          </div>
          <div class="form-group">
            <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
            <textarea id="idCardAddress" class="form-control" rows="3" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡∏ñ‡∏ô‡∏ô ‡∏ï‡∏≥‡∏ö‡∏• ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå"></textarea>
          </div>

          <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ read-only -->
          <div class="form-section-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>
          <div class="form-row">
            <div class="form-group">
              <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
              <div class="info-readonly" id="profileEmail">‚Äî</div>
            </div>
            <div class="form-group">
              <label>‡∏ß‡∏á</label>
              <div class="info-readonly" id="profileBand">‚Äî</div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
              <div class="info-readonly" id="profileRole">‚Äî</div>
            </div>
            <div class="form-group">
              <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <div class="info-readonly" id="profileStatus">‚Äî</div>
            </div>
          </div>

          <div style="margin-top:var(--spacing-xl);display:flex;gap:var(--spacing-md);flex-wrap:wrap">
            <button type="submit" class="btn btn-primary" id="saveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button type="button" class="btn btn-secondary" onclick="history.back()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </form>
      </div>

      <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏• -->
      <div class="section-card">
        <h3>üìß ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•</h3>
        <p style="font-size:var(--text-sm);color:var(--premium-text-muted);margin-bottom:var(--spacing-md)">
          ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        </p>
        <div class="change-row">
          <div class="form-group">
            <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡∏°‡πà</label>
            <input type="email" id="newEmail" class="form-control" placeholder="new@example.com">
          </div>
          <div>
            <button type="button" class="btn btn-primary" id="changeEmailBtn" onclick="doChangeEmail()">üìß ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
          </div>
        </div>
        <div id="emailMsg" class="msg-box"></div>
      </div>

      <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô -->
      <div class="section-card">
        <h3>üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
        <div class="form-row">
          <div class="form-group">
            <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
            <input type="password" id="newPassword" class="form-control" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" minlength="6">
          </div>
          <div class="form-group">
            <label>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
            <input type="password" id="confirmPassword" class="form-control" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" minlength="6">
          </div>
        </div>
        <div style="margin-top:var(--spacing-md)">
          <button type="button" class="btn btn-primary" id="changePwdBtn" onclick="doChangePassword()">üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
        </div>
        <div id="pwdMsg" class="msg-box"></div>
      </div>

    </div>
  </main>

  <script src="js/i18n.js"></script>
  <script src="js/app.js"></script>
  <script>
  var instrumentIcons = {
    '‡∏£‡πâ‡∏≠‡∏á‡∏ô‡∏≥': 'üé§', '‡∏£‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô': 'üé§',
    '‡∏Å‡∏µ‡∏ï‡∏≤‡∏£‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤': 'üé∏', '‡∏Å‡∏µ‡∏ï‡∏≤‡∏£‡πå‡πÇ‡∏õ‡∏£‡πà‡∏á': 'üé∏', '‡∏Å‡∏µ‡∏ï‡∏≤‡∏£‡πå‡πÄ‡∏ö‡∏™': 'üé∏',
    '‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î': 'üéπ', '‡∏Å‡∏•‡∏≠‡∏á': 'ü•Å', '‡πÄ‡∏û‡∏≠‡∏£‡πå‡∏Ñ‡∏±‡∏™‡∏ä‡∏±‡∏ô': 'ü•Å',
    '‡∏ó‡∏£‡∏±‡∏°‡πÄ‡∏õ‡∏ï': 'üé∫', '‡πÅ‡∏ã‡∏Å‡πÇ‡∏ã‡πÇ‡∏ü‡∏ô': 'üé∑', '‡πÑ‡∏ß‡πÇ‡∏≠‡∏•‡∏¥‡∏ô': 'üéª',
    '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏á': 'üìã'
  };
  var roleLabels = { admin: 'üîß ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', manager: 'üëî ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏á', member: 'üé∏ ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å' };

  function $el(id) { return document.getElementById(id); }
  function setVal(id, val) { var el = $el(id); if (el) el.value = val || ''; }
  function setTxt(id, val) { var el = $el(id); if (el) el.textContent = val || '‚Äî'; }

  function renderDisplay(p) {
    var title     = p.title      || '';
    var firstName = p.firstName  || p.first_name || '';
    var lastName  = p.lastName   || p.last_name  || '';
    var nickname  = p.nickname   || '';
    var inst      = p.instrument || '';
    var fullName  = [title !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' ? title : '', firstName, lastName].filter(Boolean).join(' ') || nickname || '‚Äî';
    $el('displayFullName').textContent   = fullName;
    $el('displayNickname').textContent   = nickname ? '(' + nickname + ')' : '';
    $el('displayInstrument').textContent = inst;
    $el('avatarIcon').textContent = instrumentIcons[inst] || 'üé§';
  }

  // ‚îÄ‚îÄ Format ID card: x-xxxx-xxxxx-xx-x ‚îÄ‚îÄ
  function formatIdCard(val) {
    var d = (val || '').replace(/\D/g, '').substring(0, 13);
    if (d.length <= 1) return d;
    var parts = [d.substring(0,1), d.substring(1,5), d.substring(5,10), d.substring(10,12), d.substring(12,13)];
    return parts.filter(Boolean).join('-');
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (typeof requireAuth === 'function') requireAuth();
    renderMainNav('mainNav');

    // Auto-format ID card input
    var idInput = $el('idCardNumber');
    if (idInput) {
      idInput.addEventListener('input', function() {
        var pos = this.selectionStart;
        var oldLen = this.value.length;
        this.value = formatIdCard(this.value);
        var newLen = this.value.length;
        this.setSelectionRange(pos + (newLen - oldLen), pos + (newLen - oldLen));
      });
    }

    // ‚îÄ‚îÄ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚îÄ‚îÄ
    function loadProfile() {
      gasRun('getMyProfile', {}, function(r) {
        if (!r || !r.success) return;
        var p = r.data || {};
        setVal('title',        p.title      || '‡∏ô‡∏≤‡∏¢');
        setVal('firstName',    p.firstName  || p.first_name || '');
        setVal('lastName',     p.lastName   || p.last_name  || '');
        setVal('nickname',     p.nickname   || '');
        setVal('instrument',   p.instrument || '');
        setVal('phone',        p.phone      || '');
        setVal('idCardNumber', formatIdCard(p.idCardNumber || p.id_card_number || ''));
        setVal('birthDate',    p.birthDate  || p.birth_date || '');
        setVal('idCardAddress', p.idCardAddress || p.id_card_address || '');
        setTxt('profileEmail',  p.email    || '‚Äî');
        setTxt('profileBand',   p.bandName || p.band_name || '‚Äî');
        setTxt('profileRole',   roleLabels[p.role] || p.role || '‚Äî');
        setTxt('profileStatus', p.status === 'active' ? '‚úÖ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : p.status || '‚Äî');
        renderDisplay(p);
      });
    }
    loadProfile();

    // ‚îÄ‚îÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‚îÄ‚îÄ
    $el('profileForm').addEventListener('submit', function(e) {
      e.preventDefault();
      var firstName = $el('firstName').value.trim();
      var lastName  = $el('lastName').value.trim();
      var nickname  = $el('nickname').value.trim();
      if (!firstName || !lastName || !nickname) {
        if (typeof showToast === 'function') showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô', 'error');
        return;
      }
      var idRaw = ($el('idCardNumber').value || '').replace(/\D/g, '');
      if (idRaw && idRaw.length !== 13) {
        if (typeof showToast === 'function') showToast('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å', 'error');
        return;
      }

      var btn = $el('saveBtn');
      btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      gasRun('updateMyProfile', {
        title:         $el('title').value,
        firstName:     firstName,
        lastName:      lastName,
        nickname:      nickname,
        instrument:    $el('instrument').value,
        phone:         ($el('phone') ? $el('phone').value.trim() : ''),
        idCardNumber:  idRaw,
        birthDate:     $el('birthDate').value || '',
        idCardAddress: ($el('idCardAddress') ? $el('idCardAddress').value.trim() : '')
      }, function(r) {
        btn.disabled = false; btn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        if (r && r.success) {
          if (typeof showToast === 'function') showToast(r.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
          renderDisplay({
            title:      $el('title').value,
            firstName:  firstName,
            lastName:   lastName,
            nickname:   nickname,
            instrument: $el('instrument').value
          });
          setTimeout(function() { renderMainNav('mainNav'); }, 300);
        } else {
          if (typeof showToast === 'function') showToast((r && r.message) || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
      });
    });
  });

  // ‚îÄ‚îÄ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‚îÄ‚îÄ
  function doChangeEmail() {
    var newEmail = ($el('newEmail').value || '').trim();
    var msgEl = $el('emailMsg');
    msgEl.className = 'msg-box'; msgEl.textContent = '';

    if (!newEmail || !newEmail.includes('@')) {
      msgEl.className = 'msg-box error'; msgEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
      return;
    }
    var btn = $el('changeEmailBtn');
    btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';

    gasRun('changeEmail', { email: newEmail }, function(r) {
      btn.disabled = false; btn.textContent = 'üìß ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•';
      if (r && r.success) {
        msgEl.className = 'msg-box success';
        msgEl.textContent = r.message || '‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢';
        $el('newEmail').value = '';
      } else {
        msgEl.className = 'msg-box error';
        msgEl.textContent = (r && r.message) || '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      }
    });
  }

  // ‚îÄ‚îÄ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ‚îÄ‚îÄ
  function doChangePassword() {
    var newPwd = ($el('newPassword').value || '');
    var confirmPwd = ($el('confirmPassword').value || '');
    var msgEl = $el('pwdMsg');
    msgEl.className = 'msg-box'; msgEl.textContent = '';

    if (newPwd.length < 6) {
      msgEl.className = 'msg-box error'; msgEl.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
      return;
    }
    if (newPwd !== confirmPwd) {
      msgEl.className = 'msg-box error'; msgEl.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
      return;
    }

    var btn = $el('changePwdBtn');
    btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';

    gasRun('changePassword', { password: newPwd }, function(r) {
      btn.disabled = false; btn.textContent = 'üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
      if (r && r.success) {
        msgEl.className = 'msg-box success';
        msgEl.textContent = r.message || '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
        $el('newPassword').value = '';
        $el('confirmPassword').value = '';
      } else {
        msgEl.className = 'msg-box error';
        msgEl.textContent = (r && r.message) || '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      }
    });
  }
  </script>
</body>
</html>
