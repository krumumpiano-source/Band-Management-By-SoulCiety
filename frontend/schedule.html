<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô ‚Äî Band Management By SoulCiety</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <?!= include('css_theme') ?>
  <?!= include('css_nav') ?>
  <?!= include('css_browser-compat') ?>
  <style>
    .schedule-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;font-size:12px}
    .cal-day-hdr{text-align:center;padding:6px;font-weight:600;color:var(--premium-text-muted);background:var(--premium-off-white)}
    .cal-day{min-height:80px;padding:4px;background:var(--premium-white);border-radius:4px;border:1px solid var(--premium-light-gray);cursor:pointer;transition:background .15s}
    .cal-day:hover{background:var(--premium-off-white)}
    .cal-day.today{border-color:var(--premium-gold);background:#fffbeb}
    .cal-day.other-month{opacity:.35}
    .cal-day .day-num{font-weight:600;font-size:13px;margin-bottom:4px}
    .cal-event{background:var(--premium-gold);color:#fff;border-radius:3px;padding:1px 5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px;font-size:10px}
    .cal-event.past{background:#a0aec0}
    .cal-nav{display:flex;align-items:center;gap:var(--spacing-md);margin-bottom:var(--spacing-lg)}
    .cal-nav h2{flex:1;text-align:center;font-size:var(--text-lg);font-weight:700}
    /* Modal */
    .job-form{display:flex;flex-direction:column;gap:var(--spacing-md)}
    .form-r2{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-md)}
    @media(max-width:480px){.form-r2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="mainNav"></div>
  <div id="toast"></div>
  <div id="confirmModal"></div>

  <!-- Job Modal -->
  <div id="jobModal" class="modal-backdrop" style="display:none">
    <div class="modal" style="max-width:560px">
      <div class="modal-header">
        <h3 class="modal-title" id="jobModalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</h3>
        <button class="modal-close" onclick="closeJobModal()">√ó</button>
      </div>
      <form id="jobForm" class="job-form">
        <input type="hidden" id="jobId">
        <input type="hidden" id="jobDate">
        <div class="form-r2">
          <div class="form-group"><label data-i18n="venue">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà *</label><input type="text" id="venue" required></div>
          <div class="form-group"><label data-i18n="client">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏ú‡∏π‡πâ‡∏à‡πâ‡∏≤‡∏á</label><input type="text" id="client"></div>
        </div>
        <div class="form-r2">
          <div class="form-group"><label data-i18n="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà *</label><input type="date" id="dateInput" required></div>
          <div class="form-group">
            <label data-i18n="jobType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
            <select id="jobType" onchange="onJobTypeChange()">
              <option value="‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á">‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á</option>
              <option value="‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á">‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</option>
              <option value="‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï">‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï</option>
              <option value="‡∏ã‡πâ‡∏≠‡∏°">‡∏ã‡πâ‡∏≠‡∏°</option>
              <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
          </div>
        </div>
        <div class="form-r2">
          <div class="form-group"><label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="time" id="startTime"></div>
          <div class="form-group"><label>‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö</label><input type="time" id="endTime"></div>
        </div>
        <div class="form-r2">
          <div class="form-group"><label data-i18n="payment">‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="payment" min="0"></div>
          <div class="form-group">
            <label data-i18n="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select id="jobStatus"><option value="confirmed">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</option><option value="tentative">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</option><option value="cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option></select>
          </div>
        </div>
        <div style="font-size:var(--text-xs);color:var(--premium-text-muted);margin-top:-8px;margin-bottom:var(--spacing-sm)" id="pricingHint"></div>
        <div class="form-group"><label data-i18n="notes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="jobNotes" rows="2"></textarea></div>
        <div style="display:flex;justify-content:flex-end;gap:var(--spacing-sm)">
          <button type="button" class="btn btn-secondary" onclick="closeJobModal()" data-i18n="cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="button" class="btn btn-danger" id="deleteJobBtn" style="display:none" onclick="deleteCurrentJob()" data-i18n="delete">‡∏•‡∏ö</button>
          <button type="submit" class="btn btn-primary" id="saveJobBtn" data-i18n="save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>

  <main>
    <div class="container">
      <div class="page-header">
        <h1 class="page-title" data-i18n="nav_schedule">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô</h1>
        <button class="btn btn-primary" onclick="openJobModal(null,null)">+ <span data-i18n="addJob">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</span></button>
      </div>
      <div class="card">
        <div class="cal-nav">
          <button class="btn btn-ghost btn-sm" onclick="changeMonth(-1)">‚óÄ</button>
          <h2 id="calTitle"></h2>
          <button class="btn btn-ghost btn-sm" onclick="changeMonth(1)">‚ñ∂</button>
          <button class="btn btn-secondary btn-sm" onclick="goToday()" data-i18n="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>
        <div class="schedule-grid" id="calGrid"></div>
      </div>
      <!-- List view -->
      <div class="card" style="margin-top:var(--spacing-xl)">
        <div class="card-header"><h3 class="card-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3></div>
        <div class="table-responsive">
          <table class="table" id="jobTable">
            <thead><tr>
              <th data-i18n="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th data-i18n="venue">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
              <th data-i18n="client">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
              <th data-i18n="jobType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th data-i18n="payment">‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß</th>
              <th data-i18n="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th></th>
            </tr></thead>
            <tbody id="jobTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <?!= include('js_i18n') ?>
  <?!= include('js_app') ?>
  <?!= include('js_nav') ?>
  <script>
  var curYear = new Date().getFullYear(), curMonth = new Date().getMonth();
  var allJobs = [];
  var pricingData = null;

  document.addEventListener('DOMContentLoaded', function() {
    requireAuth(); renderMainNav('mainNav'); applyTranslations();
    loadPricingData();
    loadJobs();
  });

  /* ‚îÄ‚îÄ‚îÄ Load pricing from localStorage/GAS ‚îÄ‚îÄ‚îÄ */
  function loadPricingData(){
    try { var c=localStorage.getItem('pricingData'); if(c) pricingData=JSON.parse(c); } catch(e){}
    gasRun('getPricing',{bandId:localStorage.getItem('bandId')||''},function(r){
      if(r&&r.success&&r.data){ pricingData=r.data; localStorage.setItem('pricingData',JSON.stringify(pricingData)); }
    });
  }

  function onJobTypeChange(){
    if(!pricingData||!pricingData.jobTypes) return;
    var type=document.getElementById('jobType').value;
    var match=pricingData.jobTypes.find(function(jt){return jt.name===type;});
    var hint=document.getElementById('pricingHint');
    if(match && match.price>0){
      var payInput=document.getElementById('payment');
      if(!payInput.value || payInput.value==='0'){
        payInput.value=match.price;
      }
      hint.textContent='üí° ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô: '+formatCurrency(match.price)+' (‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤)';
    } else {
      hint.textContent='';
    }
  }

  function loadJobs() {
    var bandId = localStorage.getItem('bandId') || '';
    var year = curYear;
    gasRun('getSchedule', { bandId: bandId, year: year }, function(r) {
      allJobs = (r && r.success && r.data) ? r.data : [];
      renderCalendar(); renderTable();
    });
  }

  function goToday() { curYear=new Date().getFullYear(); curMonth=new Date().getMonth(); renderCalendar(); renderTable(); }
  function changeMonth(d) { curMonth+=d; if(curMonth<0){curMonth=11;curYear--;} if(curMonth>11){curMonth=0;curYear++;} renderCalendar(); renderTable(); }

  function renderCalendar() {
    var days=['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'];
    var grid=document.getElementById('calGrid');
    var today=new Date(); today.setHours(0,0,0,0);
    var firstDay=new Date(curYear,curMonth,1).getDay();
    var daysInMonth=new Date(curYear,curMonth+1,0).getDate();
    var thaiMonths=['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
    document.getElementById('calTitle').textContent = thaiMonths[curMonth]+' '+( curYear +543);
    var html=days.map(function(d){return '<div class="cal-day-hdr">'+d+'</div>';}).join('');
    var prevDays=new Date(curYear,curMonth,0).getDate();
    for(var i=firstDay-1;i>=0;i--) html+='<div class="cal-day other-month"><div class="day-num">'+(prevDays-i)+'</div></div>';
    for(var d2=1;d2<=daysInMonth;d2++){
      var dt=new Date(curYear,curMonth,d2); dt.setHours(0,0,0,0);
      var isToday=dt.getTime()===today.getTime();
      var dateStr=curYear+'-'+String(curMonth+1).padStart(2,'0')+'-'+String(d2).padStart(2,'0');
      var dayJobs=allJobs.filter(function(j){return (j.date||'').startsWith(dateStr);});
      html+='<div class="cal-day'+(isToday?' today':'')+'" onclick="openJobModal(null,\''+dateStr+'\')"><div class="day-num">'+d2+'</div>'
        +dayJobs.map(function(j){
          var sid=encodeURIComponent(j.scheduleId||'');
          var vname=escapeHtml(j.venueName||j.venue||'');
          var past=new Date(j.date)<today?' past':'';
          return '<div class="cal-event'+past+'" title="'+vname+'" onclick="event.stopPropagation();openJobModal(\''+sid+'\',null)">'+vname+'</div>';
        }).join('')+'</div>';
    }
    var remain=(7-( (firstDay+daysInMonth)%7 ))%7;
    for(var i=1;i<=remain;i++) html+='<div class="cal-day other-month"><div class="day-num">'+i+'</div></div>';
    grid.innerHTML=html;
  }

  function renderTable() {
    var tbody=document.getElementById('jobTbody');
    var monthJobs=allJobs.filter(function(j){ var d=new Date(j.date); return d.getFullYear()===curYear && d.getMonth()===curMonth; });
    monthJobs.sort(function(a,b){return new Date(a.date)-new Date(b.date);});
    if(!monthJobs.length){ tbody.innerHTML='<tr><td colspan="7" class="text-center" data-i18n="noData">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; return; }
    tbody.innerHTML=monthJobs.map(function(j){
      var badge={confirmed:'badge-success',tentative:'badge-warning',cancelled:'badge-danger'}[j.status]||'';
      return '<tr><td>'+formatDate(j.date)+'</td><td>'+escapeHtml(j.venueName||j.venue||'')+'</td><td>'+escapeHtml(j.description||j.client||'')+'</td>'
        +'<td>'+escapeHtml(j.type||'')+'</td><td>'+formatCurrency(j.totalPay||j.payment||0)+'</td>'
        +'<td><span class="badge '+badge+'">'+escapeHtml(j.status||'')+'</span></td>'
        +'<td><button class="btn btn-ghost btn-sm" onclick="openJobModal(\''+encodeURIComponent(j.scheduleId||'')+"',null)\">‚úèÔ∏è</button></td></tr>';
    }).join('');
  }

  function openJobModal(id, date) {
    document.getElementById('jobModal').style.display='flex';
    document.getElementById('jobForm').reset();
    document.getElementById('jobId').value='';
    document.getElementById('deleteJobBtn').style.display='none';
    document.getElementById('jobModalTitle').textContent = id ? t('editJob')||'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô' : t('addJob')||'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô';
    if (date) document.getElementById('dateInput').value=date;
    if (id) {
      var j=allJobs.find(function(x){return x.scheduleId===id || decodeURIComponent(x.scheduleId||'')===id;});
      if(j){
        document.getElementById('jobId').value=j.scheduleId||'';
        document.getElementById('venue').value=j.venueName||j.venue||'';
        document.getElementById('client').value=j.description||j.client||'';
        document.getElementById('dateInput').value=(j.date||'').substring(0,10);
        document.getElementById('jobType').value=j.type||'‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á';
        document.getElementById('startTime').value=(j.timeSlots&&j.timeSlots[0]&&j.timeSlots[0].startTime)||j.startTime||'';
        document.getElementById('endTime').value=(j.timeSlots&&j.timeSlots[0]&&j.timeSlots[0].endTime)||j.endTime||'';
        document.getElementById('payment').value=j.totalPay||j.payment||'';
        document.getElementById('jobStatus').value=j.status||'confirmed';
        document.getElementById('jobNotes').value=j.notes||'';
        document.getElementById('deleteJobBtn').style.display='inline-flex';
      }
    }
  }

  function closeJobModal() { document.getElementById('jobModal').style.display='none'; }

  document.getElementById('jobForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var btn=document.getElementById('saveJobBtn'); btn.disabled=true; btn.textContent=t('loading');
    var id=document.getElementById('jobId').value;
    var data={
      scheduleId:id, bandId:localStorage.getItem('bandId')||'',
      venue:document.getElementById('venue').value.trim(),
      client:document.getElementById('client').value.trim(),
      date:document.getElementById('dateInput').value,
      type:document.getElementById('jobType').value,
      startTime:document.getElementById('startTime').value,
      endTime:document.getElementById('endTime').value,
      payment:document.getElementById('payment').value,
      status:document.getElementById('jobStatus').value,
      notes:document.getElementById('jobNotes').value
    };
    var action=id?'updateJob':'addJob';
    gasRun(action, data, function(r){
      btn.disabled=false; btn.textContent=t('save');
      if(r&&r.success){ showToast(t('msg_saved'),'success'); closeJobModal(); loadJobs(); }
      else showToast((r&&r.message)||t('msg_error'),'error');
    });
  });

  function deleteCurrentJob() {
    var id=document.getElementById('jobId').value;
    showConfirm(t('confirmDeleteTitle'),t('confirmDeleteMsg')).then(function(ok){
      if(!ok) return;
      gasRun('deleteJob',{scheduleId:id},function(r){
        if(r&&r.success){ showToast(t('msg_deleted'),'success'); closeJobModal(); loadJobs(); }
        else showToast((r&&r.message)||t('msg_error'),'error');
      });
    });
  }
  </script>
</body>
</html>
