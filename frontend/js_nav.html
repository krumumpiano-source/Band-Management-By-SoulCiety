<script>
/**
 * Band Management By SoulCiety ‚Äî Navigation
 * renderMainNav() ‚Äî ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏µ‡πà renderMainNav ‡∏ñ‡∏π‡∏Å‡∏ô‡∏¥‡∏¢‡∏≤‡∏°
 */

function renderMainNav(containerId) {
  if (typeof ensureDemoSession === 'function') ensureDemoSession();
  var container = document.getElementById(containerId || 'mainNav');
  if (!container) return;

  var bandName = localStorage.getItem('bandName') || (typeof t === 'function' ? t('yourBand') : '‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
  var userName = localStorage.getItem('userName') || (typeof t === 'function' ? t('user') : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
  var isManager = !!(localStorage.getItem('bandManager') || localStorage.getItem('userRole') === 'manager');
  var isAdmin = localStorage.getItem('userRole') === 'admin';
  var _t = typeof t === 'function' ? t : function(k) { return k; };

  // ‡∏ï‡∏£‡∏ß‡∏à active page
  var currentPage = '';
  if (typeof google !== 'undefined' && google.script) {
    var params = new URLSearchParams(window.location.search);
    currentPage = params.get('page') || 'dashboard';
  } else {
    currentPage = (window.location.pathname.split('/').pop() || 'dashboard.html').replace('.html','');
  }

  function navLink(page, label) {
    var isActive = currentPage === page ? ' active' : '';
    var href = typeof google !== 'undefined' && google.script ? '?page=' + page : page + '.html';
    return '<li><a href="' + href + '" class="nav-link' + isActive + '">' + label + '</a></li>';
  }

  container.innerHTML =
    '<div class="main-nav">' +
      '<div class="nav-inner">' +
        '<div class="nav-brand">' +
          '<a href="' + (typeof google !== 'undefined' && google.script ? '?page=dashboard' : 'dashboard.html') + '">üéµ ' + _escHtml(bandName) + '</a>' +
        '</div>' +
        '<button class="nav-hamburger" id="navHamburger" aria-label="‡πÄ‡∏°‡∏ô‡∏π">' +
          '<span></span><span></span><span></span>' +
        '</button>' +
        '<div class="nav-menu-wrap" id="navMenuWrap">' +
          '<ul class="nav-menu">' +
            navLink('dashboard', 'üìä ' + _t('nav_dashboard')) +
            navLink('songs', 'üéµ ' + _t('nav_songs')) +
            navLink('attendance-payroll', '‚è∞ ' + _t('nav_attendance')) +
            navLink('external-payout', 'üíµ ' + _t('nav_externalPayout')) +
            navLink('schedule', 'üìÖ ' + _t('nav_schedule')) +
            (isManager ? navLink('job-calculator', 'üßÆ ' + _t('nav_jobCalculator')) : '') +
            navLink('quotation', 'üìÑ ' + _t('nav_quotation')) +
            navLink('contract', 'üìú ' + _t('nav_contract')) +
            navLink('statistics', 'üìà ' + _t('nav_statistics')) +
            navLink('equipment', 'üé∏ ' + _t('nav_equipment')) +
            navLink('clients', 'ü§ù ' + _t('nav_clients')) +
            navLink('band-info', 'üë• ' + _t('nav_bandInfo')) +
            (isManager ? navLink('band-fund', 'üí∞ ' + _t('nav_bandFund')) : '') +
            (isManager ? navLink('band-settings', '‚öôÔ∏è ' + _t('nav_settings')) : '') +
            navLink('user-manual', 'üìñ ' + _t('nav_userManual')) +
            (isAdmin ? navLink('admin', 'üîß ' + _t('nav_admin')) : '') +
          '</ul>' +
          '<div class="nav-right">' +
            '<div id="navLangSwitcher"></div>' +
            '<span class="nav-user-name">' + _escHtml(userName) + '</span>' +
            '<a href="' + (typeof google !== 'undefined' && google.script ? '?page=index' : 'index.html') + '" class="nav-logout" onclick="if(typeof doLogout===\'function\')doLogout();return true;">' + _t('logout') + '</a>' +
          '</div>' +
        '</div>' +
      '</div>' +
    '</div>';

  // Hamburger toggle
  var hamburger = document.getElementById('navHamburger');
  var menuWrap = document.getElementById('navMenuWrap');
  if (hamburger && menuWrap) {
    hamburger.addEventListener('click', function() {
      hamburger.classList.toggle('open');
      menuWrap.classList.toggle('open');
    });
    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å
    document.addEventListener('click', function(e) {
      if (!container.contains(e.target)) {
        hamburger.classList.remove('open');
        menuWrap.classList.remove('open');
      }
    });
  }

  // Lang switcher
  if (typeof renderLangSwitcher === 'function') {
    renderLangSwitcher('navLangSwitcher');
  } else {
    _renderNavLang('navLangSwitcher');
  }
}

function _renderNavLang(containerId) {
  var el = document.getElementById(containerId);
  if (!el) return;
  var lang = typeof getLang === 'function' ? getLang() : 'th';
  el.innerHTML =
    '<div class="lang-switcher">' +
      '<button type="button" class="lang-btn ' + (lang==='th'?'active':'') + '" data-lang="th">TH</button>' +
      '<button type="button" class="lang-btn ' + (lang==='en'?'active':'') + '" data-lang="en">EN</button>' +
    '</div>';
  el.querySelectorAll('[data-lang]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      if (typeof setLang === 'function') setLang(btn.dataset.lang);
      renderMainNav('mainNav');
      if (typeof applyTranslations === 'function') applyTranslations();
    });
  });
}

function renderLangSwitcher(containerId) { _renderNavLang(containerId); }

function doLogout() {
  var token = getAuthToken ? getAuthToken() : (localStorage.getItem('auth_token') || '');
  if (token && token.indexOf('demo_') !== 0 && typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run.doPostFromClient({ action: 'logout', _token: token });
  }
  ['auth_token','bandId','bandName','bandManager','userRole','userName'].forEach(function(k) {
    localStorage.removeItem(k);
    sessionStorage.removeItem(k);
  });
}

function _escHtml(text) {
  if (!text) return '';
  var d = document.createElement('div');
  d.textContent = text;
  return d.innerHTML;
}
</script>
